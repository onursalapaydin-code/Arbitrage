<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitraj Dashboard v14</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4; 
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .status-badges { display: flex; gap: 10px; }
        .badge { 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 0.85rem;
            font-weight: 500;
        }
        .badge-market { background: #10b981; color: #000; }
        .badge-market.closed { background: #ef4444; color: #fff; }
        .badge-broker { background: #3b82f6; }
        .badge-broker.disconnected { background: #f59e0b; }
        .badge-test { background: #8b5cf6; }
        .badge-pending { background: #f59e0b; color: #000; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Cards Grid */
        .cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 16px; 
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title { 
            font-size: 0.85rem; 
            color: #9ca3af; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .card-value { 
            font-size: 1.8rem; 
            font-weight: 700;
        }
        .card-sub { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #9ca3af; }
        
        /* Tables */
        .table-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .table-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .table-title .count {
            background: rgba(255,255,255,0.1);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        th { 
            color: #9ca3af; 
            font-weight: 500; 
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        td { font-size: 0.95rem; }
        tr:hover { background: rgba(255,255,255,0.03); }
        
        /* Pending Orders Alert */
        .pending-alert {
            background: linear-gradient(135deg, #f59e0b22 0%, #f5720b22 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .pending-alert.hidden { display: none; }
        .pending-icon { font-size: 1.5rem; }
        .pending-text { flex: 1; }
        .pending-text strong { color: #f59e0b; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        .stat-label { font-size: 0.8rem; color: #6b7280; margin-bottom: 5px; }
        .stat-value { font-size: 1.3rem; font-weight: 600; }
        .stat-sub { font-size: 0.75rem; color: #4b5563; margin-top: 3px; }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #4b5563;
            font-size: 0.85rem;
            margin-top: 20px;
        }
        .update-time { color: #6b7280; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        /* Error */
        .error {
            background: #ef444422;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Arbitraj Dashboard</h1>
            <div class="status-badges">
                <span id="badge-market" class="badge badge-market">Piyasa A√ßƒ±k</span>
                <span id="badge-broker" class="badge badge-broker">Broker ‚úì</span>
                <span id="badge-test" class="badge badge-test" style="display:none">TEST</span>
                <span id="badge-pending" class="badge badge-pending" style="display:none">‚è≥ Bekleyen Emir</span>
            </div>
        </div>
        
        <div id="pending-alert" class="pending-alert hidden">
            <span class="pending-icon">‚ö†Ô∏è</span>
            <div class="pending-text">
                <strong id="pending-count">0</strong> bekleyen emir var. Bu emirler kƒ±smi dolmu≈ü ve tamamlanmayƒ± bekliyor.
            </div>
        </div>
        
        <div class="cards">
            <div class="card">
                <div class="card-title">G√ºnl√ºk P&L</div>
                <div id="daily-pnl" class="card-value">-</div>
                <div id="daily-trades" class="card-sub">- i≈ülem</div>
            </div>
            <div class="card">
                <div class="card-title">A√ßƒ±k Pozisyon P&L</div>
                <div id="total-pnl" class="card-value">-</div>
                <div id="pos-count" class="card-sub">- pozisyon</div>
            </div>
            <div class="card">
                <div class="card-title">VIOP Bakiye</div>
                <div id="viop-bal" class="card-value">-</div>
                <div id="viop-used" class="card-sub">Kullanƒ±lan: -</div>
            </div>
            <div class="card">
                <div class="card-title">SPOT Bakiye</div>
                <div id="spot-bal" class="card-value">-</div>
                <div id="spot-used" class="card-sub">Kullanƒ±lan: -</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Haftalƒ±k</div>
                <div id="week-pnl" class="stat-value">-</div>
                <div id="week-sub" class="stat-sub">- i≈ülem / - g√ºn</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Aylƒ±k</div>
                <div id="month-pnl" class="stat-value">-</div>
                <div id="month-sub" class="stat-sub">- i≈ülem / - g√ºn</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Toplam</div>
                <div id="all-pnl" class="stat-value">-</div>
                <div id="all-sub" class="stat-sub">- i≈ülem / - g√ºn</div>
            </div>
        </div>
        
        <!-- Bekleyen Emirler Tablosu -->
        <div id="pending-section" class="table-section" style="display:none">
            <div class="table-title">
                ‚è≥ Bekleyen Emirler
                <span id="pending-table-count" class="count">0</span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sembol</th>
                        <th>Y√∂n</th>
                        <th>Miktar</th>
                        <th>Fiyat</th>
                        <th>Dolum</th>
                        <th>Bekleme</th>
                    </tr>
                </thead>
                <tbody id="pending-tbody"></tbody>
            </table>
        </div>
        
        <!-- Pozisyonlar Tablosu -->
        <div class="table-section">
            <div class="table-title">
                üìà A√ßƒ±k Pozisyonlar
                <span id="positions-count" class="count">0</span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sembol</th>
                        <th>Spot</th>
                        <th>Near</th>
                        <th>Giri≈ü Spread</th>
                        <th>Beklenen Kar</th>
                        <th>B√ºy√ºtme</th>
                    </tr>
                </thead>
                <tbody id="positions-tbody"></tbody>
            </table>
        </div>
        
        <div class="footer">
            <span class="update-time">Son g√ºncelleme: <span id="update-time">-</span></span>
            <br>
            <span>Komisyon: <span id="total-comm">-</span> TL | Risk-Free: <span id="risk-free">-</span></span>
        </div>
    </div>
    
    <script>
        // Gist URL'ini buraya gir
        const GIST_ID = 'YOUR_GIST_ID_HERE';
        const GIST_URL = `https://gist.githubusercontent.com/raw/${GIST_ID}/arb_stats.json`;
        
        // Alternatif: Lokal dosya
        const LOCAL_URL = 'stats.json';
        
        // Hangi kaynaƒüƒ± kullanacaƒüƒ±z
        const USE_GIST = false;  // true = Gist, false = lokal
        
        function formatMoney(val) {
            if (val === undefined || val === null) return '-';
            const num = parseFloat(val);
            if (isNaN(num)) return '-';
            const formatted = Math.abs(num).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
            if (num >= 0) return formatted + ' ‚Ç∫';
            return '-' + formatted + ' ‚Ç∫';
        }
        
        function formatPercent(val) {
            if (val === undefined || val === null) return '-';
            return (parseFloat(val) * 100).toFixed(3) + '%';
        }
        
        function getPnlClass(val) {
            const num = parseFloat(val);
            if (num > 0) return 'positive';
            if (num < 0) return 'negative';
            return 'neutral';
        }
        
        async function fetchData() {
            try {
                const url = USE_GIST ? GIST_URL + '?t=' + Date.now() : LOCAL_URL;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Veri alƒ±namadƒ±');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Hata:', error);
            }
        }
        
        function updateUI(data) {
            // Durum badge'leri
            const marketBadge = document.getElementById('badge-market');
            marketBadge.textContent = data.market ? 'Piyasa A√ßƒ±k' : 'Piyasa Kapalƒ±';
            marketBadge.className = 'badge badge-market' + (data.market ? '' : ' closed');
            
            const brokerBadge = document.getElementById('badge-broker');
            brokerBadge.textContent = data.broker ? 'Broker ‚úì' : 'Broker ‚úó';
            brokerBadge.className = 'badge badge-broker' + (data.broker ? '' : ' disconnected');
            
            document.getElementById('badge-test').style.display = data.test ? 'inline' : 'none';
            
            // Pending badge ve alert
            const pendingCount = data.pending_count || 0;
            const pendingBadge = document.getElementById('badge-pending');
            const pendingAlert = document.getElementById('pending-alert');
            const pendingSection = document.getElementById('pending-section');
            
            if (pendingCount > 0) {
                pendingBadge.style.display = 'inline';
                pendingBadge.textContent = '‚è≥ ' + pendingCount + ' Bekleyen';
                pendingAlert.classList.remove('hidden');
                document.getElementById('pending-count').textContent = pendingCount;
                pendingSection.style.display = 'block';
                document.getElementById('pending-table-count').textContent = pendingCount;
                
                // Pending tablosu
                const pendingTbody = document.getElementById('pending-tbody');
                pendingTbody.innerHTML = '';
                
                if (data.pending) {
                    for (const [key, p] of Object.entries(data.pending)) {
                        const parts = key.split('_');
                        const sym = parts[0].replace('VIP\'F_', '').replace('IMKBH\'', '');
                        const row = document.createElement('tr');
                        const fillPct = p.qty > 0 ? ((p.processed / p.qty) * 100).toFixed(0) : 0;
                        row.innerHTML = `
                            <td><strong>${sym}</strong></td>
                            <td>${p.side}</td>
                            <td>${p.qty}</td>
                            <td>${p.price.toFixed(2)} ‚Ç∫</td>
                            <td>${p.processed}/${p.qty} (${fillPct}%)</td>
                            <td>${p.wait} dk</td>
                        `;
                        pendingTbody.appendChild(row);
                    }
                }
            } else {
                pendingBadge.style.display = 'none';
                pendingAlert.classList.add('hidden');
                pendingSection.style.display = 'none';
            }
            
            // Kartlar
            const dailyPnl = document.getElementById('daily-pnl');
            dailyPnl.textContent = formatMoney(data.daily_pnl);
            dailyPnl.className = 'card-value ' + getPnlClass(data.daily_pnl);
            document.getElementById('daily-trades').textContent = (data.trades || 0) + ' i≈ülem';
            
            const totalPnl = document.getElementById('total-pnl');
            totalPnl.textContent = formatMoney(data.total_pnl);
            totalPnl.className = 'card-value ' + getPnlClass(data.total_pnl);
            document.getElementById('pos-count').textContent = (data.count || 0) + ' pozisyon';
            
            document.getElementById('viop-bal').textContent = formatMoney(data.viop_bal);
            document.getElementById('viop-used').textContent = 'Kullanƒ±lan: ' + formatMoney(data.viop_used);
            
            document.getElementById('spot-bal').textContent = formatMoney(data.spot_bal);
            document.getElementById('spot-used').textContent = 'Kullanƒ±lan: ' + formatMoney(data.spot_used);
            
            // Period stats
            if (data.week) {
                const weekEl = document.getElementById('week-pnl');
                weekEl.textContent = formatMoney(data.week.pnl);
                weekEl.className = 'stat-value ' + getPnlClass(data.week.pnl);
                document.getElementById('week-sub').textContent = 
                    data.week.trades + ' i≈ülem / ' + data.week.days + ' g√ºn';
            }
            
            if (data.month) {
                const monthEl = document.getElementById('month-pnl');
                monthEl.textContent = formatMoney(data.month.pnl);
                monthEl.className = 'stat-value ' + getPnlClass(data.month.pnl);
                document.getElementById('month-sub').textContent = 
                    data.month.trades + ' i≈ülem / ' + data.month.days + ' g√ºn';
            }
            
            if (data.all) {
                const allEl = document.getElementById('all-pnl');
                allEl.textContent = formatMoney(data.all.pnl);
                allEl.className = 'stat-value ' + getPnlClass(data.all.pnl);
                document.getElementById('all-sub').textContent = 
                    data.all.trades + ' i≈ülem / ' + data.all.days + ' g√ºn';
            }
            
            // Pozisyonlar tablosu
            const posTbody = document.getElementById('positions-tbody');
            posTbody.innerHTML = '';
            
            if (data.positions && Object.keys(data.positions).length > 0) {
                document.getElementById('positions-count').textContent = Object.keys(data.positions).length;
                
                for (const [sym, pos] of Object.entries(data.positions)) {
                    const row = document.createElement('tr');
                    // positions formatƒ±: sym -> {pnl, spread, qty, entry, ...} veya array
                    let spotQty, nearQty, spread, expPnl, addCount;
                    
                    if (Array.isArray(pos)) {
                        [spotQty, nearQty, , , spread, expPnl, addCount] = pos;
                    } else {
                        spotQty = pos.spotQty || pos.qty || '-';
                        nearQty = pos.nearQty || '-';
                        spread = pos.spread || pos.entrySpread || 0;
                        expPnl = pos.expectedPnl || pos.pnl || 0;
                        addCount = pos.addCount || 0;
                    }
                    
                    const pnlClass = getPnlClass(expPnl);
                    row.innerHTML = `
                        <td><strong>${sym}</strong></td>
                        <td>${spotQty}</td>
                        <td>${nearQty}</td>
                        <td>${formatPercent(spread)}</td>
                        <td class="${pnlClass}">${formatMoney(expPnl)}</td>
                        <td>${addCount || 0}/2</td>
                    `;
                    posTbody.appendChild(row);
                }
            } else {
                document.getElementById('positions-count').textContent = '0';
                posTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280">A√ßƒ±k pozisyon yok</td></tr>';
            }
            
            // Footer
            document.getElementById('update-time').textContent = data.ts || new Date().toLocaleTimeString('tr-TR');
            document.getElementById('total-comm').textContent = (data.total_comm || 0).toFixed(2);
            document.getElementById('risk-free').textContent = ((data.risk_free || 0) * 100).toFixed(2) + '%';
        }
        
        // ƒ∞lk y√ºkleme ve periyodik g√ºncelleme
        fetchData();
        setInterval(fetchData, 10000);  // 10 saniyede bir g√ºncelle
    </script>
</body>
</html>
