<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SN Arbitraj Dashboard v19.5</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e4e4e4; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .status-badges { display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
        .badge-market { background: #10b981; color: #000; }
        .badge-market.closed { background: #ef4444; color: #fff; }
        .badge-broker { background: #3b82f6; }
        .badge-broker.disconnected { background: #f59e0b; }
        .badge-pending { background: #f59e0b; color: #000; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .nav-links { display: flex; gap: 10px; }
        .nav-link { padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #9ca3af; text-decoration: none; font-size: 0.85rem; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: rgba(59, 130, 246, 0.3); color: #fff; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .card-title { font-size: 0.85rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .card-value { font-size: 1.8rem; font-weight: 700; }
        .card-sub { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #9ca3af; }
        .table-section { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .table-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .table-title .count { background: rgba(255,255,255,0.1); padding: 2px 10px; border-radius: 12px; font-size: 0.85rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: #9ca3af; font-weight: 500; font-size: 0.85rem; text-transform: uppercase; }
        td { font-size: 0.95rem; }
        tr:hover { background: rgba(255,255,255,0.03); }
        .pending-alert { background: linear-gradient(135deg, #f59e0b22 0%, #f5720b22 100%); border: 1px solid #f59e0b; border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .pending-alert.hidden { display: none; }
        .critical-alert { background: linear-gradient(135deg, #ef444422 0%, #dc262622 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; animation: critical-pulse 1.5s infinite; }
        .critical-alert.hidden { display: none; }
        .critical-alert-icon { font-size: 1.5rem; }
        .critical-alert-content { flex: 1; }
        .critical-alert-title { font-weight: 700; color: #ef4444; margin-bottom: 4px; }
        .critical-alert-desc { font-size: 0.9rem; color: #fca5a5; }
        @keyframes critical-pulse { 0%, 100% { border-color: #ef4444; } 50% { border-color: #f87171; } }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px; text-align: center; }
        .stat-label { font-size: 0.8rem; color: #6b7280; margin-bottom: 5px; }
        .stat-value { font-size: 1.3rem; font-weight: 600; }
        .stat-sub { font-size: 0.75rem; color: #4b5563; margin-top: 3px; }
        .log-section { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .log-title { font-size: 1.1rem; font-weight: 600; }
        .log-actions { display: flex; gap: 10px; }
        .log-btn { padding: 6px 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: #9ca3af; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .log-btn:hover { background: rgba(59, 130, 246, 0.3); color: #fff; }
        .log-content { background: #0d1117; border-radius: 8px; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.75rem; line-height: 1.4; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .log-line { padding: 2px 0; }
        .log-time { color: #6b7280; }
        .log-error { color: #ef4444; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .footer { text-align: center; color: #4b5563; font-size: 0.85rem; margin-top: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .settings-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .settings-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 15px; color: #3b82f6; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { color: #9ca3af; font-size: 0.9rem; }
        .setting-value { color: #e4e4e4; font-weight: 500; font-family: 'Consolas', monospace; }
        .setting-value.highlight { color: #10b981; }
        .setting-value.warning { color: #f59e0b; }
        .setup-box { background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; border-radius: 12px; padding: 30px; text-align: center; margin: 50px auto; max-width: 400px; }
        .setup-box h2 { margin-bottom: 15px; color: #3b82f6; }
        .setup-box p { margin-bottom: 20px; color: #9ca3af; font-size: 0.9rem; }
        .setup-box input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 12px 15px; color: #fff; width: 100%; margin-bottom: 15px; font-family: monospace; font-size: 1rem; text-align: center; }
        .setup-box button { padding: 12px 30px; background: #3b82f6; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 1rem; font-weight: 500; }
        .setup-box button:hover { background: #2563eb; }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .cards { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Arbitraj Dashboard <span id="robot-status" style="font-size:0.7em;color:#10b981;"></span><span id="data-warning" style="display:none;font-size:0.6em;color:#ef4444;margin-left:10px;">‚ö†Ô∏è VERƒ∞ BAƒûLANTISI YOK</span></h1>
            <div class="header-right">
                <div class="nav-links">
                    <span class="nav-link active" data-page="main">Ana Sayfa</span>
                    <span class="nav-link" data-page="logs">üìã Loglar</span>
                    <span class="nav-link" data-page="settings">‚öôÔ∏è Ayarlar</span>
                </div>
                <div class="status-badges">
                    <span id="badge-data" class="badge" style="display:none;background:#ef4444;color:#fff;">Veri ‚úó</span>
                    <span id="badge-circuit" class="badge" style="display:none;background:#ef4444;color:#fff;font-weight:600;">‚ö° DEVRE KESƒ∞Cƒ∞</span>
                    <span id="badge-margin" class="badge" style="display:none;font-weight:600;">Margin</span>
                    <span id="badge-market" class="badge badge-market">-</span>
                    <span id="badge-broker" class="badge badge-broker">-</span>
                    <span id="badge-pending" class="badge badge-pending" style="display:none">‚è≥</span>
                    <span id="badge-paused" class="badge" style="display:none;background:#f59e0b;color:#000;font-weight:600;">‚è∏Ô∏è DURAKLATILDI</span>
                    <button id="pause-btn" class="badge" style="background:#f59e0b;color:#000;border:none;cursor:pointer;font-weight:600;" onclick="sendPauseCommand()">‚è∏ DURAKLAT</button>
                    <button id="stop-btn" class="badge" style="background:#ef4444;color:#fff;border:none;cursor:pointer;font-weight:600;" onclick="sendStopCommand()">‚èπ STOP</button>
                </div>
            </div>
        </div>
        
        <!-- Setup Sayfasƒ± -->
        <div id="page-setup" class="page">
            <div class="setup-box">
                <h2>üîó Gist Baƒülantƒ±sƒ±</h2>
                <p>Gist ID'nizi girin</p>
                <input type="text" id="gist-id-input" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                <p style="margin-top:15px;font-size:0.85rem;">Token (STOP butonu i√ßin, opsiyonel)</p>
                <input type="password" id="gist-token-input" placeholder="github_pat_... veya ghp_...">
                <button onclick="saveGistId()">Baƒülan</button>
            </div>
        </div>
        
        <!-- Ana Sayfa -->
        <div id="page-main" class="page">
            <div id="critical-alert" class="critical-alert hidden">
                <span class="critical-alert-icon">üö®</span>
                <div class="critical-alert-content">
                    <div class="critical-alert-title">KRƒ∞Tƒ∞K UYARI</div>
                    <div id="critical-alert-text" class="critical-alert-desc"></div>
                </div>
            </div>
            <div id="pending-alert" class="pending-alert hidden">
                <span>‚ö†Ô∏è</span>
                <div><strong id="pending-count">0</strong> bekleyen emir var.</div>
            </div>
            <div class="cards">
                <div class="card"><div class="card-title">G√ºnl√ºk P&L</div><div id="daily-pnl" class="card-value">-</div><div id="daily-trades" class="card-sub">-</div></div>
                <div class="card"><div class="card-title">A√ßƒ±k Poz P&L</div><div id="total-pnl" class="card-value">-</div><div id="pos-count" class="card-sub">-</div></div>
                <div class="card"><div class="card-title">VIOP Teminat</div><div id="viop-bal" class="card-value">-</div><div id="viop-used" class="card-sub">-</div></div>
                <div class="card"><div class="card-title">SPOT Kullanƒ±labilir (T+2)</div><div id="spot-bal" class="card-value">-</div><div id="spot-used" class="card-sub">-</div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Haftalƒ±k</div><div id="week-pnl" class="stat-value">-</div><div id="week-sub" class="stat-sub">-</div></div>
                <div class="stat-card"><div class="stat-label">Aylƒ±k</div><div id="month-pnl" class="stat-value">-</div><div id="month-sub" class="stat-sub">-</div></div>
                <div class="stat-card"><div class="stat-label">Toplam</div><div id="all-pnl" class="stat-value">-</div><div id="all-sub" class="stat-sub">-</div></div>
            </div>
            <div id="pending-section" class="table-section" style="display:none">
                <div class="table-title">‚è≥ Bekleyen Emirler <span id="pending-table-count" class="count">0</span></div>
                <table><thead><tr><th>Sembol</th><th>Y√∂n</th><th>Miktar</th><th>Fiyat</th><th>Dolum</th><th>Bekleme</th></tr></thead><tbody id="pending-tbody"></tbody></table>
            </div>
            <div id="orphan-section" class="table-section" style="display:none;border-left:3px solid #f59e0b;">
                <div class="table-title">ü¶¥ Yetim Bacaklar <span id="orphan-count" class="count">0</span></div>
                <table><thead><tr><th>Sembol</th><th>Dolan Bacak</th><th>Y√∂n</th><th>Miktar</th><th>Fiyat</th><th>Hedef</th></tr></thead><tbody id="orphan-tbody"></tbody></table>
            </div>
            <div class="table-section">
                <div class="table-title">üìà A√ßƒ±k Pozisyonlar <span id="positions-count" class="count">0</span></div>
                <table><thead><tr><th>Sembol</th><th>A√ßƒ±lƒ±≈ü</th><th>Spot</th><th>Near</th><th>Giri≈ü Sp.</th><th>G√ºncel Sp.</th><th>Beklenen</th><th>Anlƒ±k P&L</th><th>Ekl.</th></tr></thead><tbody id="positions-tbody"></tbody></table>
            </div>
        </div>
        
        <!-- Log Sayfasƒ± -->
        <div id="page-logs" class="page">
            <div class="log-section">
                <div class="log-header">
                    <div class="log-title">üìã Robot Loglarƒ± (Son 50 Satƒ±r)</div>
                    <div class="log-actions">
                        <button class="log-btn" onclick="refreshLogs()">üîÑ Yenile</button>
                        <button class="log-btn" onclick="scrollToBottom()">‚¨áÔ∏è Sona Git</button>
                    </div>
                </div>
                <div id="log-content" class="log-content">Y√ºkleniyor...</div>
            </div>
        </div>
        
        <!-- Ayarlar Sayfasƒ± -->
        <div id="page-settings" class="page">
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-card-title">üìä SN Strateji</div>
                    <div class="setting-row"><span class="setting-label">SN Min Marj</span><span id="set-sn-min" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">Roll Min Marj</span><span id="set-roll-min" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">Replacement E≈üik</span><span id="set-replacement" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">GIE Kademe</span><span id="set-gie-depth" class="setting-value">-</span></div>
                </div>
                <div class="settings-card">
                    <div class="settings-card-title">‚ö†Ô∏è Risk Y√∂netimi</div>
                    <div class="setting-row"><span class="setting-label">Max G√ºnl√ºk Zarar</span><span id="set-max-loss" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">Margin Sarƒ±</span><span id="set-margin-warn" class="setting-value" style="color:#f59e0b">-</span></div>
                    <div class="setting-row"><span class="setting-label">Margin Turuncu</span><span id="set-margin-danger" class="setting-value" style="color:#f97316">-</span></div>
                    <div class="setting-row"><span class="setting-label">Margin Kƒ±rmƒ±zƒ±</span><span id="set-margin-crit" class="setting-value" style="color:#ef4444">-</span></div>
                </div>
                <div class="settings-card">
                    <div class="settings-card-title">üéØ Erken √áƒ±kƒ±≈ü</div>
                    <div class="setting-row"><span class="setting-label">Erken √áƒ±kƒ±≈ü K</span><span id="set-early-k" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">BB √áƒ±kƒ±≈ü Ref</span><span id="set-bb-exit" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">G√ºn ƒ∞√ßi Min Kar</span><span id="set-intraday" class="setting-value">-</span></div>
                </div>
                <div class="settings-card">
                    <div class="settings-card-title">‚öôÔ∏è Sistem</div>
                    <div class="setting-row"><span class="setting-label">BB Periyodu</span><span id="set-bb-period" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">D√∂ng√º (ms)</span><span id="set-loop-ms" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">Cache Yolu</span><span id="set-cache-path" class="setting-value">-</span></div>
                </div>
                <div class="settings-card">
                    <div class="settings-card-title">üîó Baƒülantƒ±</div>
                    <div class="setting-row"><span class="setting-label">Durum</span><span id="set-gist-status" class="setting-value highlight">Baƒülƒ±</span></div>
                    <div class="setting-row"><span class="setting-label">Token</span><span id="set-token-status" class="setting-value">-</span></div>
                    <div class="setting-row"><span class="setting-label">Son G√ºncelleme</span><span id="set-last-update" class="setting-value">-</span></div>
                    <div class="setting-row">
                        <span class="setting-label">Baƒülantƒ±yƒ± Sƒ±fƒ±rla</span>
                        <button class="log-btn" onclick="resetConnection()">Sƒ±fƒ±rla</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <span>Son g√ºncelleme: <span id="update-time">-</span></span> |
            <span>Komisyon: <span id="total-comm">-</span> TL</span> |
            <span>Risk-Free: <span id="risk-free">-</span></span>
        </div>
    </div>
    
    <script>
        // Hardcoded Gist kullanƒ±cƒ±sƒ±
        const GIST_USER = 'onursalapaydin-code';
        
        // Gist ID ve Token localStorage'dan
        let GIST_ID = localStorage.getItem('arbGistId') || '';
        let GIST_TOKEN = localStorage.getItem('arbGistToken') || '';
        let lastUpdateTime = null;
        let statsData = null;  // Stats verisi
        
        function getGistUrl(file) {
            return `https://gist.githubusercontent.com/${GIST_USER}/${GIST_ID}/raw/${file}?t=${Date.now()}`;
        }
        
        function saveGistId() {
            const idInput = document.getElementById('gist-id-input').value.trim();
            const tokenInput = document.getElementById('gist-token-input')?.value.trim() || '';
            
            if (idInput && idInput.length > 10) {
                GIST_ID = idInput;
                GIST_TOKEN = tokenInput;
                localStorage.setItem('arbGistId', GIST_ID);
                if (GIST_TOKEN) localStorage.setItem('arbGistToken', GIST_TOKEN);
                showPage('main');
                fetchData();
            } else {
                alert('Ge√ßerli bir Gist ID girin');
            }
        }
        
        async function sendStopCommand() {
            if (!GIST_ID || !GIST_TOKEN) {
                alert('STOP komutu g√∂ndermek i√ßin Ayarlar > Baƒülantƒ± b√∂l√ºm√ºnden token girmeniz gerekiyor.');
                return;
            }
            
            if (!confirm('Robotu durdurmak istediƒüinizden emin misiniz?')) return;
            
            try {
                const authPrefix = GIST_TOKEN.startsWith('github_pat_') ? 'Bearer ' : 'token ';
                const body = JSON.stringify({
                    files: {
                        'arb_command.json': {
                            content: JSON.stringify({command: 'STOP', ts: new Date().toLocaleTimeString('tr-TR')})
                        }
                    }
                });
                
                const resp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': authPrefix + GIST_TOKEN,
                        'Content-Type': 'application/json',
                        'User-Agent': 'ArbDashboard'
                    },
                    body: body
                });
                
                if (resp.ok) {
                    alert('STOP komutu g√∂nderildi! Robot 1 dakika i√ßinde duracak.');
                    document.getElementById('stop-btn').textContent = '‚èπ G√∂nderildi';
                    document.getElementById('stop-btn').style.background = '#6b7280';
                } else {
                    alert('Hata: ' + resp.status + ' - Token ge√ßersiz olabilir.');
                }
            } catch(e) {
                alert('Hata: ' + e.message);
            }
        }
        
        // Robot duraklatma durumu
        let robotPaused = false;
        
        async function sendPauseCommand() {
            if (!GIST_ID || !GIST_TOKEN) {
                alert('Komut g√∂ndermek i√ßin Ayarlar > Baƒülantƒ± b√∂l√ºm√ºnden token giriniz.');
                return;
            }
            
            const command = robotPaused ? 'RESUME' : 'PAUSE';
            const confirmMsg = robotPaused ? 'Robotu devam ettirmek istiyor musunuz?' : 'Robotu duraklatmak istiyor musunuz?';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                const authPrefix = GIST_TOKEN.startsWith('github_pat_') ? 'Bearer ' : 'token ';
                const body = JSON.stringify({
                    files: {
                        'arb_command.json': {
                            content: JSON.stringify({command: command, ts: new Date().toLocaleTimeString('tr-TR')})
                        }
                    }
                });
                
                const resp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': authPrefix + GIST_TOKEN,
                        'Content-Type': 'application/json',
                        'User-Agent': 'ArbDashboard'
                    },
                    body: body
                });
                
                if (resp.ok) {
                    robotPaused = !robotPaused;
                    updatePauseButton();
                    alert(robotPaused ? 'PAUSE komutu g√∂nderildi!' : 'RESUME komutu g√∂nderildi!');
                } else {
                    alert('Hata: ' + resp.status + ' - Token ge√ßersiz olabilir.');
                }
            } catch(e) {
                alert('Hata: ' + e.message);
            }
        }
        
        function updatePauseButton() {
            const btn = document.getElementById('pause-btn');
            const badge = document.getElementById('badge-paused');
            if (robotPaused) {
                btn.textContent = '‚ñ∂ DEVAM';
                btn.style.background = '#10b981';
                btn.style.color = '#fff';
                badge.style.display = 'inline-block';
            } else {
                btn.textContent = '‚è∏ DURAKLAT';
                btn.style.background = '#f59e0b';
                btn.style.color = '#000';
                badge.style.display = 'none';
            }
        }
        
        function updateRobotStatus(isRunning) {
            const statusEl = document.getElementById('robot-status');
            const pauseBtn = document.getElementById('pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            if (isRunning) {
                statusEl.textContent = '‚óè Robot √áalƒ±≈üƒ±yor';
                statusEl.style.color = '#10b981';
                pauseBtn.disabled = false;
                pauseBtn.style.opacity = '1';
                pauseBtn.style.cursor = 'pointer';
                stopBtn.disabled = false;
                stopBtn.style.opacity = '1';
                stopBtn.style.cursor = 'pointer';
            } else {
                statusEl.textContent = '‚óã Robot Durdu';
                statusEl.style.color = '#ef4444';
                pauseBtn.disabled = true;
                pauseBtn.style.opacity = '0.5';
                pauseBtn.style.cursor = 'not-allowed';
                stopBtn.disabled = true;
                stopBtn.style.opacity = '0.5';
                stopBtn.style.cursor = 'not-allowed';
            }
        }
        
        function resetConnection() {
            localStorage.removeItem('arbGistId');
            localStorage.removeItem('arbGistToken');
            GIST_ID = '';
            GIST_TOKEN = '';
            showPage('setup');
        }
        
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            if (!GIST_ID) {
                document.getElementById('page-setup').classList.add('active');
                return;
            }
            
            document.getElementById('page-' + page).classList.add('active');
            document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
            
            if (page === 'logs') refreshLogs();
            if (page === 'settings') loadSettings();
        }
        
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => showPage(link.dataset.page));
        });
        
        function formatMoney(val) {
            if (val === undefined || val === null) return '-';
            const num = parseFloat(val);
            if (isNaN(num)) return '-';
            return (num >= 0 ? '' : '-') + Math.abs(num).toLocaleString('tr-TR', {maximumFractionDigits:0}) + ' ‚Ç∫';
        }
        function formatPercent(val) { return val ? (parseFloat(val)*100).toFixed(3)+'%' : '-'; }
        function getPnlClass(val) { const n=parseFloat(val); return n>0?'positive':n<0?'negative':'neutral'; }
        
        function formatLogLine(line) {
            if (!line.trim()) return '';
            const m = line.match(/^(\d{2}:\d{2}:\d{2}\.\d{3})\s(.*)$/);
            if (!m) return '<div class="log-line">'+line+'</div>';
            let cls = '';
            if (m[2].includes('‚ùå')||m[2].includes('HATA')) cls='log-error';
            else if (m[2].includes('‚úÖ')||m[2].includes('‚úì')) cls='log-success';
            else if (m[2].includes('‚ö†Ô∏è')) cls='log-warning';
            else if (m[2].includes('üîÑ')||m[2].includes('üìä')||m[2].includes('üéØ')) cls='log-info';
            return '<div class="log-line"><span class="log-time">'+m[1]+'</span> <span class="'+cls+'">'+m[2]+'</span></div>';
        }
        
        async function fetchData() {
            if (!GIST_ID) return;
            try {
                const r = await fetch(getGistUrl('arb_stats.json'));
                if (!r.ok) { document.getElementById('set-gist-status').textContent = 'Baƒülantƒ± Hatasƒ±'; return; }
                const d = await r.json();
                statsData = d;  // Global'e kaydet (loadSettings i√ßin)
                lastUpdateTime = d.ts;
                
                // Veri baƒülantƒ±sƒ± kontrol√º (IdealData)
                const dataOk = d.data !== false;
                document.getElementById('data-warning').style.display = dataOk ? 'none' : 'inline';
                document.getElementById('badge-data').style.display = dataOk ? 'none' : 'inline';
                
                document.getElementById('badge-market').textContent = d.market?'Piyasa A√ßƒ±k':'Piyasa Kapalƒ±';
                document.getElementById('badge-market').className = 'badge badge-market'+(d.market?'':' closed');
                document.getElementById('badge-broker').textContent = d.broker?'Broker ‚úì':'Broker ‚úó';
                document.getElementById('badge-broker').className = 'badge badge-broker'+(d.broker?'':' disconnected');
                
                // Margin durumu: 0=normal, 1=warning(sarƒ±), 2=danger(turuncu), 3=critical(kƒ±rmƒ±zƒ±)
                const marginBadge = document.getElementById('badge-margin');
                const marginStatus = d.margin || 0;
                if (marginStatus === 0) {
                    marginBadge.style.display = 'none';
                } else {
                    marginBadge.style.display = 'inline';
                    if (marginStatus === 1) {
                        marginBadge.textContent = '‚ö†Ô∏è Margin';
                        marginBadge.style.background = '#f59e0b';
                        marginBadge.style.color = '#000';
                    } else if (marginStatus === 2) {
                        marginBadge.textContent = 'üü† Margin!';
                        marginBadge.style.background = '#f97316';
                        marginBadge.style.color = '#fff';
                    } else if (marginStatus === 3) {
                        marginBadge.textContent = 'üî¥ MARGIN!';
                        marginBadge.style.background = '#ef4444';
                        marginBadge.style.color = '#fff';
                    }
                }
                
                // Devre kesici durumu
                const circuitBadge = document.getElementById('badge-circuit');
                circuitBadge.style.display = d.circuit ? 'inline' : 'none';

                // Kritik uyarƒ±lar
                const alerts = d.alerts || [];
                const criticalBox = document.getElementById('critical-alert');
                const criticalText = document.getElementById('critical-alert-text');
                if (alerts.length > 0) {
                    const alertMessages = {
                        'T2_CRITICAL': '‚ö†Ô∏è T+2 Bakiye 17:00 sonrasƒ± hala negatif! Manuel m√ºdahale gerekebilir.',
                        'INDEX_CIRCUIT': '‚ö° Endeks devre kesici aktif - Yeni pozisyon a√ßƒ±lmƒ±yor.',
                        'MARGIN_CRITICAL': 'üî¥ Margin kritik seviyede - Pozisyon kapatƒ±lƒ±yor.'
                    };
                    const messages = alerts.map(a => alertMessages[a] || a).join('<br>');
                    criticalText.innerHTML = messages;
                    criticalBox.classList.remove('hidden');
                } else {
                    criticalBox.classList.add('hidden');
                }

                // Running durumunu kontrol et
                const isRobotRunning = d.running !== false;  // undefined veya true ise √ßalƒ±≈üƒ±yor
                updateRobotStatus(isRobotRunning);
                
                // Paused durumunu stats.json'dan oku (form veya dashboard'dan duraklatƒ±lmƒ±≈ü olabilir)
                if (d.paused !== undefined) {
                    robotPaused = d.paused;
                    updatePauseButton();
                }
                
                const pc = d.pending_count||0;
                document.getElementById('badge-pending').style.display = pc>0?'inline':'none';
                document.getElementById('badge-pending').textContent = '‚è≥ '+pc;
                document.getElementById('pending-alert').classList.toggle('hidden', pc===0);
                document.getElementById('pending-count').textContent = pc;
                document.getElementById('pending-section').style.display = pc>0?'block':'none';
                document.getElementById('pending-table-count').textContent = pc;
                
                if (d.pending && pc>0) {
                    const tb = document.getElementById('pending-tbody'); tb.innerHTML='';
                    for (const [k,p] of Object.entries(d.pending)) {
                        // Key format: "F_GUBRF0126_BUY" veya "GUBRF_BUY"
                        // Son _ √∂ncesini al (side hari√ß)
                        const parts = k.split('_');
                        const sym = parts.slice(0, -1).join('_');  // Side hari√ß t√ºm√ºn√º birle≈ütir
                        const pct = p.qty>0?((p.processed/p.qty)*100).toFixed(0):0;
                        tb.innerHTML += '<tr><td><strong>'+sym+'</strong></td><td>'+p.side+'</td><td>'+p.qty+'</td><td>'+(p.price||0).toFixed(2)+' ‚Ç∫</td><td>'+p.processed+'/'+p.qty+' ('+pct+'%)</td><td>'+(p.wait||0)+' dk</td></tr>';
                    }
                }
                
                // Yetim Bacaklar (orphanLegs)
                const oc = d.orphan_count||0;
                document.getElementById('orphan-section').style.display = oc>0?'block':'none';
                document.getElementById('orphan-count').textContent = oc;
                
                if (d.orphans && oc>0) {
                    const otb = document.getElementById('orphan-tbody'); otb.innerHTML='';
                    for (const [sym, o] of Object.entries(d.orphans)) {
                        const filledLeg = o.fl || '-';
                        const filledSide = o.fs || '-';
                        const filledQty = o.fq || 0;
                        const filledPrice = o.fp || 0;
                        const targetLeg = o.tl || '-';
                        const sideClass = filledSide === 'SELL' ? 'pnl-neg' : 'pnl-pos';
                        otb.innerHTML += '<tr><td><strong>'+sym+'</strong></td><td>'+filledLeg+'</td><td class="'+sideClass+'">'+filledSide+'</td><td>'+filledQty+'</td><td>'+filledPrice.toFixed(2)+' ‚Ç∫</td><td>'+targetLeg+'</td></tr>';
                    }
                }
                
                const dp = document.getElementById('daily-pnl');
                dp.textContent = formatMoney(d.daily_pnl); dp.className = 'card-value '+getPnlClass(d.daily_pnl);
                document.getElementById('daily-trades').textContent = (d.trades||0)+' i≈ülem';
                
                const tp = document.getElementById('total-pnl');
                tp.textContent = formatMoney(d.total_pnl); tp.className = 'card-value '+getPnlClass(d.total_pnl);
                document.getElementById('pos-count').textContent = (d.count||0)+' pozisyon';
                
                const viopToplam = d.viop_toplam || d.viop_bal;
                const viopKullanilabilir = d.viop_kullanilabilir || (d.viop_bal - d.viop_used);
                document.getElementById('viop-bal').textContent = formatMoney(viopToplam);
                const viopFree = d.viop_free || 0;
                const viopFreePct = (viopFree * 100).toFixed(1) + '%';
                let viopFreeColor = '#10b981';  // ye≈üil
                if (viopFree < 0.05) viopFreeColor = '#ef4444';  // kƒ±rmƒ±zƒ±
                else if (viopFree < 0.10) viopFreeColor = '#f97316';  // turuncu
                else if (viopFree < 0.20) viopFreeColor = '#f59e0b';  // sarƒ±
                document.getElementById('viop-used').innerHTML = 'Kullanƒ±labilir: '+formatMoney(viopKullanilabilir)+' <span style="color:'+viopFreeColor+';font-weight:600;">(Serbest: '+viopFreePct+')</span>';
                document.getElementById('spot-bal').textContent = formatMoney(d.t2 !== undefined ? d.t2 : d.spot_bal);
                document.getElementById('spot-used').textContent = 'Kullanƒ±lan: '+formatMoney(d.spot_used)+' / Toplam: '+formatMoney(d.spot_bal);
                
                if (d.week) { const e=document.getElementById('week-pnl'); e.textContent=formatMoney(d.week.pnl); e.className='stat-value '+getPnlClass(d.week.pnl); document.getElementById('week-sub').textContent=d.week.trades+' i≈ülem / '+d.week.days+' g√ºn'; }
                if (d.month) { const e=document.getElementById('month-pnl'); e.textContent=formatMoney(d.month.pnl); e.className='stat-value '+getPnlClass(d.month.pnl); document.getElementById('month-sub').textContent=d.month.trades+' i≈ülem / '+d.month.days+' g√ºn'; }
                if (d.all) { const e=document.getElementById('all-pnl'); e.textContent=formatMoney(d.all.pnl); e.className='stat-value '+getPnlClass(d.all.pnl); document.getElementById('all-sub').textContent=d.all.trades+' i≈ülem / '+d.all.days+' g√ºn'; }
                
                const ptb = document.getElementById('positions-tbody'); ptb.innerHTML='';
                const posKeys = d.positions ? Object.keys(d.positions) : [];
                document.getElementById('positions-count').textContent = posKeys.length;
                if (posKeys.length > 0) {
                    for (const [sym,pos] of Object.entries(d.positions)) {
                        let sq,nq,sp,ep,pnl,ac,et,es;
                        if (Array.isArray(pos)) { [sq,nq,,,sp,ep,ac]=pos; et=0; es=0; }
                        else {sq=pos.sq||'-';nq=pos.nq||'-';sp=pos.sp||0;ep=pos.exp||0;pnl=pos.pnl||0;ac=pos.d||0;et=pos.et||0;es=pos.es||0;}
                        // .NET ticks -> JS Date
                        var entryDate = '-';
                        if (et > 0) { var ms = (et - 621355968000000000) / 10000; var dd = new Date(ms); entryDate = dd.toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit'})+' '+dd.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}); }
                        var spColor = (es > 0 && sp > 0) ? (sp <= es ? '#10b981' : '#ef4444') : '';
                        ptb.innerHTML += '<tr><td><strong>'+sym+'</strong></td><td style="font-size:0.75rem">'+entryDate+'</td><td>'+sq+'</td><td>'+nq+'</td><td>'+formatPercent(es)+'</td><td style="color:'+spColor+'">'+formatPercent(sp)+'</td><td class="'+getPnlClass(ep)+'">'+formatMoney(ep)+'</td><td class="'+getPnlClass(pnl)+'">'+formatMoney(pnl)+'</td><td>'+(ac||0)+'/2</td></tr>';
                    }
                } else ptb.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#6b7280">A√ßƒ±k pozisyon yok</td></tr>';
                
                document.getElementById('update-time').textContent = d.ts || new Date().toLocaleTimeString('tr-TR');
                document.getElementById('total-comm').textContent = (d.total_comm||0).toFixed(2);
                document.getElementById('risk-free').textContent = ((d.risk_free||0)*100).toFixed(2)+'%';
                document.getElementById('set-gist-status').textContent = 'Baƒülƒ±';
                document.getElementById('set-gist-status').className = 'setting-value highlight';
                
            } catch(e) { 
                console.error(e);
                document.getElementById('set-gist-status').textContent = 'Hata';
                document.getElementById('set-gist-status').className = 'setting-value warning';
            }
        }
        
        async function refreshLogs() {
            if (!GIST_ID) return;
            try {
                const r = await fetch(getGistUrl('arb_logs.txt'));
                if (!r.ok) { document.getElementById('log-content').innerHTML='<div style="color:#6b7280">Log dosyasƒ± bulunamadƒ±.</div>'; return; }
                const t = await r.text();
                const lines = t.split('\n').filter(l=>l.trim()).reverse();  // Yeniden eskiye sƒ±rala
                document.getElementById('log-content').innerHTML = lines.map(formatLogLine).join('');
            } catch(e) { document.getElementById('log-content').innerHTML='<div class="log-error">Hata: '+e.message+'</div>'; }
        }
        
        async function loadSettings() {
            if (!GIST_ID) return;
            document.getElementById('set-last-update').textContent = lastUpdateTime || '-';
            document.getElementById('set-token-status').textContent = GIST_TOKEN ? 'Var ‚úì' : 'Yok';
            document.getElementById('set-token-status').className = 'setting-value ' + (GIST_TOKEN ? 'highlight' : 'warning');
            try {
                const r = await fetch(getGistUrl('arb_settings.json'));
                if (!r.ok) { console.error('Settings fetch failed:', r.status); return; }
                const text = await r.text();
                console.log('Settings raw:', text);
                let s;
                try {
                    s = JSON.parse(text);
                } catch(parseErr) {
                    console.error('Settings JSON parse error:', parseErr, 'Raw:', text);
                    return;
                }
                console.log('Settings parsed:', s);
                
                
                // SN Strateji
                document.getElementById('set-sn-min').textContent = s.sn_min_margin ? (s.sn_min_margin * 100).toFixed(2) + '%' : '-';
                document.getElementById('set-roll-min').textContent = s.roll_min_margin ? (s.roll_min_margin * 100).toFixed(2) + '%' : '-';
                document.getElementById('set-replacement').textContent = s.replacement_threshold ? (s.replacement_threshold * 100).toFixed(0) + '%' : '-';
                document.getElementById('set-gie-depth').textContent = s.gie_depth_levels || '-';
                
                // Risk Y√∂netimi
                document.getElementById('set-max-loss').textContent = formatMoney(s.max_daily_loss);
                document.getElementById('set-margin-warn').textContent = s.margin_warning_pct !== undefined ? '<' + (s.margin_warning_pct * 100).toFixed(0) + '%' : '<10%';
                document.getElementById('set-margin-danger').textContent = s.margin_danger_pct !== undefined ? '<' + (s.margin_danger_pct * 100).toFixed(0) + '%' : '<5%';
                document.getElementById('set-margin-crit').textContent = s.margin_critical_pct !== undefined ? '<' + (s.margin_critical_pct * 100).toFixed(0) + '%' : '<0%';
                
                // Erken √áƒ±kƒ±≈ü
                document.getElementById('set-early-k').textContent = s.early_exit_k !== undefined ? s.early_exit_k.toFixed(2) : '0.20';
                document.getElementById('set-bb-exit').textContent = s.bb_exit_helper !== undefined ? '<' + s.bb_exit_helper.toFixed(0) : '<30';
                document.getElementById('set-intraday').textContent = s.intraday_min_profit ? '‚Ä∞' + (s.intraday_min_profit * 1000).toFixed(1) : '‚Ä∞2';
                
                // Sistem
                document.getElementById('set-bb-period').textContent = s.bb_period || '-';
                document.getElementById('set-loop-ms').textContent = s.loop_ms ? s.loop_ms + ' ms' : '-';
                document.getElementById('set-cache-path').textContent = s.cache_path || 'D:\\arbit\\';
            } catch(e) { console.error('Settings:', e); }
        }
        
        function scrollToBottom() { const el=document.getElementById('log-content'); el.scrollTop=el.scrollHeight; }
        
        // Ba≈ülangƒ±√ß
        if (GIST_ID) {
            showPage('main');
            fetchData();
        } else {
            showPage('setup');
        }
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
