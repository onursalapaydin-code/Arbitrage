<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitraj Robot v13 - Spot-Near Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .version { color: #888; font-size: 0.9rem; }
        
        .status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .status-indicator.online { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .status-indicator.offline { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        .status-indicator.test { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .pulse {
            width: 10px; height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .pulse.green { background: #00ff88; }
        .pulse.red { background: #ff4444; }
        .pulse.yellow { background: #ffc107; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card.highlight-week { border-left: 3px solid #00d4ff; }
        .card.highlight-month { border-left: 3px solid #ff9800; }
        .card.highlight-all { border-left: 3px solid #9c27b0; }
        
        .card-title {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .card-value.positive { color: #00ff88; }
        .card-value.negative { color: #ff4444; }
        .card-value.neutral { color: #00d4ff; }
        .card-sub { font-size: 0.85rem; color: #666; margin-top: 5px; }
        
        .period-stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .period-stat {
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .period-stat span { color: #888; }
        
        .budget-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .budget-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .budget-fill.viop { background: linear-gradient(90deg, #00d4ff, #0099cc); }
        .budget-fill.spot { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
        }
        
        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .positions-table th {
            text-align: left;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }
        .positions-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .positions-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .pnl-positive { color: #00ff88; }
        .pnl-negative { color: #ff4444; }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.85rem;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .refresh-info {
            font-size: 0.75rem;
            color: #555;
            text-align: right;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr 1fr; }
            .grid-3 { grid-template-columns: 1fr; }
            .card-value { font-size: 1.4rem; }
            header { flex-direction: column; gap: 15px; }
        }
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <div class="logo">üìä Arbitraj Robot</div>
                <div class="version">v13 - Spot-Near Only</div>
            </div>
            <div class="status-bar">
                <div class="status-indicator" id="brokerStatus">
                    <div class="pulse" id="brokerPulse"></div>
                    <span id="brokerText">Broker</span>
                </div>
                <div class="status-indicator" id="marketStatus">
                    <div class="pulse" id="marketPulse"></div>
                    <span id="marketText">Y√ºkleniyor...</span>
                </div>
                <div class="status-indicator" id="modeStatus">
                    <span id="modeText">-</span>
                </div>
            </div>
        </header>
        
        <!-- D√∂nemsel Performans -->
        <div class="section-title">üìà Performans √ñzeti</div>
        <div class="grid-3">
            <div class="card highlight-week">
                <div class="card-title">üìÖ Bu Hafta (7 G√ºn)</div>
                <div class="card-value" id="weekPnl">-</div>
                <div class="period-stats">
                    <div class="period-stat"><span>Komisyon:</span> <span id="weekComm">-</span></div>
                    <div class="period-stat"><span>ƒ∞≈ülem:</span> <span id="weekTrades">-</span></div>
                    <div class="period-stat"><span>G√ºn:</span> <span id="weekDays">-</span></div>
                </div>
            </div>
            
            <div class="card highlight-month">
                <div class="card-title">üìÜ Bu Ay (30 G√ºn)</div>
                <div class="card-value" id="monthPnl">-</div>
                <div class="period-stats">
                    <div class="period-stat"><span>Komisyon:</span> <span id="monthComm">-</span></div>
                    <div class="period-stat"><span>ƒ∞≈ülem:</span> <span id="monthTrades">-</span></div>
                    <div class="period-stat"><span>G√ºn:</span> <span id="monthDays">-</span></div>
                </div>
            </div>
            
            <div class="card highlight-all">
                <div class="card-title">üèÜ T√ºm Zamanlar</div>
                <div class="card-value" id="allPnl">-</div>
                <div class="period-stats">
                    <div class="period-stat"><span>Komisyon:</span> <span id="allComm">-</span></div>
                    <div class="period-stat"><span>ƒ∞≈ülem:</span> <span id="allTrades">-</span></div>
                    <div class="period-stat"><span>G√ºn:</span> <span id="allDays">-</span></div>
                </div>
            </div>
        </div>
        
        <!-- G√ºnl√ºk Durum -->
        <div class="section-title">üìä G√ºnl√ºk Durum</div>
        <div class="grid">
            <div class="card">
                <div class="card-title">üí∞ A√ßƒ±k P&L</div>
                <div class="card-value" id="totalPnl">-</div>
                <div class="card-sub">Ger√ßekle≈üen: <span id="realizedPnl">-</span></div>
            </div>
            
            <div class="card">
                <div class="card-title">üìà Pozisyon</div>
                <div class="card-value neutral" id="snCount">-</div>
                <div class="card-sub">A√ßƒ±k pozisyon sayƒ±sƒ±</div>
            </div>
            
            <div class="card">
                <div class="card-title">üîÑ G√ºnl√ºk ƒ∞≈ülem</div>
                <div class="card-value neutral" id="dailyTrades">-</div>
                <div class="card-sub">Komisyon: <span id="dailyComm">-</span></div>
            </div>
            
            <div class="card">
                <div class="card-title">üìä Risksiz Faiz</div>
                <div class="card-value neutral" id="riskFree">-</div>
                <div class="card-sub">Yƒ±llƒ±k (TAHVIL-G)</div>
            </div>
        </div>
        
        <!-- B√ºt√ße -->
        <div class="section-title">üí≥ B√ºt√ße Durumu</div>
        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <div class="card-title">Vƒ∞OP Teminat</div>
                <div class="card-value neutral" id="viopBal">-</div>
                <div class="budget-bar"><div class="budget-fill viop" id="viopBar"></div></div>
                <div class="card-sub">Kullanƒ±lan: <span id="viopUsed">-</span></div>
            </div>
            
            <div class="card">
                <div class="card-title">Spot Bakiye</div>
                <div class="card-value neutral" id="spotBal">-</div>
                <div class="budget-bar"><div class="budget-fill spot" id="spotBar"></div></div>
                <div class="card-sub">Kullanƒ±lan: <span id="spotUsed">-</span></div>
            </div>
        </div>
        
        <!-- Pozisyonlar -->
        <div class="card">
            <div class="card-title">üìã A√ßƒ±k Pozisyonlar</div>
            <table class="positions-table">
                <thead>
                    <tr>
                        <th>Sembol</th>
                        <th>Spot Adet</th>
                        <th>Near Adet</th>
                        <th>Anlƒ±k P&L</th>
                        <th>Beklenen</th>
                        <th>G√ºn</th>
                    </tr>
                </thead>
                <tbody id="snPositions">
                    <tr><td colspan="6" class="no-data">Veri bekleniyor...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="refresh-info">
            Son g√ºncelleme: <span id="lastUpdate">-</span> | Robot saati: <span id="robotTime">-</span>
        </div>
        
        <div class="footer">
            Bƒ∞ST Spot-Near Arbitraj Robot Dashboard | Gist √ºzerinden otomatik g√ºncelleme
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const GIST_ID = urlParams.get('gist');
        
        if (!GIST_ID) {
            document.body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;color:#fff;">
                    <h2>‚ö†Ô∏è Gist ID Gerekli</h2>
                    <p style="color:#888;margin-top:10px;">Kullanƒ±m: <code style="background:#333;padding:5px 10px;border-radius:4px;">index.html?gist=GIST_ID</code></p>
                    <p style="color:#666;margin-top:20px;font-size:0.9rem;">Gist ID'nizi GitHub Gist sayfasƒ±ndan alabilirsiniz.</p>
                </div>
            `;
            throw new Error('Gist ID not provided');
        }
        
        const GIST_RAW_URL = `https://gist.githubusercontent.com/raw/${GIST_ID}/arb_stats.json`;
        
        function formatNumber(n) {
            if (n === undefined || n === null) return '-';
            return n.toLocaleString('tr-TR', { maximumFractionDigits: 0 });
        }
        
        function formatPnl(n) {
            if (n === undefined || n === null) return '-';
            const formatted = formatNumber(Math.abs(n));
            return (n >= 0 ? '+' : '-') + formatted + ' TL';
        }
        
        function updatePeriodCard(prefix, data) {
            if (!data) return;
            
            const pnlEl = document.getElementById(prefix + 'Pnl');
            const pnl = data.pnl || 0;
            pnlEl.textContent = formatPnl(pnl);
            pnlEl.className = 'card-value ' + (pnl >= 0 ? 'positive' : 'negative');
            
            document.getElementById(prefix + 'Comm').textContent = formatNumber(data.comm) + ' TL';
            document.getElementById(prefix + 'Trades').textContent = data.trades || 0;
            document.getElementById(prefix + 'Days').textContent = data.days || 0;
        }
        
        function updateDashboard(data) {
            // Broker status
            const brokerEl = document.getElementById('brokerStatus');
            const brokerPulse = document.getElementById('brokerPulse');
            const brokerText = document.getElementById('brokerText');
            
            if (data.broker !== false) {
                brokerEl.className = 'status-indicator online';
                brokerPulse.className = 'pulse green';
                brokerText.textContent = 'Broker ‚úì';
            } else {
                brokerEl.className = 'status-indicator offline';
                brokerPulse.className = 'pulse red';
                brokerText.textContent = 'Broker ‚úó';
            }
            
            // Market status
            const marketEl = document.getElementById('marketStatus');
            const marketPulse = document.getElementById('marketPulse');
            const marketText = document.getElementById('marketText');
            
            if (data.market) {
                marketEl.className = 'status-indicator online';
                marketPulse.className = 'pulse green';
                marketText.textContent = 'Piyasa A√ßƒ±k';
            } else {
                marketEl.className = 'status-indicator offline';
                marketPulse.className = 'pulse red';
                marketText.textContent = 'Piyasa Kapalƒ±';
            }
            
            // Test mode
            const modeEl = document.getElementById('modeStatus');
            const modeText = document.getElementById('modeText');
            if (data.test) {
                modeEl.className = 'status-indicator test';
                modeText.textContent = 'üß™ TEST';
            } else {
                modeEl.className = 'status-indicator online';
                modeText.textContent = 'üöÄ CANLI';
            }
            
            // Period stats
            updatePeriodCard('week', data.week);
            updatePeriodCard('month', data.month);
            updatePeriodCard('all', data.all);
            
            // Daily PnL
            const totalPnl = data.total_pnl || 0;
            const totalEl = document.getElementById('totalPnl');
            totalEl.textContent = formatPnl(totalPnl);
            totalEl.className = 'card-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
            
            document.getElementById('realizedPnl').textContent = formatPnl(data.daily_pnl);
            
            // Positions count
            document.getElementById('snCount').textContent = data.count || 0;
            
            // Daily trades
            document.getElementById('dailyTrades').textContent = data.trades || 0;
            document.getElementById('dailyComm').textContent = formatNumber(data.total_comm) + ' TL';
            
            // Risk free
            document.getElementById('riskFree').textContent = '%' + (data.risk_free ? (data.risk_free * 100).toFixed(2) : '0.00');
            
            // Budget
            const viopUsed = data.viop_used || 0;
            const viopBal = data.viop_bal || 0;
            const viopTotal = viopUsed + viopBal;
            const viopPct = viopTotal > 0 ? (viopUsed / viopTotal) * 100 : 0;
            document.getElementById('viopBal').textContent = formatNumber(viopBal) + ' TL';
            document.getElementById('viopUsed').textContent = formatNumber(viopUsed) + ' TL';
            document.getElementById('viopBar').style.width = Math.min(viopPct, 100) + '%';
            
            const spotUsed = data.spot_used || 0;
            const spotBal = data.spot_bal || 0;
            const spotTotal = spotUsed + spotBal;
            const spotPct = spotTotal > 0 ? (spotUsed / spotTotal) * 100 : 0;
            document.getElementById('spotBal').textContent = formatNumber(spotBal) + ' TL';
            document.getElementById('spotUsed').textContent = formatNumber(spotUsed) + ' TL';
            document.getElementById('spotBar').style.width = Math.min(spotPct, 100) + '%';
            
            // Positions table
            const snTbody = document.getElementById('snPositions');
            const snData = data.positions || {};
            const snKeys = Object.keys(snData);
            
            if (snKeys.length === 0) {
                snTbody.innerHTML = '<tr><td colspan="6" class="no-data">A√ßƒ±k pozisyon yok</td></tr>';
            } else {
                let html = '';
                snKeys.forEach(sym => {
                    const p = snData[sym];
                    const pnl = p.pnl || 0;
                    const exp = p.exp || 0;
                    const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                    const expClass = exp >= 0 ? 'pnl-positive' : 'pnl-negative';
                    html += `<tr>
                        <td><strong>${sym}</strong></td>
                        <td>${p.sq || '-'}</td>
                        <td>${p.nq || '-'}</td>
                        <td class="${pnlClass}">${formatPnl(pnl)}</td>
                        <td class="${expClass}">${formatPnl(exp)}</td>
                        <td>${p.d || '-'}</td>
                    </tr>`;
                });
                snTbody.innerHTML = html;
            }
            
            // Timestamps
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('tr-TR');
            document.getElementById('robotTime').textContent = data.ts || '-';
        }
        
        async function fetchData() {
            try {
                const url = GIST_RAW_URL + '?t=' + Date.now();
                const response = await fetch(url);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                updateDashboard(data);
            } catch (err) {
                console.error('Veri alƒ±namadƒ±:', err);
                document.getElementById('marketText').textContent = 'Baƒülantƒ± Hatasƒ±';
                document.getElementById('marketStatus').className = 'status-indicator offline';
            }
        }
        
        fetchData();
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
