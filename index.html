<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitraj Robot v13 - Spot-Near Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .version { color: #888; font-size: 0.9rem; }
        
        .status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .status-indicator.online { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .status-indicator.offline { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        .status-indicator.test { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .pulse {
            width: 10px; height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .pulse.green { background: #00ff88; }
        .pulse.red { background: #ff4444; }
        .pulse.yellow { background: #ffc107; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .card-value.positive { color: #00ff88; }
        .card-value.negative { color: #ff4444; }
        .card-value.neutral { color: #00d4ff; }
        .card-sub { font-size: 0.85rem; color: #666; margin-top: 5px; }
        
        .budget-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .budget-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .budget-fill.viop { background: linear-gradient(90deg, #00d4ff, #0099cc); }
        .budget-fill.spot { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        
        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .positions-table th {
            text-align: left;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }
        .positions-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .positions-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .pnl-positive { color: #00ff88; }
        .pnl-negative { color: #ff4444; }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.85rem;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .refresh-info {
            font-size: 0.75rem;
            color: #555;
            text-align: right;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .card-value { font-size: 1.5rem; }
            header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <div class="logo">üìä Arbitraj Robot</div>
                <div class="version">v13 - Spot-Near Only</div>
            </div>
            <div class="status-bar">
                <div class="status-indicator" id="marketStatus">
                    <div class="pulse" id="marketPulse"></div>
                    <span id="marketText">Y√ºkleniyor...</span>
                </div>
                <div class="status-indicator" id="modeStatus">
                    <span id="modeText">-</span>
                </div>
            </div>
        </header>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">üí∞ Toplam P&L</div>
                <div class="card-value" id="totalPnl">-</div>
                <div class="card-sub">Ger√ßekle≈üen: <span id="realizedPnl">-</span></div>
            </div>
            
            <div class="card">
                <div class="card-title">üìà Spot-Near Pozisyon</div>
                <div class="card-value neutral" id="snCount">-</div>
                <div class="card-sub">A√ßƒ±k pozisyon sayƒ±sƒ±</div>
            </div>
            
            <div class="card">
                <div class="card-title">üîÑ G√ºnl√ºk ƒ∞≈ülem</div>
                <div class="card-value neutral" id="dailyTrades">-</div>
                <div class="card-sub">Komisyon: <span id="dailyComm">-</span></div>
            </div>
            
            <div class="card">
                <div class="card-title">üí≥ VIOP B√ºt√ße</div>
                <div class="card-value neutral" id="viopUsed">-</div>
                <div class="budget-bar"><div class="budget-fill viop" id="viopBar"></div></div>
                <div class="card-sub" id="viopSub">- / -</div>
            </div>
            
            <div class="card">
                <div class="card-title">üíµ Spot B√ºt√ße</div>
                <div class="card-value neutral" id="spotUsed">-</div>
                <div class="budget-bar"><div class="budget-fill spot" id="spotBar"></div></div>
                <div class="card-sub" id="spotSub">- / -</div>
            </div>
            
            <div class="card">
                <div class="card-title">üìä Risksiz Faiz</div>
                <div class="card-value neutral" id="riskFree">-</div>
                <div class="card-sub">Yƒ±llƒ±k (TAHVIL-G)</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">üìã Spot-Near Pozisyonlar</div>
            <table class="positions-table">
                <thead>
                    <tr>
                        <th>Sembol</th>
                        <th>Spot Adet</th>
                        <th>Near Adet</th>
                        <th>P&L</th>
                        <th>G√ºn</th>
                    </tr>
                </thead>
                <tbody id="snPositions">
                    <tr><td colspan="5" class="no-data">Veri bekleniyor...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="refresh-info">
            Son g√ºncelleme: <span id="lastUpdate">-</span>
        </div>
        
        <div class="footer">
            Bƒ∞ST Spot-Near Arbitraj Robot Dashboard | Gist √ºzerinden otomatik g√ºncelleme
        </div>
    </div>
    
    <script>
        // Gist URL'yi URL parametresinden al: index.html?gist=GIST_ID
        // √ñrnek: https://user.github.io/repo/index.html?gist=abc123def456
        const urlParams = new URLSearchParams(window.location.search);
        const GIST_ID = urlParams.get('gist');
        
        if (!GIST_ID) {
            document.body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;color:#fff;">
                    <h2>‚ö†Ô∏è Gist ID Gerekli</h2>
                    <p style="color:#888;margin-top:10px;">Kullanƒ±m: <code style="background:#333;padding:5px 10px;border-radius:4px;">index.html?gist=GIST_ID</code></p>
                    <p style="color:#666;margin-top:20px;font-size:0.9rem;">Gist ID'nizi GitHub Gist sayfasƒ±ndan alabilirsiniz.</p>
                </div>
            `;
            throw new Error('Gist ID not provided');
        }
        
        const GIST_RAW_URL = `https://gist.githubusercontent.com/raw/${GIST_ID}/arb_stats.json`;
        
        function formatNumber(n) {
            if (n === undefined || n === null) return '-';
            return n.toLocaleString('tr-TR', { maximumFractionDigits: 0 });
        }
        
        function formatPnl(n) {
            if (n === undefined || n === null) return '-';
            const formatted = formatNumber(Math.abs(n));
            return (n >= 0 ? '+' : '-') + formatted + ' TL';
        }
        
        function updateDashboard(data) {
            // Market status
            const marketEl = document.getElementById('marketStatus');
            const marketPulse = document.getElementById('marketPulse');
            const marketText = document.getElementById('marketText');
            
            if (data.market) {
                marketEl.className = 'status-indicator online';
                marketPulse.className = 'pulse green';
                marketText.textContent = 'Piyasa A√ßƒ±k';
            } else {
                marketEl.className = 'status-indicator offline';
                marketPulse.className = 'pulse red';
                marketText.textContent = 'Piyasa Kapalƒ±';
            }
            
            // Test mode
            const modeEl = document.getElementById('modeStatus');
            const modeText = document.getElementById('modeText');
            if (data.test) {
                modeEl.className = 'status-indicator test';
                modeText.textContent = 'üß™ TEST';
            } else {
                modeEl.className = 'status-indicator online';
                modeText.textContent = 'üöÄ CANLI';
            }
            
            // PnL
            const totalPnl = data.total_pnl || 0;
            const totalEl = document.getElementById('totalPnl');
            totalEl.textContent = formatPnl(totalPnl);
            totalEl.className = 'card-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
            
            document.getElementById('realizedPnl').textContent = formatPnl(data.daily_pnl);
            
            // Positions
            document.getElementById('snCount').textContent = data.count || 0;
            
            // Daily
            document.getElementById('dailyTrades').textContent = data.trades || 0;
            document.getElementById('dailyComm').textContent = formatNumber(data.total_comm || 0) + ' TL';
            
            // Budget - v13 uses viop_bal/spot_bal and viop_used/spot_used
            const viopUsed = data.viop_used || 0;
            const viopBal = data.viop_bal || 0;
            const viopTotal = viopUsed + viopBal;
            const viopPct = viopTotal > 0 ? (viopUsed / viopTotal) * 100 : 0;
            document.getElementById('viopUsed').textContent = formatNumber(viopBal) + ' TL';
            document.getElementById('viopBar').style.width = Math.min(viopPct, 100) + '%';
            document.getElementById('viopSub').textContent = formatNumber(viopUsed) + ' / ' + formatNumber(viopTotal);
            
            const spotUsed = data.spot_used || 0;
            const spotBal = data.spot_bal || 0;
            const spotTotal = spotUsed + spotBal;
            const spotPct = spotTotal > 0 ? (spotUsed / spotTotal) * 100 : 0;
            document.getElementById('spotUsed').textContent = formatNumber(spotBal) + ' TL';
            document.getElementById('spotBar').style.width = Math.min(spotPct, 100) + '%';
            document.getElementById('spotSub').textContent = formatNumber(spotUsed) + ' / ' + formatNumber(spotTotal);
            
            // Risk free - not in v13
            document.getElementById('riskFree').textContent = '%' + (data.risk_free ? (data.risk_free * 100).toFixed(2) : '0.00');
            
            // Spot-Near positions table - v13 uses "positions" with sq, nq, d
            const snTbody = document.getElementById('snPositions');
            const snData = data.positions || {};
            const snKeys = Object.keys(snData);
            
            if (snKeys.length === 0) {
                snTbody.innerHTML = '<tr><td colspan="5" class="no-data">A√ßƒ±k pozisyon yok</td></tr>';
            } else {
                let html = '';
                snKeys.forEach(sym => {
                    const p = snData[sym];
                    const pnlClass = (p.pnl || 0) >= 0 ? 'pnl-positive' : 'pnl-negative';
                    html += `<tr>
                        <td><strong>${sym}</strong></td>
                        <td>${p.sq || '-'}</td>
                        <td>${p.nq || '-'}</td>
                        <td class="${pnlClass}">${formatPnl(p.pnl)}</td>
                        <td>${p.d || '-'}</td>
                    </tr>`;
                });
                snTbody.innerHTML = html;
            }
            
            // Last update
            document.getElementById('lastUpdate').textContent = data.timestamp || new Date().toLocaleString('tr-TR');
        }
        
        async function fetchData() {
            try {
                // Cache buster
                const url = GIST_RAW_URL + '?t=' + Date.now();
                const response = await fetch(url);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                updateDashboard(data);
            } catch (err) {
                console.error('Veri alƒ±namadƒ±:', err);
                document.getElementById('marketText').textContent = 'Baƒülantƒ± Hatasƒ±';
                document.getElementById('marketStatus').className = 'status-indicator offline';
            }
        }
        
        // ƒ∞lk y√ºkleme
        fetchData();
        
        // Her 30 saniyede g√ºncelle
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
