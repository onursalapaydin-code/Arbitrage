// IdealData C# Arbitraj Robot - SPOT-NEAR + NEAR-FAR + PAIR TRADING
// === VERSÄ°YON: 2026-02-01 v19.4 ===
// 
// Ã–ZELLÄ°KLER:
// - Spot-Near arbitraj stratejisi + Rollover
// - Near-Far (NF) takvim spread stratejisi
// - Pair Trading (VIOP Near-Near kointegrasyon)
// - Piyasa kontrolÃ¼: Saat + XU030 hacim (tatil/yarÄ±m gÃ¼n tespiti)
// - Recovery sistemi (baÅŸlangÄ±Ã§, baÄŸlantÄ± kopmasÄ±, periyodik)
// - SubMarket 19220 filtresi (sadece pay vadeliler)
// - API optimizasyonu: Tek RefreshHesaplar fonksiyonu, sÄ±ra VIOPâ†’BIST sabit
// - Gist Dashboard entegrasyonu (uzaktan izleme ve STOP komutu)
// - Log klasÃ¶rÃ¼ ayrÄ±mÄ± (D:\arbit\logs\)
// - Gist credentials ayrÄ± dosya (gÃ¼venlik)
//
// DetaylÄ± deÄŸiÅŸiklik geÃ§miÅŸi iÃ§in: CHANGELOG.md

// ====================================
// DOSYA YOLLARI
// ====================================
var BASE_PATH = @"D:\arbit\";
var CACHE_PATH = @"D:\arbit\";  // RAMDisk iÃ§in Z:\ olarak deÄŸiÅŸtirilebilir (stats.json ve log iÃ§in)
var LOG_PATH = CACHE_PATH + @"logs\";  // CACHE_PATH kullanÄ±r
var STATS_FILE = CACHE_PATH + "stats.json";  // CACHE_PATH kullanÄ±r
var TEMINAT_FILE = BASE_PATH + "teminat.json";
var SETTINGS_FILE = BASE_PATH + "settings.json";
var GIST_CREDENTIALS_FILE = BASE_PATH + "gist_credentials.json";
var POSITIONS_FILE = BASE_PATH + "positions.json";
var TEMETTU_FILE = BASE_PATH + "Temettu.json";  // TemettÃ¼ verileri
var TEMETTU_SCRAPER = BASE_PATH + "Temettu_Scraper.py";  // TemettÃ¼ scraper
var SRM_FILE = BASE_PATH + "srm.json";  // Sermaye artÄ±rÄ±mÄ± verileri
var SRM_SCRAPER = BASE_PATH + "srm_scraper.py";  // Sermaye artÄ±rÄ±mÄ± scraper
// KullanÄ±lmayan eski deÄŸiÅŸkenler kaldÄ±rÄ±ldÄ± (SPREAD_CACHE_MAX_AGE_MIN, SN_BB_ENTRY, ATR)

// TemettÃ¼ verileri: {symbol: [{date, amount}, ...]}
var dividends = new System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<System.Tuple<DateTime, decimal>>>();
var lastTemettuCheck = DateTime.MinValue;  // Son temettÃ¼ kontrolÃ¼

// Sermaye artÄ±rÄ±mÄ± verileri: {symbol: date}
var sermayeArtirimlari = new System.Collections.Generic.Dictionary<string, DateTime>();
var lastSrmCheck = DateTime.MinValue;  // Son sermaye artÄ±rÄ±mÄ± kontrolÃ¼
var lastSrmCloseCheck = DateTime.MinValue;  // Son sermaye artÄ±rÄ±mÄ± kapatma kontrolÃ¼

var SPOT_PREFIX = "IMKBH'";
var FUTURES_PREFIX = "VIP'";
var ROBOT_NAME = "ArbBot";

// ====================================
// Ã‡ALIÅMA SAATLERÄ° (BÄ°ST) + HACÄ°M KONTROLÃœ
// ====================================
var MARKET_OPEN_HOUR = 10;
var MARKET_OPEN_MINUTE = 1;
var MARKET_CLOSE_HOUR = 18;
var MARKET_CLOSE_MINUTE = 9;
var BIST_CLOSE_HOUR = 18;      // BIST kapanÄ±ÅŸ saati (SN aÃ§Ä±lÄ±ÅŸÄ± iÃ§in)
var BIST_CLOSE_MINUTE = 0;     // BIST kapanÄ±ÅŸ dakikasÄ±
var ENTRY_WAIT_MINUTES = 5;    // Piyasa aÃ§Ä±lÄ±ÅŸÄ±ndan sonra giriÅŸ bekleme sÃ¼resi (temettÃ¼/volatilite korumasÄ±)
var lastXU030Volume = 0.0;
var lastVolumeCheckTime = DateTime.MinValue;
var isMarketOpen = false;

// ====================================
// FORWARD DECLARATIONS (Pair Trading'den Ã¶nce kullanÄ±lmasÄ± iÃ§in)
// ====================================

// BugÃ¼n temettÃ¼ gÃ¼nÃ¼ mÃ¼ kontrolÃ¼ (ex-dividend date)
Func<string, bool> IsDividendDay = (sym) => {
    if (!dividends.ContainsKey(sym)) return false;
    
    var today = DateTime.Now.Date;
    foreach (var div in dividends[sym]) {
        if (div.Item1.Date == today) {
            return true;
        }
    }
    return false;
};

// AÃ§Ä±lÄ±ÅŸ volatilitesi bekleme sÃ¼resi geÃ§ti mi kontrolÃ¼
Func<bool> IsAfterOpeningVolatility = () => {
    var now = DateTime.Now;
    var currentMinutes = now.Hour * 60 + now.Minute;
    var entryStartMinutes = MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE + ENTRY_WAIT_MINUTES;  // 10:05 (veya 10:06)
    return currentMinutes >= entryStartMinutes;
};

// Sermaye artÄ±rÄ±mÄ± durumunu kontrol et
// Returns: 0=GÃ¼venli, 1=BugÃ¼n(bloke), 2=7 gÃ¼n iÃ§inde(bloke)
Func<string, int> CheckSermayeArtirimi = (symbol) => {
    // SembolÃ¼ normalize et (THYAO, F_THYAO0226 -> THYAO)
    string normalizedSymbol = symbol.ToUpper();
    if (normalizedSymbol.StartsWith("F_")) {
        normalizedSymbol = normalizedSymbol.Substring(2);
        if (normalizedSymbol.Length > 4) {
            normalizedSymbol = normalizedSymbol.Substring(0, normalizedSymbol.Length - 4);
        }
    }
    
    if (!sermayeArtirimlari.ContainsKey(normalizedSymbol)) {
        return 0;  // GÃ¼venli - listede yok
    }
    
    DateTime saDate = sermayeArtirimlari[normalizedSymbol];
    int gunFarki = (saDate.Date - DateTime.Today).Days;
    
    if (gunFarki == 0) {
        return 1;  // BugÃ¼n
    } else if (gunFarki > 0 && gunFarki <= 7) {
        return 2;  // 7 gÃ¼n iÃ§inde
    }
    return 0;  // GeÃ§miÅŸ veya 7 gÃ¼nden uzak
};

// Sermaye artÄ±rÄ±mÄ± nedeniyle iÅŸlem blokeli mi?
// BugÃ¼n VEYA 7 gÃ¼n iÃ§inde ise TRUE dÃ¶ner
// NOT: Log fonksiyonu henÃ¼z tanÄ±mlÄ± olmadÄ±ÄŸÄ± iÃ§in burada log yok, Ã§aÄŸrÄ± noktasÄ±nda loglanÄ±r
Func<string, bool> IsSermayeArtirimiBlocked = (symbol) => {
    int status = CheckSermayeArtirimi(symbol);
    return status > 0;  // 1=BugÃ¼n, 2=7 gÃ¼n iÃ§inde â†’ blokeli
};

// ====================================
// KOMÄ°SYON VE VERGÄ°
// ====================================
var COMMISSION_RATE = 0.00009m;
var TAKASBANK_RATE = 0.000004m;
var TAX_RATE = 0.05m;

// SÃ¶zleÅŸme Ã§arpanÄ± - Sadece hisse (100x)
Func<string, int> GetMultiplier = (sym) => 100;

var TOTAL_COST_RATE = (COMMISSION_RATE + TAKASBANK_RATE) * (1 + TAX_RATE);
var SN_TOTAL_COST = TOTAL_COST_RATE * 4;

// ====================================
// RÄ°SK YÃ–NETÄ°MÄ°
// ====================================
var MAX_DAILY_LOSS = 10000m;
var REPLACEMENT_THRESHOLD = 0.10m;
var INTRADAY_MIN_PROFIT = 0.002m;  // GÃ¼n iÃ§i kar minimum (binde 2)

// Erken KapanÄ±ÅŸ Skor Sistemi
// Skor = (KÃ¢r OranÄ±) Ã— (Kalan SÃ¼re OranÄ±)
// Erken Ã§Ä±kÄ±ÅŸ iÃ§in dinamik k formÃ¼lÃ¼: earnedTarget = expectedPnl Ã— elapsedRatio Ã— (1 + k)
// k = EARLY_EXIT_K Ã— remainingRatio (vade sonuna yaklaÅŸtÄ±kÃ§a k dÃ¼ÅŸer)
var EARLY_EXIT_K = 0.20m;                  // Erken Ã§Ä±kÄ±ÅŸ k katsayÄ±sÄ± (0.20 = %20 marj baÅŸlangÄ±Ã§ta)
var BB_EXIT_HELPER = 30m;                  // BB5 Ã§Ä±kÄ±ÅŸ yardÄ±mcÄ± referansÄ± (altÄ±ndaysa Ã§Ä±k)

// BB93+ GiriÅŸ Stratejisi Parametreleri (Spot-Near)
var BB93_ENTRY_ENABLED = true;     // BB 93+ giriÅŸi aktif mi
var BB93_ENTRY_THRESHOLD = 93m;    // GiriÅŸ iÃ§in BB eÅŸiÄŸi
var BB93_EXIT_BB = 15m;            // Ã‡Ä±kÄ±ÅŸ iÃ§in BB eÅŸiÄŸi
var BB93_EXIT_SPREAD = 0.0023m;    // Ã‡Ä±kÄ±ÅŸ iÃ§in spread daralmasÄ± (%0.23)
var BB93_START_HOUR = 10;          // BB93 giriÅŸ baÅŸlangÄ±Ã§ saati
var BB93_START_MIN = 0;            // BB93 giriÅŸ baÅŸlangÄ±Ã§ dakikasÄ±
var BB93_END_HOUR = 12;            // BB93 giriÅŸ bitiÅŸ saati
var BB93_END_MIN = 55;             // BB93 giriÅŸ bitiÅŸ dakikasÄ±

// ====================================
// NEAR-FAR (NF) STRATEJÄ°SÄ° PARAMETRELERÄ°
// ====================================
// Near AL + Far SAT (takvim spread arbitrajÄ±)
var NF_ENABLED = true;             // Near-Far stratejisi aktif mi
var NF_MAX_POSITIONS = 1;          // Maksimum NF pozisyon sayÄ±sÄ± (ÅŸimdilik 1)
var NF_ENTRY_BB = 99m;             // GiriÅŸ iÃ§in BB eÅŸiÄŸi (>= 99)
var NF_EXIT_BB = 27m;              // Ã‡Ä±kÄ±ÅŸ iÃ§in BB eÅŸiÄŸi (<= 27)
var NF_EXIT_PROFIT = 0.003m;       // Ã‡Ä±kÄ±ÅŸ iÃ§in minimum kar (binde 3)
var NF_START_HOUR = 10;            // NF giriÅŸ baÅŸlangÄ±Ã§ saati
var NF_START_MIN = 0;              // NF giriÅŸ baÅŸlangÄ±Ã§ dakikasÄ±
var NF_END_HOUR = 12;              // NF giriÅŸ bitiÅŸ saati
var NF_END_MIN = 0;                // NF giriÅŸ bitiÅŸ dakikasÄ±
var NF_BUDGET = 0m;                // NF bÃ¼tÃ§esi (dinamik: en bÃ¼yÃ¼k teminat Ã— 2)

// ====================================
// PAIR TRADING PARAMETRELERÄ°
// ====================================
// VIOP Near-Near kointegrasyon arbitrajÄ±
var PAIR_ENABLED = true;           // Pair Trading aktif mi
var PAIR_BUDGET = 100000m;         // Pair Trading teminat bÃ¼tÃ§esi (SN/NF'den ayrÄ±)
var PAIR_MAX_TIERS = 3;            // Maksimum kademe sayÄ±sÄ±

// Z-Score eÅŸikleri (kademeli giriÅŸ)
var PAIR_Z_ENTRY_1 = 2.0m;         // Kademe 1 giriÅŸ
var PAIR_Z_ENTRY_2 = 2.5m;         // Kademe 2 giriÅŸ  
var PAIR_Z_ENTRY_3 = 3.0m;         // Kademe 3 giriÅŸ
var PAIR_Z_EXIT = 0.5m;            // Ã‡Ä±kÄ±ÅŸ eÅŸiÄŸi

// Kademe bÃ¼tÃ§e daÄŸÄ±lÄ±mÄ± (toplam %100 olmalÄ±)
var PAIR_ALLOC_1 = 30;             // Kademe 1 bÃ¼tÃ§e yÃ¼zdesi
var PAIR_ALLOC_2 = 30;             // Kademe 2 bÃ¼tÃ§e yÃ¼zdesi
var PAIR_ALLOC_3 = 40;             // Kademe 3 bÃ¼tÃ§e yÃ¼zdesi

// Beta oran sapma toleransÄ± (Recovery'de dÃ¼zeltme eÅŸiÄŸi)
var PAIR_RATIO_TOLERANCE = 0.10m;  // %10 sapma toleransÄ± (Ã¶nceden %15'ti)

// Pair Ã§alÄ±ÅŸma saatleri
var PAIR_START_HOUR = 10;
var PAIR_START_MIN = 5;
var PAIR_END_HOUR = 17;
var PAIR_END_MIN = 59;

// Margin Call Seviyeleri (kullanÄ±labilir teminat / toplam teminat)
var MARGIN_WARNING_PCT = 0.10m;   // SarÄ± uyarÄ±: <%10 kullanÄ±labilir
var MARGIN_DANGER_PCT = 0.05m;    // Turuncu tehlike: <%5 kullanÄ±labilir
var MARGIN_CRITICAL_PCT = 0.00m;  // KÄ±rmÄ±zÄ± kritik: %0 (teminat tÃ¼kendi)

// Devre Kesici KorumasÄ±
var SPOT_CIRCUIT_PCT = -8.0m;     // Spot %8 dÃ¼ÅŸÃ¼ÅŸ = devre kesici
var INDEX_CIRCUIT_PCT = -5.0m;   // BIST100 %5 dÃ¼ÅŸÃ¼ÅŸ = endeks devre kesici

// ====================================
// TEKNÄ°K PARAMETRELER
// ====================================
var MAX_LOG_LINES = 1000;  // RAMDisk iÃ§in satÄ±r limiti (truncate)
var LOOP_MS = 2000;
var BB_PERIOD = 20;
var GIE_WAIT_MS = 3000;
var GIE_DEPTH_LEVELS = 1;  // GIE iÃ§in kaÃ§ kademe derinlik kontrol edilsin (1 veya 2)
var COOLDOWN = 600000000L;
var GIST_TOKEN = "";
var GIST_ID = "";
var lastGistUpload = DateTime.MinValue;
var GIST_INTERVAL_MIN = 1;
var gistUploadInProgress = false;  // Async upload devam ediyor mu
var gistUploadThread = (System.Threading.Thread)null;  // Gist upload thread'i

// ====================================
// Ã‡ALIÅMA PARAMETRELERÄ°
// ====================================
var IS_TEST = false;
var VIOP_BUDGET = 70000m;
var SPOT_BUDGET = 490000m;
var VIOP_RESERVE = 25000m;  // Near kapatma iÃ§in geÃ§ici teminat rezervi (dinamik gÃ¼ncellenir)
var SPOT_RESERVE = 0m;      // Kredi olarak kullanÄ±labilir SPOT rezervi (dinamik: t2Balance - 5000)
var SPOT_BUDGET_RESERVE = 0m;  // BÃ¼tÃ§e yeterlilik iÃ§in SPOT rezervi (dinamik: maxSpotPrice Ã— 50)
// SN_BB_ENTRY kaldÄ±rÄ±ldÄ± - gÃ¼nlÃ¼k BB kontrolÃ¼ analiz sonucu iÅŸe yaramÄ±yor
var SN_MIN_MARGIN = -0.02m;
var ROLL_MIN_MARGIN = 0.005m;  // Rollover iÃ§in minimum kar marjÄ± (%0.5)
var RISK_FREE = 0.50m;

// Bakiye deÄŸiÅŸkenleri (test vs gerÃ§ek mod)
var viopBalance = 0m;  // KullanÄ±labilir VÄ°OP teminatÄ±
var spotBalance = 0m;  // KullanÄ±labilir SPOT bakiyesi (yeni poz aÃ§mak iÃ§in)
var spotBudgetTotal = 0m;  // Toplam SPOT bÃ¼tÃ§e (dashboard iÃ§in: spotUsed + t2Balance)
var t2Balance = 0m;    // T+2 bakiye (canlÄ± mod iÃ§in)
var apiDataOk = false; // API verisi geldi mi? (canlÄ±da false ise hiÃ§ iÅŸlem yapma)
var t2NegativeDetected = false;  // T+2 negatif tespit edildi mi?
var t2NegativeTime = DateTime.MinValue;  // Ä°lk tespit zamanÄ±
var t2CriticalAlert = false;  // T+2 kritik uyarÄ± (17:00 sonrasÄ± hala negatifse)

// ====================================
// API CACHE SÄ°STEMÄ°
// ====================================
// TÃ¼m API Ã§aÄŸrÄ±larÄ± RefreshHesaplar Ã¼zerinden geÃ§er (sÄ±ra: VIOP â†’ BIST)
// Get fonksiyonlarÄ± sadece cache'den okur, API Ã§aÄŸÄ±rmaz
dynamic _bistHesap = null;
dynamic _viopHesap = null;

// Forward declarations
Action CheckPendingOrders = null;
Action CheckMarginStatus = null;
Func<string, DateTime, DateTime, System.Tuple<bool, decimal>> GetDividendsBetween = null;
var inMarginCheck = false;

// BIST hesap okuma (sadece cache'den, API Ã§aÄŸÄ±rmaz)
Func<dynamic> GetBistHesap = () => {
    return _bistHesap;
};

// VIOP hesap okuma (sadece cache'den, API Ã§aÄŸÄ±rmaz)
Func<dynamic> GetViopHesap = () => {
    return _viopHesap;
};

// Tek hesap yenileme fonksiyonu (sÄ±ra: VIOP â†’ BIST, her zaman aynÄ±)
// NOT: spotUsed henÃ¼z tanÄ±mlÄ± olmayabilir, bu yÃ¼zden try-catch iÃ§inde
Action<bool> RefreshHesaplar = (waitFirst) => {
    if (waitFirst) System.Threading.Thread.Sleep(2000);  // Emir teyidi iÃ§in bekleme
    try {
        _viopHesap = Sistem.ViopHesapOku();
    } catch { }
    System.Threading.Thread.Sleep(200);  // API gÃ¼venlik arasÄ±
    try {
        _bistHesap = Sistem.BistHesapOku();
        
        // T+2 hesapla (canlÄ± mod)
        if (!IS_TEST && _bistHesap != null && _bistHesap.Bakiye > 0 && _bistHesap.Pozisyonlar != null) {
            var bakiye = (decimal)_bistHesap.Bakiye;
            decimal totalHisseValue = 0;
            var allPricesOk = true;
            
            var pozList = _bistHesap.Pozisyonlar;
            for (int i = 0; i < pozList.Count; i++) {
                var sym = pozList[i].Symbol ?? "";
                // IMKBH' prefix'ini temizle
                if (sym.StartsWith("IMKBH'")) sym = sym.Substring(6);
                var lot = (int)pozList[i].Lot;
                if (lot > 0) {
                    decimal price = 0;
                    
                    // 1. Ã–nce LastPrice dene (gÃ¼ncel fiyat)
                    try { price = (decimal)pozList[i].LastPrice; } catch { }
                    
                    // 2. LastPrice yoksa Cost kullan (maliyet)
                    if (price <= 0) {
                        try { price = (decimal)pozList[i].Cost; } catch { }
                    }
                    
                    // 3. Piyasa aÃ§Ä±ksa SonFiyat dene
                    if (price <= 0 && isMarketOpen) {
                        try {
                            var livePrice = (decimal)Sistem.SonFiyat("IMKBH'" + sym);
                            if (livePrice > 0) price = livePrice;
                        } catch { }
                    }
                    
                    if (price > 0) {
                        totalHisseValue += price * lot;
                    } else {
                        allPricesOk = false;  // En az bir fiyat alÄ±namadÄ±
                    }
                }
            }
            
            // TÃ¼m fiyatlar alÄ±ndÄ±ysa T+2 gÃ¼ncelle
            if (allPricesOk && totalHisseValue > 0) {
                t2Balance = bakiye - totalHisseValue;
                // spotBalance = T+2 - SPOT_BUDGET_RESERVE (kullanÄ±labilir bakiye)
                spotBalance = t2Balance - SPOT_BUDGET_RESERVE;
                if (spotBalance < 0) spotBalance = 0;
                // SPOT_RESERVE = T+2 - 5000 (kredi olarak kullanÄ±labilir miktar)
                SPOT_RESERVE = t2Balance > 5000m ? t2Balance - 5000m : 0m;
                // spotBudgetTotal UpdateBalances'da gÃ¼ncellenir
            }
        }
    } catch { }
    System.Threading.Thread.Sleep(200);  // Sonraki Ã§aÄŸrÄ± iÃ§in gÃ¼venlik
    
    // Bekleyen emirleri kontrol et
    if (CheckPendingOrders != null) CheckPendingOrders();
};

// ====================================
// VERÄ° YAPILARI
// ====================================
var teminat = new System.Collections.Generic.Dictionary<string, decimal>();
var symbols = new System.Collections.Generic.List<string>();
var snBBPos = new System.Collections.Generic.Dictionary<string, decimal>();  // Sembol -> BB pozisyonu (0-100)

// Spot-Near: [spotQty, nearQty, spotEntry, nearEntry, entrySpread, expectedPnl, addCount, entryTicks]
//               0        1         2          3           4            5           6          7
var snPos = new System.Collections.Generic.Dictionary<string, decimal[]>();

var blockedSymbols = new System.Collections.Generic.Dictionary<string, string>();
var lastBlockReset = DateTime.Today;

var isPaused = false;
var stopRequested = false;
var isRunning = false;  // Robot Ã§alÄ±ÅŸÄ±yor mu (dashboard iÃ§in)
var settingsNeedReload = false;
System.Windows.Forms.Form mainForm = null;
System.Windows.Forms.Label lblStatus = null;
System.Windows.Forms.Label lblInfo = null;
System.Windows.Forms.Label lblLog = null;
System.Windows.Forms.Button btnPause = null;

var viopUsed = 0m;
var spotUsed = 0m;
var rejected = new System.Collections.Generic.Dictionary<string, long>();

// Near-Far pozisyonlarÄ±
// nfPos[sym] = [nearQty, farQty, nearEntry, farEntry, entrySpread, expectedPnl, entryTicks]
var nfPos = new System.Collections.Generic.Dictionary<string, decimal[]>();
var nfContracts = new System.Collections.Generic.Dictionary<string, string[]>();  // nfContracts[sym] = [nearC, farC]
var nfViopUsed = 0m;  // NF iÃ§in kullanÄ±lan VIOP teminatÄ±

// Yetim bacaklar (bir bacak doldu, diÄŸeri dolmadÄ±)
// orphanLegs[sym] = { filledLeg, filledCode, filledSide, filledQty, filledPrice, targetLeg, targetCode, targetSide, targetQty, timestamp }
// Ã–rnek: Near satÄ±ldÄ±, Spot alÄ±namadÄ± â†’ { "NEAR", "F_THYAO0126", "SELL", 2, 514.50, "SPOT", "THYAO", "BUY", 200, ticks }
var orphanLegs = new System.Collections.Generic.Dictionary<string, object[]>();

// ====================================
// PAIR TRADING DEÄÄ°ÅKENLERÄ°
// ====================================
// Ã‡ift tanÄ±mlarÄ± string formatÄ±: "SYMB_A-SYMB_B:BETA,SYMB_C-SYMB_D:BETA"
// Ã–rnek: "TCELL-TTKOM:1.80,CIMSA-OYAKC:2.03"
var PAIR_DEFINITIONS = "TCELL-TTKOM:1.80,CIMSA-OYAKC:2.03";

// Parse edilmiÅŸ Ã§ift tanÄ±mlarÄ±: {symA, symB, beta}
var PAIR_DEFS = new System.Collections.Generic.List<object[]>();

// YasaklÄ± semboller (SN/NF'den hariÃ§) - dinamik gÃ¼ncellenir
var PAIR_BLOCKED = new System.Collections.Generic.HashSet<string>();

// Pair pozisyonlarÄ±: {pairKey: [qtyA, qtyB, avgA, avgB, openZ, tier, entryTicks, expectedPnl]}
var pairPos = new System.Collections.Generic.Dictionary<string, decimal[]>();

// Pair kontratlarÄ±: {pairKey: [nearA, nearB]} - Rollover iÃ§in kontrat takibi
var pairContracts = new System.Collections.Generic.Dictionary<string, string[]>();

// Pair spread geÃ§miÅŸi (gÃ¼nlÃ¼k): {pairKey: List<spread>}
var pairSpreads = new System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<decimal>>();

// Pair Z-Score cache
var pairZScores = new System.Collections.Generic.Dictionary<string, decimal>();

// Pair kullanÄ±lan teminat
var pairUsed = 0m;

// Pair istatistikleri
var totalClosedPair = 0;
var dailyPairPnl = 0m;
var lastPairDataLoad = DateTime.MinValue;

// Pair Pending Completion (tek bacak aÃ§Ä±k kalmÄ±ÅŸ, ikinci bacak bekliyor)
// {pairKey: [pairIdx, tier, isLongA, contractOffset, filledLeg(A/B), filledSide, filledQty, filledPrice, filledContract, timestamp, retryCount]}
var pairPendingCompletion = new System.Collections.Generic.Dictionary<string, object[]>();
var PAIR_PENDING_WAIT_SEC = 30;    // Ä°kinci bacak iÃ§in bekleme sÃ¼resi (saniye)
var PAIR_PENDING_MAX_RETRY = 2;    // Maksimum tekrar deneme sayÄ±sÄ±

// Tavan/Taban fiyatlarÄ± (warmup'ta yÃ¼klenir)
var tavanFiyat = new System.Collections.Generic.Dictionary<string, decimal>();  // Sembol -> Tavan fiyat
var tabanFiyat = new System.Collections.Generic.Dictionary<string, decimal>();  // Sembol -> Taban fiyat

// Tavan/Taban kontrol fonksiyonlarÄ±
// TAVAN = SatÄ±cÄ± yok = AlÄ±ÅŸ fiyatÄ± tavana yapÄ±ÅŸÄ±k = ALINAMAZ
// TABAN = AlÄ±cÄ± yok = SatÄ±ÅŸ fiyatÄ± tabana yapÄ±ÅŸÄ±k = SATILAMAZ
Func<string, decimal, bool> IsTavan = (sembol, alisFiyat) => {
    if (!tavanFiyat.ContainsKey(sembol) || tavanFiyat[sembol] <= 0) return false;
    return alisFiyat >= tavanFiyat[sembol];
};

Func<string, decimal, bool> IsTaban = (sembol, satisFiyat) => {
    if (!tabanFiyat.ContainsKey(sembol) || tabanFiyat[sembol] <= 0) return false;
    return satisFiyat <= tabanFiyat[sembol];
};

// Spot iÅŸlem sonrasÄ± T+2 gÃ¼ncelleme (API beklemeden)
// amount: pozitif = alÄ±ÅŸ (T+2 azalÄ±r), negatif = satÄ±ÅŸ (T+2 artar)
// commission: her zaman pozitif, T+2'den dÃ¼ÅŸÃ¼lÃ¼r
Action<decimal, decimal> AdjustT2Balance = (amount, commission) => {
    if (IS_TEST) return;  // Test modunda gerek yok
    
    // AlÄ±ÅŸ: T+2 azalÄ±r (para Ã§Ä±kÄ±ÅŸÄ±)
    // SatÄ±ÅŸ: T+2 artar (para giriÅŸi)
    t2Balance -= amount;
    t2Balance -= commission;  // Komisyon her zaman dÃ¼ÅŸer
    
    // spotBalance ve spotBudgetTotal gÃ¼ncelle (SPOT_BUDGET_RESERVE dÃ¼ÅŸÃ¼lÃ¼r)
    spotBalance = t2Balance - SPOT_BUDGET_RESERVE;
    if (spotBalance < 0) spotBalance = 0;
    spotBudgetTotal = spotUsed + t2Balance;
    
    // SPOT_RESERVE = T+2 - 5000 (kredi olarak kullanÄ±labilir miktar)
    SPOT_RESERVE = t2Balance > 5000m ? t2Balance - 5000m : 0m;
};

// VIOP iÅŸlem sonrasÄ± teminat gÃ¼ncelleme (API beklemeden)
// teminatChange: pozitif = teminat kullanÄ±ldÄ± (azalÄ±r), negatif = teminat serbest (artar)
Action<decimal> AdjustViopBalance = (teminatChange) => {
    if (IS_TEST) {
        // Test modunda da gÃ¼ncelle
        viopBalance = VIOP_BUDGET - viopUsed - VIOP_RESERVE;
        if (viopBalance < 0) viopBalance = 0;
    } else {
        // CanlÄ±da anlÄ±k gÃ¼ncelle
        viopBalance -= teminatChange;
        if (viopBalance < 0) viopBalance = 0;
    }
};

var dailyRealizedPnl = 0m;
var dailyTrades = 0;
var dailySpotCommission = 0m;   // SPOT iÅŸlem komisyonlarÄ±
var dailyViopCommission = 0m;   // VÄ°OP iÅŸlem komisyonlarÄ± (henÃ¼z transfer edilmemiÅŸ)
var totalTransferredComm = 0m;  // SPOT'a transfer edilmiÅŸ toplam VÄ°OP komisyonu
var lastCommissionTransfer = DateTime.MinValue;  // Son komisyon transfer zamanÄ±

// GÃ¼nlÃ¼k kapanÄ±ÅŸ takibi
var dailySNPnl = 0m;            // GÃ¼nlÃ¼k Spot-Near kar/zarar
var totalClosedSN = 0;          // GÃ¼nlÃ¼k kapatÄ±lan SN pozisyon sayÄ±sÄ±
var lastStatsSaveDate = "";     // Son stats kayÄ±t tarihi

// Stats history dosyasÄ±
var STATS_HISTORY_FILE = BASE_PATH + "stats_history.json";

var brokerConnected = true;     // AracÄ± kurum baÄŸlantÄ±sÄ±
var dataConnected = true;       // IdealData veri baÄŸlantÄ±sÄ±
var lastBrokerCheck = DateTime.MinValue;  // Son baÄŸlantÄ± kontrol zamanÄ±

// Margin durumu: 0=Normal, 1=Warning(sarÄ±), 2=Danger(turuncu), 3=Critical(kÄ±rmÄ±zÄ±)
var marginStatus = 0;
// inMarginCheck yukarÄ±da forward declaration olarak tanÄ±mlÄ±

// Devre kesici durumu
var indexCircuitBreaker = false;  // Endeks devre kesici aktif mi
var spotCircuitBreakers = new System.Collections.Generic.HashSet<string>();  // Devre kesici aktif semboller

// ====================================
// LOG FONKSÄ°YONU
// ====================================
var logLines = new System.Collections.Generic.List<string>();
var logPath = "";

Action<string> Log = (msg) => {
    var now = DateTime.Now;
    var line = now.ToString("HH:mm:ss.fff") + " " + msg;
    
    try {
        // Log klasÃ¶rÃ¼ yoksa oluÅŸtur
        if (!System.IO.Directory.Exists(LOG_PATH)) {
            System.IO.Directory.CreateDirectory(LOG_PATH);
        }
        
        // Sabit dosya adÄ± (tarihsiz - RAMDisk iÃ§in)
        var currentPath = LOG_PATH + "arb.log";
        
        // Ä°lk Ã§alÄ±ÅŸtÄ±rma veya path deÄŸiÅŸti - mevcut dosyayÄ± oku
        if (logPath != currentPath) {
            logPath = currentPath;
            logLines.Clear();
            if (System.IO.File.Exists(logPath)) {
                var existingLines = System.IO.File.ReadAllLines(logPath, System.Text.Encoding.UTF8);
                logLines.AddRange(existingLines);
            }
        }
        
        // Yeni satÄ±rÄ± ekle
        logLines.Add(line);
        
        // Limit aÅŸÄ±ldÄ±ysa eski satÄ±rlarÄ± sil (son 1000 satÄ±rÄ± tut)
        if (logLines.Count > MAX_LOG_LINES) {
            var removeCount = logLines.Count - MAX_LOG_LINES;
            logLines.RemoveRange(0, removeCount);
        }
        
        // Dosyaya yaz (her 10 satÄ±rda bir veya Ã¶nemli mesajlarda)
        // RAMDisk kullanÄ±ldÄ±ÄŸÄ± iÃ§in her satÄ±rda yaz
        if (msg.Contains("HATA") || msg.Contains("BAÅLADI") || msg.Contains("STOP") || msg.Contains("KAPAN") || msg.Contains("AÃ‡ILDI") || logLines.Count % 3 == 0) {
            // FileShare.ReadWrite ile yaz - diÄŸer process'ler okuyabilir
            try {
                var utf8 = new System.Text.UTF8Encoding(false);
                var content = string.Join(Environment.NewLine, logLines.ToArray());
                var bytes = utf8.GetBytes(content);
                using (var fs = new System.IO.FileStream(logPath, System.IO.FileMode.Create, System.IO.FileAccess.Write, System.IO.FileShare.ReadWrite)) {
                    fs.Write(bytes, 0, bytes.Length);
                }
            } catch { }  // Log yazma hatasÄ± robotu durdurmamalÄ±
        }
        
        // UI'da son 5 satÄ±rÄ± gÃ¶ster
        if (mainForm != null && lblLog != null && !mainForm.IsDisposed) {
            try {
                mainForm.BeginInvoke(new Action(() => {
                    try {
                        var startIdx = Math.Max(0, logLines.Count - 8);
                        var last8 = new System.Text.StringBuilder();
                        for (int i = startIdx; i < logLines.Count; i++) {
                            if (last8.Length > 0) last8.AppendLine();
                            // SatÄ±rÄ± kÄ±salt (max 100 karakter)
                            var ln = logLines[i];
                            if (ln.Length > 100) ln = ln.Substring(0, 97) + "...";
                            last8.Append(ln);
                        }
                        lblLog.Text = last8.ToString();
                    } catch { }
                }));
            } catch { }
        }
    } catch { }
};

// ====================================
// KONTRAT VE SEMBOL FONKSÄ°YONLARI
// ====================================
// Kontrat adÄ± hesaplama - Sadece aylÄ±k vade (hisse)
Func<string, int, string> GetContract = (sym, offset) => {
    var now = DateTime.Now;
    var m = now.Month + offset;
    var y = now.Year % 100;
    while (m > 12) { m -= 12; y++; }
    
    // AyÄ±n son iÅŸ gÃ¼nÃ¼nÃ¼ bul (vade tarihi)
    var fullYear = 2000 + y;
    var lastDay = new DateTime(fullYear, m, DateTime.DaysInMonth(fullYear, m));
    while (lastDay.DayOfWeek == DayOfWeek.Saturday || lastDay.DayOfWeek == DayOfWeek.Sunday) 
        lastDay = lastDay.AddDays(-1);
    
    // EÄŸer bugÃ¼n vade tarihinden sonraysa, bir sonraki aya geÃ§
    if (now.Date > lastDay.Date) {
        m++;
        if (m > 12) { m = 1; y++; }
    }
    
    return "F_" + sym + m.ToString("D2") + y.ToString("D2");
};

// Kontrat kodundan vade tarihini hesapla (ayÄ±n son iÅŸ gÃ¼nÃ¼)
Func<string, DateTime> GetExpiryDate = (contract) => {
    try {
        var l = contract.Length;
        var mm = int.Parse(contract.Substring(l - 4, 2));
        var yy = int.Parse(contract.Substring(l - 2, 2)) + 2000;
        var last = new DateTime(yy, mm, DateTime.DaysInMonth(yy, mm));
        while (last.DayOfWeek == DayOfWeek.Saturday || last.DayOfWeek == DayOfWeek.Sunday) 
            last = last.AddDays(-1);
        return last;
    } catch { 
        return DateTime.Now.AddDays(30); 
    }
};

Func<string, int> GetDays = (contract) => {
    try {
        // Ã–nce YÃ¼zeyselVeri'den DaysToExpiry al (en doÄŸru kaynak)
        var yuz = Sistem.YuzeyselVeriOku("VIP'" + contract);
        if (yuz != null) {
            var dte = (int)yuz.DaysToExpiry;
            if (dte >= 0) return dte;
        }
        // Fallback: Kontrat kodundan manuel hesapla
        var l = contract.Length;
        var mm = int.Parse(contract.Substring(l - 4, 2));
        var yy = int.Parse(contract.Substring(l - 2, 2)) + 2000;
        var last = new DateTime(yy, mm, DateTime.DaysInMonth(yy, mm));
        while (last.DayOfWeek == DayOfWeek.Saturday || last.DayOfWeek == DayOfWeek.Sunday) 
            last = last.AddDays(-1);
        return (int)(last - DateTime.Now).TotalDays;
    } catch { return 30; }
};

Func<string, int> GetHours = (contract) => {
    try {
        // Ã–nce YÃ¼zeyselVeri'den DaysToExpiry al ve saate Ã§evir
        var yuz = Sistem.YuzeyselVeriOku("VIP'" + contract);
        if (yuz != null) {
            var dte = (int)yuz.DaysToExpiry;
            if (dte >= 0) {
                // GÃ¼n sayÄ±sÄ±nÄ± saate Ã§evir (18:10 kapanÄ±ÅŸ varsayÄ±mÄ±)
                var now = DateTime.Now;
                var hoursToday = (18 * 60 + 10 - now.Hour * 60 - now.Minute) / 60.0;
                return (int)(dte * 24 + (hoursToday > 0 ? hoursToday : 0));
            }
        }
        // Fallback: Kontrat kodundan manuel hesapla
        var l = contract.Length;
        var mm = int.Parse(contract.Substring(l - 4, 2));
        var yy = int.Parse(contract.Substring(l - 2, 2)) + 2000;
        var last = new DateTime(yy, mm, DateTime.DaysInMonth(yy, mm), 18, 10, 0);
        while (last.DayOfWeek == DayOfWeek.Saturday || last.DayOfWeek == DayOfWeek.Sunday) 
            last = last.AddDays(-1);
        return (int)(last - DateTime.Now).TotalHours;
    } catch { return 720; }
};

// ====================================
// YARDIMCI FONKSÄ°YONLAR
// ====================================
// GÃ¼venli dosya yazma - FileShare.ReadWrite ile diÄŸer process'ler okuyabilir
Action<string, string> SafeWrite = (path, content) => {
    try {
        var tmp = path + ".tmp";
        var utf8 = new System.Text.UTF8Encoding(false);
        var bytes = utf8.GetBytes(content);
        
        // Temp dosyaya yaz (FileShare.Read - antivirus okuyabilir)
        using (var fs = new System.IO.FileStream(tmp, System.IO.FileMode.Create, System.IO.FileAccess.Write, System.IO.FileShare.Read)) {
            fs.Write(bytes, 0, bytes.Length);
        }
        
        // Atomic replace (3 deneme)
        for (int i = 0; i < 3; i++) {
            try {
                if (System.IO.File.Exists(path)) System.IO.File.Delete(path);
                System.IO.File.Move(tmp, path);
                break;
            } catch {
                if (i < 2) System.Threading.Thread.Sleep(100);
            }
        }
    } catch { }
};

// Piyasa kontrolÃ¼: Saat + XU030 hacim deÄŸiÅŸimi
// Tatil/yarÄ±m gÃ¼n iÃ§in hacim deÄŸiÅŸimi ÅŸart
Func<bool> CheckMarketOpen = () => {
    var now = DateTime.Now;
    
    // Hafta sonu kesin kapalÄ±
    if (now.DayOfWeek == DayOfWeek.Saturday || now.DayOfWeek == DayOfWeek.Sunday) return false;
    
    // Saat kontrolÃ¼ (10:01-18:09 dÄ±ÅŸÄ±nda kesin kapalÄ±)
    var currentMinutes = now.Hour * 60 + now.Minute;
    var openMinutes = MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE;
    var closeMinutes = MARKET_CLOSE_HOUR * 60 + MARKET_CLOSE_MINUTE;
    if (currentMinutes < openMinutes || currentMinutes > closeMinutes) return false;
    
    // Hacim kontrolÃ¼ (tatil/yarÄ±m gÃ¼n tespiti)
    try {
        var currentVolume = Sistem.HacimGun("IMKBX'XU030");
        
        // Ä°lk Ã§aÄŸrÄ± - hacmi kaydet
        if (lastXU030Volume == 0) {
            lastXU030Volume = currentVolume;
            lastVolumeCheckTime = now;
            return currentVolume > 0;  // Hacim varsa aÃ§Ä±k
        }
        
        // Hacim deÄŸiÅŸtiyse piyasa aÃ§Ä±k
        if (currentVolume > lastXU030Volume) {
            lastXU030Volume = currentVolume;
            lastVolumeCheckTime = now;
            return true;
        }
        
        // Hacim deÄŸiÅŸmediyse ama son 5 dakika iÃ§inde deÄŸiÅŸmiÅŸti â†’ hala aÃ§Ä±k say
        if ((now - lastVolumeCheckTime).TotalMinutes < 5) {
            return true;
        }
        
        // 5 dakikadan fazla hacim deÄŸiÅŸmedi â†’ piyasa kapalÄ± (tatil/arÄ±za)
        return false;
    } catch {
        return false;
    }
};

// Derinlik fonksiyonlarÄ±
Func<string, bool, int, decimal> Depth2x = (sym, buy, qty) => {
    try {
        var d = Sistem.DerinlikVerisiOku(sym);
        if (d == null) return 0;
        var total = 0;
        var arr = buy ? d.Asks : d.Bids;
        for (int i = 0; i < 5 && i < arr.Count; i++) {
            total += (int)arr[i].Size;
            if (total >= qty * 2) return (decimal)arr[i].Price;
        }
        return arr.Count > 0 ? (decimal)arr[arr.Count - 1].Price : 0;
    } catch { return 0; }
};

// Test modu iÃ§in: 2x derinliÄŸe kadar ortalama fiyat hesapla
Func<string, bool, int, decimal> DepthAvgPrice = (sym, buy, qty) => {
    try {
        var d = Sistem.DerinlikVerisiOku(sym);
        if (d == null) return 0;
        var arr = buy ? d.Asks : d.Bids;
        if (arr == null || arr.Count == 0) return 0;
        
        decimal totalValue = 0;
        int totalQty = 0;
        int targetQty = qty;  // Ä°stenen miktar
        
        for (int i = 0; i < arr.Count && totalQty < targetQty; i++) {
            var kademeFiyat = (decimal)arr[i].Price;
            var kademeMiktar = (int)arr[i].Size;
            var alQty = Math.Min(kademeMiktar, targetQty - totalQty);
            totalValue += kademeFiyat * alQty;
            totalQty += alQty;
        }
        
        return totalQty > 0 ? totalValue / totalQty : 0;
    } catch { return 0; }
};

// Bollinger Bands
Func<System.Collections.Generic.List<decimal>, System.Tuple<decimal, decimal, decimal>> CalcBB = (d) => {
    if (d == null || d.Count < BB_PERIOD) return System.Tuple.Create(0m, 0m, 0m);
    decimal sum = 0;
    for (int i = d.Count - BB_PERIOD; i < d.Count; i++) sum += d[i];
    var mid = sum / BB_PERIOD;
    decimal sq = 0;
    for (int i = d.Count - BB_PERIOD; i < d.Count; i++) { var x = d[i] - mid; sq += x * x; }
    var std = (decimal)Math.Sqrt((double)(sq / BB_PERIOD));
    return System.Tuple.Create(mid + 2 * std, mid, mid - 2 * std);
};

Func<decimal, decimal, decimal, decimal> BBPos = (v, u, l) => u == l ? 50 : ((v - l) / (u - l)) * 100;

// ====================================
// PAIR TRADING YARDIMCI FONKSÄ°YONLARI
// ====================================
// Pair key oluÅŸtur
Func<string, string, string> GetPairKey = (a, b) => a + "-" + b;

// PAIR_DEFINITIONS string'ini parse et
Action ParsePairDefinitions = () => {
    PAIR_DEFS.Clear();
    PAIR_BLOCKED.Clear();
    
    if (string.IsNullOrEmpty(PAIR_DEFINITIONS) || PAIR_DEFINITIONS.Trim().Length == 0) {
        Log("ğŸ“Š PAIR: TanÄ±m yok, strateji pasif");
        return;
    }
    
    foreach (var pair in PAIR_DEFINITIONS.Split(',')) {
        try {
            var parts = pair.Trim().Split(':');
            if (parts.Length != 2) continue;
            var syms = parts[0].Split('-');
            if (syms.Length != 2) continue;
            
            decimal beta;
            if (!decimal.TryParse(parts[1].Trim(), System.Globalization.NumberStyles.Any, 
                System.Globalization.CultureInfo.InvariantCulture, out beta)) continue;
            
            var symA = syms[0].Trim().ToUpper();
            var symB = syms[1].Trim().ToUpper();
            
            PAIR_DEFS.Add(new object[] { symA, symB, beta });
            PAIR_BLOCKED.Add(symA);
            PAIR_BLOCKED.Add(symB);
            
            Log("ğŸ“Š PAIR: " + symA + "-" + symB + " Î²=" + beta.ToString("F2") + " eklendi");
        } catch { }
    }
    
    if (PAIR_DEFS.Count == 0) {
        Log("ğŸ“Š PAIR: GeÃ§erli Ã§ift yok, strateji pasif");
    }
};

// BÃ¼tÃ§eden lot sayÄ±sÄ± hesapla (kademe bazlÄ±)
// Kademe 1: BÃ¼tÃ§enin %30'u, Kademe 2: %30'u, Kademe 3: %40'Ä±
Func<int, int, decimal, decimal, decimal, int[]> CalcPairLots = (pairIdx, tier, beta, priceA, priceB) => {
    // Kademe baÅŸÄ±na bÃ¼tÃ§e oranlarÄ±
    var tierBudgetPct = new decimal[] { PAIR_ALLOC_1 / 100m, PAIR_ALLOC_2 / 100m, PAIR_ALLOC_3 / 100m };
    if (tier < 0 || tier >= tierBudgetPct.Length) return new int[] { 0, 0 };
    
    var def = PAIR_DEFS[pairIdx];
    var symA = (string)def[0];
    var symB = (string)def[1];
    
    // Teminat deÄŸerleri
    var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
    var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
    
    // Bu kademe iÃ§in ayrÄ±lan bÃ¼tÃ§e
    var tierBudget = PAIR_BUDGET * tierBudgetPct[tier];
    
    // lotA Ã— temA + lotB Ã— temB = tierBudget
    // lotB = lotA Ã— beta (yaklaÅŸÄ±k)
    // lotA Ã— temA + lotA Ã— beta Ã— temB = tierBudget
    // lotA = tierBudget / (temA + beta Ã— temB)
    
    var denominator = temA + beta * temB;
    if (denominator <= 0) return new int[] { 0, 0 };
    
    var lotA = (int)Math.Floor(tierBudget / denominator);
    var lotB = (int)Math.Round(lotA * beta);
    
    // Minimum lot kontrolÃ¼
    if (lotA < 1 || lotB < 1) return new int[] { 0, 0 };
    
    return new int[] { lotA, lotB };
};

// Pair iÃ§in devre kesici kontrolÃ¼ (herhangi bir bacak)
// NOT: IsSpotCircuitBreaker henÃ¼z tanÄ±mlanmadÄ±ÄŸÄ± iÃ§in spotCircuitBreakers HashSet'ini doÄŸrudan kullanÄ±yoruz
Func<string, string, bool> IsPairCircuitBreaker = (symA, symB) => {
    return spotCircuitBreakers.Contains(symA) || spotCircuitBreakers.Contains(symB);
};

// Pair iÃ§in taban/tavan kontrolÃ¼
// isLongA: true = A alÄ±nacak (A tavanda mÄ±?), B satÄ±lacak (B tabanda mÄ±?)
// isLongA: false = A satÄ±lacak (A tabanda mÄ±?), B alÄ±nacak (B tavanda mÄ±?)
Func<string, string, bool, bool> IsPairLimitBlocked = (symA, symB, isLongA) => {
    try {
        // VIOP kontrat isimleri (Near)
        var nearA = GetContract(symA, 0);
        var nearB = GetContract(symB, 0);
        if (string.IsNullOrEmpty(nearA) || string.IsNullOrEmpty(nearB)) return false;
        
        // GÃ¼ncel fiyatlarÄ± al (doÄŸrudan DerinlikVerisiOku)
        decimal askA = 0, bidA = 0, askB = 0, bidB = 0;
        try {
            var depthA = Sistem.DerinlikVerisiOku("VIP'" + nearA);
            if (depthA != null && depthA.Length > 0) {
                askA = (decimal)depthA[0].SatisFiyat;
                bidA = (decimal)depthA[0].AlisFiyat;
            }
        } catch { }
        try {
            var depthB = Sistem.DerinlikVerisiOku("VIP'" + nearB);
            if (depthB != null && depthB.Length > 0) {
                askB = (decimal)depthB[0].SatisFiyat;
                bidB = (decimal)depthB[0].AlisFiyat;
            }
        } catch { }
        
        if (isLongA) {
            // A BUY (ask fiyatÄ±ndan) - A tavanda mÄ±?
            if (askA > 0 && IsTavan(nearA, askA)) {
                Log("âš ï¸ PAIR LIMIT: " + symA + " TAVANDA - BUY yapÄ±lamaz");
                return true;
            }
            // B SELL (bid fiyatÄ±ndan) - B tabanda mÄ±?
            if (bidB > 0 && IsTaban(nearB, bidB)) {
                Log("âš ï¸ PAIR LIMIT: " + symB + " TABANDA - SELL yapÄ±lamaz");
                return true;
            }
        } else {
            // A SELL (bid fiyatÄ±ndan) - A tabanda mÄ±?
            if (bidA > 0 && IsTaban(nearA, bidA)) {
                Log("âš ï¸ PAIR LIMIT: " + symA + " TABANDA - SELL yapÄ±lamaz");
                return true;
            }
            // B BUY (ask fiyatÄ±ndan) - B tavanda mÄ±?
            if (askB > 0 && IsTavan(nearB, askB)) {
                Log("âš ï¸ PAIR LIMIT: " + symB + " TAVANDA - BUY yapÄ±lamaz");
                return true;
            }
        }
        
        return false;
    } catch { return false; }
};

// Pair unrealized PnL hesapla
Func<string, decimal[], decimal> CalcPairUnrealizedPnl = (pairKey, pos) => {
    var parts = pairKey.Split('-');
    if (parts.Length != 2) return 0;
    
    var symA = parts[0];
    var symB = parts[1];
    var qtyA = (int)pos[0];
    var qtyB = (int)pos[1];
    var avgA = pos[2];
    var avgB = pos[3];
    var openZ = pos[4];
    
    // GÃ¼ncel fiyatlarÄ± al
    try {
        var yuzA = Sistem.YuzeyselVeriOku(SPOT_PREFIX + symA);
        var yuzB = Sistem.YuzeyselVeriOku(SPOT_PREFIX + symB);
        if (yuzA == null || yuzB == null) return 0;
        
        var priceA = (decimal)yuzA.LastPrice;
        var priceB = (decimal)yuzB.LastPrice;
        if (priceA <= 0 || priceB <= 0) return 0;
        
        var mult = GetMultiplier(symA);
        var isLongA = openZ < 0;
        
        decimal pnlA, pnlB;
        if (isLongA) {
            pnlA = (priceA - avgA) * qtyA * mult;
            pnlB = (avgB - priceB) * qtyB * mult;
        } else {
            pnlA = (avgA - priceA) * qtyA * mult;
            pnlB = (priceB - avgB) * qtyB * mult;
        }
        
        return pnlA + pnlB;
    } catch { return 0; }
};

// Z-Score hesapla (son 60 gÃ¼nlÃ¼k veriden)
Func<System.Collections.Generic.List<decimal>, decimal> CalcZScore = (spreads) => {
    if (spreads == null || spreads.Count < 20) return 0;
    
    var n = Math.Min(60, spreads.Count);
    var startIdx = spreads.Count - n;
    
    decimal sum = 0;
    for (int i = startIdx; i < spreads.Count; i++) sum += spreads[i];
    var mean = sum / n;
    
    decimal sumSq = 0;
    for (int i = startIdx; i < spreads.Count; i++) {
        var diff = spreads[i] - mean;
        sumSq += diff * diff;
    }
    var std = (decimal)Math.Sqrt((double)(sumSq / n));
    
    if (std == 0) return 0;
    return (spreads[spreads.Count - 1] - mean) / std;
};

// Komisyon hesaplama
Func<string, decimal, int, decimal> CalcCommission = (sym, price, qty) => {
    var mult = GetMultiplier(sym);
    var value = price * qty * mult;
    var comm = value * (COMMISSION_RATE + TAKASBANK_RATE);
    return comm + comm * TAX_RATE;
};

Func<decimal, int, decimal> CalcSpotCommission = (price, qty) => {
    var value = price * qty;
    var comm = value * (COMMISSION_RATE + TAKASBANK_RATE);
    return comm + comm * TAX_RATE;
};

// Dinamik eÅŸik
Func<int, decimal> SNThreshold = (daysN) => {
    var opp = RISK_FREE * daysN / 365m;
    return opp + SN_TOTAL_COST + SN_MIN_MARGIN;
};

// Sembol engelleme
Func<string, bool> IsBlocked = (sym) => {
    if (DateTime.Today > lastBlockReset) {
        blockedSymbols.Clear();
        lastBlockReset = DateTime.Today;
    }
    return blockedSymbols.ContainsKey(sym);
};

// Beklemede kalan emirler (nadir durum - izleme iÃ§in)
var pendingOrders = new System.Collections.Generic.Dictionary<string, object[]>();  
// sym_side -> [0:side, 1:originalQty, 2:price, 3:time, 4:orderNo, 5:isSpot, 6:symbol, 7:orderDate, 8:orderType, 9:session, 10:status, 11:processedQty]

// En kÃ¶tÃ¼ pozisyonu bul
Func<string, System.Collections.Generic.HashSet<string>, System.Tuple<string, decimal>> FindWorstSNPosition = (excludeSym, excludeSet) => {
    string worstSym = null;
    decimal worstSpread = decimal.MaxValue;  // En dÃ¼ÅŸÃ¼k giriÅŸ spread'i = en kÃ¶tÃ¼ pozisyon
    foreach (var kv in snPos) {
        if (kv.Key == excludeSym) continue;
        if (excludeSet != null && excludeSet.Contains(kv.Key)) continue;
        // Pending order olan sembolleri atla
        if (pendingOrders.ContainsKey(kv.Key + "_BUY") || pendingOrders.ContainsKey(kv.Key + "_SELL")) continue;
        var entrySpread = kv.Value[4];  // GiriÅŸ spread'i (vade sonu garantili getiri)
        if (entrySpread < worstSpread) { worstSpread = entrySpread; worstSym = kv.Key; }
    }
    return System.Tuple.Create(worstSym, worstSpread);
};

// ====================================
// MERKEZÄ° DERÄ°NLÄ°K OKUMA FONKSÄ°YONU
// ====================================
// Parametreler:
//   fullSym: Tam sembol (VIP'F_THYAO0126 veya IMKBH'THYAO gibi)
//   side: "BID" (satÄ±ÅŸ iÃ§in) veya "ASK" (alÄ±ÅŸ iÃ§in)
//   minQty: Minimum gereken miktar (0 ise sadece varlÄ±k kontrolÃ¼)
//   maxRetries: Derinlik 0 gelirse kaÃ§ kez tekrar denenecek (varsayÄ±lan 3)
//   retryDelayMs: Tekrar denemeler arasÄ± bekleme (varsayÄ±lan 100ms)
// DÃ¶nÃ¼ÅŸ: Tuple<success, level1Size, level2Size, level1Price, level2Price, totalSize>
Func<string, string, int, int, int, System.Tuple<bool, int, int, decimal, decimal, int>> ReadDepth = 
    (fullSym, side, minQty, maxRetries, retryDelayMs) => {
    
    var level1Size = 0;
    var level2Size = 0;
    var level1Price = 0m;
    var level2Price = 0m;
    var totalSize = 0;
    var success = false;
    
    for (int attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            dynamic depth = Sistem.DerinlikVerisiOku(fullSym);
            if (depth == null) {
                if (attempt < maxRetries) { System.Threading.Thread.Sleep(retryDelayMs); continue; }
                break;
            }
            
            var arr = (side == "BID") ? depth.Bids : depth.Asks;
            if (arr == null || arr.Count == 0) {
                if (attempt < maxRetries) { System.Threading.Thread.Sleep(retryDelayMs); continue; }
                break;
            }
            
            level1Size = (int)arr[0].Size;
            level1Price = (decimal)arr[0].Price;
            
            if (arr.Count > 1) {
                level2Size = (int)arr[1].Size;
                level2Price = (decimal)arr[1].Price;
            }
            
            totalSize = level1Size + level2Size;
            
            // 1. kademe > 0 ise baÅŸarÄ±lÄ±
            if (level1Size > 0) {
                success = true;
                break;
            }
            
            // 1. kademe 0 - tekrar dene
            if (attempt < maxRetries) { 
                System.Threading.Thread.Sleep(retryDelayMs); 
            }
        } catch {
            if (attempt < maxRetries) { System.Threading.Thread.Sleep(retryDelayMs); }
        }
    }
    
    // 3+ deneme sonunda hala 0 ise log (tarama dÃ¶ngÃ¼sÃ¼nde 1 deneme olduÄŸu iÃ§in log yok)
    if (!success && maxRetries > 1) {
        Log("âŒ " + fullSym + " " + side + " derinlik yok (" + maxRetries + " deneme)");
    }
    
    // minQty kontrolÃ¼
    if (success && minQty > 0 && level1Size < minQty) {
        success = false;
    }
    
    return System.Tuple.Create(success, level1Size, level2Size, level1Price, level2Price, totalSize);
};

// KÄ±sa kullanÄ±m iÃ§in overload benzeri wrapper'lar
Func<string, string, int, System.Tuple<bool, int, int, decimal, decimal, int>> ReadDepthSimple = 
    (fullSym, side, minQty) => ReadDepth(fullSym, side, minQty, 3, 100);

Func<string, string, System.Tuple<bool, int, int, decimal, decimal, int>> ReadDepthBasic = 
    (fullSym, side) => ReadDepth(fullSym, side, 0, 3, 100);

// ====================================
// EMÄ°R FONKSÄ°YONLARI
// ====================================
// Son emir no takibi
var lastOrderNo = "";

Func<string, string, int, decimal, bool> SendGIE = (contract, side, qty, price) => {
    // Miktar kontrolÃ¼
    if (qty <= 0) {
        Log("âš ï¸ SendGIE: " + contract + " miktar 0, emir atlanÄ±yor");
        return false;
    }
    
    try {
        // GÃ¶ndermeden Ã¶nce son OrderNo'yu kaydet
        try {
            var viopHesap = GetViopHesap();
            if (viopHesap != null && viopHesap.GerceklesenEmirler != null) {
                var emirList = viopHesap.GerceklesenEmirler;
                if (emirList.Count > 0) {
                    lastOrderNo = emirList[emirList.Count - 1].OrderNo ?? "";
                }
            }
        } catch { lastOrderNo = ""; }
        
        Sistem.EmirSembol = FUTURES_PREFIX + contract;
        Sistem.EmirIslem = side == "BUY" ? "ALIS" : "SATIS";
        Sistem.EmirMiktari = qty;
        Sistem.EmirSuresi = "GIE";
        Sistem.EmirTipi = "Limitli";
        Sistem.EmirFiyati = (double)price;
        Sistem.EmirGonder();
        return true;
    } catch { return false; }
};

Func<string, string, int, int> CheckFilledQty = (contract, side, qty) => {
    if (IS_TEST) return qty;  // Test modunda tam dolum
    
    var sym = FUTURES_PREFIX + contract;
    var yon = side == "BUY" ? "AlÄ±ÅŸ" : "SatÄ±ÅŸ";
    var now = DateTime.Now;
    
    for (int attempt = 1; attempt <= 2; attempt++) {
        try {
            RefreshHesaplar(true);  // Emir sonrasÄ± taze veri al
            var viopHesap = GetViopHesap();
            
            // Hesap null ise tekrar dene
            if (viopHesap == null) {
                Log("âš ï¸ CheckFilledQty: VIOP hesap null (deneme " + attempt + "/2)");
                continue;
            }
            
            // Hesap OK ama GerceklesenEmirler null/boÅŸ - gerÃ§ekleÅŸmedi
            if (viopHesap.GerceklesenEmirler == null) {
                Log("âš ï¸ CheckFilledQty: GerceklesenEmirler null");
                return 0;
            }
            
            var emirList = viopHesap.GerceklesenEmirler;
            
            // Son 5 saniye iÃ§indeki emirleri kontrol et
            var totalFilled = 0;
            for (int i = emirList.Count - 1; i >= 0; i--) {  // Sondan baÅŸla (en yeni)
                var e = emirList[i];
                var eSymbol = e.Symbol ?? "";
                var eBuySell = e.BuySell ?? "";
                var eAmount = (int)e.GAmount;
                
                // Emir zamanÄ±nÄ± kontrol et (varsa)
                DateTime emirTime = now;
                try {
                    if (e.Time != null) emirTime = (DateTime)e.Time;
                } catch { }
                
                var secondsAgo = (now - emirTime).TotalSeconds;
                
                // 5 saniyeden eski emirleri atla (sondan baÅŸladÄ±ÄŸÄ±mÄ±z iÃ§in dÃ¶ngÃ¼yÃ¼ kÄ±r)
                if (secondsAgo > 10) break;  // 10 saniye tolerans
                
                // Sembol ve yÃ¶n eÅŸleÅŸmesi
                if (eSymbol == sym && eBuySell == yon) {
                    totalFilled += eAmount;
                    Log("âœ“ Emir bulundu: " + eSymbol + " " + eBuySell + " x" + eAmount + " (" + secondsAgo.ToString("F1") + "sn Ã¶nce)");
                }
            }
            
            if (totalFilled > 0) {
                Log("âœ… CheckFilledQty: " + contract + " " + side + " toplam " + totalFilled + "/" + qty + " doldu");
            }
            
            // Beklenen miktardan fazla olamaz (eski emirler karÄ±ÅŸmasÄ±n)
            if (totalFilled > qty) totalFilled = qty;
            
            return totalFilled;
            
        } catch (Exception ex) { 
            Log("âŒ CheckFilledQty hata: " + ex.Message);
        }
    }
    
    // 2 denemede de hesap null - gÃ¼venli tarafta kal
    return 0;
};

// Geriye uyumluluk iÃ§in bool dÃ¶nen wrapper
Func<string, string, int, bool> CheckFilled = (contract, side, qty) => {
    return CheckFilledQty(contract, side, qty) >= qty;
};

// Forward declarations (kullanÄ±mdan Ã¶nce tanÄ±mlanmalÄ±)
Action SavePositions = null;
Action SyncAndRecoverPositions = null;
Action<string, string, int, int> RecoverMissingLeg = null;
Action SaveDailyStats = null;
var inRecovery = false;  // Sonsuz dÃ¶ngÃ¼ Ã¶nleme flag'i

// Forward declaration for ExecGuar (CheckPendingOrders iÃ§inde kullanÄ±lacak)
Func<string, string, int, System.Tuple<int, decimal>> ExecGuar = null;

// Bekleyen emirleri kontrol et - gerÃ§ekleÅŸti mi? KÄ±smi dolum da handle et
CheckPendingOrders = () => {
    if (pendingOrders.Count == 0) return;
    
    var toRemove = new System.Collections.Generic.List<string>();
    var toUpdate = new System.Collections.Generic.Dictionary<string, object[]>();
    
    foreach (var kv in pendingOrders) {
        try {
            var key = kv.Key;
            var data = kv.Value;
            var orderNo = (string)data[4];
            var isSpot = (bool)data[5];
            var entryTime = (DateTime)data[3];
            var originalQty = (int)data[1];
            var pendingPrice = (decimal)data[2];
            var side = (string)data[0];
            var fullSymbol = (string)data[6];
            var processedQty = data.Length > 11 ? (int)data[11] : 0;  // Daha Ã¶nce iÅŸlenen miktar
            
            // DoÄŸru hesabÄ± kontrol et
            dynamic hesap = isSpot ? _bistHesap : _viopHesap;
            if (hesap == null) continue;
            
            // GerceklesenEmirler'de OrderNo ara
            var found = false;
            var totalFilledQty = 0;
            var filledPrice = 0m;
            
            try {
                var emirList = hesap.GerceklesenEmirler;
                if (emirList != null) {
                    for (int i = emirList.Count - 1; i >= 0 && i >= emirList.Count - 20; i--) {
                        var e = emirList[i];
                        if ((e.OrderNo ?? "") == orderNo) {
                            found = true;
                            totalFilledQty = (int)e.GAmount;  // API'den toplam dolmuÅŸ
                            filledPrice = (decimal)e.Price;
                            break;
                        }
                    }
                }
            } catch { }
            
            // Bu sefer yeni dolmuÅŸ miktar
            var newFilledQty = totalFilledQty - processedQty;
            
            if (found && newFilledQty > 0) {
                // Base sembolÃ¼ Ã§Ä±kar (VIOP iÃ§in)
                var baseSym = "";
                if (!isSpot) {
                    try {
                        var idx = fullSymbol.IndexOf("F_");
                        if (idx >= 0) {
                            baseSym = fullSymbol.Substring(idx + 2);
                            if (baseSym.Length > 4) baseSym = baseSym.Substring(0, baseSym.Length - 4);
                        }
                    } catch { }
                } else {
                    try {
                        var idx = fullSymbol.IndexOf("'");
                        if (idx >= 0) baseSym = fullSymbol.Substring(idx + 1);
                        else baseSym = fullSymbol;
                    } catch { baseSym = fullSymbol; }
                }
                
                var isComplete = totalFilledQty >= originalQty;
                
                Log("âœ… BEKLEYEN EMÄ°R " + (isComplete ? "TAM " : "KISMÄ° ") + "GERÃ‡EKLEÅTÄ°: " + key + 
                    " OrderNo:" + orderNo + " Yeni:" + newFilledQty + " Toplam:" + totalFilledQty + "/" + originalQty + " @" + filledPrice.ToString("F2"));
                
                if (ExecGuar == null || string.IsNullOrEmpty(baseSym)) {
                    if (isComplete) toRemove.Add(key);
                    continue;
                }
                
                var mult = GetMultiplier(baseSym);
                
                // ========== NEAR BUY (KapanÄ±ÅŸ) - KarÅŸÄ±lÄ±ÄŸÄ± Spot SAT ==========
                if (!isSpot && side == "BUY") {
                    if (snPos.ContainsKey(baseSym)) {
                        var p = snPos[baseSym];
                        var spotToClose = (int)Math.Round((decimal)newFilledQty * mult);
                        var currentSpot = (int)p[0];
                        var currentNear = (int)p[1];
                        
                        if (spotToClose > currentSpot) spotToClose = currentSpot;
                        if (spotToClose > 0) {
                            Log("ğŸ“Š PENDING NEAR BUY: " + baseSym + " Near:" + newFilledQty + " -> Spot:" + spotToClose + " satÄ±lÄ±yor");
                            
                            var sr = ExecGuar(baseSym, "SELL", spotToClose);
                            if (sr.Item1 > 0) {
                                var spotPnl = (sr.Item2 - p[2]) * sr.Item1;
                                var nearPnl = (p[3] - filledPrice) * newFilledQty * mult;
                                var totalPnl = spotPnl + nearPnl;
                                var spotComm = CalcSpotCommission(sr.Item2, sr.Item1);
                                var nearComm = CalcCommission(baseSym, filledPrice, newFilledQty);
                                totalPnl -= (spotComm + nearComm);
                                
                                dailyRealizedPnl += totalPnl;
                                dailySpotCommission += spotComm;
                                dailyViopCommission += nearComm;
                                spotUsed -= sr.Item2 * sr.Item1;
                                if (spotUsed < 0) spotUsed = 0;
                                AdjustT2Balance(-(sr.Item2 * sr.Item1), spotComm);  // SatÄ±ÅŸ
                                var viopTeminat = teminat.ContainsKey(baseSym) ? teminat[baseSym] * newFilledQty : 0;
                                viopUsed -= viopTeminat;
                                if (viopUsed < 0) viopUsed = 0;
                                AdjustViopBalance(-viopTeminat);  // Teminat serbest
                                
                                Log("ğŸ’° PENDING P&L: Spot:" + spotPnl.ToString("F0") + " Near:" + nearPnl.ToString("F0") + " Toplam:" + totalPnl.ToString("F0") + " TL");
                                
                                var remainSpot = currentSpot - sr.Item1;
                                var remainNear = currentNear - newFilledQty;
                                
                                if (remainSpot <= 0 && remainNear <= 0) {
                                    snPos.Remove(baseSym);
                                    totalClosedSN++;
                                    Log("âœ… PENDING KAPANIÅ TAMAMLANDI: " + baseSym);
                                } else {
                                    var expPnlRatio = currentNear > 0 ? p[5] * remainNear / currentNear : 0;
                                    snPos[baseSym] = new decimal[] { remainSpot, remainNear, p[2], p[3], p[4], expPnlRatio, p[6], p[7] };
                                    Log("ğŸ“Š PENDING GÃœNCELLEME: " + baseSym + " Kalan S:" + remainSpot + " N:" + remainNear);
                                }
                                SavePositions();
                                if (SaveDailyStats != null) SaveDailyStats();
                            }
                        }
                    }
                    else if (orphanLegs.ContainsKey(baseSym)) {
                        // snPos'ta yok ama orphanLegs'te var - Near geri alÄ±mÄ± tamamlandÄ±
                        var orph = orphanLegs[baseSym];
                        if ((string)orph[0] == "NEAR" && (string)orph[2] == "SELL") {
                            var orphQty = (int)orph[3];
                            var orphPrice = (decimal)orph[4];
                            
                            // P&L hesapla: Near SELL @orphPrice, Near BUY @filledPrice
                            var nearPnl = (orphPrice - filledPrice) * newFilledQty * mult;
                            var nearComm = CalcCommission(baseSym, filledPrice, newFilledQty);
                            var totalPnl = nearPnl - nearComm;
                            
                            dailyRealizedPnl += totalPnl;
                            dailyViopCommission += nearComm;
                            
                            Log("ğŸ’° ORPHAN NEAR GERÄ° ALIM: " + baseSym + " @" + filledPrice.ToString("F2") + 
                                " (AÃ§Ä±lÄ±ÅŸ:" + orphPrice.ToString("F2") + ") P&L:" + totalPnl.ToString("F0") + " TL");
                            
                            // MiktarÄ± kontrol et
                            if (newFilledQty >= orphQty) {
                                orphanLegs.Remove(baseSym);
                                Log("ğŸ—‘ï¸ ORPHAN: " + baseSym + " orphanLegs'ten silindi (tam geri alÄ±m)");
                            } else {
                                // KÄ±smi geri alÄ±m
                                orph[3] = orphQty - newFilledQty;
                                orphanLegs[baseSym] = orph;
                                Log("ğŸ“Š ORPHAN: " + baseSym + " kalan miktar: " + (orphQty - newFilledQty));
                            }
                            SavePositions();
                            if (SaveDailyStats != null) SaveDailyStats();
                        }
                    }
                }
                // ========== NEAR SELL (AÃ§Ä±lÄ±ÅŸ) - KarÅŸÄ±lÄ±ÄŸÄ± Spot BUY ==========
                else if (!isSpot && side == "SELL") {
                    var spotToBuy = (int)Math.Round((decimal)newFilledQty * mult);
                    if (spotToBuy > 0) {
                        // AÃ‡ILIÅ VOLATÄ°LÄ°TESÄ° KORUMASI: 10:05'e kadar Spot aÃ§mayÄ± beklet
                        // Piyasa kapalÄ±yken veya aÃ§Ä±lÄ±ÅŸ volatilitesinde yanlÄ±ÅŸ fiyattan iÅŸlem Ã¶nlenir
                        var recoveryNow = DateTime.Now;
                        var recoveryMinutes = recoveryNow.Hour * 60 + recoveryNow.Minute;
                        var recoveryStartMinutes = MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE + 5;  // 10:05
                        
                        if (recoveryMinutes < recoveryStartMinutes) {
                            // 10:05'ten Ã¶nce - orphanLegs'e kaydet ve bekle
                            if (!orphanLegs.ContainsKey(baseSym)) {
                                orphanLegs[baseSym] = new object[] {
                                    "NEAR", fullSymbol, "SELL", newFilledQty, filledPrice,
                                    "SPOT", baseSym, "BUY", spotToBuy, DateTime.Now.Ticks
                                };
                                Log("â³ AÃ‡ILIÅ BEKLETMESÄ°: " + baseSym + " Near SELL x" + newFilledQty + " @" + filledPrice.ToString("F2") + 
                                    " - Spot BUY 10:05'te yapÄ±lacak");
                                SavePositions();
                            }
                            // Pending order'Ä± iÅŸlenmiÅŸ say ama silme (orphan'dan devam edecek)
                            data[11] = totalFilledQty;
                            toUpdate[key] = data;
                            continue;
                        }
                        
                        Log("ğŸ“Š PENDING NEAR SELL: " + baseSym + " Near:" + newFilledQty + " -> Spot:" + spotToBuy + " alÄ±nÄ±yor");
                        
                        var sr = ExecGuar(baseSym, "BUY", spotToBuy);
                        if (sr.Item1 > 0) {
                            var spotFilledQty = sr.Item1;
                            var spotAvgP = sr.Item2;
                            
                            if (snPos.ContainsKey(baseSym)) {
                                var p = snPos[baseSym];
                                var oldSQty = (int)p[0];
                                var oldNQty = (int)p[1];
                                var newSQty = oldSQty + spotFilledQty;
                                var newNQty = oldNQty + newFilledQty;
                                if (newSQty <= 0 || newNQty <= 0) {
                                    Log("âŒ PENDING: Yeni miktar sÄ±fÄ±r, gÃ¼ncelleme atlanÄ±yor");
                                    continue;
                                }
                                var avgSpot = (p[2] * oldSQty + spotAvgP * spotFilledQty) / newSQty;
                                var avgNear = (p[3] * oldNQty + filledPrice * newFilledQty) / newNQty;
                                if (avgSpot <= 0) {
                                    Log("âŒ PENDING: avgSpot sÄ±fÄ±r, gÃ¼ncelleme atlanÄ±yor");
                                    continue;
                                }
                                var newSpread = (avgNear - avgSpot) / avgSpot;
                                var newExpectedPnl = newSpread * avgSpot * newSQty;
                                
                                snPos[baseSym] = new decimal[] { newSQty, newNQty, avgSpot, avgNear, p[4], newExpectedPnl, p[6], p[7] };
                                Log("ğŸ“Š PENDING AÃ‡ILIÅ EKLENDÄ°: " + baseSym + " S:" + oldSQty + "â†’" + newSQty + " N:" + oldNQty + "â†’" + newNQty);
                            } else {
                                if (spotAvgP <= 0) {
                                    Log("âŒ PENDING: spotAvgP sÄ±fÄ±r, yeni pozisyon atlanÄ±yor");
                                    continue;
                                }
                                var openSpread = (filledPrice - spotAvgP) / spotAvgP;
                                var expectedPnl = openSpread * spotAvgP * spotFilledQty;
                                snPos[baseSym] = new decimal[] { spotFilledQty, newFilledQty, spotAvgP, filledPrice, openSpread, expectedPnl, 0, DateTime.Now.Ticks };
                                Log("ğŸ“Š PENDING YENÄ° POZÄ°SYON: " + baseSym + " S:" + spotFilledQty + " N:" + newFilledQty);
                            }
                            
                            var spotComm = CalcSpotCommission(spotAvgP, spotFilledQty);
                            var nearComm = CalcCommission(baseSym, filledPrice, newFilledQty);
                            dailySpotCommission += spotComm;
                            dailyViopCommission += nearComm;
                            spotUsed += spotAvgP * spotFilledQty;
                            AdjustT2Balance(spotAvgP * spotFilledQty, spotComm);  // AlÄ±ÅŸ
                            var viopTeminat = teminat.ContainsKey(baseSym) ? teminat[baseSym] * newFilledQty : 0;
                            viopUsed += viopTeminat;
                            AdjustViopBalance(viopTeminat);  // Teminat kullanÄ±ldÄ±
                            
                            SavePositions();
                            if (SaveDailyStats != null) SaveDailyStats();
                        }
                    }
                }
                // ========== SPOT BUY (AÃ§Ä±lÄ±ÅŸ) - Pozisyona ekle ==========
                else if (isSpot && side == "BUY") {
                    if (snPos.ContainsKey(baseSym)) {
                        var p = snPos[baseSym];
                        var oldSQty = (int)p[0];
                        var newSQty = oldSQty + newFilledQty;
                        if (newSQty <= 0) {
                            Log("âŒ PENDING SPOT BUY: newSQty sÄ±fÄ±r");
                            continue;
                        }
                        var avgSpot = (p[2] * oldSQty + filledPrice * newFilledQty) / newSQty;
                        if (avgSpot <= 0) {
                            Log("âŒ PENDING SPOT BUY: avgSpot sÄ±fÄ±r");
                            continue;
                        }
                        var newSpread = (p[3] - avgSpot) / avgSpot;
                        var newExpectedPnl = newSpread * avgSpot * newSQty;
                        
                        snPos[baseSym] = new decimal[] { newSQty, p[1], avgSpot, p[3], p[4], newExpectedPnl, p[6], p[7] };
                        Log("ğŸ“Š PENDING SPOT BUY EKLENDÄ°: " + baseSym + " S:" + oldSQty + "â†’" + newSQty);
                        
                        var spotComm = CalcSpotCommission(filledPrice, newFilledQty);
                        dailySpotCommission += spotComm;
                        spotUsed += filledPrice * newFilledQty;
                        AdjustT2Balance(filledPrice * newFilledQty, spotComm);  // AlÄ±ÅŸ
                        
                        SavePositions();
                    }
                }
                // ========== SPOT SELL (KapanÄ±ÅŸ) - Pozisyondan dÃ¼ÅŸ ==========
                else if (isSpot && side == "SELL") {
                    if (snPos.ContainsKey(baseSym)) {
                        var p = snPos[baseSym];
                        var currentSpot = (int)p[0];
                        var currentNear = (int)p[1];
                        
                        var spotPnl = (filledPrice - p[2]) * newFilledQty;
                        var spotComm = CalcSpotCommission(filledPrice, newFilledQty);
                        spotPnl -= spotComm;
                        dailyRealizedPnl += spotPnl;
                        dailySpotCommission += spotComm;
                        spotUsed -= filledPrice * newFilledQty;
                        if (spotUsed < 0) spotUsed = 0;
                        AdjustT2Balance(-(filledPrice * newFilledQty), spotComm);  // SatÄ±ÅŸ
                        
                        var remainSpot = currentSpot - newFilledQty;
                        if (remainSpot <= 0 && currentNear <= 0) {
                            snPos.Remove(baseSym);
                            Log("âœ… PENDING SPOT SELL KAPANIÅ: " + baseSym);
                        } else {
                            var expPnlRatio = currentSpot > 0 ? p[5] * remainSpot / currentSpot : 0;
                            snPos[baseSym] = new decimal[] { remainSpot, currentNear, p[2], p[3], p[4], expPnlRatio, p[6], p[7] };
                            Log("ğŸ“Š PENDING SPOT SELL: " + baseSym + " S:" + currentSpot + "â†’" + remainSpot);
                        }
                        
                        SavePositions();
                        if (SaveDailyStats != null) SaveDailyStats();
                    }
                }
                
                // Tam dolduysa sil, kÄ±smi dolduysa processedQty gÃ¼ncelle
                if (isComplete) {
                    toRemove.Add(key);
                } else {
                    // processedQty'yi gÃ¼ncelle (11. index)
                    if (data.Length > 11) {
                        data[11] = totalFilledQty;
                    } else {
                        var newData = new object[12];
                        for (int i = 0; i < data.Length; i++) newData[i] = data[i];
                        newData[11] = totalFilledQty;
                        data = newData;
                    }
                    toUpdate[key] = data;
                    Log("ğŸ“Š PENDING processedQty GÃœNCELLEME: " + key + " Ä°ÅŸlenen:" + totalFilledQty + "/" + originalQty);
                }
            } else if (!found || newFilledQty == 0) {
                // Hala bekliyor veya deÄŸiÅŸiklik yok - ne kadar sÃ¼redir?
                var waitTime = (DateTime.Now - entryTime).TotalMinutes;
                if (waitTime > 5 && newFilledQty == 0) {
                    Log("âš ï¸ BEKLEYEN EMÄ°R " + waitTime.ToString("F0") + " dk'dÄ±r bekliyor: " + key + " OrderNo:" + orderNo);
                }
                
                // Manuel iptal kontrolÃ¼: BekleyenEmirler'de de yoksa silinmiÅŸ demektir
                var stillPending = false;
                try {
                    var bekleyenList = hesap.BekleyenEmirler;
                    if (bekleyenList != null) {
                        for (int i = 0; i < bekleyenList.Count; i++) {
                            if ((bekleyenList[i].OrderNo ?? "") == orderNo) {
                                stillPending = true;
                                break;
                            }
                        }
                    }
                } catch { stillPending = true; }  // Hata durumunda silme
                
                // BekleyenEmirler'de yok VE GerceklesenEmirler'de de yok â†’ Manuel iptal edilmiÅŸ
                if (!stillPending && !found && waitTime > 1) {
                    Log("ğŸ—‘ï¸ BEKLEYEN EMÄ°R MANUEL Ä°PTAL EDÄ°LMÄ°Å: " + key + " OrderNo:" + orderNo);
                    toRemove.Add(key);
                    
                    // orphanLegs'te bu sembol varsa onu da temizle
                    var baseSym2 = "";
                    if (!isSpot) {
                        try {
                            var idx = fullSymbol.IndexOf("F_");
                            if (idx >= 0) {
                                baseSym2 = fullSymbol.Substring(idx + 2);
                                if (baseSym2.Length > 4) baseSym2 = baseSym2.Substring(0, baseSym2.Length - 4);
                            }
                        } catch { }
                    }
                    // Not: orphanLegs'i burada silmiyoruz Ã§Ã¼nkÃ¼ manuel iptal = pozisyon hala aÃ§Ä±k
                    // Recovery'nin halletmesine bÄ±rakÄ±yoruz
                }
            }
        } catch { }
    }
    
    // Tam gerÃ§ekleÅŸenleri sil ve bÃ¼tÃ§eyi geri ver
    foreach (var key in toRemove) {
        try {
            var data = pendingOrders[key];
            var orderQty = (int)data[1];
            var pendingPrice = (decimal)data[2];
            var isSpot = (bool)data[5];
            var fullSymbol = (string)data[6];
            
            // AyrÄ±lan bÃ¼tÃ§eyi geri ver
            var pendingValue = pendingPrice * orderQty;
            if (isSpot) {
                spotUsed -= pendingValue;
                if (spotUsed < 0) spotUsed = 0;
                spotBudgetTotal = spotUsed + t2Balance;
                Log("ğŸ’° Pending SPOT bÃ¼tÃ§e serbest: " + pendingValue.ToString("N0"));
            } else {
                // Near iÃ§in teminat serbest bÄ±rak
                var baseSym = "";
                try {
                    var idx = fullSymbol.IndexOf("F_");
                    if (idx >= 0) {
                        baseSym = fullSymbol.Substring(idx + 2);
                        if (baseSym.Length > 4) baseSym = baseSym.Substring(0, baseSym.Length - 4);
                    }
                } catch { }
                if (!string.IsNullOrEmpty(baseSym) && teminat.ContainsKey(baseSym)) {
                    var pendingTeminat = teminat[baseSym] * orderQty;
                    viopUsed -= pendingTeminat;
                    if (viopUsed < 0) viopUsed = 0;
                    Log("ğŸ’° Pending VIOP teminat serbest: " + pendingTeminat.ToString("N0"));
                }
            }
        } catch { }
        pendingOrders.Remove(key);
    }
    
    // processedQty gÃ¼ncellemelerini uygula
    foreach (var kv in toUpdate) {
        pendingOrders[kv.Key] = kv.Value;
    }
};

ExecGuar = (sym, side, qty) => {
    // Miktar kontrolÃ¼
    if (qty <= 0) {
        Log("âš ï¸ ExecGuar: " + sym + " miktar 0, emir atlanÄ±yor");
        return System.Tuple.Create(0, 0m);
    }
    
    var buy = side == "BUY";
    var spot = !sym.StartsWith("F_");
    var full = spot ? SPOT_PREFIX + sym : FUTURES_PREFIX + sym;
    
    // Derinlikten fiyat al
    var limitPrice = Depth2x(full, buy, qty);
    var avgPrice = DepthAvgPrice(full, buy, qty);
    if (avgPrice <= 0) avgPrice = limitPrice;
    
    // Derinlik yoksa baÅŸarÄ±sÄ±z
    if (limitPrice <= 0 || avgPrice <= 0) {
        Log("âŒ " + side + " " + sym + " derinlik yok");
        return System.Tuple.Create(0, 0m);
    }
    
    Log("ğŸ“¤ LMT: " + side + " " + sym + " x" + qty + " @" + limitPrice.ToString("F2"));
    
    // Emir gÃ¶nder (KIE - KalanÄ± Ä°ptal Et)
    Sistem.EmirSembol = full;
    Sistem.EmirIslem = buy ? "ALIS" : "SATIS";
    Sistem.EmirMiktari = qty;
    Sistem.EmirSuresi = "KIE";
    Sistem.EmirTipi = spot ? "Limit" : "Limitli";
    Sistem.EmirFiyati = (double)limitPrice;
    Sistem.EmirGonder();
    
    // Test modu: Teyit beklemeden ortalama fiyatla doldu say
    if (IS_TEST) {
        return System.Tuple.Create(qty, avgPrice);
    }
    
    // GerÃ§ek mod: 2 deneme teyit
    var yon = buy ? "AlÄ±ÅŸ" : "SatÄ±ÅŸ";
    
    for (int attempt = 1; attempt <= 2; attempt++) {
        RefreshHesaplar(true);  // 2sn bekle + taze veri
        
        dynamic hesap = spot ? GetBistHesap() : GetViopHesap();
        
        // Hesap null ise tekrar dene
        if (hesap == null) {
            Log("âš ï¸ " + side + " " + sym + " hesap null (deneme " + attempt + "/2)");
            continue;
        }
        
        // GerÃ§ekleÅŸen emirleri kontrol et (son 5 emir)
        try {
            var emirList = hesap.GerceklesenEmirler;
            if (emirList != null) {
                for (int i = emirList.Count - 1; i >= 0 && i >= emirList.Count - 5; i--) {
                    var e = emirList[i];
                    var eSym = e.Symbol ?? "";
                    var eYon = e.BuySell ?? "";
                    if ((spot && eSym.Contains(sym) && eYon == yon) || 
                        (!spot && eSym == full && eYon == yon)) {
                        var filledQty = (int)e.GAmount;
                        var filledPrice = (decimal)e.Price;
                        if (filledQty > 0) {
                            Log("âœ“ " + side + " " + sym + " teyit: " + filledQty + "@" + filledPrice.ToString("F2"));
                            return System.Tuple.Create(filledQty, filledPrice);
                        }
                    }
                }
            }
        } catch { }
        
        // Bekleyen emirleri kontrol et (KIE dolmamÄ±ÅŸ mÄ±?)
        try {
            var bekleyenList = hesap.BekleyenEmirler;
            if (bekleyenList != null) {
                for (int i = 0; i < bekleyenList.Count; i++) {
                    var e = bekleyenList[i];
                    var eSym = e.Symbol ?? "";
                    var eYon = e.BuySell ?? "";
                    if ((spot && eSym.Contains(sym) && eYon == yon) || 
                        (!spot && eSym == full && eYon == yon)) {
                        // Beklemede kaldÄ± - izlemeye al
                        var orderNo = e.OrderNo ?? "";
                        var orderDate = e.OrderDate ?? "";
                        var orderType = e.OrderType ?? "";
                        var session = e.Session ?? "";
                        var status = e.Status ?? "";
                        var orderQty = (int)e.Amount;
                        var orderPrice = (decimal)e.Price;
                        Log("âš ï¸ " + side + " " + sym + " BEKLEMEDE KALDI!");
                        Log("   OrderNo:" + orderNo + " Date:" + orderDate + " Status:" + status);
                        Log("   Qty:" + orderQty + " @" + orderPrice.ToString("F2") + " Type:" + orderType + " Session:" + session);
                        pendingOrders[sym + "_" + side] = new object[] { 
                            side, orderQty, orderPrice, DateTime.Now, 
                            orderNo, spot, eSym, orderDate, orderType, session, status, 0  // 11:processedQty=0
                        };
                        
                        // Pending order iÃ§in bÃ¼tÃ§e ayÄ±r
                        var pendingValue = orderPrice * orderQty;
                        if (spot) {
                            spotUsed += pendingValue;
                            spotBudgetTotal = spotUsed + t2Balance;
                            Log("ğŸ’° Pending SPOT bÃ¼tÃ§e ayrÄ±ldÄ±: " + pendingValue.ToString("N0"));
                        } else {
                            // Near iÃ§in teminat ayÄ±r
                            var baseSym = sym.Replace("F_", "").Substring(0, sym.Length - 5);  // F_THYAO0126 -> THYAO
                            if (teminat.ContainsKey(baseSym)) {
                                var pendingTeminat = teminat[baseSym] * orderQty;
                                viopUsed += pendingTeminat;
                                Log("ğŸ’° Pending VIOP teminat ayrÄ±ldÄ±: " + pendingTeminat.ToString("N0"));
                            }
                        }
                        
                        return System.Tuple.Create(0, 0m);  // DolmadÄ± say
                    }
                }
            }
        } catch { }
        
        if (attempt == 1) {
            Log("â³ " + side + " " + sym + " teyit bulunamadÄ±, tekrar deneniyor...");
        }
    }
    
    // 2 denemede de teyit alÄ±namadÄ±
    Log("âŒ " + side + " " + sym + " teyit alÄ±namadÄ±, dolmadÄ± sayÄ±lÄ±yor");
    return System.Tuple.Create(0, 0m);
};

// ====================================
// SPOT-NEAR AÃ‡ILIÅ (KontrollÃ¼ GÄ°E)
// ====================================
Func<string, string, int, int, decimal, int, bool> OpenSN = (sym, nearC, sQty, nQty, minSp, bb93Flag) => {
    try {
        // Pair Trading iÃ§in yasaklÄ± sembol kontrolÃ¼
        if (PAIR_BLOCKED.Contains(sym)) {
            return false;  // Sessizce atla (normal durum)
        }
        
        // Miktar kontrolÃ¼
        if (nQty <= 0 || sQty <= 0) {
            Log("âš ï¸ OpenSN: " + sym + " miktar 0, aÃ§Ä±lÄ±ÅŸ atlanÄ±yor (S:" + sQty + " N:" + nQty + ")");
            return false;
        }
        
        // Pending order kontrolÃ¼
        if (pendingOrders.ContainsKey(sym + "_BUY") || pendingOrders.ContainsKey(sym + "_SELL")) {
            Log("â›” SN AÃ‡ILIÅ: " + sym + " pending order var, aÃ§Ä±lmÄ±yor");
            return false;
        }
        
        var nearS = FUTURES_PREFIX + nearC;
        var spotS = SPOT_PREFIX + sym;
        Log("ğŸ“Š SN AÃ‡ILIÅ: " + sym + " S:" + sQty + " N:" + nQty);
        
        // === KONTROLLÃœ GÄ°E: 3 deneme ===
        decimal nearP = 0;
        var filled = false;
        
        for (int attempt = 1; attempt <= 3; attempt++) {
            // 1. Near Bid derinlik kontrolÃ¼ (Near satÄ±yoruz)
            var nearDepthResult = ReadDepth(nearS, "BID", 0, 3, 100);
            if (!nearDepthResult.Item1) {
                Log("âŒ Near Bids boÅŸ (deneme " + attempt + ")");
                if (attempt == 3) return false;
                System.Threading.Thread.Sleep(200);
                continue;
            }
            
            var nearBid1Size = nearDepthResult.Item2;
            var nearBid2Size = nearDepthResult.Item3;
            var nearBid1Price = nearDepthResult.Item4;
            var nearBid2Price = nearDepthResult.Item5;
            var nearTotalSize = GIE_DEPTH_LEVELS >= 2 ? nearDepthResult.Item6 : nearBid1Size;
            
            // Derinlik yeterli mi?
            if (GIE_DEPTH_LEVELS == 1) {
                if (nearBid1Size < nQty) {
                    Log("âŒ Near 1.kademe yetersiz: " + nearBid1Size + " < " + nQty + " (deneme " + attempt + ")");
                    if (attempt == 3) return false;
                    System.Threading.Thread.Sleep(200);
                    continue;
                }
            } else {
                if (nearTotalSize < nQty) {
                    Log("âŒ Near 1+2.kademe yetersiz: " + nearTotalSize + " < " + nQty + " (deneme " + attempt + ")");
                    if (attempt == 3) return false;
                    System.Threading.Thread.Sleep(200);
                    continue;
                }
            }
            
            // 2. Spot Ask derinlik kontrolÃ¼ (Spot alÄ±yoruz)
            var spotDepthResult = ReadDepth(spotS, "ASK", 0, 3, 100);
            if (!spotDepthResult.Item1 || spotDepthResult.Item4 <= 0) {
                Log("âŒ Spot derinlik yok (deneme " + attempt + ")");
                if (attempt == 3) return false;
                System.Threading.Thread.Sleep(200);
                continue;
            }
            
            var spotAsk1Price = spotDepthResult.Item4;
            var spotAsk1Size = spotDepthResult.Item2;
            
            // 3. GIE fiyatÄ± ve spread kontrolÃ¼
            var giePrice = nearBid1Price;
            if (GIE_DEPTH_LEVELS >= 2 && nearBid1Size < nQty && nearBid2Price > 0) {
                giePrice = nearBid2Price;  // 2. kademeye gÃ¶nder
            }
            
            // Spread kontrolÃ¼ (GIE fiyatÄ± Ã¼zerinden)
            var sp = (giePrice - spotAsk1Price) / spotAsk1Price;
            if (sp < minSp * 0.95m) {
                Log("âŒ Spread dÃ¼ÅŸtÃ¼: " + (sp * 100).ToString("F3") + "% < " + (minSp * 0.95m * 100).ToString("F3") + "% (deneme " + attempt + ")");
                if (attempt == 3) return false;
                System.Threading.Thread.Sleep(200);
                continue;
            }
            
            // 4. Spot derinlik yeterliliÄŸi kontrolÃ¼ (10 kademe toplam)
            dynamic spotDepthFull = Sistem.DerinlikVerisiOku(spotS);
            var cumQty = 0;
            if (spotDepthFull != null && spotDepthFull.Asks != null) {
                for (int i = 0; i < spotDepthFull.Asks.Count && i < 10; i++) {
                    cumQty += (int)spotDepthFull.Asks[i].Size;
                }
            }
            if (cumQty < sQty) {
                Log("âŒ Spot derinlik yetersiz: " + cumQty + " < " + sQty + " (deneme " + attempt + ")");
                if (attempt == 3) return false;
                System.Threading.Thread.Sleep(200);
                continue;
            }
            
            // 5. Her ÅŸey uygun - Near GÄ°E gÃ¶nder
            nearP = giePrice;
            var gieInfo = (GIE_DEPTH_LEVELS >= 2 && giePrice < nearBid1Price) ? " [2.KDM]" : "";
            Log("ğŸ“¤ Near GÄ°E: " + nearC + " SELL x" + nQty + " @" + nearP.ToString("F2") + gieInfo);
            SendGIE(nearC, "SELL", nQty, nearP);
            System.Threading.Thread.Sleep(GIE_WAIT_MS);
            
            // 6. Doldu mu kontrol et
            if (IS_TEST || CheckFilled(nearC, "SELL", nQty)) {
                filled = true;
                Log("âœ“ Near GÄ°E doldu (deneme " + attempt + ")");
                break;
            }
            
            Log("â³ Near dolmadÄ± (deneme " + attempt + "/3)");
        }
        
        if (!filled) {
            Log("âŒ Near 3 denemede dolmadÄ±");
            return false;
        }
        
        // === Near doldu, ÅŸimdi Spot al (garantili) ===
        dynamic finalSpotDepth = Sistem.DerinlikVerisiOku(spotS);
        if (finalSpotDepth == null || finalSpotDepth.Asks == null || finalSpotDepth.Asks.Count == 0) {
            Log("âŒ Spot derinlik kayboldu - Near geri alÄ±nÄ±yor");
            // Yetim bacak kaydet (Near satÄ±ldÄ±, Spot alÄ±namadÄ±)
            orphanLegs[sym] = new object[] {
                "NEAR", nearC, "SELL", nQty, nearP,  // Dolan bacak
                "SPOT", sym, "BUY", sQty, DateTime.Now.Ticks  // Hedef bacak
            };
            SavePositions();
            Log("ğŸ“ Yetim bacak kaydedildi: " + sym + " NEAR SELL x" + nQty + " @" + nearP.ToString("F2"));
            if (!IS_TEST) ExecGuar(nearC, "BUY", nQty);
            return false;
        }
        
        // Limit fiyat hesapla (2x derinlik)
        var targetQty = sQty * 2;
        var cumQtyFinal = 0;
        decimal limitPrice = 0;
        decimal avgTotal = 0;
        var avgQty = 0;
        
        for (int i = 0; i < finalSpotDepth.Asks.Count && i < 10; i++) {
            var kademeFiyat = (decimal)finalSpotDepth.Asks[i].Price;
            var kademeMiktar = (int)finalSpotDepth.Asks[i].Size;
            cumQtyFinal += kademeMiktar;
            if (avgQty < sQty) {
                var alQty = Math.Min(kademeMiktar, sQty - avgQty);
                avgTotal += kademeFiyat * alQty;
                avgQty += alQty;
            }
            if (cumQtyFinal >= targetQty && limitPrice == 0) limitPrice = kademeFiyat;
        }
        if (limitPrice == 0 && finalSpotDepth.Asks.Count > 0) {
            limitPrice = (decimal)finalSpotDepth.Asks[finalSpotDepth.Asks.Count - 1].Price;
        }
        
        if (cumQtyFinal < sQty) {
            Log("âŒ Spot derinlik yetersiz - Near geri alÄ±nÄ±yor");
            // Yetim bacak kaydet (Near satÄ±ldÄ±, Spot alÄ±namadÄ±)
            orphanLegs[sym] = new object[] {
                "NEAR", nearC, "SELL", nQty, nearP,  // Dolan bacak
                "SPOT", sym, "BUY", sQty, DateTime.Now.Ticks  // Hedef bacak
            };
            SavePositions();
            Log("ğŸ“ Yetim bacak kaydedildi: " + sym + " NEAR SELL x" + nQty + " @" + nearP.ToString("F2"));
            if (!IS_TEST) ExecGuar(nearC, "BUY", nQty);
            return false;
        }
        
        // Spot emir (garantili yÃ¶ntem)
        var spotResult = ExecGuar(sym, "BUY", sQty);
        if (spotResult.Item1 == 0) {
            Log("âŒ Spot alÄ±namadÄ± - Near geri alÄ±nÄ±yor");
            // Yetim bacak kaydet (Near satÄ±ldÄ±, Spot alÄ±namadÄ±)
            orphanLegs[sym] = new object[] {
                "NEAR", nearC, "SELL", nQty, nearP,  // Dolan bacak
                "SPOT", sym, "BUY", sQty, DateTime.Now.Ticks  // Hedef bacak
            };
            SavePositions();
            Log("ğŸ“ Yetim bacak kaydedildi: " + sym + " NEAR SELL x" + nQty + " @" + nearP.ToString("F2"));
            if (!IS_TEST) ExecGuar(nearC, "BUY", nQty);
            return false;
        }
        
        decimal spotAvgP = spotResult.Item2;
        int spotFilledQty = spotResult.Item1;
        
        // Spot kÄ±smi dolduysa, fazla Near'Ä± geri al
        var mult = GetMultiplier(sym);
        var neededNear = (int)Math.Ceiling((decimal)spotFilledQty / mult);  // Spot'a karÅŸÄ±lÄ±k gelen Near
        var excessNear = nQty - neededNear;
        
        if (excessNear > 0 && spotFilledQty < sQty) {
            Log("âš ï¸ Spot kÄ±smi doldu: " + spotFilledQty + "/" + sQty + " - Fazla Near geri alÄ±nÄ±yor: " + excessNear);
            if (!IS_TEST) ExecGuar(nearC, "BUY", excessNear);
            nQty = neededNear;  // Kalan Near miktarÄ±
        }
        
        // Pozisyon kaydet
        if (spotAvgP <= 0) {
            Log("âŒ Spot ortalama fiyat sÄ±fÄ±r, pozisyon kaydedilemiyor");
            return true;  // Near zaten aÃ§Ä±ldÄ±, spot da doldu ama fiyat sÄ±fÄ±r - anormal durum
        }
        var openSpread = (nearP - spotAvgP) / spotAvgP;
        var expectedPnl = openSpread * spotAvgP * spotFilledQty;
        var spotComm = CalcSpotCommission(spotAvgP, spotFilledQty);
        var nearComm = CalcCommission(sym, nearP, nQty);
        var totalComm = spotComm + nearComm;
        expectedPnl -= totalComm * 2;
        
        snPos[sym] = new decimal[] { spotFilledQty, nQty, spotAvgP, nearP, openSpread, expectedPnl, bb93Flag, DateTime.Now.Ticks };
        dailySpotCommission += spotComm;
        dailyViopCommission += nearComm;
        spotUsed += spotAvgP * spotFilledQty;
        AdjustT2Balance(spotAvgP * spotFilledQty, spotComm);  // AlÄ±ÅŸ: T+2 azalÄ±r
        var viopTeminat = teminat.ContainsKey(sym) ? teminat[sym] * nQty : 0;
        viopUsed += viopTeminat;
        AdjustViopBalance(viopTeminat);  // Teminat kullanÄ±ldÄ±
        
        // IdealData pozisyon listesine ekle
        try {
            Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_SPOT," + sym, spotFilledQty, (double)spotAvgP, "SPOT");
            Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + nearC, nQty, (double)nearP, "NEAR");
        } catch { }
        
        Log("âœ… SN AÃ‡ILDI: " + sym + " S:" + spotFilledQty + "@" + spotAvgP.ToString("F2") + 
            " N:" + nQty + "@" + nearP.ToString("F2") + " Spread:" + (openSpread * 100).ToString("F3") + "%");
        SavePositions();
        return true;
    } catch (Exception ex) {
        Log("âŒ SN AÃ‡ILIÅ HATA: " + sym + " - " + ex.Message);
        return false;
    }
};
// ====================================
// SPOT-NEAR BÃœYÃœTME (KontrollÃ¼ GÄ°E)
// ====================================
Func<string, string, int, int, decimal, bool> AddToSN = (sym, nearC, addSQty, addNQty, minSp) => {
    if (!snPos.ContainsKey(sym)) return false;
    
    // Miktar kontrolÃ¼
    if (addNQty <= 0 || addSQty <= 0) {
        Log("âš ï¸ AddToSN: " + sym + " miktar 0, bÃ¼yÃ¼tme atlanÄ±yor (S:" + addSQty + " N:" + addNQty + ")");
        return false;
    }
    
    // Pending order kontrolÃ¼
    if (pendingOrders.ContainsKey(sym + "_BUY") || pendingOrders.ContainsKey(sym + "_SELL")) {
        Log("â›” SN BÃœYÃœTME: " + sym + " pending order var, bÃ¼yÃ¼tÃ¼lmÃ¼yor");
        return false;
    }
    
    var p = snPos[sym];
    var currentAddCount = (int)p[6];
    if (currentAddCount >= 2) {
        Log("â›” SN " + sym + " max ekleme (2) ulaÅŸÄ±ldÄ±");
        return false;
    }
    
    var nearS = FUTURES_PREFIX + nearC;
    var spotS = SPOT_PREFIX + sym;
    Log("ğŸ“Š SN BÃœYÃœTME: " + sym + " +" + addSQty + "/" + addNQty + " (ekleme:" + (currentAddCount+1) + "/2)");
    
    // === KONTROLLÃœ GÄ°E: 3 deneme ===
    decimal nearP = 0;
    var filled = false;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        // 1. Near Bid derinlik kontrolÃ¼ (Near satÄ±yoruz)
        var nearBidResult = ReadDepth(nearS, "BID", 0, 3, 100);
        if (!nearBidResult.Item1) {
            if (attempt == 3) return false;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var nearBid1Size = nearBidResult.Item2;
        var nearBid2Size = nearBidResult.Item3;
        var nearBid1Price = nearBidResult.Item4;
        var nearBid2Price = nearBidResult.Item5;
        var nearTotalSize = GIE_DEPTH_LEVELS >= 2 ? nearBidResult.Item6 : nearBid1Size;
        
        // Derinlik yeterli mi?
        if (GIE_DEPTH_LEVELS == 1) {
            if (nearBid1Size < addNQty) {
                if (attempt == 3) return false;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        } else {
            if (nearTotalSize < addNQty) {
                if (attempt == 3) return false;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        }
        
        // Near Ask derinlik kontrolÃ¼ (kapanÄ±ÅŸta sorun yaÅŸamamak iÃ§in)
        var currentNQty = (int)p[1];
        var totalNQtyAfterAdd = currentNQty + addNQty;
        var minAskDepthRequired = totalNQtyAfterAdd * 5;
        
        // Near Ask iÃ§in ayrÄ± okuma (3 kademe toplam lazÄ±m)
        dynamic nearDepthFull = Sistem.DerinlikVerisiOku(nearS);
        var nearAsk3Depth = 0;
        if (nearDepthFull != null && nearDepthFull.Asks != null) {
            for (int i = 0; i < nearDepthFull.Asks.Count && i < 3; i++) {
                nearAsk3Depth += (int)nearDepthFull.Asks[i].Size;
            }
        }
        
        if (nearAsk3Depth < minAskDepthRequired) {
            Log("â›” SN BÃœYÃœTME: " + sym + " Near Ask derinlik yetersiz: " + nearAsk3Depth + " < " + minAskDepthRequired + " (poz:" + totalNQtyAfterAdd + " x5)");
            return false;
        }
        
        // 2. Spot Ask derinlik kontrolÃ¼ (Spot alÄ±yoruz)
        var spotDepthResult = ReadDepth(spotS, "ASK", 0, 3, 100);
        if (!spotDepthResult.Item1 || spotDepthResult.Item4 <= 0) {
            if (attempt == 3) return false;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var spotAsk1Price = spotDepthResult.Item4;
        
        // 3. GIE fiyatÄ± ve Spread kontrolÃ¼
        var giePrice = nearBid1Price;
        if (GIE_DEPTH_LEVELS >= 2 && nearBid1Size < addNQty && nearBid2Price > 0) {
            giePrice = nearBid2Price;
        }
        
        var sp = (giePrice - spotAsk1Price) / spotAsk1Price;
        if (sp < minSp * 0.95m) {
            if (attempt == 3) return false;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        // 4. Spot derinlik yeterliliÄŸi (10 kademe toplam)
        dynamic spotDepthFull = Sistem.DerinlikVerisiOku(spotS);
        var cumQty = 0;
        if (spotDepthFull != null && spotDepthFull.Asks != null) {
            for (int i = 0; i < spotDepthFull.Asks.Count && i < 10; i++) {
                cumQty += (int)spotDepthFull.Asks[i].Size;
            }
        }
        if (cumQty < addSQty) {
            if (attempt == 3) return false;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        // 5. Her ÅŸey uygun - Near GÄ°E gÃ¶nder
        nearP = giePrice;
        SendGIE(nearC, "SELL", addNQty, nearP);
        System.Threading.Thread.Sleep(GIE_WAIT_MS);
        
        // 6. Doldu mu kontrol et
        if (IS_TEST || CheckFilled(nearC, "SELL", addNQty)) {
            filled = true;
            break;
        }
    }
    
    if (!filled) {
        Log("âŒ Near 3 denemede dolmadÄ±");
        return false;
    }
    
    // === Near doldu, Spot al (garantili) ===
    var spotResult = ExecGuar(sym, "BUY", addSQty);
    if (spotResult.Item1 == 0) {
        Log("âŒ Spot alÄ±namadÄ± - Near geri alÄ±nÄ±yor");
        if (!IS_TEST) ExecGuar(nearC, "BUY", addNQty);
        return false;
    }
    
    decimal spotAvgP = spotResult.Item2;
    int spotFilledQty = spotResult.Item1;
    
    // Spot kÄ±smi dolduysa, fazla Near'Ä± geri al
    var mult = GetMultiplier(sym);
    var neededNear = (int)Math.Ceiling((decimal)spotFilledQty / mult);  // Spot'a karÅŸÄ±lÄ±k gelen Near
    var excessNear = addNQty - neededNear;
    var actualAddNQty = addNQty;
    
    if (excessNear > 0 && spotFilledQty < addSQty) {
        Log("âš ï¸ Spot kÄ±smi doldu: " + spotFilledQty + "/" + addSQty + " - Fazla Near geri alÄ±nÄ±yor: " + excessNear);
        if (!IS_TEST) ExecGuar(nearC, "BUY", excessNear);
        actualAddNQty = neededNear;  // Kalan Near miktarÄ±
    }
    
    // Ortalama hesapla
    var oldSQty = (int)p[0];
    var oldNQty = (int)p[1];
    var newSQty = oldSQty + spotFilledQty;
    var newNQty = oldNQty + actualAddNQty;
    if (newSQty <= 0 || newNQty <= 0) {
        Log("âŒ AddToSN: Yeni miktar sÄ±fÄ±r, gÃ¼ncelleme yapÄ±lamÄ±yor");
        return true;
    }
    var avgSpot = (p[2] * oldSQty + spotAvgP * spotFilledQty) / newSQty;
    var avgNear = (p[3] * oldNQty + nearP * actualAddNQty) / newNQty;
    if (avgSpot <= 0) {
        Log("âŒ AddToSN: Ortalama spot fiyat sÄ±fÄ±r");
        return true;
    }
    var newSpread = (avgNear - avgSpot) / avgSpot;
    var newExpectedPnl = newSpread * avgSpot * newSQty;
    var spotComm = CalcSpotCommission(spotAvgP, spotFilledQty);
    var nearComm = CalcCommission(sym, nearP, actualAddNQty);
    var totalComm = spotComm + nearComm;
    newExpectedPnl -= totalComm * 2;
    
    // p[6] = bb93Flag korunur (BB93+ giriÅŸi ise 1, deÄŸilse 0 veya addCount)
    // BB93 pozisyonlarÄ±na ekleme yapÄ±lÄ±rsa flag korunur
    var bb93Flag = (int)p[6];
    snPos[sym] = new decimal[] { newSQty, newNQty, avgSpot, avgNear, newSpread, newExpectedPnl, bb93Flag, p[7] };
    dailySpotCommission += spotComm;
    dailyViopCommission += nearComm;
    spotUsed += spotAvgP * spotFilledQty;
    AdjustT2Balance(spotAvgP * spotFilledQty, spotComm);  // AlÄ±ÅŸ: T+2 azalÄ±r
    var viopTeminat = teminat.ContainsKey(sym) ? teminat[sym] * actualAddNQty : 0;
    viopUsed += viopTeminat;
    AdjustViopBalance(viopTeminat);  // Teminat kullanÄ±ldÄ±
    
    // IdealData pozisyon listesini gÃ¼ncelle
    try {
        Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_SPOT," + sym, newSQty, (double)avgSpot, "SPOT");
        Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + nearC, newNQty, (double)avgNear, "NEAR");
    } catch { }
    
    Log("âœ… SN BÃœYÃœTÃœLDÃœ: " + sym + " S:" + oldSQty + "â†’" + newSQty + " Sp:" + (newSpread * 100).ToString("F3") + "%");
    SavePositions();
    return true;
};

// ====================================
// SPOT-NEAR KAPANIÅ (KontrollÃ¼ GÄ°E)
// ====================================
Action<string, string, int, int, string> CloseSN = (sym, nearC, sQty, nQty, reason) => {
    // Miktar kontrolÃ¼ - Near 0 ise kapanÄ±ÅŸ yapma
    if (nQty <= 0) {
        Log("âš ï¸ CloseSN: " + sym + " Near miktarÄ± 0, kapanÄ±ÅŸ atlanÄ±yor");
        return;
    }
    
    // Pending order kontrolÃ¼
    if (pendingOrders.ContainsKey(sym + "_BUY") || pendingOrders.ContainsKey(sym + "_SELL")) {
        Log("â›” SN KAPANIÅ: " + sym + " pending order var, kapatÄ±lmÄ±yor");
        return;
    }
    
    var nearS = FUTURES_PREFIX + nearC;
    var spotS = SPOT_PREFIX + sym;
    
    // TAVAN/TABAN KONTROLÃœ - KapanÄ±ÅŸ
    // Near tavanda â†’ Geri alÄ±namaz (vade sonu hariÃ§)
    var nearTavanFiyat = tavanFiyat.ContainsKey(nearS) ? tavanFiyat[nearS] : 0;
    if (nearTavanFiyat > 0) {
        var nearAlisFiyat = (decimal)Sistem.AlisFiyat(nearS);
        if (nearAlisFiyat >= nearTavanFiyat) {
            if (!reason.StartsWith("EXPIRY_MANDATORY")) {
                Log("âš ï¸ CloseSN: " + sym + " Near TAVANDA - geri alÄ±namaz, kapanÄ±ÅŸ atlanÄ±yor");
                return;
            }
            // Vade sonu - zorunlu kapat (settlement'a bÄ±rak)
            Log("âš ï¸ CloseSN: " + sym + " Near TAVANDA ama vade sonu - settlement'a bÄ±rakÄ±lÄ±yor");
        }
    }
    
    // Spot tabanda â†’ SatÄ±lamaz (vade sonu hariÃ§)
    var spotTabanFiyat = tabanFiyat.ContainsKey(spotS) ? tabanFiyat[spotS] : 0;
    if (spotTabanFiyat > 0) {
        var spotSatisFiyat = (decimal)Sistem.SatisFiyat(spotS);
        if (spotSatisFiyat <= spotTabanFiyat) {
            if (!reason.StartsWith("EXPIRY_MANDATORY")) {
                Log("âš ï¸ CloseSN: " + sym + " Spot TABANDA - satÄ±lamaz, kapanÄ±ÅŸ atlanÄ±yor");
                return;
            }
            // Vade sonu - zorunlu kapat (settlement'a bÄ±rak)
            Log("âš ï¸ CloseSN: " + sym + " Spot TABANDA ama vade sonu - settlement'a bÄ±rakÄ±lÄ±yor");
        }
    }
    
    // GÃ¼n iÃ§i kar durumunda Ã¶zel loglama
    var isIntraday = reason.StartsWith("INTRADAY_PROFIT") || reason.StartsWith("INTRADAY_BB93");
    var intradaySpotPnl = 0m;
    var intradayNearPnl = 0m;
    if (isIntraday) {
        var parts = reason.Split('|');
        if (parts.Length >= 4) {
            decimal.TryParse(parts[2], out intradaySpotPnl);
            decimal.TryParse(parts[3], out intradayNearPnl);
        }
        if (reason.StartsWith("INTRADAY_BB93")) {
            var exitType = reason.Contains("_BB|") ? "BBâ‰¤15" : "Spreadâ‰¥0.23%";
            Log("ğŸ“Š BB93 GÃœN Ä°Ã‡Ä° KAPANIÅ: " + sym + " (" + exitType + ")");
        } else {
            Log("ğŸ“Š GÃœN Ä°Ã‡Ä° KAR KAPANIÅ: " + sym + " (T+0)");
        }
    } else {
        Log("ğŸ“Š SN KAPANIÅ: " + sym + " Sebep: " + reason);
    }
    
    // === Ã–NCE derinlik kontrolÃ¼ ===
    var nearInitResult = ReadDepth(nearS, "ASK", 0, 3, 100);
    if (!nearInitResult.Item1) {
        Log("âŒ KapanÄ±ÅŸ: Near Ask derinlik yok");
        return;
    }
    
    var spotInitResult = ReadDepth(spotS, "BID", 0, 3, 100);
    if (!spotInitResult.Item1) {
        Log("âŒ KapanÄ±ÅŸ: Spot Bid derinlik yok");
        return;
    }
    
    // === Ã–NCE Near al (3 deneme GÄ°E) ===
    decimal nearPrice = 0;
    var nearFilledQty = 0;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        // Near Ask derinlik kontrolÃ¼ (Near alÄ±yoruz)
        var nearAskResult = ReadDepth(nearS, "ASK", 0, 3, 100);
        if (!nearAskResult.Item1) {
            Log("â³ Near Ask boÅŸ (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var nearAsk1Size = nearAskResult.Item2;
        var nearAsk2Size = nearAskResult.Item3;
        var nearAsk1Price = nearAskResult.Item4;
        var nearAsk2Price = nearAskResult.Item5;
        var nearTotalSize = GIE_DEPTH_LEVELS >= 2 ? nearAskResult.Item6 : nearAsk1Size;
        
        if (GIE_DEPTH_LEVELS == 1) {
            if (nearAsk1Size < nQty) {
                Log("â³ Near Ask 1.kademe yetersiz (deneme " + attempt + "/3)");
                if (attempt == 3) break;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        } else {
            if (nearTotalSize < nQty) {
                Log("â³ Near Ask 1+2.kademe yetersiz (deneme " + attempt + "/3)");
                if (attempt == 3) break;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        }
        
        // GIE fiyatÄ±
        nearPrice = nearAsk1Price;
        if (GIE_DEPTH_LEVELS >= 2 && nearAsk1Size < nQty && nearAsk2Price > 0) {
            nearPrice = nearAsk2Price;
        }
        SendGIE(nearC, "BUY", nQty, nearPrice);
        System.Threading.Thread.Sleep(GIE_WAIT_MS);
        
        nearFilledQty = IS_TEST ? nQty : CheckFilledQty(nearC, "BUY", nQty);
        // Beklenen miktardan fazla olamaz (eski emirler karÄ±ÅŸmasÄ±n)
        if (nearFilledQty > nQty) nearFilledQty = nQty;
        if (nearFilledQty >= nQty) {
            break;  // Tam doldu
        } else if (nearFilledQty > 0) {
            Log("âš ï¸ Near kÄ±smi doldu: " + nearFilledQty + "/" + nQty);
            break;  // KÄ±smi doldu - devam et
        }
        
        Log("â³ Near dolmadÄ± (deneme " + attempt + "/3)");
    }
    
    // HiÃ§ dolmadÄ±ysa garantili yÃ¶ntemle al
    if (nearFilledQty == 0) {
        Log("âš ï¸ Near GÄ°E dolmadÄ±, garantili alÄ±m yapÄ±lÄ±yor");
        var nr = ExecGuar(nearC, "BUY", nQty);
        if (nr.Item1 == 0) {
            // Near kapatÄ±lamadÄ± - Spot'a dokunma, pozisyon aynÄ± kalsÄ±n
            Log("âŒ Near kapatÄ±lamadÄ± - kapanÄ±ÅŸ iptal, pozisyon korunuyor");
            return;
        }
        nearFilledQty = nr.Item1;
        nearPrice = nr.Item2;
    }
    
    // KÄ±smi dolum durumunda oranla Spot hesapla
    var mult = GetMultiplier(sym);
    var closeSQty = (int)Math.Round((decimal)nearFilledQty * mult);  // Near lot -> Spot lot
    if (closeSQty > sQty) closeSQty = sQty;  // Max spot miktarÄ±nÄ± aÅŸma
    if (closeSQty == 0) closeSQty = 1;  // En az 1 lot
    
    Log("ğŸ“Š Near dolum: " + nearFilledQty + "/" + nQty + " -> Spot kapatÄ±lacak: " + closeSQty + "/" + sQty);
    
    // === Near kapandÄ±, ÅŸimdi Spot sat (garantili) ===
    var sr = ExecGuar(sym, "SELL", closeSQty);
    if (sr.Item1 == 0) {
        // Spot satÄ±lamadÄ± ama Near kapandÄ± - orphan pozisyon!
        Log("âŒ Spot satÄ±lamadÄ± - ORPHAN POZÄ°SYON! Near kapandÄ±, Spot hala aÃ§Ä±k");
        if (snPos.ContainsKey(sym)) {
            var p = snPos[sym];
            // Near kapandÄ±, P&L'yi sadece near kÄ±smÄ± iÃ§in hesapla
            var nearPnl = (p[3] - nearPrice) * nearFilledQty * mult;
            var nearComm = CalcCommission(sym, nearPrice, nearFilledQty);
            nearPnl -= nearComm;
            dailyRealizedPnl += nearPnl;
            dailyViopCommission += nearComm;
            var viopTeminat = teminat.ContainsKey(sym) ? teminat[sym] * nearFilledQty : 0;
            viopUsed -= viopTeminat;
            if (viopUsed < 0) viopUsed = 0;
            AdjustViopBalance(-viopTeminat);  // Teminat serbest
            
            // Pozisyonu gÃ¼ncelle - Near kapananÄ± dÃ¼ÅŸ, Spot aynÄ± kalsÄ±n
            var remainNQty = nQty - nearFilledQty;
            var newExpPnl = nQty > 0 ? p[5] * remainNQty / nQty : 0;
            snPos[sym] = new decimal[] { p[0], remainNQty, p[2], p[3], p[4], newExpPnl, p[6], p[7] };
            Log("âš ï¸ " + sym + " pozisyon gÃ¼ncellendi: Spot=" + p[0] + ", Near=" + remainNQty + " (recovery bekliyor)");
        }
        SavePositions();
        return;
    }
    
    // === P&L hesapla ===
    if (snPos.ContainsKey(sym)) {
        var p = snPos[sym];
        
        var spotPnl = (sr.Item2 - p[2]) * closeSQty;
        var nearPnl = (p[3] - nearPrice) * nearFilledQty * mult;
        var totalPnl = spotPnl + nearPnl;
        
        var spotComm = CalcSpotCommission(sr.Item2, closeSQty);
        var nearComm = CalcCommission(sym, nearPrice, nearFilledQty);
        totalPnl -= (spotComm + nearComm);
        
        dailyRealizedPnl += totalPnl;
        dailySNPnl += totalPnl;
        dailySpotCommission += spotComm;
        dailyViopCommission += nearComm;
        spotUsed -= sr.Item2 * closeSQty;
        if (spotUsed < 0) spotUsed = 0;
        AdjustT2Balance(-(sr.Item2 * closeSQty), spotComm);  // SatÄ±ÅŸ: T+2 artar (negatif amount)
        dailyTrades++;
        
        var viopTeminat = teminat.ContainsKey(sym) ? teminat[sym] * nearFilledQty : 0;
        viopUsed -= viopTeminat;
        if (viopUsed < 0) viopUsed = 0;
        AdjustViopBalance(-viopTeminat);  // Teminat serbest (negatif = artar)
        
        // GÃ¼n iÃ§i kar durumunda Ã¶zel loglama
        if (isIntraday) {
            Log("ğŸ’° GÃœN Ä°Ã‡Ä° KAR: Spot:" + spotPnl.ToString("F0") + " Near:" + nearPnl.ToString("F0") + " Net:" + totalPnl.ToString("F0") + " TL (T+0)");
        } else {
            Log("ğŸ’° SN P&L: Spot:" + spotPnl.ToString("F0") + " Near:" + nearPnl.ToString("F0") + " Toplam:" + totalPnl.ToString("F0") + " TL");
        }
        
        // KÄ±smi kapanÄ±ÅŸ mÄ± tam kapanÄ±ÅŸ mÄ±?
        if (nearFilledQty >= nQty && closeSQty >= sQty) {
            // Tam kapanÄ±ÅŸ
            totalClosedSN++;
            snPos.Remove(sym);
            try {
                Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_SPOT," + sym, 0, 0, "X");
                Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + nearC, 0, 0, "X");
            } catch { }
            Log("âœ… SN KAPANDI: " + sym);
        } else {
            // KÄ±smi kapanÄ±ÅŸ - kalan pozisyonu gÃ¼ncelle
            var remainSQty = sQty - closeSQty;
            var remainNQty = nQty - nearFilledQty;
            var newExpPnl = nQty > 0 ? p[5] * remainNQty / nQty : 0;
            snPos[sym] = new decimal[] { remainSQty, remainNQty, p[2], p[3], p[4], newExpPnl, p[6], p[7] };
            try {
                Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_SPOT," + sym, remainSQty, (double)p[2], "SPOT");
                Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + nearC, remainNQty, (double)p[3], "NEAR");
            } catch { }
            Log("âš ï¸ SN KISMÄ° KAPANDI: " + sym + " Kalan S:" + remainSQty + " N:" + remainNQty);
        }
        
        if (SaveDailyStats != null) SaveDailyStats();
    }
    
    SavePositions();
};

// ====================================
// SPOT-NEAR KISMÄ° KAPANIÅ (Sadece gerektiÄŸi kadar kapat)
// ====================================
Func<string, string, int, int, string, bool> PartialCloseSN = (sym, nearC, closeSQty, closeNQty, reason) => {
    if (!snPos.ContainsKey(sym)) return false;
    var p = snPos[sym];
    var totalSQty = (int)p[0];
    var totalNQty = (int)p[1];
    
    // Miktar kontrolÃ¼
    if (closeNQty <= 0 || closeSQty <= 0) {
        Log("âš ï¸ PartialCloseSN: " + sym + " miktar 0, kapanÄ±ÅŸ atlanÄ±yor (S:" + closeSQty + " N:" + closeNQty + ")");
        return false;
    }
    
    // Tam kapanÄ±ÅŸ mÄ±?
    if (closeSQty >= totalSQty || closeNQty >= totalNQty) {
        CloseSN(sym, nearC, totalSQty, totalNQty, reason);
        return true;
    }
    
    Log("ğŸ“Š SN KISMÄ° KAPANIÅ: " + sym + " S:" + closeSQty + "/" + totalSQty + " N:" + closeNQty + "/" + totalNQty + " Sebep: " + reason);
    
    var nearS = FUTURES_PREFIX + nearC;
    var spotS = SPOT_PREFIX + sym;
    
    // Derinlik Ã¶n kontrolÃ¼
    var nearDepthPre = ReadDepth(nearS, "ASK", 0, 3, 100);
    if (!nearDepthPre.Item1) {
        Log("âŒ KÄ±smi KapanÄ±ÅŸ: Near Ask derinlik yok");
        return false;
    }
    
    var spotDepthPre = ReadDepth(spotS, "BID", 0, 3, 100);
    if (!spotDepthPre.Item1) {
        Log("âŒ KÄ±smi KapanÄ±ÅŸ: Spot Bid derinlik yok");
        return false;
    }
    
    // === Ã–NCE Near al (3 deneme GÄ°E) ===
    decimal nearPrice = 0;
    var nearFilledQty = 0;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        var nearAskResult = ReadDepth(nearS, "ASK", 0, 3, 100);
        if (!nearAskResult.Item1) {
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var nearAsk1Price = nearAskResult.Item4;
        var nearAsk1Size = nearAskResult.Item2;
        var nearAsk2Price = nearAskResult.Item5;
        var nearAsk2Size = nearAskResult.Item3;
        var nearTotalSize = GIE_DEPTH_LEVELS >= 2 ? nearAskResult.Item6 : nearAsk1Size;
        
        if (GIE_DEPTH_LEVELS == 1) {
            if (nearAsk1Size < closeNQty) {
                if (attempt == 3) break;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        } else {
            if (nearTotalSize < closeNQty) {
                if (attempt == 3) break;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        }
        
        nearPrice = nearAsk1Price;
        if (GIE_DEPTH_LEVELS >= 2 && nearAsk1Size < closeNQty && nearAsk2Price > 0) {
            nearPrice = nearAsk2Price;
        }
        SendGIE(nearC, "BUY", closeNQty, nearPrice);
        System.Threading.Thread.Sleep(GIE_WAIT_MS);
        
        nearFilledQty = IS_TEST ? closeNQty : CheckFilledQty(nearC, "BUY", closeNQty);
        // Beklenen miktardan fazla olamaz (eski emirler karÄ±ÅŸmasÄ±n)
        if (nearFilledQty > closeNQty) nearFilledQty = closeNQty;
        if (nearFilledQty >= closeNQty) {
            break;  // Tam doldu
        } else if (nearFilledQty > 0) {
            Log("âš ï¸ Near kÄ±smi doldu: " + nearFilledQty + "/" + closeNQty);
            break;  // KÄ±smi doldu - devam et
        }
    }
    
    // HiÃ§ dolmadÄ±ysa garantili yÃ¶ntemle al
    if (nearFilledQty == 0) {
        Log("âš ï¸ Near GÄ°E dolmadÄ±, garantili alÄ±m yapÄ±lÄ±yor");
        var nr = ExecGuar(nearC, "BUY", closeNQty);
        if (nr.Item1 == 0) {
            // Near kapatÄ±lamadÄ± - Spot'a dokunma, pozisyon aynÄ± kalsÄ±n
            Log("âŒ KÄ±smi KapanÄ±ÅŸ: Near kapatÄ±lamadÄ± - iÅŸlem iptal, pozisyon korunuyor");
            return false;
        }
        nearFilledQty = nr.Item1;
        nearPrice = nr.Item2;
    }
    
    // KÄ±smi dolum durumunda oranla Spot hesapla
    var mult = GetMultiplier(sym);
    var actualCloseSQty = (int)Math.Round((decimal)nearFilledQty * mult);  // Near lot -> Spot lot
    if (actualCloseSQty > closeSQty) actualCloseSQty = closeSQty;  // Max istenen miktarÄ± aÅŸma
    if (actualCloseSQty > totalSQty) actualCloseSQty = totalSQty;  // Max pozisyonu aÅŸma
    if (actualCloseSQty == 0) actualCloseSQty = 1;  // En az 1 lot
    
    Log("ğŸ“Š Near dolum: " + nearFilledQty + "/" + closeNQty + " -> Spot kapatÄ±lacak: " + actualCloseSQty + "/" + closeSQty);
    
    // === Near kapandÄ±, ÅŸimdi Spot sat ===
    var sr = ExecGuar(sym, "SELL", actualCloseSQty);
    if (sr.Item1 == 0) {
        // Spot satÄ±lamadÄ± ama Near kapandÄ± - orphan pozisyon!
        Log("âŒ Spot satÄ±lamadÄ± - ORPHAN POZÄ°SYON! KÄ±smi Near kapandÄ±, Spot hala aÃ§Ä±k");
        // Near kapandÄ±, P&L'yi sadece near kÄ±smÄ± iÃ§in hesapla
        var nearPnl = (p[3] - nearPrice) * nearFilledQty * mult;
        var nearComm = CalcCommission(sym, nearPrice, nearFilledQty);
        nearPnl -= nearComm;
        dailyRealizedPnl += nearPnl;
        dailyViopCommission += nearComm;
        var viopTeminat = teminat.ContainsKey(sym) ? teminat[sym] * nearFilledQty : 0;
        viopUsed -= viopTeminat;
        if (viopUsed < 0) viopUsed = 0;
        AdjustViopBalance(-viopTeminat);  // Teminat serbest
        
        var remainNQty = totalNQty - nearFilledQty;
        // Spot deÄŸiÅŸmedi, kalan Near ile gÃ¼ncelle
        var expPnlRatio = totalNQty > 0 ? p[5] * remainNQty / totalNQty : 0;
        snPos[sym] = new decimal[] { totalSQty, remainNQty, p[2], p[3], p[4], expPnlRatio, p[6], p[7] };
        Log("âš ï¸ " + sym + " pozisyon gÃ¼ncellendi: Spot=" + totalSQty + ", Near=" + remainNQty + " (uyumsuz - recovery bekliyor)");
        SavePositions();
        return false;
    }
    
    // === Ä°ki bacak da kapandÄ± - P&L hesapla ===
    var spotPnl = (sr.Item2 - p[2]) * actualCloseSQty;
    var nearPnl2 = (p[3] - nearPrice) * nearFilledQty * mult;
    var totalPnl = spotPnl + nearPnl2;
    
    var spotComm = CalcSpotCommission(sr.Item2, actualCloseSQty);
    var nearComm2 = CalcCommission(sym, nearPrice, nearFilledQty);
    totalPnl -= (spotComm + nearComm2);
    
    dailyRealizedPnl += totalPnl;
    dailySpotCommission += spotComm;
    dailyViopCommission += nearComm2;
    spotUsed -= sr.Item2 * actualCloseSQty;
    if (spotUsed < 0) spotUsed = 0;
    AdjustT2Balance(-(sr.Item2 * actualCloseSQty), spotComm);  // SatÄ±ÅŸ: T+2 artar
    dailyTrades++;
    
    var viopTeminat2 = teminat.ContainsKey(sym) ? teminat[sym] * nearFilledQty : 0;
    viopUsed -= viopTeminat2;
    if (viopUsed < 0) viopUsed = 0;
    AdjustViopBalance(-viopTeminat2);  // Teminat serbest
    
    // Kalan pozisyonu gÃ¼ncelle
    var remainSQty = totalSQty - actualCloseSQty;
    var remainNQty2 = totalNQty - nearFilledQty;
    var expPnlRatio2 = totalSQty > 0 ? p[5] * remainSQty / totalSQty : 0;
    snPos[sym] = new decimal[] { remainSQty, remainNQty2, p[2], p[3], p[4], expPnlRatio2, p[6], p[7] };
    
    // IdealData gÃ¼ncelle
    try {
        Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_SPOT," + sym, remainSQty, (double)p[2], "SPOT");
        Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + nearC, remainNQty2, (double)p[3], "NEAR");
    } catch { }
    
    Log("ğŸ’° SN KISMÄ° P&L: Spot:" + spotPnl.ToString("F0") + " Near:" + nearPnl2.ToString("F0") + " Toplam:" + totalPnl.ToString("F0") + " TL");
    Log("âœ… SN KISMÄ° KAPANDI: " + sym + " Kalan S:" + remainSQty + " N:" + remainNQty2);
    SavePositions();
    return true;
};


// ====================================
// SPOT-NEAR ROLLOVER (Nearâ†’Far) - KontrollÃ¼ GÄ°E
// ====================================
Func<string, string, string, int, bool> RolloverSN = (sym, nearC, farC, nQty) => {
    Log("ğŸ”„ SN ROLLOVER: " + sym + " Nearâ†’Far");
    
    var farS = FUTURES_PREFIX + farC;
    
    // === Ã–NCE Far derinlik kontrolÃ¼ (Near kapatmadan Ã¶nce!) ===
    // Far derinlik Ã¶n kontrolÃ¼
    var farDepthPre = ReadDepth(farS, "BID", 0, 3, 100);
    if (!farDepthPre.Item1) {
        Log("âŒ Rollover: Far derinlik yok, iÅŸlem yapÄ±lmadÄ±");
        return false;
    }
    
    var preBid1Size = farDepthPre.Item2;
    var preTotalSize = GIE_DEPTH_LEVELS >= 2 ? farDepthPre.Item6 : preBid1Size;
    
    if (GIE_DEPTH_LEVELS == 1) {
        if (preBid1Size < nQty) {
            Log("âŒ Rollover: Far 1.kademe yetersiz, iÅŸlem yapÄ±lmadÄ±");
            return false;
        }
    } else {
        if (preTotalSize < nQty) {
            Log("âŒ Rollover: Far 1+2.kademe yetersiz, iÅŸlem yapÄ±lmadÄ±");
            return false;
        }
    }
    
    // === Near kapat (garantili) ===
    var nearResult = ExecGuar(nearC, "BUY", nQty);
    if (nearResult.Item1 == 0) {
        Log("âŒ Rollover: Near kapatÄ±lamadÄ±");
        return false;
    }
    
    // === Far aÃ§ (3 deneme) ===
    decimal farPrice = 0;
    var filled = false;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        // Derinlik oku
        var farDepthResult = ReadDepth(farS, "BID", 0, 3, 100);
        if (!farDepthResult.Item1) {
            Log("â³ Far Bid boÅŸ (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var farBid1Price = farDepthResult.Item4;
        var farBid1Size = farDepthResult.Item2;
        var farBid2Price = farDepthResult.Item5;
        var farBid2Size = farDepthResult.Item3;
        var farTotalSize = GIE_DEPTH_LEVELS >= 2 ? farDepthResult.Item6 : farBid1Size;
        
        if (GIE_DEPTH_LEVELS == 1) {
            if (farBid1Size < nQty) {
                Log("â³ Far Bid 1.kademe yetersiz (deneme " + attempt + "/3)");
                if (attempt == 3) break;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        } else {
            if (farTotalSize < nQty) {
                Log("â³ Far Bid 1+2.kademe yetersiz (deneme " + attempt + "/3)");
                if (attempt == 3) break;
                System.Threading.Thread.Sleep(200);
                continue;
            }
        }
        
        farPrice = farBid1Price;
        if (GIE_DEPTH_LEVELS >= 2 && farBid1Size < nQty && farBid2Price > 0) {
            farPrice = farBid2Price;
        }
        SendGIE(farC, "SELL", nQty, farPrice);
        System.Threading.Thread.Sleep(GIE_WAIT_MS);
        
        if (IS_TEST || CheckFilled(farC, "SELL", nQty)) {
            filled = true;
            break;
        }
        
        Log("â³ Far dolmadÄ± (deneme " + attempt + "/3)");
    }
    
    if (!filled) {
        Log("âŒ Rollover: Far 3 denemede dolmadÄ± - Spot kapatÄ±lÄ±yor");
        // Spot'u garantili emirle sat
        var spotQty = (int)snPos[sym][0];
        var spotResult = ExecGuar(sym, "SELL", spotQty);
        
        // Pozisyon kapat ve kaydet
        var p = snPos[sym];
        var pnl = p[5];  // Mevcut beklenen PnL
        dailySNPnl += pnl;
        totalClosedSN++;
        
        // Bakiye gÃ¼ncellemeleri
        var spotValue = p[2] * spotQty;  // spotEntry * spotQty
        spotUsed -= spotValue;
        if (spotUsed < 0) spotUsed = 0;
        var spotCommRoll = CalcSpotCommission(spotResult.Item2, spotQty);
        AdjustT2Balance(-spotValue, spotCommRoll);  // SatÄ±ÅŸ
        
        var viopTeminatRoll = teminat.ContainsKey(sym) ? teminat[sym] * nQty : 0;
        viopUsed -= viopTeminatRoll;
        if (viopUsed < 0) viopUsed = 0;
        AdjustViopBalance(-viopTeminatRoll);  // Teminat serbest (Near zaten kapatÄ±lmÄ±ÅŸtÄ±)
        
        snPos.Remove(sym);
        SavePositions();
        Log("âœ… Pozisyon kapatÄ±ldÄ± (Rollover baÅŸarÄ±sÄ±z): " + sym);
        return false;
    }
    
    // === Pozisyon gÃ¼ncelle (Spot aynÄ± kalÄ±yor!) ===
    var pos = snPos[sym];
    var spotEntry = pos[2];
    if (spotEntry <= 0) {
        Log("âŒ Rollover: Spot entry sÄ±fÄ±r, pozisyon gÃ¼ncelleme atlanÄ±yor");
        return false;
    }
    var newSpread = (farPrice - spotEntry) / spotEntry;
    var newExpectedPnl = newSpread * spotEntry * pos[0];
    var nearComm = CalcCommission(sym, nearResult.Item2, nQty);
    var farComm = CalcCommission(sym, farPrice, nQty);
    newExpectedPnl -= (nearComm + farComm);
    dailyViopCommission += nearComm + farComm;
    
    snPos[sym] = new decimal[] { pos[0], nQty, spotEntry, farPrice, newSpread, newExpectedPnl, 0, DateTime.Now.Ticks };
    
    // IdealData pozisyon listesini gÃ¼ncelle
    try {
        Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + nearC, 0, 0, "X");
        Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + farC, nQty, (double)farPrice, "NEAR");
    } catch { }
    
    Log("âœ… SN ROLLOVER: " + sym + " Near:" + nearResult.Item2.ToString("F2") + "â†’Far:" + farPrice.ToString("F2") + " Spread:" + (newSpread * 100).ToString("F3") + "%");
    SavePositions();
    return true;
};

// ====================================
// KAPANIÅ KOÅULLARI
// ====================================
Func<string, string, decimal, decimal, int, decimal, string> CheckSNClose = 
    (sym, nearC, spotBid, nearAsk, daysN, currentBBPos) => {
    
    if (!snPos.ContainsKey(sym)) return null;
    var p = snPos[sym];
    var sQty = (int)p[0];
    var nQty = (int)p[1];
    
    // Near 0 ise kapanÄ±ÅŸ kontrolÃ¼ yapma (yetim pozisyon - recovery halledecek)
    if (nQty <= 0) return null;
    
    var spotEntry = p[2];
    var nearEntry = p[3];
    // p[4] = entrySpread, p[5] = expectedPnl, p[6] = bb93Flag, p[7] = entryTicks
    var bb93Flag = p.Length > 6 ? (int)p[6] : 0;
    var entryTicks = p.Length > 7 ? (long)p[7] : 0L;
    var expectedPnl = p[5];
    var entrySpread = p[4];
    
    var spotSym = SPOT_PREFIX + sym;
    var nearSym = FUTURES_PREFIX + nearC;
    
    // TAVAN/TABAN KONTROLÃœ - P&L HESABI
    // KapanÄ±ÅŸ iÃ§in: Spot SATIYORUZ (spotBid) + Near ALIYORUZ (nearAsk)
    //
    // TAVAN = SatÄ±cÄ± yok = Ask tarafÄ± boÅŸ/0 = AlÄ±ÅŸ fiyatÄ± tavana yapÄ±ÅŸÄ±k
    // TABAN = AlÄ±cÄ± yok = Bid tarafÄ± boÅŸ/0 = SatÄ±ÅŸ fiyatÄ± tabana yapÄ±ÅŸÄ±k
    //
    // Spot tavan: spotBid normal (alÄ±cÄ±lar tavanda bekliyor), satÄ±labilir AMA fiyat tavanda
    // Spot taban: spotBid = 0 veya taban fiyatÄ± (alÄ±cÄ± yok), SATILAMAZ
    // Near tavan: nearAsk = 0 veya tavan fiyatÄ± (satÄ±cÄ± yok), ALINAMAZ  
    // Near taban: nearAsk normal (satÄ±cÄ±lar tabanda bekliyor), alÄ±nabilir AMA fiyat tabanda
    
    // P&L hesabÄ± iÃ§in fiyat dÃ¼zeltmeleri
    var spotBidForPnL = spotBid;
    var nearAskForPnL = nearAsk;
    
    // Spot tavan kontrolÃ¼ (Bid tarafÄ± tavana yapÄ±ÅŸÄ±k mÄ±?)
    var spotTavanFiyat = tavanFiyat.ContainsKey(spotSym) ? tavanFiyat[spotSym] : 0;
    var spotTavanda = spotTavanFiyat > 0 && spotBid >= spotTavanFiyat;
    if (spotTavanda) spotBidForPnL = spotTavanFiyat;  // Tavanda satÄ±labilir
    
    // Spot taban kontrolÃ¼ (Bid = 0 veya taban?)
    var spotTabanFiyat = tabanFiyat.ContainsKey(spotSym) ? tabanFiyat[spotSym] : 0;
    var spotTabanda = spotTabanFiyat > 0 && (spotBid <= 0 || spotBid <= spotTabanFiyat);
    if (spotTabanda) {
        spotBidForPnL = spotTabanFiyat;  // P&L hesabÄ± iÃ§in taban fiyatÄ± kullan
        // Spot tabanda â†’ SATILAMAZ â†’ pozisyon kapatÄ±lamaz (vade sonu hariÃ§)
        if (daysN > 0) return null;
    }
    
    // Near tavan kontrolÃ¼ (Ask = 0 veya tavan?)
    var nearTavanFiyat = tavanFiyat.ContainsKey(nearSym) ? tavanFiyat[nearSym] : 0;
    var nearTavanda = nearTavanFiyat > 0 && (nearAsk <= 0 || nearAsk >= nearTavanFiyat);
    if (nearTavanda) {
        nearAskForPnL = nearTavanFiyat;  // P&L hesabÄ± iÃ§in tavan fiyatÄ± kullan
        // Near tavanda â†’ ALINAMAZ â†’ pozisyon kapatÄ±lamaz (vade sonu hariÃ§)
        if (daysN > 0) return null;
    }
    
    // Near taban kontrolÃ¼ (Ask tarafÄ± tabana yapÄ±ÅŸÄ±k mÄ±?)
    var nearTabanFiyat = tabanFiyat.ContainsKey(nearSym) ? tabanFiyat[nearSym] : 0;
    var nearTabanda = nearTabanFiyat > 0 && nearAsk <= nearTabanFiyat;
    if (nearTabanda) nearAskForPnL = nearTabanFiyat;  // Tabanda alÄ±nabilir
    
    // nearAsk direkt kullanÄ±lÄ±yor (dayanakSatAl yerine)
    var mult = GetMultiplier(sym);
    var closePnl = (spotBidForPnL - spotEntry) * sQty + (nearEntry - nearAskForPnL) * nQty * mult;
    var closeComm = CalcSpotCommission(spotBidForPnL, sQty) + CalcCommission(sym, nearAskForPnL, nQty);
    closePnl -= closeComm;
    
    // Mevcut spread hesapla
    var currentSpread = spotBidForPnL > 0 ? (nearAskForPnL - spotBidForPnL) / spotBidForPnL : 0;
    var spreadDaralma = entrySpread - currentSpread;  // Pozitif = spread daraldÄ± (iyi)
    
    // 1. VADE SONU - ZORUNLU (12:00 sonrasÄ± - yarÄ±m gÃ¼n vade 12:30 kapanÄ±ÅŸÄ±na 30dk marj)
    if (daysN <= 0) {
        var expiryNow = DateTime.Now;
        var expiryMinutes = expiryNow.Hour * 60 + expiryNow.Minute;
        if (expiryMinutes >= 12 * 60) {  // 12:00 sonrasÄ±
            return "EXPIRY_MANDATORY";
        }
        // 12:00 Ã¶ncesi - henÃ¼z kapatma
        return null;
    }
    
    // 2. GÃœNLÃœK ZARAR
    if (dailyRealizedPnl <= -MAX_DAILY_LOSS) return "DAILY_LOSS";
    
    // 3. BB93+ POZÄ°SYON KAPANIS KONTROLÃœ (gÃ¼n iÃ§i kar mekanizmasÄ±na entegre)
    // BB93+ giriÅŸleri iÃ§in: BB <= 15 VEYA spread >= %0.23 daralma
    if (bb93Flag == 1 && BB93_ENTRY_ENABLED) {
        // Ã‡Ä±kÄ±ÅŸ koÅŸullarÄ±: BB <= 15 VEYA spread daralmasÄ± >= %0.23
        if (currentBBPos >= 0 && currentBBPos <= BB93_EXIT_BB) {
            var spotPnl = (spotBidForPnL - spotEntry) * sQty - CalcSpotCommission(spotBidForPnL, sQty);
            var nearPnl = (nearEntry - nearAskForPnL) * nQty * mult - CalcCommission(sym, nearAskForPnL, nQty);
            return "INTRADAY_BB93_BB|" + closePnl.ToString("F0") + "|" + spotPnl.ToString("F0") + "|" + nearPnl.ToString("F0") + "|BB:" + currentBBPos.ToString("F0");
        }
        if (spreadDaralma >= BB93_EXIT_SPREAD) {
            var spotPnl = (spotBidForPnL - spotEntry) * sQty - CalcSpotCommission(spotBidForPnL, sQty);
            var nearPnl = (nearEntry - nearAskForPnL) * nQty * mult - CalcCommission(sym, nearAskForPnL, nQty);
            return "INTRADAY_BB93_SPREAD|" + closePnl.ToString("F0") + "|" + spotPnl.ToString("F0") + "|" + nearPnl.ToString("F0") + "|D:" + (spreadDaralma * 100).ToString("F2") + "%";
        }
        // BB93+ pozisyonlarÄ± iÃ§in sadece bu koÅŸullar geÃ§erli - diÄŸer koÅŸullar uygulanmaz
        return null;
    }
    
    // 4. GÃœN Ä°Ã‡Ä° KAR (T+0 - sadece bugÃ¼n aÃ§Ä±lan pozisyonlar, BB93+ hariÃ§)
    var entryDate = new DateTime(entryTicks).Date;
    if (entryDate == DateTime.Now.Date && daysN > 0) {
        var spotValue = spotBidForPnL * sQty;
        if (spotValue > 0) {  // spotValue sÄ±fÄ±r kontrolÃ¼
            var minimumKar = spotValue * INTRADAY_MIN_PROFIT;  // Ayarlanabilir minimum
            var gunIciKarOrani = closePnl / spotValue;
            var gunlukTasimaGetirisi = (expectedPnl / spotValue) / daysN;  // vade sonuna kadar taÅŸÄ±ma varsayÄ±mÄ±
            
            // GÃ¼n iÃ§i kapat: minimum kar VE taÅŸÄ±maktan daha karlÄ±
            if (closePnl >= minimumKar && gunIciKarOrani >= gunlukTasimaGetirisi) {
                // Spot ve Near kar/zarar ayrÄ± hesapla (loglama iÃ§in)
                var spotPnl = (spotBidForPnL - spotEntry) * sQty - CalcSpotCommission(spotBidForPnL, sQty);
                var nearPnl = (nearEntry - nearAskForPnL) * nQty * mult - CalcCommission(sym, nearAskForPnL, nQty);
                return "INTRADAY_PROFIT|" + closePnl.ToString("F0") + "|" + spotPnl.ToString("F0") + "|" + nearPnl.ToString("F0");
            }
        }
    }
    
    // 5. ERKEN KAPANIÅ - DÄ°NAMÄ°K K FORMÃœLÃœ
    // MantÄ±k: GeÃ§en sÃ¼renin karÅŸÄ±lÄ±ÄŸÄ±nÄ± aldÄ±n mÄ±?
    // earnedTarget = expectedPnl Ã— elapsedRatio Ã— (1 + k)
    // k = EARLY_EXIT_K Ã— remainingRatio (vade sonuna yaklaÅŸtÄ±kÃ§a k dÃ¼ÅŸer)
    if (expectedPnl > 0 && entryTicks > 0) {
        var entryTime = new DateTime(entryTicks);
        var hoursElapsed = (decimal)(DateTime.Now - entryTime).TotalHours;
        var hoursTotal = (decimal)GetHours(nearC) + hoursElapsed;
        
        if (hoursTotal > 0 && hoursElapsed > 0) {
            var elapsedRatio = hoursElapsed / hoursTotal;       // GeÃ§en sÃ¼re oranÄ± (0-1)
            var remainingRatio = 1m - elapsedRatio;             // Kalan sÃ¼re oranÄ± (0-1)
            var k = EARLY_EXIT_K * remainingRatio;              // Dinamik marj
            var earnedTarget = expectedPnl * elapsedRatio * (1m + k);  // Hedef kÃ¢r
            
            // Hedef kÃ¢rÄ± yakaladÄ±k VE BB5 dÃ¼ÅŸÃ¼k (spread sakin)
            if (closePnl >= earnedTarget && currentBBPos < BB_EXIT_HELPER && currentBBPos > 0) {
                var profitPct = expectedPnl > 0 ? (closePnl / expectedPnl * 100m).ToString("F0") : "âˆ";
                var targetPct = expectedPnl > 0 ? (earnedTarget / expectedPnl * 100m).ToString("F0") : "âˆ";
                Log("ğŸ“Š ERKEN KAPANIÅ: " + sym + " KÃ¢r:" + profitPct + "% Hedef:" + targetPct + 
                    "% (k:" + k.ToString("F3") + " geÃ§en:" + (elapsedRatio * 100).ToString("F0") + "%) BB5:" + currentBBPos.ToString("F0"));
                return "EARLY_EXIT";
            }
        }
    }
    
    return null;
};

// ====================================
// NEAR-FAR (NF) STRATEJÄ°SÄ° FONKSÄ°YONLARI
// ====================================
// Near AL + Far SAT (takvim spread arbitrajÄ±)
// Pozisyon: nfPos[sym] = [nearQty, farQty, nearEntry, farEntry, entrySpread, expectedPnl, entryTicks]

// NF Spread hesapla (Far - Near) / Near
Func<string, string, decimal, decimal, decimal> CalcNFSpread = (nearC, farC, nearPrice, farPrice) => {
    if (nearPrice <= 0) return 0;
    return (farPrice - nearPrice) / nearPrice;
};

// NF pozisyon aÃ§: Near AL + Far SAT
// GIE sÄ±rasÄ±: Ã–nce Far SAT (likit olmayan taraf), sonra Near AL
Func<string, string, string, int, bool> OpenNF = (sym, nearC, farC, qty) => {
    // Pair Trading iÃ§in yasaklÄ± sembol kontrolÃ¼
    if (PAIR_BLOCKED.Contains(sym)) {
        return false;  // Sessizce atla (normal durum)
    }
    
    if (nfPos.Count >= NF_MAX_POSITIONS) {
        Log("âš ï¸ NF: Maksimum pozisyon sayÄ±sÄ±na ulaÅŸÄ±ldÄ± (" + NF_MAX_POSITIONS + ")");
        return false;
    }
    
    // Ã‡akÄ±ÅŸma kontrolÃ¼: Spot-Near'da bu sembol varsa NF aÃ§Ä±lamaz
    if (snPos.ContainsKey(sym)) {
        Log("âš ï¸ NF: " + sym + " Spot-Near pozisyonu var, NF aÃ§Ä±lamaz");
        return false;
    }
    
    // TemettÃ¼ kontrolÃ¼: Near-Far arasÄ± temettÃ¼ varsa spread hesabÄ±nÄ± etkiler
    var nearExpiry = GetExpiryDate(nearC);
    var farExpiry = GetExpiryDate(farC);
    var divCheck = GetDividendsBetween(sym, nearExpiry, farExpiry);
    var hasDividend = divCheck.Item1;
    var dividendAmount = divCheck.Item2;
    
    if (hasDividend) {
        // TemettÃ¼ varsa, spread hesabÄ±na dahil et
        // Far fiyatÄ± temettÃ¼ kadar dÃ¼ÅŸÃ¼k olmalÄ± (zaten dÃ¼ÅŸmÃ¼ÅŸ olabilir)
        // UyarÄ± ver ama pozisyon aÃ§Ä±lmasÄ±nÄ± engelleme (spread zaten ayarlanmÄ±ÅŸ olmalÄ±)
        Log("ğŸ“Š NF: " + sym + " Near-Far arasÄ± temettÃ¼: " + dividendAmount.ToString("F4") + " TL/hisse");
    }
    
    var nearSym = FUTURES_PREFIX + nearC;
    var farSym = FUTURES_PREFIX + farC;
    
    // Tavan/Taban kontrolÃ¼
    // Near ALIYORUZ â†’ Near tavan ise alÄ±namaz
    var nearTavanFiyat = tavanFiyat.ContainsKey(nearSym) ? tavanFiyat[nearSym] : 0;
    if (nearTavanFiyat > 0) {
        var nearAskFiyat = (decimal)Sistem.AlisFiyat(nearSym);
        if (nearAskFiyat >= nearTavanFiyat) {
            Log("âš ï¸ NF: " + sym + " Near TAVANDA - alÄ±namaz");
            return false;
        }
    }
    
    // Far SATIYORUZ â†’ Far taban ise satÄ±lamaz
    var farTabanFiyat = tabanFiyat.ContainsKey(farSym) ? tabanFiyat[farSym] : 0;
    if (farTabanFiyat > 0) {
        var farBidFiyat = (decimal)Sistem.SatisFiyat(farSym);
        if (farBidFiyat <= farTabanFiyat) {
            Log("âš ï¸ NF: " + sym + " Far TABANDA - satÄ±lamaz");
            return false;
        }
    }
    
    Log("ğŸ”· NF AÃ‡ILIÅ: " + sym + " Near:" + nearC + " Far:" + farC + " Qty:" + qty);
    
    // === Ã–N KONTROL: Near Ask derinliÄŸi var mÄ±? ===
    // Far SHORT aÃ§madan Ã–NCE Near'da likidite olduÄŸundan emin ol
    // Yoksa Far'Ä± sattÄ±ktan sonra geri almak Ã§ok pahalÄ± olabilir
    var preCheckNearAsk = ReadDepth(nearSym, "ASK", 0, 3, 100);
    if (!preCheckNearAsk.Item1 || preCheckNearAsk.Item2 < qty) {
        Log("âš ï¸ NF: " + sym + " Near Ask derinliÄŸi yetersiz (" + preCheckNearAsk.Item2 + "<" + qty + ") - iÅŸlem iptal");
        return false;
    }
    
    // === Ã–NCE Far SAT (3 deneme GIE) ===
    decimal farPrice = 0;
    var farFilledQty = 0;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        var farBidResult = ReadDepth(farSym, "BID", 0, 3, 100);
        if (!farBidResult.Item1) {
            Log("â³ Far Bid boÅŸ (deneme " + attempt + "/3)");
            if (attempt == 3) {
                Log("âŒ NF: Far SAT baÅŸarÄ±sÄ±z - derinlik yok");
                return false;
            }
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var farBid1Size = farBidResult.Item2;
        var farBid1Price = farBidResult.Item4;
        
        if (farBid1Size < qty) {
            Log("â³ Far Bid kademe yetersiz (deneme " + attempt + "/3)");
            if (attempt == 3) {
                Log("âŒ NF: Far SAT baÅŸarÄ±sÄ±z - derinlik yetersiz");
                return false;
            }
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        // Far SAT emri
        farPrice = farBid1Price;
        var farOrderId = IS_TEST ? "TEST_NF_FAR_" + DateTime.Now.Ticks : 
            Sistem.Sat(farSym, (double)farPrice, qty).ToString();
        
        if (string.IsNullOrEmpty(farOrderId) || farOrderId == "0") {
            Log("âŒ NF: Far SAT emri baÅŸarÄ±sÄ±z");
            if (attempt == 3) return false;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        // Dolum kontrolÃ¼
        System.Threading.Thread.Sleep(300);
        var farFilled = IS_TEST ? qty : (int)Sistem.GerceklesenLot(farSym);
        
        if (farFilled >= qty) {
            farFilledQty = qty;
            var farComm = CalcCommission(sym, farPrice, qty);
            Log("âœ… NF Far SAT: " + farSym + " " + qty + " lot @ " + farPrice.ToString("F2") + " Kom:" + farComm.ToString("F2"));
            break;
        } else {
            // KÄ±smi dolum veya dolum yok - iptal et
            if (!IS_TEST) Sistem.EmirIptal(farSym);
            Log("âš ï¸ Far kÄ±smi dolum: " + farFilled + "/" + qty + " (deneme " + attempt + "/3)");
            if (attempt == 3) {
                Log("âŒ NF: Far SAT baÅŸarÄ±sÄ±z - dolum yok");
                return false;
            }
            System.Threading.Thread.Sleep(500);
        }
    }
    
    if (farFilledQty == 0) {
        Log("âŒ NF: Far SAT baÅŸarÄ±sÄ±z");
        return false;
    }
    
    // === SONRA Near AL (3 deneme GIE) ===
    decimal nearPrice = 0;
    var nearFilledQty = 0;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        var nearAskResult = ReadDepth(nearSym, "ASK", 0, 3, 100);
        if (!nearAskResult.Item1) {
            Log("â³ Near Ask boÅŸ (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        var nearAsk1Size = nearAskResult.Item2;
        var nearAsk1Price = nearAskResult.Item4;
        
        if (nearAsk1Size < qty) {
            Log("â³ Near Ask kademe yetersiz (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        // Near AL emri
        nearPrice = nearAsk1Price;
        var nearOrderId = IS_TEST ? "TEST_NF_NEAR_" + DateTime.Now.Ticks :
            Sistem.Al(nearSym, (double)nearPrice, qty).ToString();
        
        if (string.IsNullOrEmpty(nearOrderId) || nearOrderId == "0") {
            Log("âŒ NF: Near AL emri baÅŸarÄ±sÄ±z");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        // Dolum kontrolÃ¼
        System.Threading.Thread.Sleep(300);
        var nearFilled = IS_TEST ? qty : (int)Sistem.GerceklesenLot(nearSym);
        
        if (nearFilled >= qty) {
            nearFilledQty = qty;
            var nearComm = CalcCommission(sym, nearPrice, qty);
            Log("âœ… NF Near AL: " + nearSym + " " + qty + " lot @ " + nearPrice.ToString("F2") + " Kom:" + nearComm.ToString("F2"));
            break;
        } else {
            // KÄ±smi dolum veya dolum yok - iptal et
            if (!IS_TEST) Sistem.EmirIptal(nearSym);
            Log("âš ï¸ Near kÄ±smi dolum: " + nearFilled + "/" + qty + " (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(500);
        }
    }
    
    // Near baÅŸarÄ±sÄ±z olduysa Far'Ä± geri al
    if (nearFilledQty == 0) {
        Log("âš ï¸ NF: Near AL baÅŸarÄ±sÄ±z, Far geri alÄ±nÄ±yor...");
        // Far'Ä± geri al (Far AL)
        for (int attempt = 1; attempt <= 3; attempt++) {
            var farAskResult = ReadDepth(farSym, "ASK", 0, 3, 100);
            if (farAskResult.Item1 && farAskResult.Item2 >= farFilledQty) {
                var buyBackPrice = farAskResult.Item4;
                var buyBackId = IS_TEST ? "TEST_NF_BUYBACK_" + DateTime.Now.Ticks :
                    Sistem.Al(farSym, (double)buyBackPrice, farFilledQty).ToString();
                System.Threading.Thread.Sleep(300);
                var buyBackFilled = IS_TEST ? farFilledQty : (int)Sistem.GerceklesenLot(farSym);
                if (buyBackFilled >= farFilledQty) {
                    Log("âœ… NF Far geri alÄ±ndÄ±: " + farFilledQty + " lot @ " + buyBackPrice.ToString("F2"));
                    break;
                }
            }
            System.Threading.Thread.Sleep(500);
        }
        return false;
    }
    
    // Pozisyonu kaydet
    var entrySpread = CalcNFSpread(nearC, farC, nearPrice, farPrice);
    var mult = GetMultiplier(sym);
    var openComm = CalcCommission(sym, nearPrice, qty) + CalcCommission(sym, farPrice, qty);
    var expectedPnl = entrySpread * nearPrice * qty * mult - openComm * 2;
    
    nfPos[sym] = new decimal[] { 
        qty,                    // [0] nearQty
        qty,                    // [1] farQty
        nearPrice,              // [2] nearEntry
        farPrice,               // [3] farEntry
        entrySpread,            // [4] entrySpread
        expectedPnl,            // [5] expectedPnl
        DateTime.Now.Ticks      // [6] entryTicks
    };
    
    // Kontrat kodlarÄ±nÄ± sakla (vade geÃ§iÅŸinde doÄŸru kontratlarÄ± bulmak iÃ§in)
    nfContracts[sym] = new string[] { nearC, farC };
    
    // VIOP kullanÄ±mÄ±nÄ± gÃ¼ncelle
    var temNear = teminat.ContainsKey(sym) ? teminat[sym] : 5000m;
    var temFar = temNear;  // Far teminatÄ± da aynÄ± varsayÄ±lÄ±r
    nfViopUsed += temNear + temFar;
    
    Log("âœ… NF AÃ‡ILDI: " + sym + " N:" + nearPrice.ToString("F2") + " F:" + farPrice.ToString("F2") + 
        " Spread:" + (entrySpread * 100).ToString("F3") + "% Beklenen:" + expectedPnl.ToString("F0"));
    
    SavePositions();
    return true;
};

// NF pozisyon kapat: Near SAT + Far AL
// GIE sÄ±rasÄ±: Ã–nce Far AL (likit olmayan taraf), sonra Near SAT
Action<string, string, string, int, int, string> CloseNF = (sym, nearC, farC, nearQty, farQty, reason) => {
    if (!nfPos.ContainsKey(sym)) return;
    
    var nearSym = FUTURES_PREFIX + nearC;
    var farSym = FUTURES_PREFIX + farC;
    
    // Tavan/Taban kontrolÃ¼
    // Far ALIYORUZ â†’ Far tavan ise alÄ±namaz
    var farTavanFiyat = tavanFiyat.ContainsKey(farSym) ? tavanFiyat[farSym] : 0;
    if (farTavanFiyat > 0) {
        var farAskFiyat = (decimal)Sistem.AlisFiyat(farSym);
        if (farAskFiyat >= farTavanFiyat) {
            if (!reason.StartsWith("EXPIRY")) {
                Log("âš ï¸ CloseNF: " + sym + " Far TAVANDA - alÄ±namaz, kapanÄ±ÅŸ atlanÄ±yor");
                return;
            }
        }
    }
    
    // Near SATIYORUZ â†’ Near taban ise satÄ±lamaz
    var nearTabanFiyat = tabanFiyat.ContainsKey(nearSym) ? tabanFiyat[nearSym] : 0;
    if (nearTabanFiyat > 0) {
        var nearBidFiyat = (decimal)Sistem.SatisFiyat(nearSym);
        if (nearBidFiyat <= nearTabanFiyat) {
            if (!reason.StartsWith("EXPIRY")) {
                Log("âš ï¸ CloseNF: " + sym + " Near TABANDA - satÄ±lamaz, kapanÄ±ÅŸ atlanÄ±yor");
                return;
            }
        }
    }
    
    Log("ğŸ”¶ NF KAPANIÅ: " + sym + " Sebep: " + reason);
    
    var p = nfPos[sym];
    var nearEntry = p[2];
    var farEntry = p[3];
    
    // === Ã–N KONTROL: Near Bid derinliÄŸi var mÄ±? ===
    // Far AL Ã¶ncesi Near'da alÄ±cÄ± olduÄŸundan emin ol
    // Yoksa Far'Ä± aldÄ±ktan sonra geri satmak pahalÄ± olabilir
    var preCheckNearBid = ReadDepth(nearSym, "BID", 0, 3, 100);
    if (!preCheckNearBid.Item1 || preCheckNearBid.Item2 < nearQty) {
        if (!reason.StartsWith("EXPIRY")) {  // Vade gÃ¼nÃ¼ zorla kapat
            Log("âš ï¸ NF: " + sym + " Near Bid derinliÄŸi yetersiz (" + preCheckNearBid.Item2 + "<" + nearQty + ") - kapanÄ±ÅŸ ertelendi");
            return;
        }
    }
    
    // === Ã–NCE Far AL (3 deneme GIE) ===
    decimal farPrice = 0;
    var farFilledQty = 0;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        var farAskResult = ReadDepth(farSym, "ASK", 0, 3, 100);
        if (!farAskResult.Item1 || farAskResult.Item2 < farQty) {
            Log("â³ Far Ask yetersiz (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        farPrice = farAskResult.Item4;
        var farOrderId = IS_TEST ? "TEST_NF_CLOSE_FAR_" + DateTime.Now.Ticks :
            Sistem.Al(farSym, (double)farPrice, farQty).ToString();
        
        if (string.IsNullOrEmpty(farOrderId) || farOrderId == "0") {
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        System.Threading.Thread.Sleep(300);
        var farFilled = IS_TEST ? farQty : (int)Sistem.GerceklesenLot(farSym);
        
        if (farFilled >= farQty) {
            farFilledQty = farQty;
            Log("âœ… NF Far AL: " + farSym + " " + farQty + " lot @ " + farPrice.ToString("F2"));
            break;
        } else {
            if (!IS_TEST) Sistem.EmirIptal(farSym);
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(500);
        }
    }
    
    if (farFilledQty == 0) {
        Log("âŒ NF: Far AL baÅŸarÄ±sÄ±z - kapanÄ±ÅŸ iptal");
        return;
    }
    
    // === SONRA Near SAT (3 deneme GIE) ===
    decimal nearPrice = 0;
    var nearFilledQty = 0;
    
    for (int attempt = 1; attempt <= 3; attempt++) {
        var nearBidResult = ReadDepth(nearSym, "BID", 0, 3, 100);
        if (!nearBidResult.Item1 || nearBidResult.Item2 < nearQty) {
            Log("â³ Near Bid yetersiz (deneme " + attempt + "/3)");
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        nearPrice = nearBidResult.Item4;
        var nearOrderId = IS_TEST ? "TEST_NF_CLOSE_NEAR_" + DateTime.Now.Ticks :
            Sistem.Sat(nearSym, (double)nearPrice, nearQty).ToString();
        
        if (string.IsNullOrEmpty(nearOrderId) || nearOrderId == "0") {
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(200);
            continue;
        }
        
        System.Threading.Thread.Sleep(300);
        var nearFilled = IS_TEST ? nearQty : (int)Sistem.GerceklesenLot(nearSym);
        
        if (nearFilled >= nearQty) {
            nearFilledQty = nearQty;
            Log("âœ… NF Near SAT: " + nearSym + " " + nearQty + " lot @ " + nearPrice.ToString("F2"));
            break;
        } else {
            if (!IS_TEST) Sistem.EmirIptal(nearSym);
            if (attempt == 3) break;
            System.Threading.Thread.Sleep(500);
        }
    }
    
    // Near baÅŸarÄ±sÄ±z olduysa Far'Ä± geri sat
    if (nearFilledQty == 0) {
        Log("âš ï¸ NF: Near SAT baÅŸarÄ±sÄ±z, Far geri satÄ±lÄ±yor...");
        for (int attempt = 1; attempt <= 3; attempt++) {
            var farBidResult = ReadDepth(farSym, "BID", 0, 3, 100);
            if (farBidResult.Item1 && farBidResult.Item2 >= farFilledQty) {
                var sellBackPrice = farBidResult.Item4;
                var sellBackId = IS_TEST ? "TEST_NF_SELLBACK_" + DateTime.Now.Ticks :
                    Sistem.Sat(farSym, (double)sellBackPrice, farFilledQty).ToString();
                System.Threading.Thread.Sleep(300);
                Log("âœ… NF Far geri satÄ±ldÄ±");
                break;
            }
            System.Threading.Thread.Sleep(500);
        }
        return;
    }
    
    // P&L hesapla
    var mult = GetMultiplier(sym);
    var nearPnl = (nearPrice - nearEntry) * nearQty * mult;  // Near aldÄ±k, ÅŸimdi satÄ±yoruz
    var farPnl = (farEntry - farPrice) * farQty * mult;      // Far sattÄ±k, ÅŸimdi alÄ±yoruz
    var closeComm = CalcCommission(sym, nearPrice, nearQty) + CalcCommission(sym, farPrice, farQty);
    var totalPnl = nearPnl + farPnl - closeComm;
    
    dailyRealizedPnl += totalPnl;
    dailyTrades++;
    dailyViopCommission += closeComm;
    
    // VIOP kullanÄ±mÄ±nÄ± gÃ¼ncelle
    var temNear = teminat.ContainsKey(sym) ? teminat[sym] : 5000m;
    nfViopUsed -= temNear * 2;
    if (nfViopUsed < 0) nfViopUsed = 0;
    
    Log("âœ… NF KAPANDI: " + sym + " P&L:" + totalPnl.ToString("F0") + " (Near:" + nearPnl.ToString("F0") + " Far:" + farPnl.ToString("F0") + ")");
    
    nfPos.Remove(sym);
    if (nfContracts.ContainsKey(sym)) nfContracts.Remove(sym);
    SavePositions();
};

// NF kapanÄ±ÅŸ koÅŸullarÄ±nÄ± kontrol et
Func<string, string, string, decimal, decimal, int, string> CheckNFClose = 
    (sym, nearC, farC, nearBid, farAsk, daysN) => {
    
    if (!nfPos.ContainsKey(sym)) return null;
    var p = nfPos[sym];
    var nearQty = (int)p[0];
    var farQty = (int)p[1];
    var nearEntry = p[2];
    var farEntry = p[3];
    var entrySpread = p[4];
    
    // Near vade sonu kontrolÃ¼ (12:00 sonrasÄ± - yarÄ±m gÃ¼n 12:30 kapanÄ±ÅŸÄ±na 30dk marj)
    if (daysN <= 0) {
        var expiryNow = DateTime.Now;
        var expiryMinutes = expiryNow.Hour * 60 + expiryNow.Minute;
        if (expiryMinutes >= 12 * 60) {  // 12:00 sonrasÄ±
            return "NF_EXPIRY";
        }
        return null;  // 12:00 Ã¶ncesi bekle
    }
    
    // P&L hesapla (kapanÄ±ÅŸ iÃ§in: Near SAT @ nearBid, Far AL @ farAsk)
    var mult = GetMultiplier(sym);
    var nearPnl = (nearBid - nearEntry) * nearQty * mult;
    var farPnl = (farEntry - farAsk) * farQty * mult;
    var closeComm = CalcCommission(sym, nearBid, nearQty) + CalcCommission(sym, farAsk, farQty);
    var closePnl = nearPnl + farPnl - closeComm;
    
    // Pozisyon deÄŸeri
    var posValue = nearEntry * nearQty * mult;
    var profitPct = posValue > 0 ? closePnl / posValue : 0;
    
    // Mevcut spread
    var currentSpread = nearBid > 0 ? (farAsk - nearBid) / nearBid : 0;
    
    // BB kontrolÃ¼ iÃ§in spread BB pozisyonunu hesapla
    // (snBB dictionary'sinden alÄ±nabilir veya ayrÄ± hesaplanabilir)
    var nfBBPos = snBBPos.ContainsKey(sym) ? snBBPos[sym] : 50m;  // VarsayÄ±lan orta
    
    // Ã‡Ä±kÄ±ÅŸ koÅŸulu 1: BB <= 27
    if (nfBBPos <= NF_EXIT_BB) {
        return "NF_BB_EXIT|" + closePnl.ToString("F0") + "|BB:" + nfBBPos.ToString("F0");
    }
    
    // Ã‡Ä±kÄ±ÅŸ koÅŸulu 2: Binde 3 kar
    if (profitPct >= NF_EXIT_PROFIT) {
        return "NF_PROFIT|" + closePnl.ToString("F0") + "|" + (profitPct * 1000).ToString("F1") + "â€°";
    }
    
    return null;
};

// ====================================
// VERÄ° YÃœKLEME
// ====================================
Action LoadTeminatFromFile = () => {
    try {
        if (!System.IO.File.Exists(TEMINAT_FILE)) return;
        var j = System.IO.File.ReadAllText(TEMINAT_FILE).Trim().TrimStart('{').TrimEnd('}');
        foreach (var p in j.Split(',')) {
            var kv = p.Split(':');
            if (kv.Length == 2) {
                decimal val;
                if (decimal.TryParse(kv[1].Trim(), System.Globalization.NumberStyles.Any,
                    System.Globalization.CultureInfo.InvariantCulture, out val)) {
                    var sym = kv[0].Trim().Trim('"');
                    teminat[sym] = val;
                    if (!symbols.Contains(sym)) symbols.Add(sym);
                }
            }
        }
        // VIOP_RESERVE = en yÃ¼ksek teminat x (2 + 2n+1) + 5000 (SN iÃ§in 2x + NF iÃ§in 2n+1)
        // NF_BUDGET = en yÃ¼ksek teminat x (2n+1) (Near-Far: aÃ§Ä±lÄ±ÅŸ 2n + kapanÄ±ÅŸ GÄ°E 1)
        decimal maxTeminat = 0;
        foreach (var kv in teminat) {
            if (kv.Value > maxTeminat) maxTeminat = kv.Value;
        }
        var nfBudgetMultiplier = NF_MAX_POSITIONS * 2 + 1;  // 2n+1 formÃ¼lÃ¼
        VIOP_RESERVE = maxTeminat * (2 + nfBudgetMultiplier) + 5000m;  // SN rezerv (2x) + NF rezerv (2n+1) + gÃ¼venlik marjÄ±
        NF_BUDGET = maxTeminat * nfBudgetMultiplier;  // NF iÃ§in ayrÄ±lmÄ±ÅŸ bÃ¼tÃ§e (2n+1)
        
        // SPOT_BUDGET_RESERVE = en yÃ¼ksek fiyatlÄ± spot Ã— 50 lot (minimum 1 pozisyon aÃ§abilme garantisi)
        decimal maxSpotPrice = 0;
        foreach (var sym in symbols) {
            try {
                var p = (decimal)Sistem.SonFiyat(SPOT_PREFIX + sym);
                if (p > maxSpotPrice) maxSpotPrice = p;
            } catch { }
        }
        SPOT_BUDGET_RESERVE = maxSpotPrice * 50m;  // 50 lot = 0.5 Near lot karÅŸÄ±lÄ±ÄŸÄ±
        
        Log("Teminat yÃ¼klendi: " + teminat.Count + " sembol, VIOP_RESERVE=" + VIOP_RESERVE.ToString("N0") + ", SPOT_BUDGET_RESERVE=" + SPOT_BUDGET_RESERVE.ToString("N0"));
    } catch (Exception ex) { Log("Teminat hata: " + ex.Message); }
};

Action SaveTeminatToFile = () => {
    try {
        var sb = new System.Text.StringBuilder();
        sb.Append("{");
        var first = true;
        foreach (var kv in teminat) {
            if (!first) sb.Append(",");
            first = false;
            sb.Append("\"" + kv.Key + "\":" + kv.Value.ToString(System.Globalization.CultureInfo.InvariantCulture));
        }
        sb.Append("}");
        SafeWrite(TEMINAT_FILE, sb.ToString());
        
        // Sembol listelerini oluÅŸtur (IdealData iÃ§in)
        try {
            var listePath = @"D:\ideal\SembolListeleri\";
            if (!System.IO.Directory.Exists(listePath)) {
                System.IO.Directory.CreateDirectory(listePath);
            }
            
            // Near vade kodunu GetContract'tan al (THYAO iÃ§in hesapla, sonra kodu Ã§Ä±kar)
            var sampleContract = GetContract("X", 0);  // F_X0126 gibi
            var vadeKodu = sampleContract.Substring(sampleContract.Length - 4);  // 0126
            
            var viopSb = new System.Text.StringBuilder();
            var spotSb = new System.Text.StringBuilder();
            
            // Endeks/dÃ¶viz/emtia hariÃ§ sadece hisse sembolleri
            var excludeList = new System.Collections.Generic.HashSet<string> { 
                "EURTRY", "USDTRY", "X10XB", "XLBNK", "XU030", "KONTR01", "KONTR02",
                "AGUSD", "GLD", "GOZ", "EUR", "GBP", "RUB", "USD", "EUD", "XPDUSD", "XPTUSD"
            };
            
            foreach (var kv in teminat) {
                if (excludeList.Contains(kv.Key)) continue;
                if (kv.Key.Length < 3) continue;  // GeÃ§ersiz semboller
                
                viopSb.AppendLine("VIP'F_" + kv.Key + vadeKodu);
                spotSb.AppendLine("IMKBH'" + kv.Key);
            }
            
            System.IO.File.WriteAllText(listePath + "viop_liste", viopSb.ToString().TrimEnd(), System.Text.Encoding.UTF8);
            System.IO.File.WriteAllText(listePath + "spot_liste", spotSb.ToString().TrimEnd(), System.Text.Encoding.UTF8);
        } catch { }
    } catch { }
};

Action UpdateTeminatFromVIOP = () => {
    try {
        var list = Sistem.SembolAdListesi(FUTURES_PREFIX + "F_", "");
        if (list == null) return;
        
        var nearContracts = new System.Collections.Generic.Dictionary<string, string>();
        foreach (var s in list) {
            try {
                var fullSym = s.ToString();
                if (!fullSym.StartsWith(FUTURES_PREFIX + "F_")) continue;
                
                // SubMarket kontrolÃ¼ - sadece pay vadeliler (19220)
                var yuz = Sistem.YuzeyselVeriOku(fullSym);
                if (yuz == null) continue;
                if (yuz.SubMarket.ToString() != "19220") continue;  // Pay vadeli deÄŸilse atla
                
                var contract = fullSym.Substring(FUTURES_PREFIX.Length);
                if (contract.Length <= 6) continue;
                var baseSym = contract.Substring(2, contract.Length - 6);
                var mmyy = contract.Substring(contract.Length - 4);
                
                if (!nearContracts.ContainsKey(baseSym)) {
                    nearContracts[baseSym] = fullSym;
                } else {
                    var existingMmyy = nearContracts[baseSym].Substring(nearContracts[baseSym].Length - 4);
                    var existingYY = int.Parse(existingMmyy.Substring(2));
                    var existingMM = int.Parse(existingMmyy.Substring(0, 2));
                    var newYY = int.Parse(mmyy.Substring(2));
                    var newMM = int.Parse(mmyy.Substring(0, 2));
                    if (newYY < existingYY || (newYY == existingYY && newMM < existingMM)) {
                        nearContracts[baseSym] = fullSym;
                    }
                }
            } catch { }
        }
        
        foreach (var kv in nearContracts) {
            try {
                var yuzeysel = Sistem.YuzeyselVeriOku(kv.Value);
                if (yuzeysel == null) continue;
                var tem = (decimal)yuzeysel.FI273;
                if (tem <= 0) continue;
                teminat[kv.Key] = tem;
                if (!symbols.Contains(kv.Key)) symbols.Add(kv.Key);
            } catch { }
        }
        
        // VIOP_RESERVE = en yÃ¼ksek teminat x 5 + 5000 (SN iÃ§in 2x + NF iÃ§in 3x)
        // NF_BUDGET = en yÃ¼ksek teminat x 3 (Near-Far: aÃ§Ä±lÄ±ÅŸ 2x + kapanÄ±ÅŸ GÄ°E 1x)
        decimal maxTeminat = 0;
        foreach (var kv in teminat) {
            if (kv.Value > maxTeminat) maxTeminat = kv.Value;
        }
        var nfBudgetMultiplier = NF_MAX_POSITIONS * 2 + 1;  // 2n+1 formÃ¼lÃ¼
        VIOP_RESERVE = maxTeminat * (2 + nfBudgetMultiplier) + 5000m;  // SN rezerv (2x) + NF rezerv (2n+1) + gÃ¼venlik marjÄ±
        NF_BUDGET = maxTeminat * nfBudgetMultiplier;  // NF iÃ§in ayrÄ±lmÄ±ÅŸ bÃ¼tÃ§e (2n+1)
        
        // SPOT_BUDGET_RESERVE = en yÃ¼ksek fiyatlÄ± spot Ã— 50 lot
        decimal maxSpotPrice = 0;
        foreach (var sym in symbols) {
            try {
                var p = (decimal)Sistem.SonFiyat(SPOT_PREFIX + sym);
                if (p > maxSpotPrice) maxSpotPrice = p;
            } catch { }
        }
        SPOT_BUDGET_RESERVE = maxSpotPrice * 50m;
        
        SaveTeminatToFile();
        Log("Teminat gÃ¼ncellendi: " + teminat.Count + " sembol, VIOP_RESERVE=" + VIOP_RESERVE.ToString("N0") + ", SPOT_BUDGET_RESERVE=" + SPOT_BUDGET_RESERVE.ToString("N0"));
    } catch (Exception ex) { Log("Teminat gÃ¼ncelleme hata: " + ex.Message); }
};

// Dosya bu aya ait mi kontrol et
Func<bool> IsTeminatFileCurrentMonth = () => {
    try {
        if (!System.IO.File.Exists(TEMINAT_FILE)) return false;
        var fileDate = System.IO.File.GetLastWriteTime(TEMINAT_FILE);
        var now = DateTime.Now;
        return fileDate.Year == now.Year && fileDate.Month == now.Month;
    } catch { return false; }
};

// ====================================
// PAIR TRADING FONKSÄ°YONLARI
// ====================================

// GÃ¼nlÃ¼k grafik verisinden pair spread geÃ§miÅŸi yÃ¼kle
Action LoadPairData = () => {
    if (!PAIR_ENABLED) return;
    if (PAIR_DEFS.Count == 0) return;
    
    foreach (var def in PAIR_DEFS) {
        var symA = (string)def[0];
        var symB = (string)def[1];
        var beta = (decimal)def[2];
        var pairKey = GetPairKey(symA, symB);
        
        try {
            var spotSymA = SPOT_PREFIX + symA;
            var spotSymB = SPOT_PREFIX + symB;
            
            dynamic dataA = Sistem.GrafikVerileriniOku(spotSymA, "G");
            dynamic dataB = Sistem.GrafikVerileriniOku(spotSymB, "G");
            
            if (dataA == null || dataB == null) {
                Log("âš ï¸ PAIR: " + pairKey + " veri yok");
                continue;
            }
            
            int countA = dataA.Count;
            int countB = dataB.Count;
            
            if (countA < 60 || countB < 60) {
                Log("âš ï¸ PAIR: " + pairKey + " yetersiz veri (A:" + countA + " B:" + countB + ")");
                continue;
            }
            
            // B verilerini tarihe gÃ¶re dictionary'e at
            var dictB = new System.Collections.Generic.Dictionary<string, decimal>();
            for (int i = 0; i < countB; i++) {
                try {
                    dynamic bar = dataB[i];
                    DateTime dt = bar.Date;
                    decimal close = (decimal)bar.Close;
                    dictB[dt.ToString("yyyyMMdd")] = close;
                } catch { }
            }
            
            // Spread serisi oluÅŸtur
            var spreads = new System.Collections.Generic.List<decimal>();
            for (int i = 0; i < countA; i++) {
                try {
                    dynamic bar = dataA[i];
                    DateTime dt = bar.Date;
                    var key = dt.ToString("yyyyMMdd");
                    if (!dictB.ContainsKey(key)) continue;
                    
                    decimal closeA = (decimal)bar.Close;
                    var closeB = dictB[key];
                    if (closeA <= 0 || closeB <= 0) continue;
                    
                    spreads.Add(closeA - beta * closeB);
                } catch { }
            }
            
            if (spreads.Count >= 20) {
                pairSpreads[pairKey] = spreads;
                pairZScores[pairKey] = CalcZScore(spreads);
                Log("ğŸ“Š PAIR: " + pairKey + " yÃ¼klendi (" + spreads.Count + " gÃ¼n) Z=" + pairZScores[pairKey].ToString("F2"));
            }
        } catch (Exception ex) {
            Log("âŒ PAIR: " + pairKey + " yÃ¼kleme hatasÄ±: " + ex.Message);
        }
    }
    lastPairDataLoad = DateTime.Now;
};

// CanlÄ± fiyatlarla Z-Score gÃ¼ncelle
Action UpdatePairZScores = () => {
    foreach (var def in PAIR_DEFS) {
        var symA = (string)def[0];
        var symB = (string)def[1];
        var beta = (decimal)def[2];
        var pairKey = GetPairKey(symA, symB);
        
        if (!pairSpreads.ContainsKey(pairKey)) continue;
        
        try {
            var yuzA = Sistem.YuzeyselVeriOku(SPOT_PREFIX + symA);
            var yuzB = Sistem.YuzeyselVeriOku(SPOT_PREFIX + symB);
            if (yuzA == null || yuzB == null) continue;
            
            var priceA = (decimal)yuzA.LastPrice;
            var priceB = (decimal)yuzB.LastPrice;
            if (priceA <= 0 || priceB <= 0) continue;
            
            var currentSpread = priceA - beta * priceB;
            
            // GeÃ§ici liste (son spread'i gÃ¼ncel fiyatla deÄŸiÅŸtir)
            var spreads = new System.Collections.Generic.List<decimal>(pairSpreads[pairKey]);
            if (spreads.Count > 0) spreads[spreads.Count - 1] = currentSpread;
            
            pairZScores[pairKey] = CalcZScore(spreads);
        } catch { }
    }
};

// Pair pozisyon aÃ§ma (kontrollÃ¼ GIE ile)
// contractOffset: 0=Near (normal), 1=Far (rollover iÃ§in)
Func<int, int, bool, int, bool> OpenPair = null;
OpenPair = (pairIdx, tier, isLongA, contractOffset) => {
    if (pairIdx < 0 || pairIdx >= PAIR_DEFS.Count) return false;
    if (tier < 0 || tier >= PAIR_MAX_TIERS) return false;
    
    var def = PAIR_DEFS[pairIdx];
    var symA = (string)def[0];
    var symB = (string)def[1];
    var beta = (decimal)def[2];
    var pairKey = GetPairKey(symA, symB);
    
    // GÃ¼ncel fiyatlarÄ± al (lot hesabÄ± iÃ§in)
    decimal priceA = 0, priceB = 0;
    try {
        var yuzA = Sistem.YuzeyselVeriOku(SPOT_PREFIX + symA);
        var yuzB = Sistem.YuzeyselVeriOku(SPOT_PREFIX + symB);
        if (yuzA != null) priceA = (decimal)yuzA.LastPrice;
        if (yuzB != null) priceB = (decimal)yuzB.LastPrice;
    } catch { }
    
    // Lot sayÄ±sÄ±nÄ± bÃ¼tÃ§eden hesapla
    var lots = CalcPairLots(pairIdx, tier, beta, priceA, priceB);
    var lotA = lots[0];
    var lotB = lots[1];
    
    if (lotA <= 0 || lotB <= 0) {
        Log("âš ï¸ PAIR: " + pairKey + " kademe " + (tier + 1) + " lot hesaplanamadÄ±");
        return false;
    }
    
    // KontratlarÄ± bul (offset: 0=Near, 1=Far)
    var nearA = GetContract(symA, contractOffset);
    var nearB = GetContract(symB, contractOffset);
    if (string.IsNullOrEmpty(nearA) || string.IsNullOrEmpty(nearB)) {
        Log("âŒ PAIR: " + pairKey + " kontrat bulunamadÄ± (offset=" + contractOffset + ")");
        return false;
    }
    
    // Teminat kontrolÃ¼
    var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
    var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
    var reqTeminat = (lotA * temA) + (lotB * temB);
    
    if (pairUsed + reqTeminat > PAIR_BUDGET) {
        Log("âš ï¸ PAIR: BÃ¼tÃ§e yetersiz. Gerekli:" + reqTeminat.ToString("F0") + " KullanÄ±lan:" + pairUsed.ToString("F0"));
        return false;
    }
    
    // Emir yÃ¶nleri
    var sideA = isLongA ? "BUY" : "SELL";
    var sideB = isLongA ? "SELL" : "BUY";
    
    // Likidite sÄ±ralamasÄ±: DÃ¼ÅŸÃ¼k teminat = az likit = Ã¶nce gÃ¶nder
    var aFirst = temA < temB;
    
    var firstSym = aFirst ? symA : symB;
    var firstNear = aFirst ? nearA : nearB;
    var firstSide = aFirst ? sideA : sideB;
    var firstLot = aFirst ? lotA : lotB;
    
    var secondSym = aFirst ? symB : symA;
    var secondNear = aFirst ? nearB : nearA;
    var secondSide = aFirst ? sideB : sideA;
    var secondLot = aFirst ? lotB : lotA;
    
    Log("ğŸ“Š PAIR AÃ‡ILIÅ: " + pairKey + " Kademe " + (tier + 1) + 
        " | " + firstSym + " " + firstSide + " x" + firstLot + " (Ã¶nce)" +
        " | " + secondSym + " " + secondSide + " x" + secondLot);
    
    if (IS_TEST) {
        // Test modunda emir gÃ¶nderme
        var testPriceA = priceA > 0 ? priceA : 50m;
        var testPriceB = priceB > 0 ? priceB : 25m;
        var currentZ = pairZScores.ContainsKey(pairKey) ? pairZScores[pairKey] : 0m;
        
        // Beklenen kar hesapla (Z normale dÃ¶nÃ¼nce)
        var mult = GetMultiplier(symA);
        var expectedMove = Math.Abs(currentZ) * 0.5m;  // Ortalama %50 geri dÃ¶nÃ¼ÅŸ
        var expectedPnl = expectedMove * testPriceA * lotA * mult * 0.02m;  // YaklaÅŸÄ±k
        
        if (pairPos.ContainsKey(pairKey)) {
            var p = pairPos[pairKey];
            var oldQtyA = (int)p[0];
            var oldQtyB = (int)p[1];
            var newQtyA = oldQtyA + lotA;
            var newQtyB = oldQtyB + lotB;
            var oldExp = p.Length > 7 ? p[7] : 0m;
            pairPos[pairKey] = new decimal[] { newQtyA, newQtyB, p[2], p[3], p[4], tier + 1, p[6], oldExp + expectedPnl };
            Log("âœ… PAIR EKLENDÄ° (TEST): " + pairKey + " A:" + oldQtyA + "â†’" + newQtyA + " B:" + oldQtyB + "â†’" + newQtyB);
        } else {
            pairPos[pairKey] = new decimal[] { lotA, lotB, testPriceA, testPriceB, currentZ, tier + 1, DateTime.Now.Ticks, expectedPnl };
            // KontratlarÄ± kaydet
            pairContracts[pairKey] = new string[] { nearA, nearB };
            Log("âœ… PAIR AÃ‡ILDI (TEST): " + pairKey + " A:" + lotA + " B:" + lotB + " Z=" + currentZ.ToString("F2") + " [" + nearA + "/" + nearB + "]");
        }
        pairUsed += reqTeminat;
        SavePositions();
        return true;
    }
    
    // === Ä°LK BACAK (az likit) ===
    var res1 = ExecGuar("F_" + firstNear, firstSide, firstLot);
    if (res1.Item1 <= 0) {
        Log("âŒ PAIR: " + firstSym + " " + firstSide + " baÅŸarÄ±sÄ±z");
        return false;
    }
    
    // Ä°lk bacak kÄ±smi dolum kontrolÃ¼
    if (res1.Item1 < firstLot) {
        Log("âš ï¸ PAIR: " + firstSym + " kÄ±smi dolum " + res1.Item1 + "/" + firstLot + " - geri alÄ±nÄ±yor");
        var reverseSide1 = firstSide == "BUY" ? "SELL" : "BUY";
        ExecGuar("F_" + firstNear, reverseSide1, res1.Item1);
        return false;
    }
    
    // === Ä°KÄ°NCÄ° BACAK (3 deneme) ===
    System.Tuple<int, decimal> res2 = null;
    var success = false;
    var totalFilled2 = 0;
    
    for (int retry = 0; retry < 3; retry++) {
        var remaining = secondLot - totalFilled2;
        if (remaining <= 0) break;
        
        res2 = ExecGuar("F_" + secondNear, secondSide, remaining);
        if (res2.Item1 > 0) {
            totalFilled2 += res2.Item1;
            if (totalFilled2 >= secondLot) {
                success = true;
                break;
            }
            Log("âš ï¸ PAIR: " + secondSym + " kÄ±smi dolum " + totalFilled2 + "/" + secondLot + " - deneme " + (retry + 1) + "/3");
        } else {
            Log("âš ï¸ PAIR: " + secondSym + " deneme " + (retry + 1) + "/3 baÅŸarÄ±sÄ±z");
        }
        System.Threading.Thread.Sleep(2000);
    }
    
    if (!success) {
        // Ä°kinci bacak tam dolmadÄ± - pairPendingCompletion'a ekle (30sn sonra tekrar denenecek)
        Log("â³ PAIR: " + secondSym + " tam dolmadÄ± (" + totalFilled2 + "/" + secondLot + ") - beklemeye alÄ±ndÄ±");
        
        // Ä°kinci bacaktan dolan kÄ±smÄ± geri al (varsa)
        if (totalFilled2 > 0) {
            var reverseSide2 = secondSide == "BUY" ? "SELL" : "BUY";
            ExecGuar("F_" + secondNear, reverseSide2, totalFilled2);
        }
        
        // Ä°lk bacaÄŸÄ± pairPendingCompletion'a ekle
        var filledLeg = aFirst ? "A" : "B";
        pairPendingCompletion[pairKey] = new object[] {
            pairIdx,           // [0] pairIdx
            tier,              // [1] tier
            isLongA,           // [2] isLongA
            contractOffset,    // [3] contractOffset
            filledLeg,         // [4] filledLeg (A veya B)
            firstSide,         // [5] filledSide
            res1.Item1,        // [6] filledQty
            res1.Item2,        // [7] filledPrice
            firstNear,         // [8] filledContract
            DateTime.Now,      // [9] timestamp
            0                  // [10] retryCount
        };
        
        Log("ğŸ“‹ PAIR PENDING: " + pairKey + " " + filledLeg + " beklemeye alÄ±ndÄ±. " + PAIR_PENDING_WAIT_SEC + "sn sonra tekrar denenecek.");
        return false;
    }
    
    // Her iki bacak da tam doldu - son fiyatÄ± al
    var finalPrice2 = res2 != null ? res2.Item2 : 0m;
    
    // Her iki bacak da tam doldu - pozisyonu kaydet
    var filledA = aFirst ? res1.Item1 : totalFilled2;
    var filledB = aFirst ? totalFilled2 : res1.Item1;
    var realPriceA = aFirst ? res1.Item2 : finalPrice2;
    var realPriceB = aFirst ? finalPrice2 : res1.Item2;
    
    var currentZScore = pairZScores.ContainsKey(pairKey) ? pairZScores[pairKey] : 0m;
    
    // Beklenen kar hesapla
    var realMult = GetMultiplier(symA);
    var realExpectedMove = Math.Abs(currentZScore) * 0.5m;
    var realExpectedPnl = realExpectedMove * realPriceA * filledA * realMult * 0.02m;
    
    if (pairPos.ContainsKey(pairKey)) {
        // Mevcut pozisyona ekle
        var p = pairPos[pairKey];
        var oldQtyA = (int)p[0];
        var oldQtyB = (int)p[1];
        var newQtyA = oldQtyA + filledA;
        var newQtyB = oldQtyB + filledB;
        if (newQtyA <= 0 || newQtyB <= 0) {
            Log("âŒ PAIR: " + pairKey + " geÃ§ersiz miktar hesaplandÄ±");
            return false;
        }
        var newAvgA = (p[2] * oldQtyA + realPriceA * filledA) / newQtyA;
        var newAvgB = (p[3] * oldQtyB + realPriceB * filledB) / newQtyB;
        var oldExp = p.Length > 7 ? p[7] : 0m;
        
        pairPos[pairKey] = new decimal[] { newQtyA, newQtyB, newAvgA, newAvgB, p[4], tier + 1, p[6], oldExp + realExpectedPnl };
        Log("âœ… PAIR EKLENDÄ°: " + pairKey + " A:" + oldQtyA + "â†’" + newQtyA + " B:" + oldQtyB + "â†’" + newQtyB + " Kademe:" + (tier + 1));
    } else {
        // Yeni pozisyon
        pairPos[pairKey] = new decimal[] { filledA, filledB, realPriceA, realPriceB, currentZScore, tier + 1, DateTime.Now.Ticks, realExpectedPnl };
        // KontratlarÄ± kaydet (yeni pozisyon aÃ§Ä±ldÄ±ÄŸÄ±nda)
        pairContracts[pairKey] = new string[] { nearA, nearB };
        Log("âœ… PAIR AÃ‡ILDI: " + pairKey + " A:" + filledA + "@" + realPriceA.ToString("F2") + " B:" + filledB + "@" + realPriceB.ToString("F2") + " Z=" + currentZScore.ToString("F2") + " [" + nearA + "/" + nearB + "]");
    }
    
    // Teminat ve komisyon
    pairUsed += (filledA * temA) + (filledB * temB);
    dailyViopCommission += CalcCommission(symA, realPriceA, filledA) + CalcCommission(symB, realPriceB, filledB);
    
    SavePositions();
    return true;
};

// Pair pozisyon kapatma
Func<int, bool> ClosePair = (pairIdx) => {
    if (pairIdx < 0 || pairIdx >= PAIR_DEFS.Count) return false;
    
    var def = PAIR_DEFS[pairIdx];
    var symA = (string)def[0];
    var symB = (string)def[1];
    var pairKey = GetPairKey(symA, symB);
    
    if (!pairPos.ContainsKey(pairKey)) return false;
    
    var p = pairPos[pairKey];
    var qtyA = (int)p[0];
    var qtyB = (int)p[1];
    var avgA = p[2];
    var avgB = p[3];
    var openZ = p[4];
    
    // KontratlarÄ± pairContracts'tan al (yoksa fallback olarak GetContract kullan)
    var nearA = pairContracts.ContainsKey(pairKey) ? pairContracts[pairKey][0] : GetContract(symA, 0);
    var nearB = pairContracts.ContainsKey(pairKey) ? pairContracts[pairKey][1] : GetContract(symB, 0);
    if (string.IsNullOrEmpty(nearA) || string.IsNullOrEmpty(nearB)) return false;
    
    // Pozisyon yÃ¶nÃ¼ (openZ'ye gÃ¶re)
    var isLongA = openZ < 0;
    var sideA = isLongA ? "SELL" : "BUY";
    var sideB = isLongA ? "BUY" : "SELL";
    
    Log("ğŸ“Š PAIR KAPANIÅ: " + pairKey + " | " + symA + " " + sideA + " x" + qtyA + " | " + symB + " " + sideB + " x" + qtyB + " [" + nearA + "/" + nearB + "]");
    
    // Teminat serbest (pozisyon silinmeden Ã¶nce hesapla)
    var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
    var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
    
    if (IS_TEST) {
        // Test modunda
        var currentZ = pairZScores.ContainsKey(pairKey) ? pairZScores[pairKey] : 0m;
        Log("âœ… PAIR KAPANDI (TEST): " + pairKey + " | Z: " + openZ.ToString("F2") + " â†’ " + currentZ.ToString("F2"));
        
        pairUsed -= (qtyA * temA) + (qtyB * temB);
        if (pairUsed < 0) pairUsed = 0;
        pairPos.Remove(pairKey);
        if (pairContracts.ContainsKey(pairKey)) pairContracts.Remove(pairKey);
        totalClosedPair++;
        SavePositions();
        return true;
    }
    
    // KapanÄ±ÅŸ emirleri - A bacaÄŸÄ±
    var resA = ExecGuar("F_" + nearA, sideA, qtyA);
    if (resA.Item1 <= 0) {
        Log("âŒ PAIR KAPAT: " + symA + " baÅŸarÄ±sÄ±z");
        return false;
    }
    
    // A kÄ±smi dolum kontrolÃ¼
    if (resA.Item1 < qtyA) {
        Log("âš ï¸ PAIR KAPAT: " + symA + " kÄ±smi dolum " + resA.Item1 + "/" + qtyA + " - kalan denenecek");
        // Kalan kÄ±smÄ± tekrar dene
        var remainingA = qtyA - resA.Item1;
        for (int retry = 0; retry < 2; retry++) {
            System.Threading.Thread.Sleep(2000);
            var resA2 = ExecGuar("F_" + nearA, sideA, remainingA);
            if (resA2.Item1 > 0) {
                resA = System.Tuple.Create(resA.Item1 + resA2.Item1, (resA.Item2 * resA.Item1 + resA2.Item2 * resA2.Item1) / (resA.Item1 + resA2.Item1));
                remainingA -= resA2.Item1;
                if (remainingA <= 0) break;
            }
        }
        if (remainingA > 0) {
            Log("âš ï¸ PAIR KAPAT: " + symA + " tam kapatÄ±lamadÄ±! Kalan: " + remainingA);
        }
    }
    
    // B bacaÄŸÄ± - 3 deneme ile tam dolum hedefi
    var totalFilledB = 0;
    decimal avgPriceB = 0;
    
    for (int retry = 0; retry < 3; retry++) {
        var remaining = qtyB - totalFilledB;
        if (remaining <= 0) break;
        
        var resB = ExecGuar("F_" + nearB, sideB, remaining);
        if (resB.Item1 > 0) {
            avgPriceB = (avgPriceB * totalFilledB + resB.Item2 * resB.Item1) / (totalFilledB + resB.Item1);
            totalFilledB += resB.Item1;
            if (totalFilledB >= qtyB) break;
            Log("âš ï¸ PAIR KAPAT: " + symB + " kÄ±smi " + totalFilledB + "/" + qtyB + " - deneme " + (retry + 1) + "/3");
        } else {
            Log("âš ï¸ PAIR KAPAT: " + symB + " deneme " + (retry + 1) + "/3 baÅŸarÄ±sÄ±z");
        }
        System.Threading.Thread.Sleep(2000);
    }
    
    if (totalFilledB <= 0) {
        Log("â³ PAIR KAPAT: " + symB + " hiÃ§ dolmadÄ± - beklemeye alÄ±nÄ±yor");
        
        // A kapatÄ±ldÄ±, B beklemede - pairPendingCompletion'a ekle
        pairPendingCompletion[pairKey + "_CLOSE"] = new object[] {
            pairIdx,           // [0] pairIdx
            -1,                // [1] tier (-1 = kapanÄ±ÅŸ modu)
            isLongA,           // [2] isLongA
            0,                 // [3] contractOffset (kullanÄ±lmÄ±yor)
            "A_CLOSED",        // [4] filledLeg (A kapatÄ±ldÄ±, B bekliyor)
            sideB,             // [5] B'nin kapanÄ±ÅŸ yÃ¶nÃ¼
            qtyB,              // [6] B'nin miktarÄ±
            resA.Item2,        // [7] A'nÄ±n kapanÄ±ÅŸ fiyatÄ± (P&L hesabÄ± iÃ§in)
            nearB,             // [8] B'nin kontratÄ±
            DateTime.Now,      // [9] timestamp
            0,                 // [10] retryCount
            qtyA,              // [11] A'nÄ±n miktarÄ±
            resA.Item1,        // [12] A'nÄ±n dolan miktarÄ±
            avgA,              // [13] A giriÅŸ fiyatÄ±
            avgB,              // [14] B giriÅŸ fiyatÄ±
            nearA,             // [15] A kontratÄ±
            symA,              // [16] sembol A
            symB,              // [17] sembol B
            openZ              // [18] aÃ§Ä±lÄ±ÅŸ Z-Score
        };
        
        Log("ğŸ“‹ PAIR PENDING CLOSE: " + pairKey + " B beklemeye alÄ±ndÄ±. " + PAIR_PENDING_WAIT_SEC + "sn sonra tekrar denenecek.");
        return false;
    }
    
    if (totalFilledB < qtyB) {
        Log("âš ï¸ PAIR KAPAT: " + symB + " kÄ±smi kapatÄ±ldÄ± " + totalFilledB + "/" + qtyB + " - kalan aÃ§Ä±k!");
    }
    
    // P&L hesapla (dolan miktarlar Ã¼zerinden)
    var mult = GetMultiplier(symA);
    decimal pnlA, pnlB;
    
    if (isLongA) {
        pnlA = (resA.Item2 - avgA) * resA.Item1 * mult;
        pnlB = (avgB - avgPriceB) * totalFilledB * mult;
    } else {
        pnlA = (avgA - resA.Item2) * resA.Item1 * mult;
        pnlB = (avgPriceB - avgB) * totalFilledB * mult;
    }
    
    var totalPnl = pnlA + pnlB;
    var commA = CalcCommission(symA, resA.Item2, resA.Item1);
    var commB = CalcCommission(symB, avgPriceB, totalFilledB);
    totalPnl -= (commA + commB);
    
    dailyRealizedPnl += totalPnl;
    dailyPairPnl += totalPnl;
    dailyViopCommission += commA + commB;
    
    // Teminat serbest - sadece kapatÄ±lan miktarlar iÃ§in
    var freedTeminat = (resA.Item1 * temA) + (totalFilledB * temB);
    pairUsed -= freedTeminat;
    if (pairUsed < 0) pairUsed = 0;
    
    // KÄ±smi kapanÄ±ÅŸ mÄ± tam kapanÄ±ÅŸ mÄ±?
    var fullyClosedA = resA.Item1 >= qtyA;
    var fullyClosedB = totalFilledB >= qtyB;
    
    var currentZFinal = pairZScores.ContainsKey(pairKey) ? pairZScores[pairKey] : 0m;
    
    if (fullyClosedA && fullyClosedB) {
        Log("âœ… PAIR KAPANDI: " + pairKey + " P&L:" + totalPnl.ToString("F0") + " TL | Z: " + openZ.ToString("F2") + " â†’ " + currentZFinal.ToString("F2"));
        pairPos.Remove(pairKey);
        if (pairContracts.ContainsKey(pairKey)) pairContracts.Remove(pairKey);
    } else {
        // KÄ±smi kapanÄ±ÅŸ - kalan miktarlarÄ± gÃ¼ncelle
        var remainingA = qtyA - resA.Item1;
        var remainingB = qtyB - totalFilledB;
        Log("âš ï¸ PAIR KISMÄ° KAPANDI: " + pairKey + " P&L:" + totalPnl.ToString("F0") + " TL | Kalan A:" + remainingA + " B:" + remainingB);
        
        if (remainingA > 0 || remainingB > 0) {
            // Pozisyonu gÃ¼ncelle (kalan miktarlarla)
            pairPos[pairKey] = new decimal[] { remainingA, remainingB, avgA, avgB, openZ, p[5], p[6], p.Length > 7 ? p[7] : 0m };
        } else {
            pairPos.Remove(pairKey);
            if (pairContracts.ContainsKey(pairKey)) pairContracts.Remove(pairKey);
        }
    }
    totalClosedPair++;
    
    SavePositions();
    if (SaveDailyStats != null) SaveDailyStats();
    return true;
};

// Pair Pending Completion kontrolÃ¼ - tek bacak aÃ§Ä±k kalmÄ±ÅŸ emirleri tamamlamaya Ã§alÄ±ÅŸÄ±r
Action CheckPairPending = () => {
    if (pairPendingCompletion.Count == 0) return;
    if (!isMarketOpen || isPaused || !apiDataOk) return;
    
    var toRemove = new System.Collections.Generic.List<string>();
    
    foreach (var kv in pairPendingCompletion) {
        try {
            var pendingKey = kv.Key;
            var data = kv.Value;
            var pairIdx = (int)data[0];
            var tier = (int)data[1];
            var isLongA = (bool)data[2];
            var contractOffset = (int)data[3];
            var filledLeg = (string)data[4];
            var filledSide = (string)data[5];
            var filledQty = (int)data[6];
            var filledPrice = (decimal)data[7];
            var filledContract = (string)data[8];
            var timestamp = (DateTime)data[9];
            var retryCount = (int)data[10];
            
            var waitSec = (DateTime.Now - timestamp).TotalSeconds;
            
            // HenÃ¼z bekleme sÃ¼resi dolmadÄ±
            if (waitSec < PAIR_PENDING_WAIT_SEC) continue;
            
            // KAPANIÅ MODU (tier == -1)
            if (tier == -1) {
                // KapanÄ±ÅŸ modunda ek veriler
                var closeQtyA = (int)data[11];
                var closeFilledA = (int)data[12];
                var closeAvgA = (decimal)data[13];
                var closeAvgB = (decimal)data[14];
                var closeNearA = (string)data[15];
                var closeSymA = (string)data[16];
                var closeSymB = (string)data[17];
                var closeOpenZ = (decimal)data[18];
                var closePairKey = pendingKey.Replace("_CLOSE", "");
                
                // Max retry aÅŸÄ±ldÄ± - Recovery'ye bÄ±rak
                if (retryCount >= PAIR_PENDING_MAX_RETRY) {
                    Log("âŒ PAIR PENDING CLOSE: " + closePairKey + " max retry aÅŸÄ±ldÄ± - Recovery'ye bÄ±rakÄ±lÄ±yor");
                    // pairPos'u gÃ¼ncelle (A kapatÄ±ldÄ±, B hala aÃ§Ä±k)
                    if (pairPos.ContainsKey(closePairKey)) {
                        var oldPos = pairPos[closePairKey];
                        var remainingA = closeQtyA - closeFilledA;
                        pairPos[closePairKey] = new decimal[] { remainingA, filledQty, closeAvgA, closeAvgB, closeOpenZ, oldPos[5], oldPos[6], oldPos.Length > 7 ? oldPos[7] : 0m };
                        Log("âš ï¸ PAIR PENDING CLOSE: " + closePairKey + " pairPos gÃ¼ncellendi. Kalan A:" + remainingA + " B:" + filledQty);
                        SavePositions();
                    }
                    toRemove.Add(pendingKey);
                    continue;
                }
                
                // B bacaÄŸÄ±nÄ± tekrar dene
                Log("ğŸ”„ PAIR PENDING CLOSE: " + closePairKey + " B tekrar deneniyor (retry " + (retryCount + 1) + "/" + PAIR_PENDING_MAX_RETRY + ")");
                
                var closeDepthType = filledSide == "BUY" ? "ASK" : "BID";
                var closeResult = ReadDepth(FUTURES_PREFIX + filledContract, closeDepthType, 0, 3, 100);
                
                if (closeResult.Item1 && closeResult.Item2 >= filledQty) {
                    var closePrice = closeResult.Item4;
                    var closeOrderId = IS_TEST ? "TEST_PAIR_CLOSE_RETRY_" + DateTime.Now.Ticks :
                        (filledSide == "BUY" ? Sistem.Al(FUTURES_PREFIX + filledContract, (double)closePrice, filledQty) :
                                               Sistem.Sat(FUTURES_PREFIX + filledContract, (double)closePrice, filledQty)).ToString();
                    
                    System.Threading.Thread.Sleep(300);
                    var closeFilled = IS_TEST ? filledQty : (int)Sistem.GerceklesenLot(FUTURES_PREFIX + filledContract);
                    
                    if (closeFilled >= filledQty) {
                        // BaÅŸarÄ±lÄ±! P&L hesapla ve pozisyonu kapat
                        Log("âœ… PAIR PENDING CLOSE: " + closePairKey + " B tamamlandÄ±! " + filledQty + " lot @ " + closePrice.ToString("F2"));
                        
                        var mult = GetMultiplier(closeSymA);
                        decimal pnlA, pnlB;
                        
                        if (isLongA) {
                            pnlA = (filledPrice - closeAvgA) * closeFilledA * mult;  // filledPrice = A kapanÄ±ÅŸ fiyatÄ±
                            pnlB = (closeAvgB - closePrice) * closeFilled * mult;
                        } else {
                            pnlA = (closeAvgA - filledPrice) * closeFilledA * mult;
                            pnlB = (closePrice - closeAvgB) * closeFilled * mult;
                        }
                        
                        var totalPnl = pnlA + pnlB;
                        var commA = CalcCommission(closeSymA, filledPrice, closeFilledA);
                        var commB = CalcCommission(closeSymB, closePrice, closeFilled);
                        totalPnl -= (commA + commB);
                        
                        dailyRealizedPnl += totalPnl;
                        dailyPairPnl += totalPnl;
                        dailyViopCommission += commA + commB;
                        
                        // Teminat serbest
                        var temA = teminat.ContainsKey(closeSymA) ? teminat[closeSymA] : 1000m;
                        var temB = teminat.ContainsKey(closeSymB) ? teminat[closeSymB] : 1000m;
                        var freedTeminat = (closeFilledA * temA) + (closeFilled * temB);
                        pairUsed -= freedTeminat;
                        if (pairUsed < 0) pairUsed = 0;
                        
                        Log("âœ… PAIR KAPANDI (PENDING): " + closePairKey + " P&L:" + totalPnl.ToString("F0") + " TL");
                        
                        pairPos.Remove(closePairKey);
                        if (pairContracts.ContainsKey(closePairKey)) pairContracts.Remove(closePairKey);
                        totalClosedPair++;
                        
                        SavePositions();
                        if (SaveDailyStats != null) SaveDailyStats();
                        toRemove.Add(pendingKey);
                    } else {
                        // Yine baÅŸarÄ±sÄ±z
                        Log("âš ï¸ PAIR PENDING CLOSE: " + closePairKey + " B yine dolmadÄ± (" + closeFilled + "/" + filledQty + ")");
                        if (!IS_TEST) Sistem.EmirIptal(FUTURES_PREFIX + filledContract);
                        data[9] = DateTime.Now;
                        data[10] = retryCount + 1;
                    }
                } else {
                    // Derinlik yok
                    Log("â³ PAIR PENDING CLOSE: " + closePairKey + " B derinlik yetersiz, bekleniyor...");
                    data[9] = DateTime.Now;
                    data[10] = retryCount + 1;
                }
                continue;
            }
            
            // AÃ‡ILIÅ MODU (tier >= 0)
            var def = PAIR_DEFS[pairIdx];
            var symA = (string)def[0];
            var symB = (string)def[1];
            var pairKey = GetPairKey(symA, symB);
            
            // Max retry aÅŸÄ±ldÄ± - geri kapat
            if (retryCount >= PAIR_PENDING_MAX_RETRY) {
                Log("âš ï¸ PAIR PENDING: " + pairKey + " max retry aÅŸÄ±ldÄ± (" + retryCount + ") - geri kapatÄ±lÄ±yor");
                
                // AÃ§Ä±k bacaÄŸÄ± geri kapat
                var reverseSide = filledSide == "BUY" ? "SELL" : "BUY";
                var reverseDepthType = reverseSide == "BUY" ? "ASK" : "BID";
                var reverseResult = ReadDepth(FUTURES_PREFIX + filledContract, reverseDepthType, 0, 3, 100);
                
                if (reverseResult.Item1 && reverseResult.Item2 >= filledQty) {
                    var reversePrice = reverseResult.Item4;
                    var reverseOrderId = IS_TEST ? "TEST_PAIR_REVERSE_" + DateTime.Now.Ticks :
                        (reverseSide == "BUY" ? Sistem.Al(FUTURES_PREFIX + filledContract, (double)reversePrice, filledQty) :
                                                Sistem.Sat(FUTURES_PREFIX + filledContract, (double)reversePrice, filledQty)).ToString();
                    
                    System.Threading.Thread.Sleep(300);
                    var reverseFilled = IS_TEST ? filledQty : (int)Sistem.GerceklesenLot(FUTURES_PREFIX + filledContract);
                    
                    if (reverseFilled >= filledQty) {
                        var slippage = filledSide == "BUY" ? (reversePrice - filledPrice) : (filledPrice - reversePrice);
                        var loss = slippage * filledQty * 100;  // YaklaÅŸÄ±k zarar
                        Log("âœ… PAIR PENDING: " + pairKey + " " + filledLeg + " geri kapatÄ±ldÄ±. Slippage:" + slippage.ToString("F2") + " Zarar:" + loss.ToString("F0"));
                        toRemove.Add(pendingKey);
                    } else {
                        Log("âŒ PAIR PENDING: " + pairKey + " geri kapatma baÅŸarÄ±sÄ±z - Recovery'ye bÄ±rakÄ±lÄ±yor");
                        toRemove.Add(pendingKey);
                    }
                } else {
                    Log("âŒ PAIR PENDING: " + pairKey + " geri kapatma iÃ§in derinlik yok - Recovery'ye bÄ±rakÄ±lÄ±yor");
                    toRemove.Add(pendingKey);
                }
                continue;
            }
            
            // Z-Score hala uygun mu kontrol et
            var currentZ = pairZScores.ContainsKey(pairKey) ? pairZScores[pairKey] : 0m;
            var absZ = Math.Abs(currentZ);
            
            // GiriÅŸ iÃ§in Z-Score hala yeterli mi?
            var minZ = tier == 0 ? PAIR_Z_ENTRY_1 : tier == 1 ? PAIR_Z_ENTRY_2 : PAIR_Z_ENTRY_3;
            if (absZ < minZ - 0.2m) {  // 0.2 tolerans
                Log("âš ï¸ PAIR PENDING: " + pairKey + " Z-Score dÃ¼ÅŸtÃ¼ (" + currentZ.ToString("F2") + " < " + minZ.ToString("F1") + ") - geri kapatÄ±lÄ±yor");
                retryCount = PAIR_PENDING_MAX_RETRY;  // Max retry'a set et, yukarÄ±daki blok kapatacak
                data[10] = retryCount;
                continue;
            }
            
            // Ä°kinci bacaÄŸÄ± tekrar dene
            Log("ğŸ”„ PAIR PENDING: " + pairKey + " ikinci bacak tekrar deneniyor (retry " + (retryCount + 1) + "/" + PAIR_PENDING_MAX_RETRY + ")");
            
            var secondLeg = filledLeg == "A" ? "B" : "A";
            var secondSym = secondLeg == "A" ? symA : symB;
            var secondSide = secondLeg == "A" ? (isLongA ? "BUY" : "SELL") : (isLongA ? "SELL" : "BUY");
            var secondContract = GetContract(secondSym, contractOffset);
            
            // Lot hesapla (ilk bacaktan orantÄ±lÄ±)
            var beta = (decimal)def[2];
            var secondQty = filledLeg == "A" ? (int)Math.Round(filledQty * beta) : (int)Math.Round(filledQty / beta);
            if (secondQty <= 0) secondQty = 1;
            
            var secondDepthType = secondSide == "BUY" ? "ASK" : "BID";
            var secondResult = ReadDepth(FUTURES_PREFIX + secondContract, secondDepthType, 0, 3, 100);
            
            if (secondResult.Item1 && secondResult.Item2 >= secondQty) {
                var secondPrice = secondResult.Item4;
                var secondOrderId = IS_TEST ? "TEST_PAIR_RETRY_" + DateTime.Now.Ticks :
                    (secondSide == "BUY" ? Sistem.Al(FUTURES_PREFIX + secondContract, (double)secondPrice, secondQty) :
                                           Sistem.Sat(FUTURES_PREFIX + secondContract, (double)secondPrice, secondQty)).ToString();
                
                System.Threading.Thread.Sleep(300);
                var secondFilled = IS_TEST ? secondQty : (int)Sistem.GerceklesenLot(FUTURES_PREFIX + secondContract);
                
                if (secondFilled >= secondQty) {
                    // BaÅŸarÄ±lÄ±! Pozisyonu kaydet
                    Log("âœ… PAIR PENDING: " + pairKey + " " + secondLeg + " tamamlandÄ±! " + secondQty + " lot @ " + secondPrice.ToString("F2"));
                    
                    var qtyA = filledLeg == "A" ? filledQty : secondFilled;
                    var qtyB = filledLeg == "B" ? filledQty : secondFilled;
                    var avgA = filledLeg == "A" ? filledPrice : secondPrice;
                    var avgB = filledLeg == "B" ? filledPrice : secondPrice;
                    
                    var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
                    var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                    
                    // Pozisyon zaten var mÄ±? (kademe ekleme)
                    if (pairPos.ContainsKey(pairKey)) {
                        var existingPos = pairPos[pairKey];
                        var existingQtyA = (int)existingPos[0];
                        var existingQtyB = (int)existingPos[1];
                        var existingAvgA = existingPos[2];
                        var existingAvgB = existingPos[3];
                        var existingTier = (int)existingPos[5];
                        
                        // Ortalama hesapla
                        var newQtyA = existingQtyA + qtyA;
                        var newQtyB = existingQtyB + qtyB;
                        var newAvgA = (existingAvgA * existingQtyA + avgA * qtyA) / newQtyA;
                        var newAvgB = (existingAvgB * existingQtyB + avgB * qtyB) / newQtyB;
                        var newTier = existingTier + 1;
                        
                        pairPos[pairKey] = new decimal[] { newQtyA, newQtyB, newAvgA, newAvgB, currentZ, newTier, existingPos[6], 0 };
                        pairUsed += (qtyA * temA) + (qtyB * temB);
                        Log("ğŸ“Š PAIR PENDING: " + pairKey + " kademe " + newTier + " eklendi. A:" + newQtyA + " B:" + newQtyB);
                    } else {
                        // Yeni pozisyon
                        pairPos[pairKey] = new decimal[] { qtyA, qtyB, avgA, avgB, currentZ, tier, DateTime.Now.Ticks, 0 };
                        pairContracts[pairKey] = new string[] { 
                            filledLeg == "A" ? filledContract : secondContract,
                            filledLeg == "B" ? filledContract : secondContract 
                        };
                        pairUsed += (qtyA * temA) + (qtyB * temB);
                        Log("ğŸ“Š PAIR PENDING: " + pairKey + " yeni pozisyon aÃ§Ä±ldÄ±. A:" + qtyA + " B:" + qtyB);
                    }
                    
                    SavePositions();
                    toRemove.Add(pendingKey);
                } else {
                    // Yine baÅŸarÄ±sÄ±z - retry sayÄ±sÄ±nÄ± artÄ±r, timestamp gÃ¼ncelle
                    Log("âš ï¸ PAIR PENDING: " + pairKey + " " + secondLeg + " yine dolmadÄ± (" + secondFilled + "/" + secondQty + ")");
                    if (!IS_TEST) Sistem.EmirIptal(FUTURES_PREFIX + secondContract);
                    data[9] = DateTime.Now;
                    data[10] = retryCount + 1;
                }
            } else {
                // Derinlik yok - bekle
                Log("â³ PAIR PENDING: " + pairKey + " " + secondLeg + " derinlik yetersiz, bekleniyor...");
                data[9] = DateTime.Now;
                data[10] = retryCount + 1;
            }
        } catch (Exception ex) {
            Log("âŒ PAIR PENDING hata: " + kv.Key + " - " + ex.Message);
        }
    }
    
    foreach (var key in toRemove) {
        pairPendingCompletion.Remove(key);
    }
};

// Pair sinyal kontrolÃ¼
Action CheckPairSignals = () => {
    if (!PAIR_ENABLED || !isMarketOpen || isPaused || !apiDataOk) return;
    if (PAIR_DEFS.Count == 0) return;  // Ã‡ift tanÄ±mÄ± yoksa Ã§Ä±k
    
    var now = DateTime.Now;
    
    // Saat kontrolÃ¼
    var pairTimeOk = (now.Hour > PAIR_START_HOUR || (now.Hour == PAIR_START_HOUR && now.Minute >= PAIR_START_MIN)) &&
                     (now.Hour < PAIR_END_HOUR || (now.Hour == PAIR_END_HOUR && now.Minute <= PAIR_END_MIN));
    
    // GÃ¼nlÃ¼k veri yÃ¼kleme (gÃ¼n deÄŸiÅŸimi veya ilk Ã§alÄ±ÅŸma)
    if (lastPairDataLoad.Date != now.Date || pairSpreads.Count == 0) {
        Log("ğŸ“Š PAIR: GÃ¼nlÃ¼k veri yÃ¼kleniyor...");
        LoadPairData();
    }
    
    // Z-Score gÃ¼ncelle (canlÄ± fiyatlarla)
    UpdatePairZScores();
    
    // ========== ENDEKS DEVRE KESÄ°CÄ° - TÃœM PAIR POZLARI KAPAT ==========
    if (indexCircuitBreaker && pairPos.Count > 0) {
        Log("ğŸš¨ PAIR: ENDEKS DEVRE KESÄ°CÄ° - TÃ¼m pair pozisyonlarÄ± kapatÄ±lÄ±yor!");
        for (int i = 0; i < PAIR_DEFS.Count; i++) {
            var def = PAIR_DEFS[i];
            var pairKey = GetPairKey((string)def[0], (string)def[1]);
            if (pairPos.ContainsKey(pairKey)) {
                ClosePair(i);
            }
        }
        return;  // Bu dÃ¶ngÃ¼de baÅŸka iÅŸlem yapma
    }
    
    // Her Ã§ift iÃ§in sinyal kontrolÃ¼
    for (int i = 0; i < PAIR_DEFS.Count; i++) {
        var def = PAIR_DEFS[i];
        var symA = (string)def[0];
        var symB = (string)def[1];
        var beta = (decimal)def[2];
        var pairKey = GetPairKey(symA, symB);
        
        if (!pairZScores.ContainsKey(pairKey)) continue;
        
        var z = pairZScores[pairKey];
        var absZ = Math.Abs(z);
        var hasPos = pairPos.ContainsKey(pairKey);
        var currentTier = hasPos ? (int)pairPos[pairKey][5] : 0;
        
        // ========== DEVRE KESÄ°CÄ° KONTROLÃœ (Ã§ift bazlÄ±) ==========
        if (hasPos && IsPairCircuitBreaker(symA, symB)) {
            Log("ğŸš¨ PAIR: " + pairKey + " DEVRE KESÄ°CÄ° - Pozisyon kapatÄ±lÄ±yor!");
            ClosePair(i);
            continue;
        }
        
        // ========== ROLLOVER KONTROLÃœ (vade son 2 gÃ¼n) ==========
        if (hasPos) {
            // Mevcut kontratlarÄ± al (pairContracts'tan veya GetContract(0)'dan)
            var currentContracts = pairContracts.ContainsKey(pairKey) ? pairContracts[pairKey] : new string[] { GetContract(symA, 0), GetContract(symB, 0) };
            var currentNearA = currentContracts[0];
            var currentNearB = currentContracts[1];
            var daysA = GetDays(currentNearA);
            var daysB = GetDays(currentNearB);
            var minDays = Math.Min(daysA, daysB);
            
            if (minDays <= 2) {
                Log("ğŸ”„ PAIR ROLLOVER: " + pairKey + " vade son " + minDays + " gÃ¼n [" + currentNearA + "/" + currentNearB + "]");
                var pos = pairPos[pairKey];
                var openZ = pos[4];
                var tier = (int)pos[5];
                var isLongA = openZ < 0;
                
                // Sonraki vade kontratlarÄ±nÄ± kontrol et (Far = offset 1)
                var nextNearA = GetContract(symA, 1);
                var nextNearB = GetContract(symB, 1);
                if (string.IsNullOrEmpty(nextNearA) || string.IsNullOrEmpty(nextNearB)) {
                    Log("âš ï¸ PAIR ROLLOVER: " + pairKey + " sonraki vade kontratÄ± bulunamadÄ±!");
                    continue;
                }
                Log("ğŸ”„ PAIR ROLLOVER: " + pairKey + " yeni kontratlar: [" + nextNearA + "/" + nextNearB + "]");
                
                // Ã–nce kapat (mevcut kontratlarla)
                if (ClosePair(i)) {
                    // Sonra yeni vade ile aÃ§ (contractOffset=1 ile Far kontrata gir)
                    Log("ğŸ”„ PAIR ROLLOVER: " + pairKey + " yeni vade ile aÃ§Ä±lÄ±yor (Kademe " + tier + ")");
                    for (int t = 0; t < tier; t++) {
                        if (!OpenPair(i, t, isLongA, 1)) break;  // offset=1 ile Far kontrat
                    }
                }
                continue;
            }
        }
        
        // ========== Ã‡IKIÅ KONTROLÃœ ==========
        if (hasPos) {
            var openZ = pairPos[pairKey][4];
            var shouldExit = false;
            
            // Z normale dÃ¶ndÃ¼ mÃ¼?
            if (openZ < 0 && z > -PAIR_Z_EXIT) shouldExit = true;
            else if (openZ > 0 && z < PAIR_Z_EXIT) shouldExit = true;
            
            if (shouldExit) {
                // Ã‡Ä±kÄ±ÅŸta isLongA'nÄ±n tersi gerekiyor (pozisyon kapatma = ters iÅŸlem)
                var wasLongA = openZ < 0;
                
                // Taban/tavan kontrolÃ¼ - Ã§Ä±kÄ±ÅŸ iÃ§in ters yÃ¶n
                if (IsPairLimitBlocked(symA, symB, !wasLongA)) {
                    Log("âš ï¸ PAIR: " + pairKey + " taban/tavan engeli - Ã§Ä±kÄ±ÅŸ ertelendi");
                    continue;
                }
                
                Log("ğŸ“‰ PAIR Ã‡IKIÅ SÄ°NYALÄ°: " + pairKey + " Z=" + z.ToString("F2") + " (GiriÅŸ:" + openZ.ToString("F2") + ")");
                ClosePair(i);
                continue;
            }
        }
        
        // ========== GÄ°RÄ°Å KONTROLÃœ ==========
        if (!pairTimeOk) continue;
        if (hasPos && currentTier >= PAIR_MAX_TIERS) continue;
        
        // Devre kesicideyse yeni pozisyon aÃ§ma
        if (IsPairCircuitBreaker(symA, symB)) continue;
        
        // AÃ‡ILIÅ VOLATÄ°LÄ°TESÄ° KORUMASI: 10:05'e kadar yeni giriÅŸ yapma
        if (!IsAfterOpeningVolatility()) continue;
        
        // TEMETTÃœ GÃœNÃœ KORUMASI: AnlÄ±k fiyatla Z-Score hesabÄ± gÃ¼venilmez
        if (IsDividendDay(symA) || IsDividendDay(symB)) {
            if (!hasPos) {  // Sadece yeni giriÅŸ iÃ§in log
                Log("âš ï¸ PAIR: " + pairKey + " temettÃ¼ gÃ¼nÃ¼ - giriÅŸ atlandÄ± (Z-Score gÃ¼venilmez)");
            }
            continue;
        }
        
        // SERMAYE ARTIRIMI KORUMASI: BugÃ¼n veya 7 gÃ¼n iÃ§inde sermaye artÄ±rÄ±mÄ± varsa atla
        if (IsSermayeArtirimiBlocked(symA) || IsSermayeArtirimiBlocked(symB)) {
            if (!hasPos) Log("â›” PAIR: " + pairKey + " sermaye artÄ±rÄ±mÄ± - giriÅŸ atlandÄ±");
            continue;
        }
        
        var shouldEnter = false;
        var targetTier = 0;
        var isLongAEntry = false;
        
        // Z < -2: A ucuz, B pahalÄ± â†’ A LONG, B SHORT
        if (z < -PAIR_Z_ENTRY_1) {
            isLongAEntry = true;
            if (z < -PAIR_Z_ENTRY_3 && currentTier < 3) targetTier = 3;
            else if (z < -PAIR_Z_ENTRY_2 && currentTier < 2) targetTier = 2;
            else if (currentTier < 1) targetTier = 1;
            if (targetTier > currentTier) shouldEnter = true;
        }
        // Z > +2: A pahalÄ±, B ucuz â†’ A SHORT, B LONG
        else if (z > PAIR_Z_ENTRY_1) {
            isLongAEntry = false;
            if (z > PAIR_Z_ENTRY_3 && currentTier < 3) targetTier = 3;
            else if (z > PAIR_Z_ENTRY_2 && currentTier < 2) targetTier = 2;
            else if (currentTier < 1) targetTier = 1;
            if (targetTier > currentTier) shouldEnter = true;
        }
        
        if (shouldEnter) {
            // Taban/tavan kontrolÃ¼ - emir gÃ¶ndermeden Ã¶nce
            if (IsPairLimitBlocked(symA, symB, isLongAEntry)) {
                Log("âš ï¸ PAIR: " + pairKey + " taban/tavan engeli - giriÅŸ iptal");
                continue;
            }
            
            Log("ğŸ“ˆ PAIR GÄ°RÄ°Å SÄ°NYALÄ°: " + pairKey + " Z=" + z.ToString("F2") + " | Kademe " + currentTier + " â†’ " + targetTier);
            
            // Eksik kademeleri sÄ±rayla aÃ§ (offset=0, normal Near kontrat)
            for (int t = currentTier; t < targetTier; t++) {
                if (!OpenPair(i, t, isLongAEntry, 0)) break;
            }
        }
    }
};

// ====================================
// STATS HISTORY - HaftalÄ±k/AylÄ±k/YÄ±llÄ±k Ä°statistikler
// ====================================
var statsHistory = new System.Collections.Generic.Dictionary<string, decimal[]>();
// Her gÃ¼n iÃ§in: [snPnl, viopComm, spotComm, closedCount]

Action LoadStatsHistory = () => {
    try {
        if (!System.IO.File.Exists(STATS_HISTORY_FILE)) return;
        var json = System.IO.File.ReadAllText(STATS_HISTORY_FILE);
        var entries = json.Trim('{', '}', ' ', '\n', '\r').Split(new[] { "}," }, StringSplitOptions.RemoveEmptyEntries);
        
        foreach (var entry in entries) {
            try {
                var parts = entry.Split(new[] { ":{" }, StringSplitOptions.None);
                if (parts.Length < 2) continue;
                var date = parts[0].Trim().Trim('"', ' ', '\n', '\r');
                var values = parts[1].Replace("}", "");
                
                var snPnl = 0m; var viopComm = 0m; var spotComm = 0m; var closedCount = 0m;
                foreach (var kv in values.Split(',')) {
                    var pair = kv.Split(':');
                    if (pair.Length != 2) continue;
                    var key = pair[0].Trim().Trim('"');
                    decimal val;
                    if (!decimal.TryParse(pair[1].Trim(), System.Globalization.NumberStyles.Any, 
                        System.Globalization.CultureInfo.InvariantCulture, out val)) continue;
                    if (key == "snPnl") snPnl = val;
                    else if (key == "viopComm") viopComm = val;
                    else if (key == "spotComm") spotComm = val;
                    else if (key == "closedCount") closedCount = val;
                }
                statsHistory[date] = new decimal[] { snPnl, viopComm, spotComm, closedCount };
            } catch { }
        }
        Log("Stats history yÃ¼klendi: " + statsHistory.Count + " gÃ¼n");
    } catch (Exception ex) { Log("Stats history yÃ¼kleme hata: " + ex.Message); }
};

Action SaveStatsHistory = () => {
    try {
        var sb = new System.Text.StringBuilder();
        sb.Append("{\n");
        var first = true;
        foreach (var kv in statsHistory) {
            if (!first) sb.Append(",\n");
            first = false;
            sb.Append("  \"" + kv.Key + "\": {");
            sb.Append("\"snPnl\":" + kv.Value[0].ToString(System.Globalization.CultureInfo.InvariantCulture));
            sb.Append(",\"viopComm\":" + kv.Value[1].ToString(System.Globalization.CultureInfo.InvariantCulture));
            sb.Append(",\"spotComm\":" + kv.Value[2].ToString(System.Globalization.CultureInfo.InvariantCulture));
            sb.Append(",\"closedCount\":" + ((int)kv.Value[3]).ToString());
            sb.Append("}");
        }
        sb.Append("\n}");
        System.IO.File.WriteAllText(STATS_HISTORY_FILE, sb.ToString());
    } catch (Exception ex) { Log("Stats history kayÄ±t hata: " + ex.Message); }
};

SaveDailyStats = () => {
    var today = DateTime.Now.ToString("yyyy-MM-dd");
    if (lastStatsSaveDate == today) {
        // BugÃ¼n zaten kaydedildi, gÃ¼ncelle
        statsHistory[today] = new decimal[] { dailySNPnl, dailyViopCommission, dailySpotCommission, totalClosedSN };
    } else {
        // Yeni gÃ¼n
        statsHistory[today] = new decimal[] { dailySNPnl, dailyViopCommission, dailySpotCommission, totalClosedSN };
        lastStatsSaveDate = today;
    }
    SaveStatsHistory();
};

// DÃ¶nemsel istatistik hesaplama
Func<int, decimal[]> CalcPeriodStats = (days) => {
    // Returns: [totalPnl, totalViopComm, totalSpotComm, totalClosed, tradingDays]
    var result = new decimal[] { 0, 0, 0, 0, 0 };
    var cutoff = DateTime.Now.AddDays(-days);
    
    foreach (var kv in statsHistory) {
        DateTime date;
        if (!DateTime.TryParse(kv.Key, out date)) continue;
        if (date < cutoff) continue;
        
        result[0] += kv.Value[0];  // snPnl
        result[1] += kv.Value[1];  // viopComm
        result[2] += kv.Value[2];  // spotComm
        result[3] += kv.Value[3];  // closedCount
        result[4]++;               // tradingDays
    }
    return result;
};

Func<decimal[]> CalcAllTimeStats = () => {
    var result = new decimal[] { 0, 0, 0, 0, 0 };
    foreach (var kv in statsHistory) {
        result[0] += kv.Value[0];
        result[1] += kv.Value[1];
        result[2] += kv.Value[2];
        result[3] += kv.Value[3];
        result[4]++;
    }
    return result;
};

// Stats JSON oluÅŸturma - tek fonksiyon, fullStats=true ise dÃ¶nemsel istatistikler ve pozisyonlar dahil
Func<string> BuildStatsJson = () => {
    var ic = System.Globalization.CultureInfo.InvariantCulture;
    var sb = new System.Text.StringBuilder();
    var totalComm = dailySpotCommission + totalTransferredComm + dailyViopCommission;
    
    sb.Append("{\"ts\":\"" + DateTime.Now.ToString("HH:mm:ss") + "\",");
    sb.Append("\"test\":" + (IS_TEST ? "true" : "false") + ",");
    sb.Append("\"running\":" + (isRunning ? "true" : "false") + ",");
    sb.Append("\"market\":" + (isMarketOpen ? "true" : "false") + ",");
    sb.Append("\"paused\":" + (isPaused ? "true" : "false") + ",");
    sb.Append("\"data\":" + (dataConnected ? "true" : "false") + ",");
    sb.Append("\"broker\":" + (brokerConnected ? "true" : "false") + ",");
    sb.Append("\"margin\":" + marginStatus + ",");  // 0=normal, 1=warning, 2=danger, 3=critical
    sb.Append("\"circuit\":" + (indexCircuitBreaker ? "true" : "false") + ",");  // Endeks devre kesici

    // Kritik uyarÄ±lar dizisi
    sb.Append("\"alerts\":[");
    var alertList = new System.Collections.Generic.List<string>();
    if (t2CriticalAlert) alertList.Add("\"T2_CRITICAL\"");
    if (indexCircuitBreaker) alertList.Add("\"INDEX_CIRCUIT\"");
    if (marginStatus >= 3) alertList.Add("\"MARGIN_CRITICAL\"");
    sb.Append(string.Join(",", alertList.ToArray()));
    sb.Append("],");

    // VÄ°OP serbest oran hesapla: kullanÄ±labilir / (kullanÄ±labilir + kullanÄ±lan)
    var viopToplam = viopBalance + viopUsed;
    var viopFreePct = viopToplam > 0 ? viopBalance / viopToplam : 0m;
    sb.Append("\"viop_free\":" + viopFreePct.ToString("F4", ic) + ",");
    
    sb.Append("\"viop_bal\":" + viopBalance.ToString("F0", ic) + ",\"spot_bal\":" + spotBudgetTotal.ToString("F0", ic) + ",\"t2\":" + t2Balance.ToString("F0", ic) + ",");
    sb.Append("\"viop_used\":" + viopUsed.ToString(ic) + ",\"spot_used\":" + spotUsed.ToString(ic) + ",");
    sb.Append("\"viop_budget\":" + VIOP_BUDGET.ToString("F0", ic) + ",\"spot_budget\":" + SPOT_BUDGET.ToString("F0", ic) + ",");
    sb.Append("\"daily_pnl\":" + dailyRealizedPnl.ToString("F0", ic) + ",\"trades\":" + dailyTrades + ",");
    sb.Append("\"total_comm\":" + totalComm.ToString("F2", ic) + ",");
    sb.Append("\"risk_free\":" + RISK_FREE.ToString("F4", ic) + ",");
    
    // DÃ¶nemsel istatistikler
    var weekStats = CalcPeriodStats(7);
    var monthStats = CalcPeriodStats(30);
    var allStats = CalcAllTimeStats();
    
    sb.Append("\"week\":{\"pnl\":" + weekStats[0].ToString("F0", ic) + 
        ",\"comm\":" + (weekStats[1] + weekStats[2]).ToString("F0", ic) + 
        ",\"trades\":" + ((int)weekStats[3]).ToString() + 
        ",\"days\":" + ((int)weekStats[4]).ToString() + "},");
    sb.Append("\"month\":{\"pnl\":" + monthStats[0].ToString("F0", ic) + 
        ",\"comm\":" + (monthStats[1] + monthStats[2]).ToString("F0", ic) + 
        ",\"trades\":" + ((int)monthStats[3]).ToString() + 
        ",\"days\":" + ((int)monthStats[4]).ToString() + "},");
    sb.Append("\"all\":{\"pnl\":" + allStats[0].ToString("F0", ic) + 
        ",\"comm\":" + (allStats[1] + allStats[2]).ToString("F0", ic) + 
        ",\"trades\":" + ((int)allStats[3]).ToString() + 
        ",\"days\":" + ((int)allStats[4]).ToString() + "},");
    
    // Pozisyonlar (her zaman tam detay)
    sb.Append("\"positions\":{");
    var posFirst = true;
    decimal totalPnl = 0;
    foreach (var kv in snPos) {
        if (!posFirst) sb.Append(",");
        posFirst = false;
        var p = kv.Value;
        var sym = kv.Key;
        var spotQty = (int)p[0]; var nearQty = (int)p[1];
        var spotEntry = (decimal)p[2]; var nearEntry = (decimal)p[3];
        var entrySpread = (decimal)p[4];
        var expectedPnl = (decimal)p[5]; var addCount = (int)p[6];
        var entryTicks = p.Length > 7 ? (long)p[7] : 0L;
        
        // GÃ¼ncel spread ve P&L hesapla (derinlikten)
        var nearC = GetContract(sym, 0);
        var nearS = FUTURES_PREFIX + nearC;
        var spotBidDepthG = ReadDepth("IMKBH'" + sym, "BID", 0, 1, 50);
        var nearAskDepthG = ReadDepth(nearS, "ASK", 0, 1, 50);
        var spotBid = spotBidDepthG.Item1 ? spotBidDepthG.Item4 : 0m;
        var nearAskG = nearAskDepthG.Item1 ? nearAskDepthG.Item4 : 0m;
        
        // dayanakSatAl = nearAsk - spotBid (kapanÄ±ÅŸ spread'i)
        var dayanakSatAl = nearAskG - spotBid;
        var currentSpread = spotBid > 0 ? dayanakSatAl / spotBid : 0m;
        
        // P&L = Spot P&L + Near P&L
        // Spot: (satÄ±ÅŸ fiyatÄ± - giriÅŸ) * adet
        // Near: (giriÅŸ - ÅŸimdiki) * kontrat * Ã§arpan
        var mult = GetMultiplier(sym);
        var currentPnl = (spotBid - spotEntry) * spotQty + (nearEntry - nearAskG) * nearQty * mult;
        totalPnl += currentPnl;
        
        sb.Append("\"" + sym + "\":{");
        sb.Append("\"sq\":" + spotQty + ",\"nq\":" + nearQty + ",");
        sb.Append("\"se\":" + spotEntry.ToString("F2", ic) + ",\"ne\":" + nearEntry.ToString("F2", ic) + ",");
        sb.Append("\"es\":" + entrySpread.ToString("F6", ic) + ",");  // entry spread
        sb.Append("\"et\":" + entryTicks + ",");  // entry ticks
        sb.Append("\"sp\":" + currentSpread.ToString("F4", ic) + ",");
        sb.Append("\"pnl\":" + currentPnl.ToString("F0", ic) + ",");
        sb.Append("\"exp\":" + expectedPnl.ToString("F0", ic) + ",");
        sb.Append("\"d\":" + addCount + "}");
    }
    sb.Append("},");
    
    // NF Pozisyonlar (Near-Far)
    sb.Append("\"nf_positions\":{");
    var nfPosFirst = true;
    decimal totalNfPnl = 0;
    foreach (var kv in nfPos) {
        if (!nfPosFirst) sb.Append(",");
        nfPosFirst = false;
        var p = kv.Value;
        var sym = kv.Key;
        var nearQty = (int)p[0]; var farQty = (int)p[1];
        var nearEntry = p[2]; var farEntry = p[3];
        var entrySpread = p[4]; var expectedPnl = p[5];
        var entryTicks = p.Length > 6 ? (long)p[6] : 0L;
        
        // GÃ¼ncel fiyatlar ve P&L hesapla
        var nearC = nfContracts.ContainsKey(sym) ? nfContracts[sym][0] : GetContract(sym, 0);
        var farC = nfContracts.ContainsKey(sym) ? nfContracts[sym][1] : GetContract(sym, 1);
        var nearS = FUTURES_PREFIX + nearC;
        var farS = FUTURES_PREFIX + farC;
        
        var nearBidDepthG = ReadDepth(nearS, "BID", 0, 1, 50);
        var farAskDepthG = ReadDepth(farS, "ASK", 0, 1, 50);
        var nearBid = nearBidDepthG.Item1 ? nearBidDepthG.Item4 : nearEntry;
        var farAsk = farAskDepthG.Item1 ? farAskDepthG.Item4 : farEntry;
        
        var mult = GetMultiplier(sym);
        var nearPnl = (nearBid - nearEntry) * nearQty * mult;
        var farPnl = (farEntry - farAsk) * farQty * mult;
        var currentPnl = nearPnl + farPnl;
        totalNfPnl += currentPnl;
        
        // GÃ¼ncel spread
        var currentSpread = nearBid > 0 ? (farAsk - nearBid) / nearBid : 0m;
        
        sb.Append("\"" + sym + "\":{");
        sb.Append("\"nq\":" + nearQty + ",\"fq\":" + farQty + ",");
        sb.Append("\"ne\":" + nearEntry.ToString("F2", ic) + ",\"fe\":" + farEntry.ToString("F2", ic) + ",");
        sb.Append("\"es\":" + entrySpread.ToString("F6", ic) + ",");
        sb.Append("\"et\":" + entryTicks + ",");
        sb.Append("\"sp\":" + currentSpread.ToString("F4", ic) + ",");
        sb.Append("\"pnl\":" + currentPnl.ToString("F0", ic) + ",");
        sb.Append("\"exp\":" + expectedPnl.ToString("F0", ic) + ",");
        sb.Append("\"d\":" + GetDays(nearC) + "}");
    }
    sb.Append("},");
    sb.Append("\"nf_count\":" + nfPos.Count + ",");
    sb.Append("\"nf_budget\":" + NF_BUDGET.ToString("F0", ic) + ",");
    
    // PAIR Pozisyonlar (Near-Near Pair Trading)
    sb.Append("\"pair_positions\":{");
    var pairPosFirst = true;
    decimal totalPairPnlB = 0;
    foreach (var kv in pairPos) {
        if (!pairPosFirst) sb.Append(",");
        pairPosFirst = false;
        var p = kv.Value;
        var parts = kv.Key.Split('-');
        if (parts.Length == 2) {
            var symA = parts[0];
            var symB = parts[1];
            var currentZ = pairZScores.ContainsKey(kv.Key) ? pairZScores[kv.Key] : 0m;
            var unrealizedPnl = CalcPairUnrealizedPnl(kv.Key, p);
            var expectedPnl = p.Length > 7 ? p[7] : 0m;
            totalPairPnlB += unrealizedPnl;
            
            // KontratlarÄ± pairContracts'tan al (yoksa GetContract'tan)
            var pairC = pairContracts.ContainsKey(kv.Key) ? pairContracts[kv.Key] : new string[] { GetContract(symA, 0), GetContract(symB, 0) };
            var nearA = pairC[0];
            var daysToExp = string.IsNullOrEmpty(nearA) ? 0 : GetDays(nearA);
            
            sb.Append("\"" + kv.Key + "\":{");
            sb.Append("\"a\":" + ((int)p[0]).ToString() + ",");
            sb.Append("\"b\":" + ((int)p[1]).ToString() + ",");
            sb.Append("\"avgA\":" + p[2].ToString("F2", ic) + ",");
            sb.Append("\"avgB\":" + p[3].ToString("F2", ic) + ",");
            sb.Append("\"oz\":" + p[4].ToString("F2", ic) + ",");
            sb.Append("\"cz\":" + currentZ.ToString("F2", ic) + ",");
            sb.Append("\"t\":" + ((int)p[5]).ToString() + ",");
            sb.Append("\"pnl\":" + unrealizedPnl.ToString("F0", ic) + ",");
            sb.Append("\"exp\":" + expectedPnl.ToString("F0", ic) + ",");
            sb.Append("\"d\":" + daysToExp + ",");
            sb.Append("\"ca\":\"" + pairC[0] + "\",");
            sb.Append("\"cb\":\"" + pairC[1] + "\"}");
        }
    }
    sb.Append("},");
    sb.Append("\"pair_count\":" + pairPos.Count + ",");
    sb.Append("\"pair_enabled\":" + (PAIR_ENABLED ? "true" : "false") + ",");
    sb.Append("\"pair_budget\":" + PAIR_BUDGET.ToString("F0", ic) + ",");
    sb.Append("\"pair_used\":" + pairUsed.ToString("F0", ic) + ",");
    sb.Append("\"pair_definitions\":\"" + PAIR_DEFINITIONS.Replace("\"", "\\\"") + "\",");
    
    // Pair Z-Score Ã¶zeti (tÃ¼m tanÄ±mlÄ± Ã§iftler iÃ§in)
    sb.Append("\"pair_z\":{");
    var pzFirst = true;
    foreach (var def in PAIR_DEFS) {
        var symA = (string)def[0];
        var symB = (string)def[1];
        var pairKey = GetPairKey(symA, symB);
        if (!pzFirst) sb.Append(",");
        pzFirst = false;
        if (pairZScores.ContainsKey(pairKey)) {
            sb.Append("\"" + pairKey + "\":" + pairZScores[pairKey].ToString("F2", ic));
        } else {
            sb.Append("\"" + pairKey + "\":null");  // Veri yok
        }
    }
    sb.Append("},");
    
    // Bekleyen emirler
    sb.Append("\"pending\":{");
    var pendFirst = true;
    foreach (var pk in pendingOrders) {
        if (!pendFirst) sb.Append(",");
        pendFirst = false;
        var pd = pk.Value;
        var waitMin = (DateTime.Now - (DateTime)pd[3]).TotalMinutes;
        sb.Append("\"" + pk.Key + "\":{");
        sb.Append("\"side\":\"" + pd[0] + "\",");
        sb.Append("\"qty\":" + ((int)pd[1]).ToString() + ",");
        sb.Append("\"price\":" + ((decimal)pd[2]).ToString("F2", ic) + ",");
        sb.Append("\"wait\":" + waitMin.ToString("F0", ic) + ",");
        sb.Append("\"processed\":" + (pd.Length > 11 ? ((int)pd[11]).ToString() : "0") + "}");
    }
    sb.Append("},");
    sb.Append("\"pending_count\":" + pendingOrders.Count + ",");
    
    // Yetim bacaklar
    sb.Append("\"orphans\":{");
    var orphFirst = true;
    foreach (var kv in orphanLegs) {
        if (!orphFirst) sb.Append(",");
        orphFirst = false;
        var o = kv.Value;
        sb.Append("\"" + kv.Key + "\":{");
        sb.Append("\"fl\":\"" + o[0] + "\",");              // filledLeg
        sb.Append("\"fs\":\"" + o[2] + "\",");              // filledSide
        sb.Append("\"fq\":" + ((int)o[3]).ToString() + ","); // filledQty
        sb.Append("\"fp\":" + ((decimal)o[4]).ToString("F2", ic) + ","); // filledPrice
        sb.Append("\"tl\":\"" + o[5] + "\"}");              // targetLeg
    }
    sb.Append("},");
    sb.Append("\"orphan_count\":" + orphanLegs.Count + ",");
    
    sb.Append("\"total_pnl\":" + (totalPnl + totalNfPnl + totalPairPnlB).ToString("F0", ic) + ",\"count\":" + (snPos.Count + nfPos.Count + pairPos.Count) + "}");
    
    return sb.ToString();
};

// 09:20 teminat gÃ¼ncelleme kontrolÃ¼
var lastTeminatUpdate = DateTime.MinValue;
Action CheckTeminatUpdate = () => {
    var now = DateTime.Now;
    if (now.Hour == 9 && now.Minute >= 20 && now.Minute < 25) {
        if (lastTeminatUpdate.Date != now.Date) {
            if (!IsTeminatFileCurrentMonth()) {
                Log("ğŸ“… Teminat dosyasÄ± bu aya ait deÄŸil, gÃ¼ncelleniyor...");
                UpdateTeminatFromVIOP();
            }
            lastTeminatUpdate = now;
        }
    }
};

// 09:56 derinlik cache warmup (piyasa aÃ§Ä±lÄ±ÅŸÄ±ndan Ã¶nce)
var lastDepthWarmup = DateTime.MinValue;
Action WarmupDepthCache = () => {
    var now = DateTime.Now;
    // 09:56-09:59 arasÄ±nda, gÃ¼nde bir kez
    if (now.Hour == 9 && now.Minute >= 56 && now.Minute < 60) {
        if (lastDepthWarmup.Date != now.Date) {
            Log("ğŸ”¥ Derinlik cache ve tavan/taban uyandÄ±rÄ±lÄ±yor (" + symbols.Count + " sembol)...");
            var warmupCount = 0;
            var tavanTabanCount = 0;
            foreach (var sym in symbols) {
                try {
                    var nearC = GetContract(sym, 0);
                    var farC = GetContract(sym, 1);
                    
                    var spotSym = SPOT_PREFIX + sym;
                    var nearSym = FUTURES_PREFIX + nearC;
                    
                    // Spot derinlik
                    Sistem.DerinlikVerisiOku(spotSym);
                    // Near derinlik
                    Sistem.DerinlikVerisiOku(nearSym);
                    // Far derinlik
                    if (!string.IsNullOrEmpty(farC)) {
                        Sistem.DerinlikVerisiOku(FUTURES_PREFIX + farC);
                    }
                    warmupCount++;
                    
                    // Tavan/Taban fiyatlarÄ± (Spot, Near ve Far iÃ§in)
                    try {
                        var spotTavan = (decimal)Sistem.Tavan(spotSym);
                        var spotTaban = (decimal)Sistem.Taban(spotSym);
                        if (spotTavan > 0) tavanFiyat[spotSym] = spotTavan;
                        if (spotTaban > 0) tabanFiyat[spotSym] = spotTaban;
                        
                        var nearTavan = (decimal)Sistem.Tavan(nearSym);
                        var nearTaban = (decimal)Sistem.Taban(nearSym);
                        if (nearTavan > 0) tavanFiyat[nearSym] = nearTavan;
                        if (nearTaban > 0) tabanFiyat[nearSym] = nearTaban;
                        
                        // Far tavan/taban (NF stratejisi iÃ§in)
                        if (!string.IsNullOrEmpty(farC)) {
                            var farSym = FUTURES_PREFIX + farC;
                            var farTavan = (decimal)Sistem.Tavan(farSym);
                            var farTaban = (decimal)Sistem.Taban(farSym);
                            if (farTavan > 0) tavanFiyat[farSym] = farTavan;
                            if (farTaban > 0) tabanFiyat[farSym] = farTaban;
                        }
                        
                        tavanTabanCount++;
                    } catch { }
                } catch { }
            }
            Log("âœ… Cache uyandÄ±rÄ±ldÄ±: " + warmupCount + " sembol (derinlik), " + tavanTabanCount + " sembol (tavan/taban)");
            lastDepthWarmup = now;
        }
    }
};

// Robot baÅŸlangÄ±cÄ±nda tavan/taban fiyatlarÄ±nÄ± yÃ¼kle (gÃ¼n iÃ§i baÅŸlatma iÃ§in)
Action LoadTavanTaban = () => {
    Log("ğŸ“Š Tavan/taban fiyatlarÄ± yÃ¼kleniyor...");
    var loadedCount = 0;
    foreach (var sym in symbols) {
        try {
            var nearC = GetContract(sym, 0);
            if (string.IsNullOrEmpty(nearC)) continue;
            
            var spotSym = SPOT_PREFIX + sym;
            var nearSym = FUTURES_PREFIX + nearC;
            
            // Spot tavan/taban
            try {
                var spotTavan = (decimal)Sistem.Tavan(spotSym);
                var spotTaban = (decimal)Sistem.Taban(spotSym);
                if (spotTavan > 0) tavanFiyat[spotSym] = spotTavan;
                if (spotTaban > 0) tabanFiyat[spotSym] = spotTaban;
            } catch { }
            
            // Near tavan/taban
            try {
                var nearTavan = (decimal)Sistem.Tavan(nearSym);
                var nearTaban = (decimal)Sistem.Taban(nearSym);
                if (nearTavan > 0) tavanFiyat[nearSym] = nearTavan;
                if (nearTaban > 0) tabanFiyat[nearSym] = nearTaban;
            } catch { }
            
            // Far tavan/taban (NF stratejisi iÃ§in)
            try {
                var farC = GetContract(sym, 1);
                if (!string.IsNullOrEmpty(farC)) {
                    var farSym = FUTURES_PREFIX + farC;
                    // Far derinlik cache uyandÄ±r
                    Sistem.DerinlikVerisiOku(farSym);
                    var farTavan = (decimal)Sistem.Tavan(farSym);
                    var farTaban = (decimal)Sistem.Taban(farSym);
                    if (farTavan > 0) tavanFiyat[farSym] = farTavan;
                    if (farTaban > 0) tabanFiyat[farSym] = farTaban;
                }
            } catch { }
            
            loadedCount++;
        } catch { }
    }
    Log("âœ… Tavan/taban yÃ¼klendi: " + loadedCount + " sembol (Tavan:" + tavanFiyat.Count + " Taban:" + tabanFiyat.Count + ")");
};

// ====================================
// TEMETTÃœ YÃ–NETÄ°MÄ°
// ====================================

// TemettÃ¼ JSON dosyasÄ±nÄ± yÃ¼kle
Action LoadDividends = () => {
    try {
        dividends.Clear();
        if (!System.IO.File.Exists(TEMETTU_FILE)) {
            Log("âš ï¸ TemettÃ¼ dosyasÄ± bulunamadÄ±: " + TEMETTU_FILE);
            return;
        }
        
        var json = System.IO.File.ReadAllText(TEMETTU_FILE);
        var ic = System.Globalization.CultureInfo.InvariantCulture;
        
        // "dividends": { bÃ¶lÃ¼mÃ¼nÃ¼ bul
        var divIdx = json.IndexOf("\"dividends\"");
        if (divIdx == -1) return;
        
        var divStart = json.IndexOf("{", divIdx + 10);
        if (divStart == -1) return;
        
        // Her sembolÃ¼ parse et
        var pos = divStart + 1;
        while (pos < json.Length) {
            // Sembol adÄ±nÄ± bul: "BEGYO": [
            var symStart = json.IndexOf("\"", pos);
            if (symStart == -1) break;
            var symEnd = json.IndexOf("\"", symStart + 1);
            if (symEnd == -1) break;
            
            var sym = json.Substring(symStart + 1, symEnd - symStart - 1);
            
            // Array baÅŸlangÄ±cÄ±
            var arrStart = json.IndexOf("[", symEnd);
            if (arrStart == -1) break;
            var arrEnd = json.IndexOf("]", arrStart);
            if (arrEnd == -1) break;
            
            var arrContent = json.Substring(arrStart, arrEnd - arrStart + 1);
            
            // Her temettÃ¼ kaydÄ±nÄ± parse et
            var divList = new System.Collections.Generic.List<System.Tuple<DateTime, decimal>>();
            var objPos = 0;
            while (true) {
                var dateIdx = arrContent.IndexOf("\"date\"", objPos);
                if (dateIdx == -1) break;
                
                // Tarih: "16.02.2026"
                var dateStart = arrContent.IndexOf("\"", dateIdx + 6) + 1;
                var dateEnd = arrContent.IndexOf("\"", dateStart);
                if (dateEnd <= dateStart) break;  // Parse hatasÄ± - Ã§Ä±k
                var dateStr = arrContent.Substring(dateStart, dateEnd - dateStart);
                
                // Tutar: "amount": 0.0215
                var amtIdx = arrContent.IndexOf("\"amount\"", dateEnd);
                if (amtIdx == -1) break;
                var amtStart = arrContent.IndexOf(":", amtIdx) + 1;
                var amtEnd = amtStart;
                while (amtEnd < arrContent.Length && (char.IsDigit(arrContent[amtEnd]) || arrContent[amtEnd] == '.' || arrContent[amtEnd] == ' ')) amtEnd++;
                
                // Ä°lerleme kontrolÃ¼ - sonsuz dÃ¶ngÃ¼ Ã¶nleme
                if (amtEnd <= objPos) break;
                
                DateTime divDate;
                decimal divAmount;
                if (DateTime.TryParseExact(dateStr, "dd.MM.yyyy", ic, System.Globalization.DateTimeStyles.None, out divDate) &&
                    decimal.TryParse(arrContent.Substring(amtStart, amtEnd - amtStart).Trim(), System.Globalization.NumberStyles.Any, ic, out divAmount)) {
                    divList.Add(System.Tuple.Create(divDate, divAmount));
                }
                
                objPos = amtEnd;
            }
            
            if (divList.Count > 0) {
                dividends[sym] = divList;
            }
            
            pos = arrEnd + 1;
            
            // Sonraki sembol veya dividends sonu
            var nextComma = json.IndexOf(",", pos);
            var nextBrace = json.IndexOf("}", pos);
            if (nextBrace != -1 && (nextComma == -1 || nextBrace < nextComma)) break;
        }
        
        var totalDivs = 0;
        foreach (var kv in dividends) totalDivs += kv.Value.Count;
        Log("âœ… TemettÃ¼ yÃ¼klendi: " + dividends.Count + " sembol, " + totalDivs + " kayÄ±t");
        
    } catch (Exception ex) {
        Log("âŒ TemettÃ¼ yÃ¼kleme hatasÄ±: " + ex.Message);
    }
};

// TemettÃ¼ scraper'Ä± Ã§alÄ±ÅŸtÄ±r ve JSON'u gÃ¼ncelle
Action UpdateDividends = () => {
    try {
        // Dosya var mÄ± ve bugÃ¼n gÃ¼ncellenmiÅŸ mi kontrol et
        var needUpdate = true;
        if (System.IO.File.Exists(TEMETTU_FILE)) {
            var json = System.IO.File.ReadAllText(TEMETTU_FILE);
            var updIdx = json.IndexOf("\"updated\"");
            if (updIdx != -1) {
                var dateStart = json.IndexOf("\"", updIdx + 9) + 1;
                var dateEnd = json.IndexOf("\"", dateStart);
                var updatedStr = json.Substring(dateStart, dateEnd - dateStart);
                DateTime updatedDate;
                if (DateTime.TryParse(updatedStr, out updatedDate)) {
                    if (updatedDate.Date >= DateTime.Now.Date) {
                        needUpdate = false;  // BugÃ¼n zaten gÃ¼ncellenmiÅŸ
                    }
                }
            }
        }
        
        if (!needUpdate) {
            Log("âœ… TemettÃ¼ verisi gÃ¼ncel (bugÃ¼n gÃ¼ncellenmiÅŸ)");
            LoadDividends();
            return;
        }
        
        // Scraper'Ä± Ã§alÄ±ÅŸtÄ±r
        if (!System.IO.File.Exists(TEMETTU_SCRAPER)) {
            Log("âš ï¸ TemettÃ¼ scraper bulunamadÄ±: " + TEMETTU_SCRAPER);
            LoadDividends();  // Mevcut veriyi yÃ¼kle
            return;
        }
        
        Log("ğŸ”„ TemettÃ¼ verisi gÃ¼ncelleniyor...");
        
        var psi = new System.Diagnostics.ProcessStartInfo();
        psi.FileName = "python";
        psi.Arguments = "\"" + TEMETTU_SCRAPER + "\"";
        psi.WorkingDirectory = BASE_PATH;
        psi.UseShellExecute = false;
        psi.CreateNoWindow = true;
        psi.RedirectStandardOutput = true;
        psi.RedirectStandardError = true;
        
        var proc = System.Diagnostics.Process.Start(psi);
        proc.WaitForExit(60000);  // 60 saniye timeout
        
        if (proc.ExitCode == 0) {
            Log("âœ… TemettÃ¼ scraper baÅŸarÄ±lÄ±");
        } else {
            var err = proc.StandardError.ReadToEnd();
            Log("âš ï¸ TemettÃ¼ scraper hata: " + (err.Length > 100 ? err.Substring(0, 100) : err));
        }
        
        LoadDividends();
        lastTemettuCheck = DateTime.Now;
        
    } catch (Exception ex) {
        Log("âŒ TemettÃ¼ gÃ¼ncelleme hatasÄ±: " + ex.Message);
        LoadDividends();  // Mevcut veriyi yÃ¼kle
    }
};

// Near-Far arasÄ± temettÃ¼ kontrolÃ¼
// DÃ¶nÃ¼ÅŸ: (temettÃ¼Var, toplamTemettÃ¼)
GetDividendsBetween = (sym, nearExpiry, farExpiry) => {
    var totalDiv = 0m;
    var hasDiv = false;
    
    if (!dividends.ContainsKey(sym)) {
        return System.Tuple.Create(false, 0m);
    }
    
    foreach (var div in dividends[sym]) {
        var exDate = div.Item1;
        // TemettÃ¼ tarihi Near vadesi ile Far vadesi arasÄ±nda mÄ±?
        if (exDate > nearExpiry && exDate <= farExpiry) {
            hasDiv = true;
            totalDiv += div.Item2;
        }
    }
    
    return System.Tuple.Create(hasDiv, totalDiv);
};

// ====================================
// SERMAYE ARTIRIMI KORUMA SÄ°STEMÄ°
// ====================================

// Sermaye artÄ±rÄ±mÄ± JSON'dan yÃ¼kle
Action LoadSermayeArtirimi = () => {
    try {
        if (!System.IO.File.Exists(SRM_FILE)) {
            Log("âš ï¸ srm.json bulunamadÄ±");
            return;
        }
        
        sermayeArtirimlari.Clear();
        var json = System.IO.File.ReadAllText(SRM_FILE);
        
        // data array'ini bul (yeni format: {"meta":{...}, "data":[...]})
        int dataStart = json.IndexOf("\"data\"");
        string dataSection = json;
        
        if (dataStart >= 0) {
            int arrayStart = json.IndexOf('[', dataStart);
            int arrayEnd = json.LastIndexOf(']');
            if (arrayStart >= 0 && arrayEnd > arrayStart) {
                dataSection = json.Substring(arrayStart, arrayEnd - arrayStart + 1);
            }
        }
        
        // Her kayÄ±t iÃ§in parse et
        int pos = 0;
        while (true) {
            int objStart = dataSection.IndexOf('{', pos);
            if (objStart < 0) break;
            
            int objEnd = dataSection.IndexOf('}', objStart);
            if (objEnd < 0) break;
            
            string obj = dataSection.Substring(objStart, objEnd - objStart + 1);
            pos = objEnd + 1;
            
            // bist_kodu Ã§Ä±kar
            var kodIdx = obj.IndexOf("\"bist_kodu\"");
            if (kodIdx < 0) continue;
            var kodStart = obj.IndexOf("\"", kodIdx + 11) + 1;
            var kodEnd = obj.IndexOf("\"", kodStart);
            if (kodStart <= 0 || kodEnd <= kodStart) continue;
            string bist_kodu = obj.Substring(kodStart, kodEnd - kodStart).ToUpper();
            
            // Ã–nce ISO formatÄ± dene
            string tarihStr = null;
            var isoIdx = obj.IndexOf("\"baslangic_iso\"");
            if (isoIdx >= 0) {
                var isoStart = obj.IndexOf("\"", isoIdx + 15) + 1;
                var isoEnd = obj.IndexOf("\"", isoStart);
                if (isoStart > 0 && isoEnd > isoStart) {
                    var isoVal = obj.Substring(isoStart, isoEnd - isoStart);
                    if (isoVal != "null" && !string.IsNullOrEmpty(isoVal)) {
                        tarihStr = isoVal;
                    }
                }
            }
            
            // ISO yoksa normal formatÄ± dene
            if (string.IsNullOrEmpty(tarihStr)) {
                var basIdx = obj.IndexOf("\"baslangic\"");
                if (basIdx >= 0) {
                    var basStart = obj.IndexOf("\"", basIdx + 11) + 1;
                    var basEnd = obj.IndexOf("\"", basStart);
                    if (basStart > 0 && basEnd > basStart) {
                        tarihStr = obj.Substring(basStart, basEnd - basStart);
                    }
                }
            }
            
            if (string.IsNullOrEmpty(tarihStr)) continue;
            
            // Tarihi parse et
            DateTime tarih;
            bool parsed = false;
            
            // ISO format: 2026-01-20
            if (DateTime.TryParseExact(tarihStr, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out tarih)) {
                parsed = true;
            }
            // TR format: 20.01.2026
            else if (DateTime.TryParseExact(tarihStr, "dd.MM.yyyy", null, System.Globalization.DateTimeStyles.None, out tarih)) {
                parsed = true;
            }
            
            if (parsed && !sermayeArtirimlari.ContainsKey(bist_kodu)) {
                sermayeArtirimlari[bist_kodu] = tarih;
            }
        }
        
        Log("âœ… Sermaye artÄ±rÄ±mÄ± yÃ¼klendi: " + sermayeArtirimlari.Count + " kayÄ±t (tarihi belli)");
        
        // 7 gÃ¼n iÃ§indekileri logla
        foreach (var kv in sermayeArtirimlari) {
            var gunFarki = (kv.Value.Date - DateTime.Today).Days;
            if (gunFarki >= 0 && gunFarki <= 7) {
                Log("  âš ï¸ " + kv.Key + ": " + kv.Value.ToString("dd.MM.yyyy") + " (" + gunFarki + " gÃ¼n sonra)");
            }
        }
        
    } catch (Exception ex) {
        Log("âŒ Sermaye artÄ±rÄ±mÄ± yÃ¼kleme hatasÄ±: " + ex.Message);
    }
};

// Sermaye artÄ±rÄ±mÄ± scraper Ã§alÄ±ÅŸtÄ±r ve JSON gÃ¼ncelle
Action UpdateSermayeArtirimi = () => {
    try {
        // Dosya var mÄ± ve bugÃ¼n gÃ¼ncellenmiÅŸ mi kontrol et
        var needUpdate = true;
        if (System.IO.File.Exists(SRM_FILE)) {
            var fileInfo = new System.IO.FileInfo(SRM_FILE);
            if (fileInfo.LastWriteTime.Date >= DateTime.Today) {
                needUpdate = false;  // BugÃ¼n zaten gÃ¼ncellenmiÅŸ
            }
        }
        
        if (!needUpdate) {
            Log("âœ… Sermaye artÄ±rÄ±mÄ± verisi gÃ¼ncel");
            LoadSermayeArtirimi();
            return;
        }
        
        // Scraper'Ä± Ã§alÄ±ÅŸtÄ±r
        if (!System.IO.File.Exists(SRM_SCRAPER)) {
            Log("âš ï¸ Sermaye artÄ±rÄ±mÄ± scraper bulunamadÄ±: " + SRM_SCRAPER);
            LoadSermayeArtirimi();  // Mevcut veriyi yÃ¼kle
            return;
        }
        
        Log("ğŸ”„ Sermaye artÄ±rÄ±mÄ± verisi gÃ¼ncelleniyor...");
        
        var psi = new System.Diagnostics.ProcessStartInfo();
        psi.FileName = "python";
        psi.Arguments = "\"" + SRM_SCRAPER + "\" --force";
        psi.WorkingDirectory = BASE_PATH;
        psi.UseShellExecute = false;
        psi.CreateNoWindow = true;
        psi.RedirectStandardOutput = true;
        psi.RedirectStandardError = true;
        
        var proc = System.Diagnostics.Process.Start(psi);
        proc.WaitForExit(90000);  // 90 saniye timeout (PDF indirme uzun sÃ¼rebilir)
        
        if (proc.ExitCode == 0) {
            Log("âœ… Sermaye artÄ±rÄ±mÄ± scraper baÅŸarÄ±lÄ±");
        } else {
            var err = proc.StandardError.ReadToEnd();
            Log("âš ï¸ Sermaye artÄ±rÄ±mÄ± scraper hata: " + (err.Length > 100 ? err.Substring(0, 100) : err));
        }
        
        LoadSermayeArtirimi();
        lastSrmCheck = DateTime.Now;
        
    } catch (Exception ex) {
        Log("âŒ Sermaye artÄ±rÄ±mÄ± gÃ¼ncelleme hatasÄ±: " + ex.Message);
        LoadSermayeArtirimi();  // Mevcut veriyi yÃ¼kle
    }
};

Action LoadSettings = () => {
    try {
        var ic = System.Globalization.CultureInfo.InvariantCulture;
        
        Func<string, string, decimal, decimal> getDecimal = (jsonStr, key, def) => {
            var idx = jsonStr.IndexOf("\"" + key + "\"");
            if (idx == -1) return def;
            var start = jsonStr.IndexOf(":", idx) + 1;
            var end = start;
            while (end < jsonStr.Length && (char.IsDigit(jsonStr[end]) || jsonStr[end] == '.' || jsonStr[end] == '-')) end++;
            decimal val;
            if (decimal.TryParse(jsonStr.Substring(start, end - start).Trim(), System.Globalization.NumberStyles.Any, ic, out val))
                return val;
            return def;
        };
        
        Func<string, string, string, string> getString = (jsonStr, key, def) => {
            var idx = jsonStr.IndexOf("\"" + key + "\"");
            if (idx == -1) return def;
            var start = jsonStr.IndexOf("\"", idx + key.Length + 3) + 1;
            var end = jsonStr.IndexOf("\"", start);
            return start > 0 && end > start ? jsonStr.Substring(start, end - start) : def;
        };
        
        // Gist credentials ayrÄ± dosyadan oku (Gist'e yÃ¼klenmiyor)
        if (System.IO.File.Exists(GIST_CREDENTIALS_FILE)) {
            var credJson = System.IO.File.ReadAllText(GIST_CREDENTIALS_FILE);
            GIST_TOKEN = getString(credJson, "gist_token", "");
            GIST_ID = getString(credJson, "gist_id", "");
        }
        
        // DiÄŸer ayarlar
        if (!System.IO.File.Exists(SETTINGS_FILE)) return;
        var json = System.IO.File.ReadAllText(SETTINGS_FILE);
        
        IS_TEST = (int)getDecimal(json, "test_mode", 0) == 1;
        VIOP_BUDGET = getDecimal(json, "viop_budget", VIOP_BUDGET);
        SPOT_BUDGET = getDecimal(json, "spot_budget", SPOT_BUDGET);
        // SN_BB_ENTRY kaldÄ±rÄ±ldÄ± - gÃ¼nlÃ¼k BB kontrolÃ¼ artÄ±k kullanÄ±lmÄ±yor
        SN_MIN_MARGIN = getDecimal(json, "sn_min_margin", SN_MIN_MARGIN);
        ROLL_MIN_MARGIN = getDecimal(json, "roll_min_margin", ROLL_MIN_MARGIN);
        REPLACEMENT_THRESHOLD = getDecimal(json, "replacement_threshold", REPLACEMENT_THRESHOLD);
        MAX_DAILY_LOSS = getDecimal(json, "max_daily_loss", MAX_DAILY_LOSS);
        EARLY_EXIT_K = getDecimal(json, "early_exit_k", EARLY_EXIT_K);
        BB_EXIT_HELPER = getDecimal(json, "bb_exit_helper", BB_EXIT_HELPER);
        BB_PERIOD = (int)getDecimal(json, "bb_period", BB_PERIOD);
        LOOP_MS = (int)getDecimal(json, "loop_ms", LOOP_MS);
        GIE_DEPTH_LEVELS = (int)getDecimal(json, "gie_depth_levels", GIE_DEPTH_LEVELS);
        
        // Yeni parametreler
        INTRADAY_MIN_PROFIT = getDecimal(json, "intraday_min_profit", INTRADAY_MIN_PROFIT);
        MARGIN_WARNING_PCT = getDecimal(json, "margin_warning_pct", MARGIN_WARNING_PCT);
        MARGIN_DANGER_PCT = getDecimal(json, "margin_danger_pct", MARGIN_DANGER_PCT);
        MARGIN_CRITICAL_PCT = getDecimal(json, "margin_critical_pct", MARGIN_CRITICAL_PCT);
        
        // Cache path (RAMDisk iÃ§in - stats.json ve loglar)
        var cachePath = getString(json, "cache_path", "");
        if (!string.IsNullOrEmpty(cachePath)) {
            CACHE_PATH = cachePath;
            if (!CACHE_PATH.EndsWith("\\")) CACHE_PATH += "\\";
            // Cache path varsa LOG_PATH ve STATS_FILE'Ä± gÃ¼ncelle
            LOG_PATH = CACHE_PATH + "logs\\";
            STATS_FILE = CACHE_PATH + "stats.json";
            Log("Cache path: " + CACHE_PATH);
        }
        
        // BB93 parametreleri
        BB93_ENTRY_ENABLED = (int)getDecimal(json, "bb93_enabled", BB93_ENTRY_ENABLED ? 1 : 0) == 1;
        BB93_START_HOUR = (int)getDecimal(json, "bb93_start_hour", BB93_START_HOUR);
        BB93_START_MIN = (int)getDecimal(json, "bb93_start_min", BB93_START_MIN);
        BB93_END_HOUR = (int)getDecimal(json, "bb93_end_hour", BB93_END_HOUR);
        BB93_END_MIN = (int)getDecimal(json, "bb93_end_min", BB93_END_MIN);
        
        // NF parametreleri
        NF_ENABLED = (int)getDecimal(json, "nf_enabled", NF_ENABLED ? 1 : 0) == 1;
        NF_MAX_POSITIONS = (int)getDecimal(json, "nf_max_positions", NF_MAX_POSITIONS);
        NF_ENTRY_BB = getDecimal(json, "nf_entry_bb", NF_ENTRY_BB);
        NF_EXIT_BB = getDecimal(json, "nf_exit_bb", NF_EXIT_BB);
        NF_EXIT_PROFIT = getDecimal(json, "nf_exit_profit", NF_EXIT_PROFIT);
        
        // Pair Trading parametreleri
        PAIR_ENABLED = (int)getDecimal(json, "pair_enabled", PAIR_ENABLED ? 1 : 0) == 1;
        PAIR_BUDGET = getDecimal(json, "pair_budget", PAIR_BUDGET);
        PAIR_Z_ENTRY_1 = getDecimal(json, "pair_z_entry_1", PAIR_Z_ENTRY_1);
        PAIR_Z_ENTRY_2 = getDecimal(json, "pair_z_entry_2", PAIR_Z_ENTRY_2);
        PAIR_Z_ENTRY_3 = getDecimal(json, "pair_z_entry_3", PAIR_Z_ENTRY_3);
        PAIR_Z_EXIT = getDecimal(json, "pair_z_exit", PAIR_Z_EXIT);
        
        // Kademe bÃ¼tÃ§e daÄŸÄ±lÄ±mÄ±
        PAIR_ALLOC_1 = (int)getDecimal(json, "pair_alloc_1", PAIR_ALLOC_1);
        PAIR_ALLOC_2 = (int)getDecimal(json, "pair_alloc_2", PAIR_ALLOC_2);
        PAIR_ALLOC_3 = (int)getDecimal(json, "pair_alloc_3", PAIR_ALLOC_3);
        
        // Pair Ã§ift tanÄ±mlarÄ± (format: "SYMB_A-SYMB_B:BETA,...")
        var pairDefsIdx = json.IndexOf("\"pair_definitions\"");
        if (pairDefsIdx >= 0) {
            var pairStart = json.IndexOf("\"", pairDefsIdx + 18) + 1;
            var pairEnd = json.IndexOf("\"", pairStart);
            if (pairStart > 0 && pairEnd > pairStart) {
                PAIR_DEFINITIONS = json.Substring(pairStart, pairEnd - pairStart);
            }
        }
        
        // Pair tanÄ±mlarÄ±nÄ± parse et
        ParsePairDefinitions();
        
        if (IS_TEST) {
            Log("Settings yÃ¼klendi: Test=True, VIOP=" + VIOP_BUDGET + ", SPOT=" + SPOT_BUDGET);
        } else {
            Log("Settings yÃ¼klendi: Test=False (gerÃ§ek bÃ¼tÃ§e kullanÄ±lacak)");
        }
    } catch (Exception ex) { Log("Settings hata: " + ex.Message); }
};

Action UpdateRiskFree = () => {
    try {
        var p = Sistem.SonFiyat("DFN'TAHVIL-G");
        if (p > 0) RISK_FREE = (decimal)p / 100m;
    } catch { }
};

// Grafik verisinden spread BB pozisyonu hesapla (5dk bar, son 100 bar)
// snBB artÄ±k sadece son BB pozisyonunu tutuyor (0-100 arasÄ±)
var lastBBRefresh = DateTime.MinValue;
Action LoadSpreadBBFromChart = () => {
    var loaded = 0;
    
    foreach (var sym in symbols) {
        try {
            // Near kontratÄ± bul
            var nearC = "";
            for (int m = 0; m < 3; m++) {
                var dt = DateTime.Now.AddMonths(m);
                var code = "F_" + sym + dt.ToString("MMyy");
                try {
                    var yuz = Sistem.YuzeyselVeriOku(FUTURES_PREFIX + code);
                    if (yuz != null && yuz.LastPrice > 0) {
                        nearC = code;
                        break;
                    }
                } catch { continue; }
            }
            if (string.IsNullOrEmpty(nearC)) continue;
            
            // 5dk grafik verisi oku
            var spotData = Sistem.GrafikVerileriniOku(SPOT_PREFIX + sym, "5");
            var nearData = Sistem.GrafikVerileriniOku(FUTURES_PREFIX + nearC, "5");
            
            if (spotData == null || nearData == null) continue;
            if (spotData.Count < 20 || nearData.Count < 20) continue;
            
            // Near verilerini dictionary'e at
            var nearDict = new System.Collections.Generic.Dictionary<string, decimal>();
            for (int i = 0; i < nearData.Count; i++) {
                try {
                    var ndt = (DateTime)nearData[i].Date;
                    var key = ndt.ToString("yyyyMMdd_HHmm");
                    nearDict[key] = (decimal)nearData[i].Close;
                } catch { continue; }
            }
            
            // Son 100 bar iÃ§in spread hesapla
            var spreads = new System.Collections.Generic.List<decimal>();
            var startIdx = Math.Max(0, spotData.Count - 100);
            
            for (int i = startIdx; i < spotData.Count; i++) {
                try {
                    var sdt = (DateTime)spotData[i].Date;
                    var key = sdt.ToString("yyyyMMdd_HHmm");
                    
                    if (!nearDict.ContainsKey(key)) continue;
                    
                    var spotClose = (decimal)spotData[i].Close;
                    var nearClose = nearDict[key];
                    
                    if (spotClose <= 0 || nearClose <= 0) continue;
                    
                    var spread = (nearClose - spotClose) / spotClose * 100;
                    spreads.Add(spread);
                } catch { continue; }
            }
            
            // BB pozisyonunu hesapla ve sakla
            if (spreads.Count >= 20) {
                var bb = CalcBB(spreads);
                var lastSpread = spreads[spreads.Count - 1];
                var bbPos = BBPos(lastSpread, bb.Item1, bb.Item3);
                snBBPos[sym] = bbPos;
                loaded++;
            }
            
        } catch { continue; }
    }
    
    lastBBRefresh = DateTime.Now;
    if (loaded > 0) Log("BB gÃ¼ncellendi: " + loaded + " sembol");
};

// Pozisyon kaydetme (dosyaya)
SavePositions = () => {
    try {
        if (snPos.Count == 0 && nfPos.Count == 0) {
            if (System.IO.File.Exists(POSITIONS_FILE)) System.IO.File.Delete(POSITIONS_FILE);
            return;
        }
        var ic = System.Globalization.CultureInfo.InvariantCulture;
        var sb = new System.Text.StringBuilder();
        sb.Append("{\"timestamp\":\"" + DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss") + "\",\"positions\":{");
        var first = true;
        foreach (var kv in snPos) {
            if (!first) sb.Append(",");
            first = false;
            var p = kv.Value;
            // [spotQty, nearQty, spotEntry, nearEntry, entrySpread, expectedPnl, addCount, entryTicks]
            sb.Append("\"" + kv.Key + "\":[");
            sb.Append(((int)p[0]).ToString() + ",");           // spotQty
            sb.Append(((int)p[1]).ToString() + ",");           // nearQty
            sb.Append(p[2].ToString("F4", ic) + ",");          // spotEntry
            sb.Append(p[3].ToString("F4", ic) + ",");          // nearEntry
            sb.Append(p[4].ToString("F6", ic) + ",");          // entrySpread (decimal)
            sb.Append(p[5].ToString("F2", ic) + ",");          // expectedPnl
            sb.Append(((int)p[6]).ToString() + ",");           // addCount
            sb.Append((p.Length > 7 ? (long)p[7] : DateTime.Now.Ticks).ToString());  // entryTicks
            sb.Append("]");
        }
        sb.Append("},");
        
        // NF pozisyonlarÄ±
        sb.Append("\"nf_positions\":{");
        var nfFirst = true;
        foreach (var kv in nfPos) {
            if (!nfFirst) sb.Append(",");
            nfFirst = false;
            var p = kv.Value;
            var nfC = nfContracts.ContainsKey(kv.Key) ? nfContracts[kv.Key] : new string[] { GetContract(kv.Key, 0), GetContract(kv.Key, 1) };
            // [nearQty, farQty, nearEntry, farEntry, entrySpread, expectedPnl, entryTicks, nearC, farC]
            sb.Append("\"" + kv.Key + "\":{");
            sb.Append("\"nq\":" + ((int)p[0]).ToString() + ",");           // nearQty
            sb.Append("\"fq\":" + ((int)p[1]).ToString() + ",");           // farQty
            sb.Append("\"ne\":" + p[2].ToString("F4", ic) + ",");          // nearEntry
            sb.Append("\"fe\":" + p[3].ToString("F4", ic) + ",");          // farEntry
            sb.Append("\"es\":" + p[4].ToString("F6", ic) + ",");          // entrySpread
            sb.Append("\"ep\":" + p[5].ToString("F2", ic) + ",");          // expectedPnl
            sb.Append("\"et\":" + (p.Length > 6 ? (long)p[6] : DateTime.Now.Ticks).ToString() + ",");  // entryTicks
            sb.Append("\"nc\":\"" + nfC[0] + "\",");                        // nearContract
            sb.Append("\"fc\":\"" + nfC[1] + "\"}");                        // farContract
        }
        sb.Append("},");
        
        // Yetim bacaklar
        sb.Append("\"orphan_legs\":{");
        var orphFirst = true;
        foreach (var kv in orphanLegs) {
            if (!orphFirst) sb.Append(",");
            orphFirst = false;
            var o = kv.Value;
            // [filledLeg, filledCode, filledSide, filledQty, filledPrice, targetLeg, targetCode, targetSide, targetQty, timestamp]
            sb.Append("\"" + kv.Key + "\":{");
            sb.Append("\"fl\":\"" + o[0] + "\",");              // filledLeg
            sb.Append("\"fc\":\"" + o[1] + "\",");              // filledCode
            sb.Append("\"fs\":\"" + o[2] + "\",");              // filledSide
            sb.Append("\"fq\":" + ((int)o[3]).ToString() + ","); // filledQty
            sb.Append("\"fp\":" + ((decimal)o[4]).ToString("F4", ic) + ","); // filledPrice
            sb.Append("\"tl\":\"" + o[5] + "\",");              // targetLeg
            sb.Append("\"tc\":\"" + o[6] + "\",");              // targetCode
            sb.Append("\"ts\":\"" + o[7] + "\",");              // targetSide
            sb.Append("\"tq\":" + ((int)o[8]).ToString() + ","); // targetQty
            sb.Append("\"t\":" + ((long)o[9]).ToString() + "}"); // timestamp
        }
        sb.Append("},");
        
        // Pair pozisyonlarÄ±
        sb.Append("\"pair_positions\":{");
        var pairFirst = true;
        foreach (var kv in pairPos) {
            if (!pairFirst) sb.Append(",");
            pairFirst = false;
            var p = kv.Value;
            var pairC = pairContracts.ContainsKey(kv.Key) ? pairContracts[kv.Key] : new string[] { "", "" };
            sb.Append("\"" + kv.Key + "\":{");
            sb.Append("\"qa\":" + ((int)p[0]).ToString() + ",");    // qtyA
            sb.Append("\"qb\":" + ((int)p[1]).ToString() + ",");    // qtyB
            sb.Append("\"aa\":" + p[2].ToString("F4", ic) + ",");   // avgA
            sb.Append("\"ab\":" + p[3].ToString("F4", ic) + ",");   // avgB
            sb.Append("\"oz\":" + p[4].ToString("F2", ic) + ",");   // openZ
            sb.Append("\"ti\":" + ((int)p[5]).ToString() + ",");    // tier
            sb.Append("\"et\":" + ((long)p[6]).ToString() + ",");   // entryTicks
            sb.Append("\"ep\":" + (p.Length > 7 ? p[7] : 0m).ToString("F0", ic) + ",");   // expectedPnl
            sb.Append("\"ca\":\"" + pairC[0] + "\",");              // contractA
            sb.Append("\"cb\":\"" + pairC[1] + "\"}");              // contractB
        }
        sb.Append("},");
        sb.Append("\"pair_used\":" + pairUsed.ToString("F0", ic) + ",");
        sb.Append("\"pair_definitions\":\"" + PAIR_DEFINITIONS.Replace("\"", "\\\"") + "\"}");
        SafeWrite(POSITIONS_FILE, sb.ToString());
    } catch (Exception ex) { Log("Pozisyon kaydetme hata: " + ex.Message); }
};

// Pozisyon yÃ¼kleme (dosyadan)
Action LoadPositions = () => {
    try {
        if (!System.IO.File.Exists(POSITIONS_FILE)) return;
        var json = System.IO.File.ReadAllText(POSITIONS_FILE);
        var ic = System.Globalization.CultureInfo.InvariantCulture;
        
        // Ã–nce kullanÄ±m deÄŸerlerini sÄ±fÄ±rla (Ã§ift yÃ¼kleme gÃ¼venliÄŸi)
        viopUsed = 0m;
        spotUsed = 0m;
        nfViopUsed = 0m;
        
        var posIdx = json.IndexOf("\"positions\"");
        if (posIdx == -1) return;
        var posStart = json.IndexOf("{", posIdx) + 1;
        var posEnd = json.IndexOf("}}", posStart);
        if (posStart <= 0 || posEnd <= posStart) return;
        
        var posContent = json.Substring(posStart, posEnd - posStart);
        var loaded = 0;
        
        // "THYAO":[1500,15,79.55,80.06,0.025,150.5,0,638766123456789]
        var pos = 0;
        while (pos < posContent.Length) {
            var q1 = posContent.IndexOf("\"", pos);
            if (q1 < 0) break;
            var q2 = posContent.IndexOf("\"", q1 + 1);
            if (q2 < 0) break;
            var sym = posContent.Substring(q1 + 1, q2 - q1 - 1);
            
            var arrStart = posContent.IndexOf("[", q2);
            var arrEnd = posContent.IndexOf("]", arrStart);
            if (arrStart < 0 || arrEnd < 0) break;
            
            var arrStr = posContent.Substring(arrStart + 1, arrEnd - arrStart - 1);
            var parts = arrStr.Split(',');
            if (parts.Length >= 7) {
                var p = new decimal[8];
                p[0] = decimal.Parse(parts[0].Trim(), ic);  // spotQty
                p[1] = decimal.Parse(parts[1].Trim(), ic);  // nearQty
                p[2] = decimal.Parse(parts[2].Trim(), ic);  // spotEntry
                p[3] = decimal.Parse(parts[3].Trim(), ic);  // nearEntry
                p[4] = decimal.Parse(parts[4].Trim(), ic);  // entrySpread
                p[5] = decimal.Parse(parts[5].Trim(), ic);  // expectedPnl
                p[6] = decimal.Parse(parts[6].Trim(), ic);  // addCount
                // entryTicks - 8. eleman varsa oku, yoksa ÅŸimdi oluÅŸtur
                p[7] = parts.Length >= 8 ? decimal.Parse(parts[7].Trim(), ic) : DateTime.Now.Ticks;
                
                // expectedPnl 0 ise yeniden hesapla
                if (p[5] == 0 && p[4] > 0 && p[2] > 0 && p[0] > 0) {
                    // expectedPnl = entrySpread * spotEntry * spotQty
                    p[5] = p[4] * p[2] * p[0];
                    Log("âš ï¸ " + sym + " expectedPnl yeniden hesaplandÄ±: " + p[5].ToString("N0"));
                }
                
                snPos[sym] = p;
                // SembolÃ¼ listeye ekle (recovery iÃ§in gerekli)
                if (!symbols.Contains(sym)) symbols.Add(sym);
                loaded++;
            }
            pos = arrEnd + 1;
        }
        
        if (loaded > 0) {
            Log("ğŸ“‚ Pozisyonlar yÃ¼klendi: " + loaded + " adet");
            // BÃ¼tÃ§e kullanÄ±mÄ±nÄ± gÃ¼ncelle
            foreach (var kv in snPos) {
                var p = kv.Value;
                var tem = teminat.ContainsKey(kv.Key) ? teminat[kv.Key] : 0;
                spotUsed += p[2] * p[0];  // spotEntry * spotQty
                viopUsed += tem * p[1];   // teminat * nearQty
            }
            if (IS_TEST) {
                Log("BÃ¼tÃ§e: VIOP=" + viopUsed.ToString("N0") + "/" + VIOP_BUDGET.ToString("N0") + 
                    " SPOT=" + spotUsed.ToString("N0") + "/" + SPOT_BUDGET.ToString("N0"));
            } else {
                Log("Pozisyon kullanÄ±mÄ±: VIOP=" + viopUsed.ToString("N0") + " SPOT=" + spotUsed.ToString("N0"));
            }
        }
        
        // NF pozisyonlarÄ± yÃ¼kle (yeni format: object, eski format: array - backward compatible)
        var nfPosIdx = json.IndexOf("\"nf_positions\"");
        if (nfPosIdx != -1) {
            var nfPosStart = json.IndexOf("{", nfPosIdx) + 1;
            var nfPosEnd = json.IndexOf("}}", nfPosStart);
            if (nfPosStart > 0 && nfPosEnd > nfPosStart) {
                var nfPosContent = json.Substring(nfPosStart, nfPosEnd - nfPosStart);
                var nfLoaded = 0;
                var nfPos2 = 0;
                while (nfPos2 < nfPosContent.Length) {
                    var nfQ1 = nfPosContent.IndexOf("\"", nfPos2);
                    if (nfQ1 < 0) break;
                    var nfQ2 = nfPosContent.IndexOf("\"", nfQ1 + 1);
                    if (nfQ2 < 0) break;
                    var nfSym = nfPosContent.Substring(nfQ1 + 1, nfQ2 - nfQ1 - 1);
                    
                    // Yeni format mÄ± (object) eski format mÄ± (array) kontrol et
                    var nextChar = nfPosContent.IndexOf(":", nfQ2);
                    if (nextChar < 0) break;
                    var formatChar = nfPosContent.Substring(nextChar + 1).TrimStart()[0];
                    
                    if (formatChar == '{') {
                        // YENÄ° FORMAT: {"THYAO":{"nq":1,"fq":1,"ne":80.5,"fe":81.2,"es":0.005,"ep":50,"et":123456,"nc":"F_THYAO0226","fc":"F_THYAO0326"}}
                        var objStart = nfPosContent.IndexOf("{", nextChar);
                        var objEnd = nfPosContent.IndexOf("}", objStart);
                        if (objStart < 0 || objEnd < 0) break;
                        
                        var objStr = nfPosContent.Substring(objStart, objEnd - objStart + 1);
                        var nfP = new decimal[7];
                        
                        // Manuel parse helper
                        Func<string, string, decimal> parseNfDecimal = (src, key) => {
                            var idx = src.IndexOf("\"" + key + "\":");
                            if (idx < 0) return 0;
                            var start = idx + key.Length + 3;
                            var end = src.IndexOfAny(new[] { ',', '}' }, start);
                            if (end < 0) return 0;
                            decimal val;
                            decimal.TryParse(src.Substring(start, end - start).Trim(), System.Globalization.NumberStyles.Any, ic, out val);
                            return val;
                        };
                        
                        Func<string, string, string, string> parseNfString = (src, key, def) => {
                            var idx = src.IndexOf("\"" + key + "\":\"");
                            if (idx < 0) return def;
                            var start = idx + key.Length + 4;
                            var end = src.IndexOf("\"", start);
                            if (end < 0) return def;
                            return src.Substring(start, end - start);
                        };
                        
                        // Parse fields
                        nfP[0] = parseNfDecimal(objStr, "nq");
                        nfP[1] = parseNfDecimal(objStr, "fq");
                        nfP[2] = parseNfDecimal(objStr, "ne");
                        nfP[3] = parseNfDecimal(objStr, "fe");
                        nfP[4] = parseNfDecimal(objStr, "es");
                        nfP[5] = parseNfDecimal(objStr, "ep");
                        var etVal = parseNfDecimal(objStr, "et");
                        nfP[6] = etVal > 0 ? etVal : DateTime.Now.Ticks;
                        
                        // Kontrat kodlarÄ±
                        var nearC = parseNfString(objStr, "nc", GetContract(nfSym, 0));
                        var farC = parseNfString(objStr, "fc", GetContract(nfSym, 1));
                        
                        nfPos[nfSym] = nfP;
                        nfContracts[nfSym] = new string[] { nearC, farC };
                        nfLoaded++;
                        
                        // NF VIOP kullanÄ±mÄ±
                        var nfTem = teminat.ContainsKey(nfSym) ? teminat[nfSym] : 5000m;
                        nfViopUsed += nfTem * 2;
                        
                        nfPos2 = objEnd + 1;
                    } else {
                        // ESKÄ° FORMAT (backward compatible): {"THYAO":[1,1,80.5,81.2,0.005,50,123456]}
                        var nfArrStart = nfPosContent.IndexOf("[", nfQ2);
                        var nfArrEnd = nfPosContent.IndexOf("]", nfArrStart);
                        if (nfArrStart < 0 || nfArrEnd < 0) break;
                        
                        var nfArrStr = nfPosContent.Substring(nfArrStart + 1, nfArrEnd - nfArrStart - 1);
                        var nfParts = nfArrStr.Split(',');
                        if (nfParts.Length >= 6) {
                            var nfP = new decimal[7];
                            nfP[0] = decimal.Parse(nfParts[0].Trim(), ic);  // nearQty
                            nfP[1] = decimal.Parse(nfParts[1].Trim(), ic);  // farQty
                            nfP[2] = decimal.Parse(nfParts[2].Trim(), ic);  // nearEntry
                            nfP[3] = decimal.Parse(nfParts[3].Trim(), ic);  // farEntry
                            nfP[4] = decimal.Parse(nfParts[4].Trim(), ic);  // entrySpread
                            nfP[5] = decimal.Parse(nfParts[5].Trim(), ic);  // expectedPnl
                            nfP[6] = nfParts.Length >= 7 ? decimal.Parse(nfParts[6].Trim(), ic) : DateTime.Now.Ticks;
                            
                            nfPos[nfSym] = nfP;
                            // Eski formatta kontrat kodu yok - GetContract kullan (UYARI: vade geÃ§iÅŸinde yanlÄ±ÅŸ olabilir!)
                            nfContracts[nfSym] = new string[] { GetContract(nfSym, 0), GetContract(nfSym, 1) };
                            Log("âš ï¸ NF " + nfSym + " eski formattan yÃ¼klendi - kontrat kodlarÄ± gÃ¼ncel aydan alÄ±ndÄ±");
                            nfLoaded++;
                            
                            // NF VIOP kullanÄ±mÄ±
                            var nfTem = teminat.ContainsKey(nfSym) ? teminat[nfSym] : 5000m;
                            nfViopUsed += nfTem * 2;
                        }
                        nfPos2 = nfArrEnd + 1;
                    }
                }
                if (nfLoaded > 0) {
                    Log("ğŸ“‚ NF Pozisyonlar yÃ¼klendi: " + nfLoaded + " adet, VIOP kullanÄ±m: " + nfViopUsed.ToString("N0"));
                }
            }
        }
        
        // Yetim bacaklar yÃ¼kle
        var orphIdx = json.IndexOf("\"orphan_legs\"");
        if (orphIdx != -1) {
            var orphStart = json.IndexOf("{", orphIdx) + 1;
            var orphEnd = json.IndexOf("}}", orphStart);
            if (orphStart > 0 && orphEnd > orphStart) {
                var orphContent = json.Substring(orphStart, orphEnd - orphStart);
                var orphLoaded = 0;
                
                // JSON parse: "THYAO":{"fl":"NEAR","fc":"F_THYAO0126",...}
                var orphPos = 0;
                while (orphPos < orphContent.Length) {
                    var oQ1 = orphContent.IndexOf("\"", orphPos);
                    if (oQ1 < 0) break;
                    var oQ2 = orphContent.IndexOf("\"", oQ1 + 1);
                    if (oQ2 < 0) break;
                    var oSym = orphContent.Substring(oQ1 + 1, oQ2 - oQ1 - 1);
                    
                    var oObjStart = orphContent.IndexOf("{", oQ2);
                    var oObjEnd = orphContent.IndexOf("}", oObjStart);
                    if (oObjStart < 0 || oObjEnd < 0) break;
                    
                    var oObj = orphContent.Substring(oObjStart, oObjEnd - oObjStart + 1);
                    
                    // Parse fields
                    Func<string, string> getStr = (key) => {
                        var ki = oObj.IndexOf("\"" + key + "\":\"");
                        if (ki < 0) return "";
                        var vs = ki + key.Length + 4;
                        var ve = oObj.IndexOf("\"", vs);
                        return ve > vs ? oObj.Substring(vs, ve - vs) : "";
                    };
                    Func<string, decimal> getNum = (key) => {
                        var ki = oObj.IndexOf("\"" + key + "\":");
                        if (ki < 0) return 0;
                        var vs = ki + key.Length + 3;
                        var ve = vs;
                        while (ve < oObj.Length && (char.IsDigit(oObj[ve]) || oObj[ve] == '.' || oObj[ve] == '-')) ve++;
                        return ve > vs ? decimal.Parse(oObj.Substring(vs, ve - vs), ic) : 0;
                    };
                    
                    orphanLegs[oSym] = new object[] {
                        getStr("fl"),   // filledLeg
                        getStr("fc"),   // filledCode
                        getStr("fs"),   // filledSide
                        (int)getNum("fq"), // filledQty
                        getNum("fp"),   // filledPrice
                        getStr("tl"),   // targetLeg
                        getStr("tc"),   // targetCode
                        getStr("ts"),   // targetSide
                        (int)getNum("tq"), // targetQty
                        (long)getNum("t")  // timestamp
                    };
                    orphLoaded++;
                    orphPos = oObjEnd + 1;
                }
                if (orphLoaded > 0) {
                    Log("ğŸ“‚ Yetim bacaklar yÃ¼klendi: " + orphLoaded + " adet");
                    foreach (var kv in orphanLegs) {
                        var o = kv.Value;
                        Log("   " + kv.Key + ": " + o[0] + " " + o[1] + " " + o[2] + " x" + o[3] + " @" + ((decimal)o[4]).ToString("F2"));
                    }
                }
            }
        }
        
        // Pair pozisyonlarÄ± yÃ¼kle (yeni format: object ile kontrat bilgisi)
        pairUsed = 0m;  // Ã–nce sÄ±fÄ±rla, sonra hesapla (Ã§ift yÃ¼kleme gÃ¼venliÄŸi)
        var pairPosIdx = json.IndexOf("\"pair_positions\"");
        if (pairPosIdx >= 0) {
            var pairPosStart = json.IndexOf("{", pairPosIdx) + 1;
            // pair_positions iÃ§eriÄŸi iÃ§in doÄŸru sonlanma noktasÄ±nÄ± bul
            var braceCount = 1;
            var pairPosEnd = pairPosStart;
            while (pairPosEnd < json.Length && braceCount > 0) {
                if (json[pairPosEnd] == '{') braceCount++;
                else if (json[pairPosEnd] == '}') braceCount--;
                pairPosEnd++;
            }
            pairPosEnd--;  // Son '}'nin pozisyonu
            
            if (pairPosStart > 0 && pairPosEnd > pairPosStart) {
                var pairContent = json.Substring(pairPosStart, pairPosEnd - pairPosStart);
                var pairLoaded = 0;
                
                // Her Ã§ift iÃ§in parse et
                var ppos = 0;
                while (ppos < pairContent.Length) {
                    var pq1 = pairContent.IndexOf("\"", ppos);
                    if (pq1 < 0) break;
                    var pq2 = pairContent.IndexOf("\"", pq1 + 1);
                    if (pq2 < 0) break;
                    var pkey = pairContent.Substring(pq1 + 1, pq2 - pq1 - 1);
                    
                    // Yeni format: object {...} veya eski format: array [...]
                    var nextChar = ':';
                    var colonPos = pairContent.IndexOf(":", pq2);
                    if (colonPos < 0) break;
                    
                    // Object mÄ± array mi?
                    var afterColon = pairContent.Substring(colonPos + 1).TrimStart();
                    if (afterColon.StartsWith("{")) {
                        // Yeni format: object
                        var objStart = pairContent.IndexOf("{", colonPos);
                        var objEnd = pairContent.IndexOf("}", objStart);
                        if (objStart < 0 || objEnd < 0) break;
                        
                        var objStr = pairContent.Substring(objStart + 1, objEnd - objStart - 1);
                        var pp = new decimal[8];
                        string contractA = "", contractB = "";
                        
                        // Parse object fields
                        Func<string, string, string> getField = (content, field) => {
                            var idx = content.IndexOf("\"" + field + "\"");
                            if (idx < 0) return "";
                            var valStart = content.IndexOf(":", idx) + 1;
                            var valEnd = content.IndexOf(",", valStart);
                            if (valEnd < 0) valEnd = content.Length;
                            return content.Substring(valStart, valEnd - valStart).Trim().Trim('"');
                        };
                        
                        decimal.TryParse(getField(objStr, "qa"), System.Globalization.NumberStyles.Any, ic, out pp[0]);
                        decimal.TryParse(getField(objStr, "qb"), System.Globalization.NumberStyles.Any, ic, out pp[1]);
                        decimal.TryParse(getField(objStr, "aa"), System.Globalization.NumberStyles.Any, ic, out pp[2]);
                        decimal.TryParse(getField(objStr, "ab"), System.Globalization.NumberStyles.Any, ic, out pp[3]);
                        decimal.TryParse(getField(objStr, "oz"), System.Globalization.NumberStyles.Any, ic, out pp[4]);
                        decimal.TryParse(getField(objStr, "ti"), System.Globalization.NumberStyles.Any, ic, out pp[5]);
                        decimal.TryParse(getField(objStr, "et"), System.Globalization.NumberStyles.Any, ic, out pp[6]);
                        decimal.TryParse(getField(objStr, "ep"), System.Globalization.NumberStyles.Any, ic, out pp[7]);
                        contractA = getField(objStr, "ca");
                        contractB = getField(objStr, "cb");
                        
                        pairPos[pkey] = pp;
                        
                        // KontratlarÄ± yÃ¼kle (boÅŸ deÄŸilse)
                        if (!string.IsNullOrEmpty(contractA) && !string.IsNullOrEmpty(contractB)) {
                            pairContracts[pkey] = new string[] { contractA, contractB };
                        }
                        
                        pairLoaded++;
                        ppos = objEnd + 1;
                    } else if (afterColon.StartsWith("[")) {
                        // Eski format: array (backward compatibility)
                        var arrStart = pairContent.IndexOf("[", colonPos);
                        var arrEnd = pairContent.IndexOf("]", arrStart);
                        if (arrStart < 0 || arrEnd < 0) break;
                        
                        var arrStr = pairContent.Substring(arrStart + 1, arrEnd - arrStart - 1);
                        var parts = arrStr.Split(',');
                        if (parts.Length >= 7) {
                            var pp = new decimal[8];
                            for (int pi = 0; pi < Math.Min(parts.Length, 8); pi++) {
                                decimal.TryParse(parts[pi].Trim(), System.Globalization.NumberStyles.Any, ic, out pp[pi]);
                            }
                            pairPos[pkey] = pp;
                            pairLoaded++;
                        }
                        ppos = arrEnd + 1;
                    } else {
                        break;
                    }
                    
                    // Pair VIOP kullanÄ±mÄ± hesapla
                    if (pairPos.ContainsKey(pkey)) {
                        var keyParts = pkey.Split('-');
                        if (keyParts.Length == 2) {
                            var temA = teminat.ContainsKey(keyParts[0]) ? teminat[keyParts[0]] : 1000m;
                            var temB = teminat.ContainsKey(keyParts[1]) ? teminat[keyParts[1]] : 1000m;
                            var pp = pairPos[pkey];
                            pairUsed += (int)pp[0] * temA + (int)pp[1] * temB;
                        }
                    }
                }
                if (pairLoaded > 0) {
                    Log("ğŸ“‚ Pair pozisyonlarÄ± yÃ¼klendi: " + pairLoaded + " adet, Teminat: " + pairUsed.ToString("F0"));
                    if (pairContracts.Count > 0) {
                        Log("ğŸ“‚ Pair kontratlarÄ± yÃ¼klendi: " + pairContracts.Count + " adet");
                    }
                }
            }
        }
        
        // pair_definitions yÃ¼kle (yeni Ã§ift tanÄ±mlarÄ±)
        var pairDefsIdx = json.IndexOf("\"pair_definitions\"");
        if (pairDefsIdx >= 0) {
            var pdStart = json.IndexOf("\"", pairDefsIdx + 18) + 1;
            var pdEnd = json.IndexOf("\"", pdStart);
            if (pdStart > 0 && pdEnd > pdStart) {
                PAIR_DEFINITIONS = json.Substring(pdStart, pdEnd - pdStart);
                ParsePairDefinitions();
            }
        }
    } catch (Exception ex) { Log("Pozisyon yÃ¼kleme hata: " + ex.Message); }
};

// Bakiye gÃ¼ncelleme (test vs gerÃ§ek mod)
Action UpdateBalances = () => {
    try {
        if (IS_TEST) {
            // Test modu: Sanal bakiye hesapla (ayarlardan okunan bÃ¼tÃ§e ile)
            viopBalance = VIOP_BUDGET - viopUsed - VIOP_RESERVE;
            spotBalance = SPOT_BUDGET - spotUsed - dailySpotCommission - totalTransferredComm - SPOT_BUDGET_RESERVE;
            spotBudgetTotal = SPOT_BUDGET - dailySpotCommission - totalTransferredComm;
            if (viopBalance < 0) viopBalance = 0;
            if (spotBalance < 0) spotBalance = 0;
            apiDataOk = true;
        } else {
            // GerÃ§ek mod: API'den al (T+2 RefreshHesaplar iÃ§inde hesaplanÄ±yor)
            RefreshHesaplar(false);
            var viopOk = false;
            var spotOk = false;
            
            // VIOP bakiye
            try {
                var viopHesap = GetViopHesap();
                if (viopHesap != null && viopHesap.TeminatKullanilabilir > 0) {
                    viopBalance = (decimal)viopHesap.TeminatKullanilabilir - VIOP_RESERVE;
                    if (viopBalance < 0) viopBalance = 0;
                    viopOk = true;
                }
            } catch { }
            
            // SPOT: T+2 zaten RefreshHesaplar'da hesaplandÄ±
            try {
                var bistHesap = GetBistHesap();
                if (bistHesap != null && bistHesap.Bakiye > 0) {
                    spotOk = true;
                    // spotBalance ve spotBudgetTotal gÃ¼ncelle (SPOT_BUDGET_RESERVE dÃ¼ÅŸÃ¼lÃ¼r)
                    spotBalance = t2Balance - SPOT_BUDGET_RESERVE;
                    if (spotBalance < 0) spotBalance = 0;
                    spotBudgetTotal = spotUsed + t2Balance;
                    
                    // T+2 negatif takibi
                    if (t2Balance < 0) {
                        if (!t2NegativeDetected) {
                            t2NegativeDetected = true;
                            t2NegativeTime = DateTime.Now;
                            Log("âš ï¸ T+2 bakiye negatif: " + t2Balance.ToString("N0") + " - takibe alÄ±ndÄ±, 16:50'de kontrol edilecek");
                        }
                        // 17:00 sonrasÄ± hala negatifse kritik uyarÄ±
                        var t2Hour = DateTime.Now.Hour;
                        if (t2Hour >= 17 && !t2CriticalAlert) {
                            t2CriticalAlert = true;
                            Log("ğŸš¨ T+2 KRÄ°TÄ°K: 17:00 sonrasÄ± hala negatif: " + t2Balance.ToString("N0") + " TL");
                        }
                    } else {
                        if (t2NegativeDetected) {
                            Log("âœ… T+2 bakiye pozitife dÃ¶ndÃ¼: " + t2Balance.ToString("N0"));
                            t2NegativeDetected = false;
                        }
                        if (t2CriticalAlert) {
                            Log("âœ… T+2 kritik uyarÄ± kaldÄ±rÄ±ldÄ± - bakiye pozitif: " + t2Balance.ToString("N0"));
                            t2CriticalAlert = false;
                        }
                    }
                }
            } catch { }
            
            // Her iki API de gelmeli
            apiDataOk = viopOk && spotOk;
            
            if (!apiDataOk && isMarketOpen) {
                Log("âš ï¸ API verisi alÄ±namadÄ± - iÅŸlemler duraklatÄ±ldÄ±");
            }
            
            // Margin durumu kontrol et
            if (!inMarginCheck && apiDataOk) CheckMarginStatus();
        }
    } catch { }
};

// VÄ°OP komisyonlarÄ±nÄ± SPOT'a transfer et (15 dakikada bir)
Action TransferViopCommission = () => {
    if (dailyViopCommission > 0) {
        Log("ğŸ’¸ VÄ°OP komisyon transferi: " + dailyViopCommission.ToString("N2") + " TL â†’ SPOT");
        totalTransferredComm += dailyViopCommission;
        dailyViopCommission = 0;
        lastCommissionTransfer = DateTime.Now;
    }
};

// AracÄ± kurum baÄŸlantÄ± kontrolÃ¼ (30 saniyede bir)
Action CheckBrokerConnection = () => {
    // brokerConnected artÄ±k RefreshHesaplar/Recovery tarafÄ±ndan gÃ¼ncelleniyor
    // Burada sadece cache'in null olup olmadÄ±ÄŸÄ±na bakÄ±yoruz, ekstra API Ã§aÄŸrÄ±sÄ± yok
    if ((DateTime.Now - lastBrokerCheck).TotalSeconds < 30) return;
    lastBrokerCheck = DateTime.Now;
    
    var wasConnected = brokerConnected;
    
    // Cache'deki son deÄŸerlere bak (API Ã§aÄŸrÄ±sÄ± yapmadan)
    var viopOk = _viopHesap != null;
    var bistOk = _bistHesap != null;
    brokerConnected = viopOk || bistOk;
    
    // Durum deÄŸiÅŸti mi?
    if (wasConnected && !brokerConnected) {
        Log("âš ï¸ AracÄ± kurum baÄŸlantÄ±sÄ± kesildi!");
    } else if (!wasConnected && brokerConnected) {
        Log("âœ… AracÄ± kurum baÄŸlantÄ±sÄ± kuruldu");
        // BaÄŸlantÄ± geri geldi - recovery tetikle
        if (!IS_TEST) {
            Log("ğŸ”„ BaÄŸlantÄ± sonrasÄ± pozisyon senkronizasyonu baÅŸlatÄ±lÄ±yor...");
            SyncAndRecoverPositions();
        }
    }
};

// Kritik margin durumunda pozisyon kapatma (en kÃ¶tÃ¼ beklenen getirili pozisyonu kapat)
Action<decimal, decimal> HandleMarginCritical = (kullanilabilir, toplam) => {
    if (IS_TEST) return;
    if (inMarginCheck) return;
    
    inMarginCheck = true;
    try {
        if (snPos.Count == 0) return;
        
        // En kÃ¶tÃ¼ beklenen getirili pozisyonu bul
        string worstSym = null;
        decimal worstExpectedPnl = decimal.MaxValue;
        
        foreach (var kv in snPos) {
            var expectedPnl = kv.Value[5];
            if (expectedPnl < worstExpectedPnl) {
                worstExpectedPnl = expectedPnl;
                worstSym = kv.Key;
            }
        }
        
        if (worstSym == null) return;
        
        // En kÃ¶tÃ¼ pozisyonu kapat
        var pos = snPos[worstSym];
        var sQty = (int)pos[0];
        var nQty = (int)pos[1];
        var nearC = GetContract(worstSym, 0);
        
        Log("ğŸ”´ MARGIN CALL: " + worstSym + " kapatÄ±lÄ±yor (Beklenen: " + worstExpectedPnl.ToString("F0") + " TL)");
        CloseSN(worstSym, nearC, sQty, nQty, "MARGIN_CALL");
        
        // Son durumu kontrol et
        System.Threading.Thread.Sleep(500);
        try {
            var viopHesap = Sistem.ViopHesapOku();
            if (viopHesap != null) {
                var teminatToplam = (decimal)viopHesap.TeminatToplam;
                if (teminatToplam <= 0) return;  // BÃ¶lme hatasÄ± Ã¶nleme
                var yeniOran = (decimal)viopHesap.TeminatKullanilabilir / teminatToplam;
                if (yeniOran >= MARGIN_WARNING_PCT) marginStatus = 0;
                else if (yeniOran >= MARGIN_DANGER_PCT) marginStatus = 1;
                else if (yeniOran >= MARGIN_CRITICAL_PCT) marginStatus = 2;
                else marginStatus = 3;
                _viopHesap = viopHesap;
                Log("âœ… MARGIN: Yeni serbest %" + (yeniOran * 100).ToString("F1"));
            }
        } catch { }
    } finally {
        inMarginCheck = false;
    }
};

// Margin durumu kontrolÃ¼ (RefreshHesaplar'dan tetiklenir)
CheckMarginStatus = () => {
    try {
        var viopHesap = GetViopHesap();
        if (viopHesap == null) return;
        
        var kullanilabilir = (decimal)viopHesap.TeminatKullanilabilir;
        var toplam = (decimal)viopHesap.TeminatToplam;
        if (toplam <= 0) return;
        
        var serbestOran = kullanilabilir / toplam;
        var oldStatus = marginStatus;
        
        // Durumu belirle
        if (serbestOran < MARGIN_CRITICAL_PCT) {
            marginStatus = 3;  // Kritik (kÄ±rmÄ±zÄ±)
        } else if (serbestOran < MARGIN_DANGER_PCT) {
            marginStatus = 2;  // Tehlike (turuncu)
        } else if (serbestOran < MARGIN_WARNING_PCT) {
            marginStatus = 1;  // UyarÄ± (sarÄ±)
        } else {
            marginStatus = 0;  // Normal
        }
        
        // Durum deÄŸiÅŸti mi? Sadece deÄŸiÅŸince logla
        if (marginStatus != oldStatus) {
            if (marginStatus == 1) {
                Log("âš ï¸ MARGIN UYARI: Serbest %" + (serbestOran * 100).ToString("F1"));
            } else if (marginStatus == 2) {
                Log("ğŸŸ  MARGIN TEHLÄ°KE: Serbest %" + (serbestOran * 100).ToString("F1"));
            } else if (marginStatus == 3) {
                Log("ğŸ”´ MARGIN KRÄ°TÄ°K: Serbest %" + (serbestOran * 100).ToString("F1") + " - Pozisyon kapatÄ±lÄ±yor");
                HandleMarginCritical(kullanilabilir, toplam);
            } else if (marginStatus == 0 && oldStatus > 0) {
                Log("âœ… MARGIN NORMAL: Serbest %" + (serbestOran * 100).ToString("F1"));
            }
        }
    } catch { }
};

// Endeks devre kesici kontrolÃ¼ (BIST100)
Action CheckIndexCircuitBreaker = () => {
    try {
        var change = (decimal)Sistem.YuzdeGun("IMKBX'XU100");
        var wasActive = indexCircuitBreaker;
        
        // %5 veya daha fazla dÃ¼ÅŸÃ¼ÅŸ = devre kesici aktif
        if (change <= INDEX_CIRCUIT_PCT) {
            indexCircuitBreaker = true;
            if (!wasActive) {
                Log("ğŸ”´ ENDEKS DEVRE KESÄ°CÄ° AKTÄ°F: BIST100 %" + change.ToString("F2") + " (eÅŸik: %" + INDEX_CIRCUIT_PCT.ToString("F0") + ")");
            }
        } else {
            indexCircuitBreaker = false;
            if (wasActive) {
                Log("âœ… ENDEKS DEVRE KESÄ°CÄ° KALDIRILDI: BIST100 %" + change.ToString("F2"));
            }
        }
    } catch { }
};

// Spot devre kesici kontrolÃ¼ (bireysel hisse) - %8 dÃ¼ÅŸÃ¼ÅŸ
Func<string, bool> IsSpotCircuitBreaker = (sym) => {
    try {
        var change = (decimal)Sistem.YuzdeGun("IMKBH'" + sym);
        
        // %8 veya daha fazla dÃ¼ÅŸÃ¼ÅŸ = devre kesici
        if (change <= SPOT_CIRCUIT_PCT) {
            if (!spotCircuitBreakers.Contains(sym)) {
                spotCircuitBreakers.Add(sym);
                Log("ğŸ”´ SPOT DEVRE KESÄ°CÄ°: " + sym + " %" + change.ToString("F2") + " (eÅŸik: %" + SPOT_CIRCUIT_PCT.ToString("F0") + ")");
            }
            return true;
        } else {
            if (spotCircuitBreakers.Contains(sym)) {
                spotCircuitBreakers.Remove(sym);
                Log("âœ… SPOT DEVRE KESÄ°CÄ° KALDIRILDI: " + sym + " %" + change.ToString("F2"));
            }
            return false;
        }
    } catch { return false; }
};

// Son recovery zamanÄ±
var lastRecoveryCheck = DateTime.MinValue;
var recoveryTriggered = false;  // BaÅŸlangÄ±Ã§ recovery'si yapÄ±ldÄ± mÄ±
var recoveryRetryNeeded = false;  // Teyit alÄ±namadÄ±, kÄ±sa sÃ¼re sonra tekrar dene
var recoveryRetryTime = DateTime.MinValue;  // Retry zamanÄ±

// GerÃ§ek pozisyonlarÄ± oku ve senkronize et (sadece normal mod)
SyncAndRecoverPositions = () => {
    if (IS_TEST) return;
    if (inRecovery) {
        Log("âš ï¸ RECOVERY: Zaten recovery iÃ§inde, atlanÄ±yor (sonsuz dÃ¶ngÃ¼ Ã¶nleme)");
        return;
    }
    
    inRecovery = true;  // Sonsuz dÃ¶ngÃ¼ Ã¶nleme
    try {
        Log("ğŸ” RECOVERY: GerÃ§ek pozisyonlar okunuyor...");
        
        // Taze veri iÃ§in cache'i yenile
        RefreshHesaplar(false);  // Bekleme yok, her ikisini taze Ã§ek
        
        // 1. AracÄ± kurumdan gerÃ§ek pozisyonlarÄ± oku
        var realSpotPos = new System.Collections.Generic.Dictionary<string, int>();  // sym -> qty
        var realNearPos = new System.Collections.Generic.Dictionary<string, int>();  // sym -> qty
        var bistOk = false;
        var viopOk = false;
        
        // BIST pozisyonlarÄ±
        try {
            var bistHesap = GetBistHesap();
            
            if (bistHesap != null && bistHesap.Pozisyonlar != null) {
                bistOk = true;
                var bistPozList = bistHesap.Pozisyonlar;
                Log("ğŸ” RECOVERY: BIST'te " + bistPozList.Count + " pozisyon bulundu");
                for (int i = 0; i < bistPozList.Count; i++) {
                    var sym = bistPozList[i].Symbol;
                    var lot = (int)bistPozList[i].Lot;
                    Log("ğŸ” RECOVERY: BIST poz: " + sym + " Lot:" + lot);
                    if (sym != null) {
                        if (sym.Contains("'")) {
                            var idx = sym.IndexOf("'");
                            sym = sym.Substring(idx + 1);
                        } else if (sym.StartsWith("E_")) {
                            sym = sym.Substring(2);
                        }
                        if (symbols.Contains(sym)) {
                            realSpotPos[sym] = Math.Abs(lot);
                            Log("âœ“ RECOVERY: " + sym + " Spot pozisyon: " + Math.Abs(lot));
                        }
                    }
                }
            } else {
                Log("âš ï¸ RECOVERY: BIST hesap veya pozisyonlar null - SPOT recovery atlanÄ±yor");
            }
        } catch (Exception ex) { 
            Log("âš ï¸ BIST pozisyon okuma hata: " + ex.Message); 
        }
        
        // VIOP pozisyonlarÄ±
        try {
            var viopHesap = GetViopHesap();
            
            if (viopHesap != null && viopHesap.Pozisyonlar != null) {
                viopOk = true;
                var viopPozList = viopHesap.Pozisyonlar;
                Log("ğŸ” RECOVERY: VIOP'ta " + viopPozList.Count + " pozisyon bulundu");
                
                // NF iÃ§in Near LONG ve Far SHORT pozisyonlarÄ±nÄ± da takip et
                // realNfNearPos[sym] = qty (LONG pozitif)
                // realNfFarPos[sym] = qty (SHORT pozitif olarak sakla)
                var realNfNearPos = new System.Collections.Generic.Dictionary<string, int>();
                var realNfFarPos = new System.Collections.Generic.Dictionary<string, int>();
                
                for (int i = 0; i < viopPozList.Count; i++) {
                    var sym = viopPozList[i].Symbol;
                    var lot = (int)viopPozList[i].NetAmount;
                    Log("ğŸ” RECOVERY: VIOP poz: " + sym + " Lot:" + lot);
                    if (sym != null && (sym.StartsWith("F_") || sym.Contains("'F_"))) {
                        // VIP'F_THYAO0225 veya F_THYAO0225 -> THYAO
                        var idx = sym.IndexOf("F_");
                        if (idx >= 0) {
                            var fullContract = sym.Substring(idx);  // F_THYAO0226
                            var baseSym = fullContract.Substring(2);  // THYAO0226
                            if (baseSym.Length > 4) baseSym = baseSym.Substring(0, baseSym.Length - 4);  // THYAO
                            
                            // PAIR_BLOCKED sembollerini atla (Pair Recovery'de iÅŸlenecek)
                            if (PAIR_BLOCKED.Contains(baseSym)) continue;
                            
                            if (symbols.Contains(baseSym)) {
                                // KontratÄ±n Near mÄ± Far mÄ± olduÄŸunu belirle
                                var nearContract = GetContract(baseSym, 0);
                                var farContract = GetContract(baseSym, 1);
                                var isNear = !string.IsNullOrEmpty(nearContract) && fullContract.Contains(nearContract.Replace("F_", ""));
                                var isFar = !string.IsNullOrEmpty(farContract) && fullContract.Contains(farContract.Replace("F_", ""));
                                
                                if (isNear) {
                                    // SN arbitrajda Near her zaman SHORT (negatif) olmalÄ±
                                    if (lot < 0) {
                                        var qty = Math.Abs(lot);
                                        if (!realNearPos.ContainsKey(baseSym)) realNearPos[baseSym] = 0;
                                        realNearPos[baseSym] += qty;
                                        Log("âœ“ RECOVERY: " + baseSym + " Near SHORT: " + qty + " (SN)");
                                    } else if (lot > 0) {
                                        // NF stratejisinde Near LONG olabilir
                                        if (NF_ENABLED) {
                                            if (!realNfNearPos.ContainsKey(baseSym)) realNfNearPos[baseSym] = 0;
                                            realNfNearPos[baseSym] += lot;
                                            Log("âœ“ RECOVERY: " + baseSym + " Near LONG: " + lot + " (NF)");
                                        } else {
                                            Log("âš ï¸ RECOVERY: " + baseSym + " Near LONG: " + lot + " (YETÄ°M - NF kapalÄ±!)");
                                        }
                                    }
                                } else if (isFar) {
                                    // NF stratejisinde Far her zaman SHORT olmalÄ±
                                    if (lot < 0) {
                                        var qty = Math.Abs(lot);
                                        if (!realNfFarPos.ContainsKey(baseSym)) realNfFarPos[baseSym] = 0;
                                        realNfFarPos[baseSym] += qty;
                                        Log("âœ“ RECOVERY: " + baseSym + " Far SHORT: " + qty + " (NF)");
                                    } else if (lot > 0) {
                                        Log("âš ï¸ RECOVERY: " + baseSym + " Far LONG: " + lot + " (YETÄ°M!)");
                                    }
                                }
                            }
                        }
                    }
                }
                
                // ========== NF RECOVERY ==========
                if (NF_ENABLED && (realNfNearPos.Count > 0 || realNfFarPos.Count > 0 || nfPos.Count > 0)) {
                    Log("ğŸ” RECOVERY NF: BaÅŸlatÄ±lÄ±yor...");
                    
                    // TÃ¼m NF sembollerini topla
                    var nfSymbols = new System.Collections.Generic.HashSet<string>();
                    foreach (var kv in nfPos) nfSymbols.Add(kv.Key);
                    foreach (var kv in realNfNearPos) nfSymbols.Add(kv.Key);
                    foreach (var kv in realNfFarPos) nfSymbols.Add(kv.Key);
                    
                    foreach (var sym in nfSymbols) {
                        var ourNear = nfPos.ContainsKey(sym) ? (int)nfPos[sym][0] : 0;
                        var ourFar = nfPos.ContainsKey(sym) ? (int)nfPos[sym][1] : 0;
                        var brokerNear = realNfNearPos.ContainsKey(sym) ? realNfNearPos[sym] : 0;
                        var brokerFar = realNfFarPos.ContainsKey(sym) ? realNfFarPos[sym] : 0;
                        
                        var mismatch = false;
                        
                        // Durum 1: Broker'da var, bizde yok
                        if ((brokerNear > 0 || brokerFar > 0) && !nfPos.ContainsKey(sym)) {
                            Log("âš ï¸ RECOVERY NF: " + sym + " broker'da var ama nfPos'ta yok!");
                            Log("   Broker: Near=" + brokerNear + " Far=" + brokerFar);
                            
                            // Orphan durumu: Sadece bir bacak var
                            if (brokerNear > 0 && brokerFar == 0) {
                                // Near LONG var, Far SHORT yok
                                // Ã–nce Far SHORT aÃ§mayÄ± dene (spread uygunsa tamamla)
                                var nearContract = GetContract(sym, 0);
                                var farContract = GetContract(sym, 1);
                                var completed = false;
                                
                                if (!string.IsNullOrEmpty(farContract) && !string.IsNullOrEmpty(nearContract)) {
                                    // Spread kontrolÃ¼
                                    var nearDepth = Sistem.DerinlikVerisiOku("VIP'F_" + nearContract);
                                    var farDepth = Sistem.DerinlikVerisiOku("VIP'F_" + farContract);
                                    
                                    if (nearDepth != null && farDepth != null) {
                                        var nearBid = nearDepth.Bids != null && nearDepth.Bids.Length > 0 && nearDepth.Bids[0] != null ? (decimal)nearDepth.Bids[0].Price : 0m;
                                        var farAsk = farDepth.Asks != null && farDepth.Asks.Length > 0 && farDepth.Asks[0] != null ? (decimal)farDepth.Asks[0].Price : 0m;
                                        
                                        if (nearBid > 0 && farAsk > 0) {
                                            var spread = (farAsk - nearBid) / nearBid;
                                            var minSpread = 0.005m; // Minimum %0.5 spread
                                            
                                            if (spread >= minSpread) {
                                                Log("ğŸ”„ RECOVERY NF: " + sym + " ORPHAN - Far SHORT aÃ§Ä±lÄ±yor (spread=" + (spread*100).ToString("F2") + "%)");
                                                var res = ExecGuar("F_" + farContract, "SELL", brokerNear);
                                                if (res.Item1 >= brokerNear) {
                                                    // BaÅŸarÄ±lÄ± - nfPos'a ekle
                                                    var tem = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                                    nfPos[sym] = new decimal[] { brokerNear, res.Item1, nearBid, res.Item2, spread, 0, DateTime.Now.Ticks };
                                                    nfContracts[sym] = new string[] { nearContract, farContract };
                                                    nfViopUsed += (brokerNear + res.Item1) * tem;
                                                    Log("âœ… RECOVERY NF: " + sym + " ORPHAN tamamlandÄ± â†’ Near=" + brokerNear + " Far=" + res.Item1);
                                                    completed = true;
                                                } else if (res.Item1 > 0) {
                                                    // KÄ±smi dolum - geri al
                                                    Log("âš ï¸ RECOVERY NF: " + sym + " Far kÄ±smi doldu (" + res.Item1 + "/" + brokerNear + ") - geri alÄ±nÄ±yor");
                                                    ExecGuar("F_" + farContract, "BUY", res.Item1);
                                                }
                                            } else {
                                                Log("ğŸ“Š RECOVERY NF: " + sym + " spread yetersiz (" + (spread*100).ToString("F2") + "% < " + (minSpread*100).ToString("F1") + "%)");
                                            }
                                        }
                                    }
                                }
                                
                                // TamamlanamadÄ±ysa Near'Ä± kapat
                                if (!completed && !string.IsNullOrEmpty(nearContract)) {
                                    Log("ğŸš¨ RECOVERY NF: " + sym + " ORPHAN - Near LONG kapatÄ±lÄ±yor x" + brokerNear);
                                    var res = ExecGuar("F_" + nearContract, "SELL", brokerNear);
                                    if (res.Item1 > 0) {
                                        Log("âœ… RECOVERY NF: " + sym + " Near LONG kapatÄ±ldÄ±");
                                    }
                                }
                            } else if (brokerFar > 0 && brokerNear == 0) {
                                // Far SHORT var, Near LONG yok
                                // Ã–nce Near LONG aÃ§mayÄ± dene
                                var nearContract = GetContract(sym, 0);
                                var farContract = GetContract(sym, 1);
                                var completed = false;
                                
                                if (!string.IsNullOrEmpty(nearContract) && !string.IsNullOrEmpty(farContract)) {
                                    // Spread kontrolÃ¼
                                    var nearDepth = Sistem.DerinlikVerisiOku("VIP'F_" + nearContract);
                                    var farDepth = Sistem.DerinlikVerisiOku("VIP'F_" + farContract);
                                    
                                    if (nearDepth != null && farDepth != null) {
                                        var nearAsk = nearDepth.Asks != null && nearDepth.Asks.Length > 0 && nearDepth.Asks[0] != null ? (decimal)nearDepth.Asks[0].Price : 0m;
                                        var farBid = farDepth.Bids != null && farDepth.Bids.Length > 0 && farDepth.Bids[0] != null ? (decimal)farDepth.Bids[0].Price : 0m;
                                        
                                        if (nearAsk > 0 && farBid > 0) {
                                            var spread = (farBid - nearAsk) / nearAsk;
                                            var minSpread = 0.005m;
                                            
                                            if (spread >= minSpread) {
                                                Log("ğŸ”„ RECOVERY NF: " + sym + " ORPHAN - Near LONG aÃ§Ä±lÄ±yor (spread=" + (spread*100).ToString("F2") + "%)");
                                                var res = ExecGuar("F_" + nearContract, "BUY", brokerFar);
                                                if (res.Item1 >= brokerFar) {
                                                    var tem = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                                    nfPos[sym] = new decimal[] { res.Item1, brokerFar, res.Item2, farBid, spread, 0, DateTime.Now.Ticks };
                                                    nfContracts[sym] = new string[] { nearContract, farContract };
                                                    nfViopUsed += (res.Item1 + brokerFar) * tem;
                                                    Log("âœ… RECOVERY NF: " + sym + " ORPHAN tamamlandÄ± â†’ Near=" + res.Item1 + " Far=" + brokerFar);
                                                    completed = true;
                                                } else if (res.Item1 > 0) {
                                                    Log("âš ï¸ RECOVERY NF: " + sym + " Near kÄ±smi doldu (" + res.Item1 + "/" + brokerFar + ") - geri alÄ±nÄ±yor");
                                                    ExecGuar("F_" + nearContract, "SELL", res.Item1);
                                                }
                                            } else {
                                                Log("ğŸ“Š RECOVERY NF: " + sym + " spread yetersiz (" + (spread*100).ToString("F2") + "%)");
                                            }
                                        }
                                    }
                                }
                                
                                // TamamlanamadÄ±ysa Far'Ä± kapat
                                if (!completed && !string.IsNullOrEmpty(farContract)) {
                                    Log("ğŸš¨ RECOVERY NF: " + sym + " ORPHAN - Far SHORT kapatÄ±lÄ±yor x" + brokerFar);
                                    var res = ExecGuar("F_" + farContract, "BUY", brokerFar);
                                    if (res.Item1 > 0) {
                                        Log("âœ… RECOVERY NF: " + sym + " Far SHORT kapatÄ±ldÄ±");
                                    }
                                }
                            } else if (brokerNear > 0 && brokerFar > 0) {
                                // Her iki bacak da var - nfPos'a ekle
                                Log("ğŸ“¥ RECOVERY NF: " + sym + " nfPos'a ekleniyor");
                                var tem = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                nfPos[sym] = new decimal[] { brokerNear, brokerFar, 0, 0, 0, 0, DateTime.Now.Ticks };
                                var nearC = GetContract(sym, 0);
                                var farC = GetContract(sym, 1);
                                if (!string.IsNullOrEmpty(nearC) && !string.IsNullOrEmpty(farC)) {
                                    nfContracts[sym] = new string[] { nearC, farC };
                                }
                                nfViopUsed += (brokerNear + brokerFar) * tem;
                                Log("âœ… RECOVERY NF: " + sym + " eklendi â†’ Near=" + brokerNear + " Far=" + brokerFar);
                            }
                            mismatch = true;
                        }
                        // Durum 2: Bizde var, broker'da yok
                        else if (nfPos.ContainsKey(sym) && brokerNear == 0 && brokerFar == 0) {
                            Log("ğŸ—‘ï¸ RECOVERY NF: " + sym + " nfPos'ta var ama broker'da yok - siliniyor");
                            Log("   nfPos: Near=" + ourNear + " Far=" + ourFar);
                            
                            var tem = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                            nfViopUsed -= (ourNear + ourFar) * tem;
                            if (nfViopUsed < 0) nfViopUsed = 0;
                            
                            nfPos.Remove(sym);
                            if (nfContracts.ContainsKey(sym)) nfContracts.Remove(sym);
                            mismatch = true;
                        }
                        // Durum 3: Miktar uyumsuzluÄŸu
                        else if (nfPos.ContainsKey(sym) && (ourNear != brokerNear || ourFar != brokerFar)) {
                            Log("âš ï¸ RECOVERY NF: " + sym + " miktar uyumsuzluÄŸu!");
                            Log("   nfPos:  Near=" + ourNear + " Far=" + ourFar);
                            Log("   Broker: Near=" + brokerNear + " Far=" + brokerFar);
                            
                            if (brokerNear > 0 && brokerFar > 0) {
                                // Her iki taraf da var - gÃ¼ncelle
                                var p = nfPos[sym];
                                var tem = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                var oldTem = (ourNear + ourFar) * tem;
                                var newTem = (brokerNear + brokerFar) * tem;
                                
                                nfPos[sym] = new decimal[] { brokerNear, brokerFar, p[2], p[3], p[4], p[5], p[6] };
                                nfViopUsed = nfViopUsed - oldTem + newTem;
                                if (nfViopUsed < 0) nfViopUsed = 0;
                                
                                Log("âœ… RECOVERY NF: " + sym + " gÃ¼ncellendi â†’ Near=" + brokerNear + " Far=" + brokerFar);
                            } else if (brokerNear == 0 && brokerFar == 0) {
                                var tem = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                nfViopUsed -= (ourNear + ourFar) * tem;
                                if (nfViopUsed < 0) nfViopUsed = 0;
                                
                                nfPos.Remove(sym);
                                if (nfContracts.ContainsKey(sym)) nfContracts.Remove(sym);
                                Log("ğŸ—‘ï¸ RECOVERY NF: " + sym + " silindi");
                            } else {
                                // Tek taraf var - ORPHAN! Ã–nce tamamlamayÄ± dene, olmazsa kapat
                                Log("ğŸš¨ RECOVERY NF: " + sym + " ORPHAN! Broker: Near=" + brokerNear + " Far=" + brokerFar);
                                var completed = false;
                                
                                if (brokerNear > 0 && brokerFar == 0) {
                                    // Near LONG var, Far yok - Ã¶nce Far aÃ§mayÄ± dene
                                    var nearContract = GetContract(sym, 0);
                                    var farContract = GetContract(sym, 1);
                                    
                                    if (!string.IsNullOrEmpty(farContract) && !string.IsNullOrEmpty(nearContract)) {
                                        var nearDepth = Sistem.DerinlikVerisiOku("VIP'F_" + nearContract);
                                        var farDepth = Sistem.DerinlikVerisiOku("VIP'F_" + farContract);
                                        
                                        if (nearDepth != null && farDepth != null) {
                                            var nearBid = nearDepth.Bids != null && nearDepth.Bids.Length > 0 && nearDepth.Bids[0] != null ? (decimal)nearDepth.Bids[0].Price : 0m;
                                            var farAsk = farDepth.Asks != null && farDepth.Asks.Length > 0 && farDepth.Asks[0] != null ? (decimal)farDepth.Asks[0].Price : 0m;
                                            
                                            if (nearBid > 0 && farAsk > 0) {
                                                var spread = (farAsk - nearBid) / nearBid;
                                                if (spread >= 0.005m) {
                                                    Log("   Far SHORT aÃ§Ä±lÄ±yor (spread=" + (spread*100).ToString("F2") + "%)");
                                                    var res = ExecGuar("F_" + farContract, "SELL", brokerNear);
                                                    if (res.Item1 >= brokerNear) {
                                                        var p = nfPos[sym];
                                                        nfPos[sym] = new decimal[] { brokerNear, res.Item1, p[2], res.Item2, spread, p[5], p[6] };
                                                        var tem3 = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                                        nfViopUsed += res.Item1 * tem3;
                                                        Log("   âœ… ORPHAN tamamlandÄ± â†’ Near=" + brokerNear + " Far=" + res.Item1);
                                                        completed = true;
                                                    } else if (res.Item1 > 0) {
                                                        ExecGuar("F_" + farContract, "BUY", res.Item1);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    if (!completed && !string.IsNullOrEmpty(nearContract)) {
                                        Log("   Near LONG kapatÄ±lÄ±yor x" + brokerNear);
                                        var res = ExecGuar("F_" + nearContract, "SELL", brokerNear);
                                        if (res.Item1 > 0) Log("   âœ… Near kapatÄ±ldÄ±");
                                    }
                                } else if (brokerFar > 0 && brokerNear == 0) {
                                    // Far SHORT var, Near yok - Ã¶nce Near aÃ§mayÄ± dene
                                    var nearContract = GetContract(sym, 0);
                                    var farContract = GetContract(sym, 1);
                                    
                                    if (!string.IsNullOrEmpty(nearContract) && !string.IsNullOrEmpty(farContract)) {
                                        var nearDepth = Sistem.DerinlikVerisiOku("VIP'F_" + nearContract);
                                        var farDepth = Sistem.DerinlikVerisiOku("VIP'F_" + farContract);
                                        
                                        if (nearDepth != null && farDepth != null) {
                                            var nearAsk = nearDepth.Asks != null && nearDepth.Asks.Length > 0 && nearDepth.Asks[0] != null ? (decimal)nearDepth.Asks[0].Price : 0m;
                                            var farBid = farDepth.Bids != null && farDepth.Bids.Length > 0 && farDepth.Bids[0] != null ? (decimal)farDepth.Bids[0].Price : 0m;
                                            
                                            if (nearAsk > 0 && farBid > 0) {
                                                var spread = (farBid - nearAsk) / nearAsk;
                                                if (spread >= 0.005m) {
                                                    Log("   Near LONG aÃ§Ä±lÄ±yor (spread=" + (spread*100).ToString("F2") + "%)");
                                                    var res = ExecGuar("F_" + nearContract, "BUY", brokerFar);
                                                    if (res.Item1 >= brokerFar) {
                                                        var p = nfPos[sym];
                                                        nfPos[sym] = new decimal[] { res.Item1, brokerFar, res.Item2, p[3], spread, p[5], p[6] };
                                                        var tem3 = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                                        nfViopUsed += res.Item1 * tem3;
                                                        Log("   âœ… ORPHAN tamamlandÄ± â†’ Near=" + res.Item1 + " Far=" + brokerFar);
                                                        completed = true;
                                                    } else if (res.Item1 > 0) {
                                                        ExecGuar("F_" + nearContract, "SELL", res.Item1);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    if (!completed && !string.IsNullOrEmpty(farContract)) {
                                        Log("   Far SHORT kapatÄ±lÄ±yor x" + brokerFar);
                                        var res = ExecGuar("F_" + farContract, "BUY", brokerFar);
                                        if (res.Item1 > 0) Log("   âœ… Far kapatÄ±ldÄ±");
                                    }
                                }
                                
                                // TamamlanamadÄ±ysa nfPos'u sil
                                if (!completed) {
                                    var tem2 = teminat.ContainsKey(sym) ? teminat[sym] : 1000m;
                                    nfViopUsed -= (ourNear + ourFar) * tem2;
                                    if (nfViopUsed < 0) nfViopUsed = 0;
                                    nfPos.Remove(sym);
                                    if (nfContracts.ContainsKey(sym)) nfContracts.Remove(sym);
                                }
                            }
                            mismatch = true;
                        }
                        
                        if (!mismatch && nfPos.ContainsKey(sym)) {
                            Log("âœ“ RECOVERY NF: " + sym + " OK (Near=" + ourNear + " Far=" + ourFar + ")");
                        }
                    }
                    
                    Log("âœ… RECOVERY NF: TamamlandÄ±. Pozisyon:" + nfPos.Count + " KullanÄ±lan:" + nfViopUsed.ToString("N0"));
                }
                
            } else {
                Log("âš ï¸ RECOVERY: VIOP hesap veya pozisyonlar null - NEAR recovery atlanÄ±yor");
            }
        } catch (Exception ex) { Log("âš ï¸ VIOP pozisyon okuma hata: " + ex.Message); }
        
        // Her iki hesap da okunamadÄ±ysa recovery'yi tamamen atla ve baÄŸlantÄ± yok say
        if (!bistOk && !viopOk) {
            Log("âš ï¸ RECOVERY: Her iki hesap da okunamadÄ± - recovery iptal, baÄŸlantÄ± yok");
            brokerConnected = false;
            inRecovery = false;
            return;
        }
        
        // En az biri okunduysa baÄŸlantÄ± var
        brokerConnected = true;
        
        Log("ğŸ“Š RECOVERY: GerÃ§ek pozisyonlar - SPOT:" + realSpotPos.Count + " NEAR:" + realNearPos.Count);
        
        // ========== PAIR TRADING RECOVERY ==========
        if (PAIR_ENABLED && viopOk && PAIR_DEFS.Count > 0) {
            try {
                Log("ğŸ” RECOVERY PAIR: BaÅŸlatÄ±lÄ±yor...");
                
                // Broker'daki VIOP pozisyonlarÄ±ndan Pair sembollerini ayÄ±kla
                // realPairPos[sym] = { kontrat, lot, yÃ¶n (1=LONG, -1=SHORT) }
                var realPairPos = new System.Collections.Generic.Dictionary<string, System.Collections.Generic.Dictionary<string, int>>();
                
                var viopHesapPair = GetViopHesap();
                if (viopHesapPair != null && viopHesapPair.Pozisyonlar != null) {
                    for (int i = 0; i < viopHesapPair.Pozisyonlar.Count; i++) {
                        var sym = (string)viopHesapPair.Pozisyonlar[i].Symbol;
                        var lot = (int)viopHesapPair.Pozisyonlar[i].NetAmount;
                        
                        if (sym != null && (sym.StartsWith("F_") || sym.Contains("'F_"))) {
                            var idx = sym.IndexOf("F_");
                            if (idx >= 0) {
                                var fullContract = sym.Substring(idx);  // F_TCELL0226
                                var baseSym = fullContract.Substring(2);  // TCELL0226
                                if (baseSym.Length > 4) baseSym = baseSym.Substring(0, baseSym.Length - 4);  // TCELL
                                
                                // Bu sembol PAIR_BLOCKED'da mÄ±? (Pair Trading sembolleri)
                                if (PAIR_BLOCKED.Contains(baseSym)) {
                                    if (!realPairPos.ContainsKey(baseSym)) {
                                        realPairPos[baseSym] = new System.Collections.Generic.Dictionary<string, int>();
                                    }
                                    realPairPos[baseSym][fullContract] = lot;
                                    Log("ğŸ” RECOVERY PAIR: " + baseSym + " [" + fullContract + "] Lot:" + lot);
                                }
                            }
                        }
                    }
                }
                
                // Her Pair tanÄ±mÄ± iÃ§in karÅŸÄ±laÅŸtÄ±r
                foreach (var def in PAIR_DEFS) {
                    var symA = (string)def[0];
                    var symB = (string)def[1];
                    var beta = (decimal)def[2];
                    var pairKey = GetPairKey(symA, symB);
                    
                    // Bizim pozisyonumuz
                    var ourQtyA = pairPos.ContainsKey(pairKey) ? (int)pairPos[pairKey][0] : 0;
                    var ourQtyB = pairPos.ContainsKey(pairKey) ? (int)pairPos[pairKey][1] : 0;
                    
                    // Broker'daki pozisyon (tÃ¼m kontratlarÄ±n toplamÄ±)
                    var brokerQtyA = 0;
                    var brokerQtyB = 0;
                    
                    if (realPairPos.ContainsKey(symA)) {
                        foreach (var kv in realPairPos[symA]) {
                            brokerQtyA += Math.Abs(kv.Value);  // Mutlak deÄŸer (yÃ¶n pairPos'tan belirlenir)
                        }
                    }
                    if (realPairPos.ContainsKey(symB)) {
                        foreach (var kv in realPairPos[symB]) {
                            brokerQtyB += Math.Abs(kv.Value);
                        }
                    }
                    
                    // KontratlarÄ± al
                    var pairNearA = GetContract(symA, 0);
                    var pairNearB = GetContract(symB, 0);
                    
                    // Uyumsuzluk kontrolÃ¼
                    var mismatch = false;
                    
                    // YardÄ±mcÄ±: Beta'ya gÃ¶re doÄŸru lot hesapla
                    // A'dan B hesapla: B = A Ã— beta
                    // B'den A hesapla: A = B / beta
                    Func<int, int> calcBfromA = (qA) => (int)Math.Round(qA * beta);
                    Func<int, int> calcAfromB = (qB) => (int)Math.Round(qB / beta);
                    
                    // Durum 1: Broker'da var, bizde yok â†’ pairPos'a ekle ve oran dÃ¼zelt
                    if ((brokerQtyA > 0 || brokerQtyB > 0) && !pairPos.ContainsKey(pairKey)) {
                        Log("âš ï¸ RECOVERY PAIR: " + pairKey + " broker'da var ama pairPos'ta yok!");
                        Log("   Broker: A=" + brokerQtyA + " B=" + brokerQtyB);
                        
                        // Pozisyon yÃ¶nÃ¼nÃ¼ tahmin et (hangi taraf daha bÃ¼yÃ¼k?)
                        // Normalde Z<0 ise A LONG, Z>0 ise A SHORT
                        // Broker'dan yÃ¶n bilgisi alalÄ±m
                        var brokerDirA = 0;  // 1=LONG, -1=SHORT
                        if (realPairPos.ContainsKey(symA)) {
                            foreach (var kv in realPairPos[symA]) {
                                brokerDirA = kv.Value > 0 ? 1 : -1;
                                break;
                            }
                        }
                        var estimatedZ = brokerDirA > 0 ? -2m : 2m;  // A LONG ise Z negatif tahmin
                        
                        // Beta oranÄ±na gÃ¶re dÃ¼zeltme gerekiyor mu?
                        var expectedB = calcBfromA(brokerQtyA);
                        var expectedA = calcAfromB(brokerQtyB);
                        
                        var finalQtyA = brokerQtyA;
                        var finalQtyB = brokerQtyB;
                        
                        if (brokerQtyA > 0 && brokerQtyB > 0) {
                            var actualRatio = (decimal)brokerQtyB / brokerQtyA;
                            var ratioDeviation = Math.Abs(actualRatio - beta) / beta;
                            
                            if (ratioDeviation > PAIR_RATIO_TOLERANCE) {
                                Log("   Oran dÃ¼zeltme gerekiyor: Î²=" + beta.ToString("F2") + " GerÃ§ek=" + actualRatio.ToString("F2"));
                                
                                // Hangisini dÃ¼zeltmek daha az iÅŸlem gerektirir?
                                var diffFixB = Math.Abs(expectedB - brokerQtyB);
                                var diffFixA = Math.Abs(expectedA - brokerQtyA);
                                
                                if (diffFixB <= diffFixA && !string.IsNullOrEmpty(pairNearB)) {
                                    // B'yi dÃ¼zelt
                                    var delta = expectedB - brokerQtyB;
                                    if (delta != 0) {
                                        var side = delta > 0 ? (brokerDirA > 0 ? "SELL" : "BUY") : (brokerDirA > 0 ? "BUY" : "SELL");
                                        Log("   B dÃ¼zeltiliyor: " + symB + " " + side + " x" + Math.Abs(delta));
                                        var res = ExecGuar("F_" + pairNearB, side, Math.Abs(delta));
                                        if (res.Item1 > 0) {
                                            finalQtyB = brokerQtyB + delta;
                                            Log("   âœ… B dÃ¼zeltildi: " + brokerQtyB + " â†’ " + finalQtyB);
                                        }
                                    }
                                } else if (!string.IsNullOrEmpty(pairNearA)) {
                                    // A'yÄ± dÃ¼zelt
                                    var delta = expectedA - brokerQtyA;
                                    if (delta != 0) {
                                        var side = delta > 0 ? (brokerDirA > 0 ? "BUY" : "SELL") : (brokerDirA > 0 ? "SELL" : "BUY");
                                        Log("   A dÃ¼zeltiliyor: " + symA + " " + side + " x" + Math.Abs(delta));
                                        var res = ExecGuar("F_" + pairNearA, side, Math.Abs(delta));
                                        if (res.Item1 > 0) {
                                            finalQtyA = brokerQtyA + delta;
                                            Log("   âœ… A dÃ¼zeltildi: " + brokerQtyA + " â†’ " + finalQtyA);
                                        }
                                    }
                                }
                            }
                        } else if (brokerQtyA > 0 && brokerQtyB == 0 && !string.IsNullOrEmpty(pairNearB)) {
                            // Sadece A var, B'yi aÃ§
                            var side = brokerDirA > 0 ? "SELL" : "BUY";
                            Log("   B eksik, aÃ§Ä±lÄ±yor: " + symB + " " + side + " x" + expectedB);
                            var res = ExecGuar("F_" + pairNearB, side, expectedB);
                            if (res.Item1 > 0) {
                                finalQtyB = res.Item1;
                                Log("   âœ… B aÃ§Ä±ldÄ±: " + finalQtyB);
                            }
                        } else if (brokerQtyB > 0 && brokerQtyA == 0 && !string.IsNullOrEmpty(pairNearA)) {
                            // Sadece B var, A'yÄ± aÃ§
                            var brokerDirB = 0;
                            if (realPairPos.ContainsKey(symB)) {
                                foreach (var kv in realPairPos[symB]) {
                                    brokerDirB = kv.Value > 0 ? 1 : -1;
                                    break;
                                }
                            }
                            var side = brokerDirB > 0 ? "SELL" : "BUY";
                            Log("   A eksik, aÃ§Ä±lÄ±yor: " + symA + " " + side + " x" + expectedA);
                            var res = ExecGuar("F_" + pairNearA, side, expectedA);
                            if (res.Item1 > 0) {
                                finalQtyA = res.Item1;
                                Log("   âœ… A aÃ§Ä±ldÄ±: " + finalQtyA);
                            }
                        }
                        
                        // pairPos'a ekle
                        if (finalQtyA > 0 && finalQtyB > 0) {
                            var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
                            var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                            pairPos[pairKey] = new decimal[] { finalQtyA, finalQtyB, 0, 0, estimatedZ, 1, DateTime.Now.Ticks, 0 };
                            if (!string.IsNullOrEmpty(pairNearA) && !string.IsNullOrEmpty(pairNearB)) {
                                pairContracts[pairKey] = new string[] { pairNearA, pairNearB };
                            }
                            pairUsed += (finalQtyA * temA) + (finalQtyB * temB);
                            Log("âœ… RECOVERY PAIR: " + pairKey + " pairPos'a eklendi A=" + finalQtyA + " B=" + finalQtyB);
                        }
                        mismatch = true;
                    }
                    // Durum 2: Bizde var, broker'da yok â†’ pairPos'tan sil
                    else if (pairPos.ContainsKey(pairKey) && brokerQtyA == 0 && brokerQtyB == 0) {
                        Log("ğŸ—‘ï¸ RECOVERY PAIR: " + pairKey + " pairPos'ta var ama broker'da yok - siliniyor");
                        Log("   pairPos: A=" + ourQtyA + " B=" + ourQtyB);
                        
                        // TeminatÄ± serbest bÄ±rak
                        var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
                        var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                        pairUsed -= (ourQtyA * temA) + (ourQtyB * temB);
                        if (pairUsed < 0) pairUsed = 0;
                        
                        pairPos.Remove(pairKey);
                        if (pairContracts.ContainsKey(pairKey)) pairContracts.Remove(pairKey);
                        mismatch = true;
                    }
                    // Durum 3: Tek taraf ORPHAN â†’ Eksik tarafÄ± tamamla
                    else if (pairPos.ContainsKey(pairKey) && ((brokerQtyA > 0 && brokerQtyB == 0) || (brokerQtyA == 0 && brokerQtyB > 0))) {
                        var p = pairPos[pairKey];
                        var openZ = p[4];
                        var isLongA = openZ < 0;
                        
                        if (brokerQtyA > 0 && brokerQtyB == 0 && !string.IsNullOrEmpty(pairNearB)) {
                            // A var, B eksik
                            var expectedB = calcBfromA(brokerQtyA);
                            var side = isLongA ? "SELL" : "BUY";
                            Log("ğŸš¨ RECOVERY PAIR: " + pairKey + " ORPHAN - B eksik, tamamlanÄ±yor");
                            Log("   A=" + brokerQtyA + " B=0 â†’ B " + side + " x" + expectedB);
                            
                            var res = ExecGuar("F_" + pairNearB, side, expectedB);
                            if (res.Item1 > 0) {
                                var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
                                var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                                var oldTem = (ourQtyA * temA) + (ourQtyB * temB);
                                var newTem = (brokerQtyA * temA) + (res.Item1 * temB);
                                
                                pairPos[pairKey] = new decimal[] { brokerQtyA, res.Item1, p[2], res.Item2, p[4], p[5], p[6], p.Length > 7 ? p[7] : 0m };
                                pairUsed = pairUsed - oldTem + newTem;
                                Log("âœ… RECOVERY PAIR: " + pairKey + " ORPHAN dÃ¼zeltildi A=" + brokerQtyA + " B=" + res.Item1);
                            }
                        } else if (brokerQtyB > 0 && brokerQtyA == 0 && !string.IsNullOrEmpty(pairNearA)) {
                            // B var, A eksik
                            var expectedA = calcAfromB(brokerQtyB);
                            var side = isLongA ? "BUY" : "SELL";
                            Log("ğŸš¨ RECOVERY PAIR: " + pairKey + " ORPHAN - A eksik, tamamlanÄ±yor");
                            Log("   A=0 B=" + brokerQtyB + " â†’ A " + side + " x" + expectedA);
                            
                            var res = ExecGuar("F_" + pairNearA, side, expectedA);
                            if (res.Item1 > 0) {
                                var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
                                var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                                var oldTem = (ourQtyA * temA) + (ourQtyB * temB);
                                var newTem = (res.Item1 * temA) + (brokerQtyB * temB);
                                
                                pairPos[pairKey] = new decimal[] { res.Item1, brokerQtyB, res.Item2, p[3], p[4], p[5], p[6], p.Length > 7 ? p[7] : 0m };
                                pairUsed = pairUsed - oldTem + newTem;
                                Log("âœ… RECOVERY PAIR: " + pairKey + " ORPHAN dÃ¼zeltildi A=" + res.Item1 + " B=" + brokerQtyB);
                            }
                        }
                        mismatch = true;
                    }
                    // Durum 4: Her iki tarafta da pozisyon var ama uyumsuzluk
                    else if (pairPos.ContainsKey(pairKey) && brokerQtyA > 0 && brokerQtyB > 0) {
                        var p = pairPos[pairKey];
                        var openZ = p[4];
                        var isLongA = openZ < 0;
                        
                        // Bizim beklediÄŸimiz doÄŸru oranlar
                        var ourExpectedB = calcBfromA(ourQtyA);
                        var brokerActualRatio = (decimal)brokerQtyB / brokerQtyA;
                        var ourRatio = ourQtyA > 0 ? (decimal)ourQtyB / ourQtyA : beta;
                        var brokerRatioDeviation = Math.Abs(brokerActualRatio - beta) / beta;
                        var ourRatioDeviation = Math.Abs(ourRatio - beta) / beta;
                        
                        // Miktar uyumsuzluÄŸu
                        if (ourQtyA != brokerQtyA || ourQtyB != brokerQtyB) {
                            Log("âš ï¸ RECOVERY PAIR: " + pairKey + " miktar uyumsuzluÄŸu!");
                            Log("   pairPos: A=" + ourQtyA + " B=" + ourQtyB + " (oran=" + ourRatio.ToString("F2") + ")");
                            Log("   Broker:  A=" + brokerQtyA + " B=" + brokerQtyB + " (oran=" + brokerActualRatio.ToString("F2") + ")");
                            Log("   Hedef Î²=" + beta.ToString("F2"));
                            
                            // Broker oranÄ± yanlÄ±ÅŸ mÄ±?
                            if (brokerRatioDeviation > PAIR_RATIO_TOLERANCE) {
                                Log("   Broker oranÄ± yanlÄ±ÅŸ, dÃ¼zeltiliyor...");
                                
                                // Bizdeki oran doÄŸruysa, bizim miktarlarÄ±mÄ±za gÃ¶re dÃ¼zelt
                                // DeÄŸilse, mevcut A'ya gÃ¶re B'yi dÃ¼zelt
                                var targetA = ourRatioDeviation <= PAIR_RATIO_TOLERANCE ? ourQtyA : brokerQtyA;
                                var targetB = calcBfromA(targetA);
                                
                                // A dÃ¼zeltmesi
                                if (brokerQtyA != targetA && !string.IsNullOrEmpty(pairNearA)) {
                                    var deltaA = targetA - brokerQtyA;
                                    var sideA = deltaA > 0 ? (isLongA ? "BUY" : "SELL") : (isLongA ? "SELL" : "BUY");
                                    Log("   A dÃ¼zeltiliyor: " + sideA + " x" + Math.Abs(deltaA));
                                    var resA = ExecGuar("F_" + pairNearA, sideA, Math.Abs(deltaA));
                                    if (resA.Item1 > 0) {
                                        brokerQtyA = targetA;
                                    }
                                }
                                
                                // B dÃ¼zeltmesi
                                if (brokerQtyB != targetB && !string.IsNullOrEmpty(pairNearB)) {
                                    var deltaB = targetB - brokerQtyB;
                                    var sideB = deltaB > 0 ? (isLongA ? "SELL" : "BUY") : (isLongA ? "BUY" : "SELL");
                                    Log("   B dÃ¼zeltiliyor: " + sideB + " x" + Math.Abs(deltaB));
                                    var resB = ExecGuar("F_" + pairNearB, sideB, Math.Abs(deltaB));
                                    if (resB.Item1 > 0) {
                                        brokerQtyB = targetB;
                                    }
                                }
                            }
                            
                            // pairPos'u gÃ¼ncelle
                            var temA = teminat.ContainsKey(symA) ? teminat[symA] : 1000m;
                            var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                            var oldTem = (ourQtyA * temA) + (ourQtyB * temB);
                            var newTem = (brokerQtyA * temA) + (brokerQtyB * temB);
                            
                            pairPos[pairKey] = new decimal[] { brokerQtyA, brokerQtyB, p[2], p[3], p[4], p[5], p[6], p.Length > 7 ? p[7] : 0m };
                            pairUsed = pairUsed - oldTem + newTem;
                            if (pairUsed < 0) pairUsed = 0;
                            
                            Log("âœ… RECOVERY PAIR: " + pairKey + " gÃ¼ncellendi â†’ A=" + brokerQtyA + " B=" + brokerQtyB);
                            mismatch = true;
                        }
                        // Miktar eÅŸit ama oran kontrolÃ¼
                        else if (brokerRatioDeviation > PAIR_RATIO_TOLERANCE) {
                            Log("âš ï¸ RECOVERY PAIR: " + pairKey + " oran uyumsuz!");
                            Log("   Mevcut: A=" + brokerQtyA + " B=" + brokerQtyB + " (oran=" + brokerActualRatio.ToString("F2") + ")");
                            Log("   Hedef Î²=" + beta.ToString("F2"));
                            
                            // B'yi dÃ¼zelt (A sabit kalsÄ±n)
                            var targetB = calcBfromA(brokerQtyA);
                            var deltaB = targetB - brokerQtyB;
                            
                            if (deltaB != 0 && !string.IsNullOrEmpty(pairNearB)) {
                                var sideB = deltaB > 0 ? (isLongA ? "SELL" : "BUY") : (isLongA ? "BUY" : "SELL");
                                Log("   B dÃ¼zeltiliyor: " + sideB + " x" + Math.Abs(deltaB));
                                var resB = ExecGuar("F_" + pairNearB, sideB, Math.Abs(deltaB));
                                if (resB.Item1 > 0) {
                                    var temB = teminat.ContainsKey(symB) ? teminat[symB] : 1000m;
                                    pairPos[pairKey] = new decimal[] { brokerQtyA, targetB, p[2], p[3], p[4], p[5], p[6], p.Length > 7 ? p[7] : 0m };
                                    pairUsed += deltaB * temB;
                                    Log("âœ… RECOVERY PAIR: " + pairKey + " oran dÃ¼zeltildi â†’ A=" + brokerQtyA + " B=" + targetB);
                                }
                            }
                            mismatch = true;
                        }
                    }
                    
                    if (!mismatch && pairPos.ContainsKey(pairKey)) {
                        Log("âœ“ RECOVERY PAIR: " + pairKey + " OK (A=" + ourQtyA + " B=" + ourQtyB + " Î²=" + beta.ToString("F2") + ")");
                    }
                }
                
                Log("âœ… RECOVERY PAIR: TamamlandÄ±. Pozisyon:" + pairPos.Count + " KullanÄ±lan:" + pairUsed.ToString("N0"));
                
            } catch (Exception ex) {
                Log("âŒ RECOVERY PAIR HATA: " + ex.Message);
            }
        }
        
        // 2. Kendi pozisyonlarÄ±mÄ±zla karÅŸÄ±laÅŸtÄ±r ve eksik bacaklarÄ± bul (SN)
        var allSymbols = new System.Collections.Generic.HashSet<string>();
        foreach (var kv in snPos) allSymbols.Add(kv.Key);
        if (bistOk) foreach (var kv in realSpotPos) allSymbols.Add(kv.Key);
        if (viopOk) foreach (var kv in realNearPos) allSymbols.Add(kv.Key);
        
        foreach (var sym in allSymbols) {
            // Bekleyen emir varsa bu sembol iÃ§in recovery atla
            var hasPendingOrder = false;
            foreach (var pk in pendingOrders.Keys) {
                // pk = "THYAO_BUY" veya "F_THYAO0126_SELL"
                // sym = "THYAO"
                if (pk.StartsWith(sym + "_") || pk.Contains("_" + sym) || pk.Contains(sym)) {
                    hasPendingOrder = true;
                    Log("â­ï¸ RECOVERY: " + sym + " iÃ§in bekleyen emir var (" + pk + "), atlanÄ±yor");
                    break;
                }
            }
            if (hasPendingOrder) continue;
            
            var ourSpot = snPos.ContainsKey(sym) ? (int)snPos[sym][0] : 0;
            var ourNear = snPos.ContainsKey(sym) ? (int)snPos[sym][1] : 0;
            
            // Sadece baÅŸarÄ±lÄ± okunan hesaplardan gerÃ§ek pozisyon al
            // Okunamayan taraf iÃ§in bizim deÄŸerimizi koru
            var realSpot = bistOk ? (realSpotPos.ContainsKey(sym) ? realSpotPos[sym] : 0) : ourSpot;
            var realNear = viopOk ? (realNearPos.ContainsKey(sym) ? realNearPos[sym] : 0) : ourNear;
            
            // Fark var mÄ±?
            if (ourSpot != realSpot || ourNear != realNear) {
                Log("âš ï¸ RECOVERY: " + sym + " uyumsuz! Bizde S:" + ourSpot + " N:" + ourNear + " GerÃ§ek S:" + realSpot + " N:" + realNear);
                
                // Durum 4: Bizde var ama aracÄ± kurumda yok - sadece her iki okuma da baÅŸarÄ±lÄ±ysa sil
                // Ã–NCELÄ°KLÄ° KONTROL: Bu durumu ilk kontrol et!
                if (realSpot == 0 && realNear == 0 && snPos.ContainsKey(sym) && bistOk && viopOk) {
                    Log("ğŸ—‘ï¸ RECOVERY: " + sym + " aracÄ± kurumda yok, pozisyon siliniyor");
                    snPos.Remove(sym);
                }
                // Durum 1: Sadece Spot var, Near yok (Near eksik) - sadece VIOP okuma baÅŸarÄ±lÄ±ysa
                else if (realSpot > 0 && realNear == 0 && viopOk) {
                    RecoverMissingLeg(sym, "NEAR", realSpot, 0);
                }
                // Durum 2: Sadece Near var, Spot yok (Spot eksik) - sadece BIST okuma baÅŸarÄ±lÄ±ysa
                else if (realNear > 0 && realSpot == 0 && bistOk) {
                    RecoverMissingLeg(sym, "SPOT", 0, realNear);
                }
                // Durum 3: Ä°kisi de var ama miktarlar uyumsuz
                else if (realSpot > 0 && realNear > 0) {
                    // Pozisyonumuzu gerÃ§eÄŸe gÃ¶re gÃ¼ncelle
                    if (snPos.ContainsKey(sym)) {
                        var p = snPos[sym];
                        if (bistOk) p[0] = realSpot;
                        if (viopOk) p[1] = realNear;
                        Log("âœ… RECOVERY: " + sym + " pozisyon gÃ¼ncellendi S:" + realSpot + " N:" + realNear);
                    }
                }
            }
            // Uyumsuzluk olmasa bile yetim pozisyon kontrolÃ¼ (positions.json'da Near=0 kaydedilmiÅŸ olabilir)
            else if (realSpot > 0 && realNear == 0 && viopOk && snPos.ContainsKey(sym)) {
                Log("âš ï¸ RECOVERY: " + sym + " yetim pozisyon! Spot:" + realSpot + " Near:0");
                RecoverMissingLeg(sym, "NEAR", realSpot, 0);
            }
            else if (realNear > 0 && realSpot == 0 && bistOk && snPos.ContainsKey(sym)) {
                Log("âš ï¸ RECOVERY: " + sym + " yetim pozisyon! Spot:0 Near:" + realNear);
                RecoverMissingLeg(sym, "SPOT", 0, realNear);
            }
        }
        
        // orphanLegs kontrolÃ¼: Manuel tamamlanmÄ±ÅŸ mÄ±?
        // Broker'da pozisyon yok ama orphanLegs'te kayÄ±t var â†’ Manuel kapatÄ±lmÄ±ÅŸ
        var orphansToRemove = new System.Collections.Generic.List<string>();
        foreach (var kv in orphanLegs) {
            var sym = kv.Key;
            var orph = kv.Value;
            var filledLeg = (string)orph[0];  // "NEAR" veya "SPOT"
            var filledSide = (string)orph[2]; // "SELL" veya "BUY"
            var filledQty = (int)orph[3];
            var filledPrice = (decimal)orph[4];
            
            // Near SHORT aÃ§Ä±ldÄ±, Spot alÄ±namadÄ± durumu
            if (filledLeg == "NEAR" && filledSide == "SELL") {
                // VÄ°OP'ta bu sembol iÃ§in SHORT var mÄ±?
                var hasNearShort = realNearPos.ContainsKey(sym) && realNearPos[sym] > 0;
                
                if (!hasNearShort && viopOk) {
                    // VÄ°OP'ta Near SHORT yok â†’ Manuel kapatÄ±lmÄ±ÅŸ!
                    Log("ğŸ—‘ï¸ RECOVERY: " + sym + " orphanLegs manuel tamamlanmÄ±ÅŸ (VÄ°OP'ta pozisyon yok)");
                    Log("   AÃ§Ä±lÄ±ÅŸ: NEAR SELL x" + filledQty + " @" + filledPrice.ToString("F2"));
                    orphansToRemove.Add(sym);
                }
            }
            // Spot alÄ±ndÄ±, Near satÄ±lamadÄ± durumu (tersi)
            else if (filledLeg == "SPOT" && filledSide == "BUY") {
                // BIST'te bu sembol iÃ§in Spot var mÄ±?
                var hasSpot = realSpotPos.ContainsKey(sym) && realSpotPos[sym] > 0;
                
                if (!hasSpot && bistOk) {
                    // BIST'te Spot yok â†’ Manuel kapatÄ±lmÄ±ÅŸ!
                    Log("ğŸ—‘ï¸ RECOVERY: " + sym + " orphanLegs manuel tamamlanmÄ±ÅŸ (BIST'te pozisyon yok)");
                    Log("   AÃ§Ä±lÄ±ÅŸ: SPOT BUY x" + filledQty + " @" + filledPrice.ToString("F2"));
                    orphansToRemove.Add(sym);
                }
            }
        }
        foreach (var sym in orphansToRemove) {
            orphanLegs.Remove(sym);
        }
        if (orphansToRemove.Count > 0) {
            Log("ğŸ“‹ RECOVERY: " + orphansToRemove.Count + " orphanLegs kaydÄ± temizlendi (manuel tamamlama)");
        }
        
        // 3. PozisyonlarÄ± kaydet ve IdealData gÃ¼ncelle
        SavePositions();
        foreach (var kv in snPos) {
            try {
                var p = kv.Value;
                Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_SPOT," + kv.Key, (int)p[0], (double)p[2], "SPOT");
                Sistem.PozisyonKontrolGuncelle(ROBOT_NAME + "_NEAR," + GetContract(kv.Key, 0), (int)p[1], (double)p[3], "NEAR");
            } catch { }
        }
        
        // BÃ¼tÃ§e kullanÄ±mÄ±nÄ± yeniden hesapla
        spotUsed = 0;
        viopUsed = 0;
        foreach (var kv in snPos) {
            var p = kv.Value;
            var tem = teminat.ContainsKey(kv.Key) ? teminat[kv.Key] : 0;
            spotUsed += p[2] * p[0];
            viopUsed += tem * p[1];
        }
        
        Log("âœ… RECOVERY: Senkronizasyon tamamlandÄ±. Pozisyon:" + snPos.Count + " SPOT:" + spotUsed.ToString("N0") + " VIOP:" + viopUsed.ToString("N0"));
        lastRecoveryCheck = DateTime.Now;
        
        // BÃ¼tÃ§eleri gÃ¼ncelle (gerÃ§ek bakiyeleri oku)
        UpdateBalances();
        if (IS_TEST) {
            Log("ğŸ’° RECOVERY: BÃ¼tÃ§e SPOT:" + spotBudgetTotal.ToString("N0") + " (kalan:" + spotBalance.ToString("N0") + ") VIOP:" + viopBalance.ToString("N0"));
        } else {
            Log("ğŸ’° RECOVERY: BÃ¼tÃ§e SPOT:" + spotBudgetTotal.ToString("N0") + " (T+2:" + t2Balance.ToString("N0") + ") VIOP:" + viopBalance.ToString("N0"));
        }
        
    } catch (Exception ex) {
        Log("âŒ RECOVERY HATA: " + ex.Message);
    } finally {
        inRecovery = false;  // Her durumda flag'i resetle
    }
};

// Eksik bacak recovery
RecoverMissingLeg = (sym, missingLeg, realSpot, realNear) => {
    try {
        // AÃ‡ILIÅ VOLATÄ°LÄ°TESÄ° KORUMASI: 10:05'e kadar beklet
        var recNow = DateTime.Now;
        var recMinutes = recNow.Hour * 60 + recNow.Minute;
        var recStartMinutes = MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE + 5;  // 10:05
        var bistOpenMinutes = MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE;  // 10:00
        
        // Piyasa aÃ§Ä±k deÄŸilse veya 10:05'ten Ã¶nceyse beklet
        if (recMinutes < recStartMinutes) {
            // orphanLegs'e kaydet ve 10:05'te iÅŸlenecek
            if (!orphanLegs.ContainsKey(sym)) {
                // snPos'tan giriÅŸ fiyatÄ±nÄ± al (varsa)
                var spotEntry = snPos.ContainsKey(sym) ? snPos[sym][2] : 0m;
                var nearEntry = snPos.ContainsKey(sym) ? snPos[sym][3] : 0m;
                
                if (missingLeg == "NEAR") {
                    // Spot var, Near yok â†’ Near aÃ§Ä±lacak veya Spot kapatÄ±lacak
                    orphanLegs[sym] = new object[] {
                        "SPOT", SPOT_PREFIX + sym, "HOLD", realSpot, spotEntry,
                        "NEAR", GetContract(sym, 0), "PENDING", realSpot / 100, DateTime.Now.Ticks
                    };
                } else {
                    // Near var, Spot yok â†’ Spot aÃ§Ä±lacak veya Near kapatÄ±lacak
                    orphanLegs[sym] = new object[] {
                        "NEAR", GetContract(sym, 0), "SELL", realNear, nearEntry,
                        "SPOT", sym, "BUY", realNear * 100, DateTime.Now.Ticks
                    };
                }
                Log("â³ RECOVERY BEKLETMESÄ°: " + sym + " eksik bacak: " + missingLeg + " - 10:05'te iÅŸlenecek");
                SavePositions();
            }
            return;
        }
        
        Log("ğŸ”§ RECOVERY: " + sym + " eksik bacak: " + missingLeg);
        
        var spotS = SPOT_PREFIX + sym;
        var nearC = GetContract(sym, 0);
        var nearS = FUTURES_PREFIX + nearC;
        
        // Derinlikten fiyat al (yÃ¼zeysel veri 26ms gecikmeli olabilir)
        var spotDepthRec = ReadDepth(spotS, "ASK", 0, 1, 50);  // Spot Ask (alÄ±m iÃ§in)
        var spotBidDepthRec = ReadDepth(spotS, "BID", 0, 1, 50);  // Spot Bid (satÄ±m iÃ§in)
        var nearDepthRec = ReadDepth(nearS, "BID", 0, 1, 50);  // Near Bid (satÄ±m iÃ§in)
        
        var spotBid = spotBidDepthRec.Item1 ? spotBidDepthRec.Item4 : 0m;
        var spotAsk = spotDepthRec.Item1 ? spotDepthRec.Item4 : 0m;
        var nearBid = nearDepthRec.Item1 ? nearDepthRec.Item4 : 0m;
        var nearAsk = 0m;  // Gerekirse ayrÄ± oku
        
        if (missingLeg == "NEAR") {
            // Spot var, Near yok
            // SeÃ§enek 1: Near aÃ§ (tamamla)
            // SeÃ§enek 2: Spot kapat
            
            var nQty = realSpot / 100;  // Near kontrat sayÄ±sÄ±
            var tem = teminat.ContainsKey(sym) ? teminat[sym] : 0;
            var nearCost = tem * nQty;
            
            // Spread kontrolÃ¼ - tamamlama mantÄ±klÄ± mÄ±?
            var currentSpread = spotAsk > 0 ? (nearBid - spotAsk) / spotAsk : 0;
            var spreadAttractive = currentSpread >= SN_MIN_MARGIN;
            
            Log("ğŸ“Š RECOVERY: " + sym + " Spread:" + (currentSpread * 100).ToString("F3") + "% Min:" + (SN_MIN_MARGIN * 100).ToString("F2") + "% Cazip:" + (spreadAttractive ? "EVET" : "HAYIR"));
            
            // BÃ¼tÃ§e yeterli VE spread cazip mi?
            if (nearCost <= viopBalance && nearBid > 0 && spreadAttractive) {
                // Near aÃ§ (tamamla)
                Log("ğŸ”§ RECOVERY: " + sym + " Near aÃ§Ä±lÄ±yor (tamamlama) x" + nQty);
                var result = ExecGuar(nearC, "SELL", nQty);
                if (result.Item1 > 0) {
                    var nearPrice = result.Item2;
                    var spread = spotAsk > 0 ? (nearPrice - spotAsk) / spotAsk : 0;
                    var expPnl = spread * spotAsk * realSpot;
                    // Komisyon dÃ¼ÅŸ (giriÅŸ + Ã§Ä±kÄ±ÅŸ)
                    var spotCommRec = CalcSpotCommission(spotAsk, realSpot);
                    var nearCommRec = CalcCommission(sym, nearPrice, result.Item1);
                    expPnl -= (spotCommRec + nearCommRec) * 2;
                    
                    snPos[sym] = new decimal[] { realSpot, result.Item1, spotAsk, nearPrice, spread, expPnl, 0, DateTime.Now.Ticks };
                    viopUsed += nearCost;
                    Log("âœ… RECOVERY: " + sym + " Near tamamlandÄ± @" + nearPrice.ToString("F2") + " Spread:" + (spread * 100).ToString("F3") + "%");
                } else {
                    // Near teyit alÄ±namadÄ± - emir gerÃ§ekleÅŸmiÅŸ olabilir, 30sn sonra tekrar kontrol edilecek
                    Log("âš ï¸ RECOVERY: " + sym + " Near teyit alÄ±namadÄ±, 30sn sonra tekrar kontrol edilecek");
                    recoveryRetryNeeded = true;
                    recoveryRetryTime = DateTime.Now.AddSeconds(30);
                    // Spot'u KAPATMA - emir gerÃ§ekleÅŸmiÅŸ olabilir!
                }
            } else {
                // BÃ¼tÃ§e yok VEYA spread cazip deÄŸil â†’ Spot kapat
                var reason = !spreadAttractive ? "spread cazip deÄŸil" : "bÃ¼tÃ§e yok";
                Log("âš ï¸ RECOVERY: " + sym + " " + reason + ", Spot kapatÄ±lÄ±yor");
                var spotResult = ExecGuar(sym, "SELL", realSpot);
                if (spotResult.Item1 > 0) {
                    Log("âœ… RECOVERY: " + sym + " Spot kapatÄ±ldÄ± @" + spotResult.Item2.ToString("F2"));
                    snPos.Remove(sym);
                    SavePositions();
                }
            }
        }
        else if (missingLeg == "SPOT") {
            // Near var, Spot yok
            // SeÃ§enek 1: Spot al (tamamla)
            // SeÃ§enek 2: Near kapat
            
            var sQty = realNear * 100;  // Spot adet
            var spotCost = spotAsk * sQty;
            
            // orphanLegs'te bu sembol var mÄ±? Varsa aÃ§Ä±lÄ±ÅŸ fiyatÄ±nÄ± kullan
            decimal nearEntryPrice = 0m;
            if (orphanLegs.ContainsKey(sym)) {
                var orph = orphanLegs[sym];
                if ((string)orph[0] == "NEAR" && (string)orph[2] == "SELL") {
                    nearEntryPrice = (decimal)orph[4];
                    Log("ğŸ“‹ RECOVERY: " + sym + " orphanLegs'ten Near aÃ§Ä±lÄ±ÅŸ fiyatÄ±: " + nearEntryPrice.ToString("F2"));
                }
            }
            
            // Spread kontrolÃ¼ - tamamlama mantÄ±klÄ± mÄ±?
            // EÄŸer orphanLegs'te aÃ§Ä±lÄ±ÅŸ fiyatÄ± varsa, ona gÃ¶re deÄŸerlendir
            decimal currentSpread;
            bool spreadAttractive;
            
            if (nearEntryPrice > 0) {
                // Near aÃ§Ä±lÄ±ÅŸ fiyatÄ±na gÃ¶re spread hesapla
                // Near SELL yapÄ±ldÄ± nearEntryPrice'tan, ÅŸimdi Spot alÄ±nacak spotAsk'tan
                // KÃ¢rlÄ±lÄ±k: (nearEntryPrice - spotAsk) / spotAsk
                currentSpread = spotAsk > 0 ? (nearEntryPrice - spotAsk) / spotAsk : 0;
                spreadAttractive = currentSpread >= SN_MIN_MARGIN;
                Log("ğŸ“Š RECOVERY: " + sym + " Spread (aÃ§Ä±lÄ±ÅŸ fiyatÄ±yla):" + (currentSpread * 100).ToString("F3") + 
                    "% (NearEntry:" + nearEntryPrice.ToString("F2") + " SpotAsk:" + spotAsk.ToString("F2") + ")");
            } else {
                // AÃ§Ä±lÄ±ÅŸ fiyatÄ± yok, o anki fiyatlarla deÄŸerlendir
                currentSpread = spotAsk > 0 ? (nearBid - spotAsk) / spotAsk : 0;
                spreadAttractive = currentSpread >= SN_MIN_MARGIN;
                Log("ğŸ“Š RECOVERY: " + sym + " Spread:" + (currentSpread * 100).ToString("F3") + "% Min:" + (SN_MIN_MARGIN * 100).ToString("F2") + "% Cazip:" + (spreadAttractive ? "EVET" : "HAYIR"));
            }
            
            // BÃ¼tÃ§e yeterli VE spread cazip mi?
            if (spotCost <= spotBalance && spotAsk > 0 && spreadAttractive) {
                // Spot al (tamamla)
                Log("ğŸ”§ RECOVERY: " + sym + " Spot alÄ±nÄ±yor (tamamlama) x" + sQty);
                var result = ExecGuar(sym, "BUY", sQty);
                if (result.Item1 > 0) {
                    var spotPrice = result.Item2;
                    // Spread hesabÄ±nda aÃ§Ä±lÄ±ÅŸ fiyatÄ± varsa onu kullan
                    var nearPriceForSpread = nearEntryPrice > 0 ? nearEntryPrice : nearBid;
                    var spread = spotPrice > 0 ? (nearPriceForSpread - spotPrice) / spotPrice : 0;
                    var expPnl = spread * spotPrice * result.Item1;
                    // Komisyon dÃ¼ÅŸ (giriÅŸ + Ã§Ä±kÄ±ÅŸ)
                    var spotCommRec2 = CalcSpotCommission(spotPrice, result.Item1);
                    var nearCommRec2 = CalcCommission(sym, nearPriceForSpread, realNear);
                    expPnl -= (spotCommRec2 + nearCommRec2) * 2;
                    
                    snPos[sym] = new decimal[] { result.Item1, realNear, spotPrice, nearPriceForSpread, spread, expPnl, 0, DateTime.Now.Ticks };
                    spotUsed += spotCost;
                    var spotCommAdj = CalcSpotCommission(spotPrice, result.Item1);
                    AdjustT2Balance(spotCost, spotCommAdj);  // AlÄ±ÅŸ
                    
                    // orphanLegs'ten sil
                    if (orphanLegs.ContainsKey(sym)) {
                        orphanLegs.Remove(sym);
                        Log("ğŸ—‘ï¸ RECOVERY: " + sym + " orphanLegs'ten silindi");
                    }
                    
                    Log("âœ… RECOVERY: " + sym + " Spot tamamlandÄ± @" + spotPrice.ToString("F2") + " Spread:" + (spread * 100).ToString("F3") + "%");
                    SavePositions();
                } else {
                    // Spot teyit alÄ±namadÄ± - emir gerÃ§ekleÅŸmiÅŸ olabilir, 30sn sonra tekrar kontrol edilecek
                    Log("âš ï¸ RECOVERY: " + sym + " Spot teyit alÄ±namadÄ±, 30sn sonra tekrar kontrol edilecek");
                    recoveryRetryNeeded = true;
                    recoveryRetryTime = DateTime.Now.AddSeconds(30);
                    // Near'Ä± KAPATMA - emir gerÃ§ekleÅŸmiÅŸ olabilir!
                }
            } else {
                // BÃ¼tÃ§e yok VEYA spread cazip deÄŸil â†’ Near kapat
                var reason = !spreadAttractive ? "spread cazip deÄŸil" : "bÃ¼tÃ§e yok";
                Log("âš ï¸ RECOVERY: " + sym + " " + reason + ", Near kapatÄ±lÄ±yor");
                var nearResult = ExecGuar(nearC, "BUY", realNear);
                if (nearResult.Item1 > 0) {
                    Log("âœ… RECOVERY: " + sym + " Near kapatÄ±ldÄ± @" + nearResult.Item2.ToString("F2"));
                    snPos.Remove(sym);
                    
                    // orphanLegs'ten sil
                    if (orphanLegs.ContainsKey(sym)) {
                        orphanLegs.Remove(sym);
                        Log("ğŸ—‘ï¸ RECOVERY: " + sym + " orphanLegs'ten silindi");
                    }
                    
                    SavePositions();
                }
            }
        }
        
    } catch (Exception ex) {
        Log("âŒ RECOVERY LEG HATA: " + sym + " - " + ex.Message);
    }
};

// Periyodik recovery kontrolÃ¼ (11:50, 17:35) ve T+2 negatif kontrolÃ¼ (16:50)
Action CheckScheduledRecovery = () => {
    if (IS_TEST) return;
    
    var now = DateTime.Now;
    var time = now.Hour * 100 + now.Minute;
    
    // 11:50 veya 17:35 - pozisyon senkronizasyonu
    if ((time == 1150 || time == 1735) && (now - lastRecoveryCheck).TotalMinutes > 5) {
        Log("â° ZamanlanmÄ±ÅŸ pozisyon senkronizasyonu");
        SyncAndRecoverPositions();
    }
    
    // 16:50 - T+2 negatif kontrolÃ¼
    if (time == 1650 && t2NegativeDetected && (now - lastRecoveryCheck).TotalMinutes > 5) {
        Log("â° 16:50 T+2 negatif kontrolÃ¼ baÅŸlatÄ±lÄ±yor...");

        // Ã–nce bakiyeleri tazele
        UpdateBalances();

        // Hala negatifse pozisyon kapat
        if (t2Balance < 0) {
            Log("ğŸš¨ T+2 hala negatif: " + t2Balance.ToString("N0") + " - pozisyon kapatma baÅŸlatÄ±lÄ±yor");

            // BIST aÃ§Ä±k mÄ± kontrol et (yarÄ±m gÃ¼n olabilir)
            var t2Now = DateTime.Now;
            var t2CurrentMinutes = t2Now.Hour * 60 + t2Now.Minute;
            var t2BistCloseMinutes = BIST_CLOSE_HOUR * 60 + BIST_CLOSE_MINUTE;
            var t2IsBistOpen = t2CurrentMinutes >= (MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE) && t2CurrentMinutes < t2BistCloseMinutes;

            if (!t2IsBistOpen) {
                Log("ğŸš¨ T+2 UYARI: BIST KAPALI! Pozisyon kapatÄ±lamÄ±yor. T+2 negatif: " + t2Balance.ToString("N0") + " TL - YarÄ±n manuel mÃ¼dahale gerekebilir!");
                lastRecoveryCheck = DateTime.Now;
                return;
            }

            var needToFree = Math.Abs(t2Balance);
            var freedSpot = 0m;
            var closedCount = 0;

            // En dÃ¼ÅŸÃ¼k expectedPnl olan pozisyonlarÄ± bul ve kapat
            while (freedSpot < needToFree && snPos.Count > 0 && closedCount < 5) {
                string worstSym = null;
                var worstPnl = decimal.MaxValue;

                foreach (var kv in snPos) {
                    var expPnl = kv.Value[5];
                    if (expPnl < worstPnl) {
                        worstPnl = expPnl;
                        worstSym = kv.Key;
                    }
                }

                if (worstSym == null) break;

                var worstPos = snPos[worstSym];
                var posSpotValue = worstPos[2] * worstPos[0];  // spotEntry * spotQty

                Log("ğŸ“Š T+2 KAPATMA: " + worstSym + " ExpPnl:" + worstPnl.ToString("N0") + " SpotDeÄŸer:" + posSpotValue.ToString("N0"));

                // SÄ±fÄ±r kontrolÃ¼
                if (posSpotValue <= 0) {
                    Log("âš ï¸ T+2: posSpotValue sÄ±fÄ±r, atlanÄ±yor: " + worstSym);
                    break;
                }

                // Ne kadar kapatmalÄ±?
                var neededRatio = (needToFree - freedSpot) / posSpotValue;
                neededRatio = Math.Min(1m, neededRatio);  // En fazla %100

                if (neededRatio >= 0.9m || worstPos[1] <= 2) {
                    // Tam kapat
                    var nearC = GetContract(worstSym, 0);
                    CloseSN(worstSym, nearC, (int)worstPos[0], (int)worstPos[1], "T2_NEGATIVE");
                    freedSpot += posSpotValue;
                } else {
                    // KÄ±smi kapat - spot/near oranÄ±nÄ± koru
                    var closeNQty = (int)Math.Ceiling((double)worstPos[1] * (double)neededRatio);
                    closeNQty = Math.Max(1, closeNQty);
                    var closeSQty = (int)(closeNQty * GetMultiplier(worstSym));
                    closeSQty = Math.Max(100, closeSQty);
                    closeSQty = ((closeSQty + 99) / 100) * 100;  // 100'e yuvarla

                    var nearC = GetContract(worstSym, 0);
                    PartialCloseSN(worstSym, nearC, closeSQty, closeNQty, "T2_NEGATIVE_PARTIAL");
                    freedSpot += posSpotValue * neededRatio;
                }

                closedCount++;

                if (freedSpot >= needToFree) break;
            }

            // Yeterli kapatÄ±lamadÄ±ysa uyar
            if (freedSpot < needToFree) {
                Log("ğŸš¨ T+2 UYARI: Yeterli pozisyon kapatÄ±lamadÄ±! Gereken: " + needToFree.ToString("N0") + " Serbest: " + freedSpot.ToString("N0") + " TL");
            }

            // Ä°ÅŸlemler sonrasÄ± T+2 bakiyesini tekrar kontrol et
            System.Threading.Thread.Sleep(2000);  // Emirlerin iÅŸlenmesi iÃ§in bekle
            UpdateBalances();

            if (t2Balance < 0) {
                Log("ğŸš¨ T+2 UYARI: Ä°ÅŸlemler sonrasÄ± hala negatif: " + t2Balance.ToString("N0") + " TL - YarÄ±n manuel mÃ¼dahale gerekebilir!");
                // t2NegativeDetected = true olarak kalÄ±r, ertesi gÃ¼n tekrar denenir
            } else {
                Log("âœ… T+2 dÃ¼zeltme baÅŸarÄ±lÄ±: " + closedCount + " pozisyon kapatÄ±ldÄ±, yeni bakiye: " + t2Balance.ToString("N0") + " TL");
                t2NegativeDetected = false;
            }
        } else {
            Log("âœ… T+2 pozitife dÃ¶ndÃ¼, kapatma gerekmiyor: " + t2Balance.ToString("N0"));
            t2NegativeDetected = false;
        }

        lastRecoveryCheck = DateTime.Now;
    }
};

// Dashboard gÃ¼ncelleme - tek fonksiyon
// fullStats=true: lokal stats.json'u yÃ¼kle (tam veriler zaten orada)
// resetCommand=true: Gist komutu NONE'a sÄ±fÄ±rla
// includeLogs=true: Log ve settings dosyalarÄ±nÄ± da yÃ¼kle
// NOT: Pozisyon detaylarÄ± her zaman gÃ¶nderilir (fullStats daima true)
// Gist upload iÅŸleminin kendisi (sync - thread iÃ§inde Ã§alÄ±ÅŸÄ±r)
Action<bool, bool, string, string, string> DoGistUpload = (resetCommand, includeLogs, statsJson, settingsContent, logContent) => {
    try {
        var escaped = statsJson.Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\n", "\\n").Replace("\r", "");
        
        var body = "{\"files\":{\"arb_stats.json\":{\"content\":\"" + escaped + "\"}";
        
        if (includeLogs) {
            var settingsEscaped = settingsContent.Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\n", "\\n").Replace("\r", "");
            var logEscaped = logContent.Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\n", "\\n").Replace("\r", "");
            body += ",\"arb_settings.json\":{\"content\":\"" + settingsEscaped + "\"}";
            body += ",\"arb_logs.txt\":{\"content\":\"" + logEscaped + "\"}";
        }
        
        if (resetCommand) {
            body += ",\"arb_command.json\":{\"content\":\"{\\\"command\\\":\\\"NONE\\\",\\\"ts\\\":\\\"" + DateTime.Now.ToString("HH:mm:ss") + "\\\"}\"}";
        }
        body += "}}";
        
        var req = (System.Net.HttpWebRequest)System.Net.WebRequest.Create("https://api.github.com/gists/" + GIST_ID);
        req.Method = "PATCH";
        req.ContentType = "application/json";
        var authPrefix = GIST_TOKEN.StartsWith("github_pat_") ? "Bearer " : "token ";
        req.Headers.Add("Authorization", authPrefix + GIST_TOKEN);
        req.UserAgent = "ArbBot";
        req.Timeout = 10000;
        req.ReadWriteTimeout = 10000;
        var bytes = System.Text.Encoding.UTF8.GetBytes(body);
        req.ContentLength = bytes.Length;
        using (var s = req.GetRequestStream()) s.Write(bytes, 0, bytes.Length);
        
        using (var resp = req.GetResponse())
        using (var sr = new System.IO.StreamReader(resp.GetResponseStream())) {
            var respJson = sr.ReadToEnd();
            
            // arb_command.json iÃ§eriÄŸini parse et
            var cmdContent = "";
            try {
                var cmdIdx = respJson.IndexOf("arb_command.json");
                if (cmdIdx > 0) {
                    var contentIdx = respJson.IndexOf("\"content\":", cmdIdx);
                    if (contentIdx > 0) {
                        var startQuote = respJson.IndexOf("\"", contentIdx + 10) + 1;
                        var endQuote = startQuote;
                        while (endQuote < respJson.Length) {
                            endQuote = respJson.IndexOf("\"", endQuote);
                            if (endQuote <= 0) break;
                            if (endQuote > 0 && respJson[endQuote - 1] != '\\') break;
                            endQuote++;
                        }
                        if (startQuote > 0 && endQuote > startQuote) {
                            cmdContent = respJson.Substring(startQuote, endQuote - startQuote)
                                .Replace("\\\"", "\"").Replace("\\n", "").Replace("\\r", "");
                        }
                    }
                }
                
                // STOP kontrolÃ¼
                if (cmdContent.Contains("\"command\":\"STOP\"") || cmdContent.Contains("\"command\": \"STOP\"")) {
                    Log("ğŸ›‘ Gist'ten STOP komutu alÄ±ndÄ±!");
                    stopRequested = true;
                    try { System.IO.File.WriteAllText(BASE_PATH + "STOP.txt", "GIST_STOP:" + DateTime.Now.ToString()); } catch { }
                    try { mainForm.BeginInvoke(new Action(() => mainForm.Close())); } catch { }
                }
                // PAUSE kontrolÃ¼
                else if (cmdContent.Contains("\"command\":\"PAUSE\"") || cmdContent.Contains("\"command\": \"PAUSE\"")) {
                    if (!isPaused) {
                        Log("â¸ï¸ Gist'ten PAUSE komutu alÄ±ndÄ±!");
                        isPaused = true;
                        try {
                            mainForm.BeginInvoke(new Action(() => {
                                btnPause.Text = "BaÅŸlat";
                                btnPause.BackColor = System.Drawing.Color.FromArgb(40, 167, 69);
                                lblStatus.Text = "â¸ï¸ UZAKTAN DURAKLADI";
                                lblStatus.ForeColor = System.Drawing.Color.Orange;
                            }));
                        } catch { }
                    }
                }
                // RESUME kontrolÃ¼
                else if (cmdContent.Contains("\"command\":\"RESUME\"") || cmdContent.Contains("\"command\": \"RESUME\"")) {
                    if (isPaused) {
                        Log("â–¶ï¸ Gist'ten RESUME komutu alÄ±ndÄ±!");
                        isPaused = false;
                        if (settingsNeedReload) { LoadSettings(); settingsNeedReload = false; }
                        try {
                            mainForm.BeginInvoke(new Action(() => {
                                btnPause.Text = "Duraklat";
                                btnPause.BackColor = System.Drawing.Color.FromArgb(255, 193, 7);
                                lblStatus.Text = "â–¶ï¸ Ã‡ALIÅIYOR";
                                lblStatus.ForeColor = System.Drawing.Color.Green;
                            }));
                        } catch { }
                        lastGistUpload = DateTime.MinValue;
                    }
                }
            } catch (Exception cmdEx) {
                Log("ğŸ“¤ Gist cmd okuma hata: " + cmdEx.Message);
            }
        }
        lastGistUpload = DateTime.Now;
    } catch (Exception gistEx) {
        Log("âŒ Gist upload hata: " + gistEx.Message);
    } finally {
        gistUploadInProgress = false;
    }
};

// ASYNC Wrapper - MainLoop'u bloklamaz
Action<bool, bool> UpdateDashboard = (resetCommand, includeLogs) => {
    if (string.IsNullOrEmpty(GIST_TOKEN) || string.IsNullOrEmpty(GIST_ID)) return;
    
    // Zaten upload devam ediyorsa atla (queue yapma)
    if (gistUploadInProgress) return;
    
    try {
        // Verileri MAIN THREAD'de hazÄ±rla (thread-safe)
        var statsJson = BuildStatsJson();
        
        var settingsContent = "{}";
        var logContent = "Log yok";
        
        if (includeLogs) {
            try {
                if (System.IO.File.Exists(SETTINGS_FILE)) {
                    settingsContent = System.IO.File.ReadAllText(SETTINGS_FILE);
                }
            } catch { }
            
            try {
                var logFilePath = LOG_PATH + "arb.log";
                if (System.IO.File.Exists(logFilePath)) {
                    using (var fs = new System.IO.FileStream(logFilePath, System.IO.FileMode.Open, System.IO.FileAccess.Read, System.IO.FileShare.ReadWrite))
                    using (var sr = new System.IO.StreamReader(fs, System.Text.Encoding.UTF8)) {
                        var allText = sr.ReadToEnd();
                        var allLines = allText.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                        var startIdx = Math.Max(0, allLines.Length - 50);
                        var count = Math.Min(50, allLines.Length);
                        var lastLines = new string[count];
                        Array.Copy(allLines, startIdx, lastLines, 0, count);
                        logContent = string.Join("\n", lastLines);
                    }
                }
            } catch { }
        }
        
        // Upload'Ä± ayrÄ± thread'de yap
        gistUploadInProgress = true;
        var rc = resetCommand;
        var il = includeLogs;
        var sj = statsJson;
        var sc = settingsContent;
        var lc = logContent;
        
        gistUploadThread = new System.Threading.Thread(() => {
            DoGistUpload(rc, il, sj, sc, lc);
        });
        gistUploadThread.IsBackground = true;  // Ana thread bitince bu da bitsin
        gistUploadThread.Start();
        
    } catch (Exception ex) {
        Log("âŒ Gist async hata: " + ex.Message);
        gistUploadInProgress = false;
    }
};

// Gist komutunu kontrol et (duraklama dÃ¶ngÃ¼sÃ¼nde kullanÄ±lÄ±r)
Action CheckGistCommand = () => {
    if (string.IsNullOrEmpty(GIST_TOKEN) || string.IsNullOrEmpty(GIST_ID)) return;
    try {
        var req = (System.Net.HttpWebRequest)System.Net.WebRequest.Create("https://api.github.com/gists/" + GIST_ID);
        req.Method = "GET";
        var authPrefix = GIST_TOKEN.StartsWith("github_pat_") ? "Bearer " : "token ";
        req.Headers.Add("Authorization", authPrefix + GIST_TOKEN);
        req.UserAgent = "ArbBot";
        req.Timeout = 10000;
        
        using (var resp = req.GetResponse())
        using (var sr = new System.IO.StreamReader(resp.GetResponseStream())) {
            var respJson = sr.ReadToEnd();
            
            // arb_command.json iÃ§eriÄŸini parse et
            var cmdContent = "";
            var cmdIdx = respJson.IndexOf("arb_command.json");
            if (cmdIdx > 0) {
                var contentIdx = respJson.IndexOf("\"content\":", cmdIdx);
                if (contentIdx > 0) {
                    var startQuote = respJson.IndexOf("\"", contentIdx + 10) + 1;
                    var endQuote = startQuote;
                    while (endQuote < respJson.Length) {
                        endQuote = respJson.IndexOf("\"", endQuote);
                        if (endQuote <= 0) break;
                        if (endQuote > 0 && respJson[endQuote - 1] != '\\') break;
                        endQuote++;
                    }
                    if (startQuote > 0 && endQuote > startQuote) {
                        cmdContent = respJson.Substring(startQuote, endQuote - startQuote)
                            .Replace("\\\"", "\"").Replace("\\n", "").Replace("\\r", "");
                    }
                }
            }
            
            // STOP kontrolÃ¼
            if (cmdContent.Contains("\"command\":\"STOP\"")) {
                Log("ğŸ›‘ Gist'ten STOP komutu alÄ±ndÄ±!");
                stopRequested = true;
                try { System.IO.File.WriteAllText(BASE_PATH + "STOP.txt", "GIST_STOP:" + DateTime.Now.ToString()); } catch { }
                try { mainForm.BeginInvoke(new Action(() => mainForm.Close())); } catch { }
            }
            // RESUME kontrolÃ¼
            else if (cmdContent.Contains("\"command\":\"RESUME\"")) {
                Log("â–¶ï¸ Gist'ten RESUME komutu alÄ±ndÄ±!");
                isPaused = false;
                if (settingsNeedReload) { LoadSettings(); settingsNeedReload = false; }
                try {
                    mainForm.BeginInvoke(new Action(() => {
                        btnPause.Text = "Duraklat";
                        btnPause.BackColor = System.Drawing.Color.FromArgb(255, 193, 7);
                        lblStatus.Text = "â–¶ï¸ Ã‡ALIÅIYOR";
                        lblStatus.ForeColor = System.Drawing.Color.Green;
                    }));
                } catch { }
                // RESUME sonrasÄ± hemen tam stats gÃ¶nder
                lastGistUpload = DateTime.MinValue;
            }
        }
    } catch { }
};

// Gist komutunu NONE olarak sÄ±fÄ±rla (formdan devam edildiÄŸinde)
Action ResetGistToNone = () => {
    if (string.IsNullOrEmpty(GIST_TOKEN) || string.IsNullOrEmpty(GIST_ID)) return;
    try {
        var authPrefix = GIST_TOKEN.StartsWith("github_pat_") ? "Bearer " : "token ";
        var body = "{\"files\":{\"arb_command.json\":{\"content\":\"{\\\"command\\\":\\\"NONE\\\",\\\"ts\\\":\\\"" + DateTime.Now.ToString("HH:mm:ss") + "\\\"}\"}}}";
        var req = (System.Net.HttpWebRequest)System.Net.WebRequest.Create("https://api.github.com/gists/" + GIST_ID);
        req.Method = "PATCH";
        req.ContentType = "application/json";
        req.Headers.Add("Authorization", authPrefix + GIST_TOKEN);
        req.UserAgent = "ArbBot";
        req.Timeout = 10000;
        var bytes = System.Text.Encoding.UTF8.GetBytes(body);
        req.ContentLength = bytes.Length;
        using (var s = req.GetRequestStream()) s.Write(bytes, 0, bytes.Length);
        using (var resp = req.GetResponse()) { }
        Log("âœ… Gist komut sÄ±fÄ±rlandÄ± (NONE)");
    } catch (Exception ex) {
        Log("âš ï¸ Gist komut sÄ±fÄ±rlama hata: " + ex.Message);
    }
};

// ====================================
// ANA DÃ–NGÃœ
// ====================================
Action MainLoop = () => {
    // CanlÄ± modda API verisi yoksa hiÃ§ iÅŸlem yapma
    if (!IS_TEST && !apiDataOk) {
        return;  // Sessizce Ã§Ä±k, log zaten UpdateBalances'da yazÄ±ldÄ±
    }
    
    var now = DateTime.Now.Ticks;
    var ic = System.Globalization.CultureInfo.InvariantCulture;
    decimal totalSnPnl = 0;
    var snStats = new System.Text.StringBuilder();
    var firstSn = true;
    
    // BIST aÃ§Ä±k mÄ±? (SN aÃ§Ä±lÄ±ÅŸ/kapanÄ±ÅŸ iÃ§in gerekli)
    var nowTime = DateTime.Now;
    var bistCloseMinutes = BIST_CLOSE_HOUR * 60 + BIST_CLOSE_MINUTE;
    var currentMinutesNow = nowTime.Hour * 60 + nowTime.Minute;
    var isBistOpen = currentMinutesNow >= (MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE) && currentMinutesNow < bistCloseMinutes;
    
    // ============ ORPHAN LEGS Ä°ÅLEME (10:05 sonrasÄ±) ============
    // AÃ§Ä±lÄ±ÅŸ volatilitesi bekleten orphan'larÄ± iÅŸle
    // Ä°ki tip orphan var:
    // 1. Near SELL var, Spot yok â†’ Spot BUY veya Near geri al
    // 2. Spot var, Near yok â†’ Near SELL veya Spot kapat
    var orphanRecoveryStart = MARKET_OPEN_HOUR * 60 + MARKET_OPEN_MINUTE + 5;  // 10:05
    if (isBistOpen && currentMinutesNow >= orphanRecoveryStart && orphanLegs.Count > 0) {
        var orphansToProcess = new System.Collections.Generic.List<string>();
        foreach (var kv in orphanLegs) {
            orphansToProcess.Add(kv.Key);
        }
        
        foreach (var oSym in orphansToProcess) {
            try {
                var oData = orphanLegs[oSym];
                var filledLeg = (string)oData[0];
                var filledSide = (string)oData[2];
                var mult = GetMultiplier(oSym);
                
                // GÃ¼ncel fiyatlarÄ± al
                var spotS = SPOT_PREFIX + oSym;
                var nearC = GetContract(oSym, 0);
                var nearS = FUTURES_PREFIX + nearC;
                
                var spotAskD = ReadDepth(spotS, "ASK", 0, 1, 50);
                var spotBidD = ReadDepth(spotS, "BID", 0, 1, 50);
                var nearAskD = ReadDepth(nearS, "ASK", 0, 1, 50);
                var nearBidD = ReadDepth(nearS, "BID", 0, 1, 50);
                
                var spotAskNow = spotAskD.Item1 ? spotAskD.Item4 : 0m;
                var spotBidNow = spotBidD.Item1 ? spotBidD.Item4 : 0m;
                var nearAskNow = nearAskD.Item1 ? nearAskD.Item4 : 0m;
                var nearBidNow = nearBidD.Item1 ? nearBidD.Item4 : 0m;
                
                if (spotAskNow <= 0 || nearAskNow <= 0 || spotBidNow <= 0 || nearBidNow <= 0) {
                    Log("âš ï¸ ORPHAN RECOVERY: " + oSym + " fiyat alÄ±namadÄ±, tekrar denenecek");
                    continue;
                }
                
                // ========== TÄ°P 1: Near SELL var, Spot yok ==========
                if (filledLeg == "NEAR" && filledSide == "SELL") {
                    var nearQty = (int)oData[3];
                    var nearEntryPrice = (decimal)oData[4];  // Near SELL fiyatÄ± (0 ise bilinmiyor)
                    var spotQty = (int)oData[8];
                    
                    // EÄŸer Near giriÅŸ fiyatÄ± bilinmiyorsa (eski recovery), ÅŸimdiki fiyatÄ± kullan
                    if (nearEntryPrice == 0) nearEntryPrice = nearBidNow;
                    
                    // SEÃ‡Ä°M 1: Spot BUY - Pozisyonu tamamla
                    var spotComm = CalcSpotCommission(spotAskNow, spotQty);
                    var expectedSpread = (nearEntryPrice - spotAskNow) / spotAskNow;
                    var expectedPnlIfComplete = expectedSpread * spotAskNow * spotQty;
                    expectedPnlIfComplete -= spotComm * 2;  // AlÄ±ÅŸ + ileride satÄ±ÅŸ komisyonu
                    
                    // SEÃ‡Ä°M 2: Near BUY - Pozisyonu geri al (iptal)
                    var nearComm = CalcCommission(oSym, nearAskNow, nearQty);
                    var nearPnlIfClose = (nearEntryPrice - nearAskNow) * nearQty * mult;
                    nearPnlIfClose -= nearComm * 2;
                    
                    Log("ğŸ“Š ORPHAN KARAR: " + oSym + " (Near var, Spot yok)" +
                        " | Spot BUY @" + spotAskNow.ToString("F2") + " â†’ Beklenen:" + expectedPnlIfComplete.ToString("F0") + " TL" +
                        " | Near GERÄ° AL @" + nearAskNow.ToString("F2") + " â†’ KÃ¢r/Zarar:" + nearPnlIfClose.ToString("F0") + " TL");
                    
                    if (expectedPnlIfComplete >= nearPnlIfClose) {
                        // SPOT BUY daha karlÄ± - Pozisyonu tamamla
                        Log("ğŸ”„ ORPHAN: " + oSym + " Spot BUY seÃ§ildi (daha karlÄ±)");
                        
                        var sr = ExecGuar(oSym, "BUY", spotQty);
                        if (sr.Item1 > 0) {
                            var spotFilledQty = sr.Item1;
                            var spotAvgP = sr.Item2;
                            
                            if (spotAvgP > 0) {
                                var openSpread = (nearEntryPrice - spotAvgP) / spotAvgP;
                                var expPnl = openSpread * spotAvgP * spotFilledQty;
                                var sComm = CalcSpotCommission(spotAvgP, spotFilledQty);
                                var nComm = CalcCommission(oSym, nearEntryPrice, nearQty);
                                expPnl -= (sComm + nComm) * 2;
                                
                                snPos[oSym] = new decimal[] { spotFilledQty, nearQty, spotAvgP, nearEntryPrice, openSpread, expPnl, 0, DateTime.Now.Ticks };
                                dailySpotCommission += sComm;
                                dailyViopCommission += nComm;
                                spotUsed += spotAvgP * spotFilledQty;
                                var viopTeminat = teminat.ContainsKey(oSym) ? teminat[oSym] * nearQty : 0;
                                viopUsed += viopTeminat;
                                
                                orphanLegs.Remove(oSym);
                                Log("âœ… ORPHAN TAMAMLANDI: " + oSym + " Spot:" + spotFilledQty + " @" + spotAvgP.ToString("F2") + 
                                    " Spread:" + (openSpread * 100).ToString("F3") + "% Beklenen:" + expPnl.ToString("F0"));
                                SavePositions();
                                if (SaveDailyStats != null) SaveDailyStats();
                            }
                        } else {
                            Log("âš ï¸ ORPHAN: " + oSym + " Spot BUY baÅŸarÄ±sÄ±z, tekrar denenecek");
                        }
                    } else {
                        // NEAR BUY daha karlÄ± - Pozisyonu geri al
                        Log("ğŸ”„ ORPHAN: " + oSym + " Near GERÄ° ALIM seÃ§ildi (daha karlÄ±/az zararlÄ±)");
                        
                        var nearOrderId = IS_TEST ? "TEST_ORPHAN_CLOSE_" + DateTime.Now.Ticks :
                            Sistem.EmirGonder(nearS, "BUY", nearQty, 0, "VIOP", "Piyasa");
                        
                        if (!string.IsNullOrEmpty(nearOrderId)) {
                            var closePnl = (nearEntryPrice - nearAskNow) * nearQty * mult;
                            var closeComm = CalcCommission(oSym, nearAskNow, nearQty) + CalcCommission(oSym, nearEntryPrice, nearQty);
                            closePnl -= closeComm;
                            dailyRealizedPnl += closePnl;
                            dailyViopCommission += closeComm;
                            
                            orphanLegs.Remove(oSym);
                            Log("âœ… ORPHAN GERÄ° ALINDI: " + oSym + " Near BUY x" + nearQty + " @" + nearAskNow.ToString("F2") + 
                                " P&L:" + closePnl.ToString("F0") + " TL");
                            SavePositions();
                            if (SaveDailyStats != null) SaveDailyStats();
                        } else {
                            Log("âš ï¸ ORPHAN: " + oSym + " Near BUY emri baÅŸarÄ±sÄ±z, tekrar denenecek");
                        }
                    }
                }
                // ========== TÄ°P 2: Spot var, Near yok ==========
                else if (filledLeg == "SPOT" && filledSide == "HOLD") {
                    var spotQty = (int)oData[3];
                    var spotEntryPrice = (decimal)oData[4];  // Spot giriÅŸ fiyatÄ±
                    var nearQty = spotQty / 100;
                    
                    // SEÃ‡Ä°M 1: Near SELL - Pozisyonu tamamla
                    var nearComm = CalcCommission(oSym, nearBidNow, nearQty);
                    var expectedSpread = (nearBidNow - spotAskNow) / spotAskNow;
                    var expectedPnlIfComplete = expectedSpread * spotAskNow * spotQty;
                    expectedPnlIfComplete -= nearComm * 2;  // Near aÃ§Ä±lÄ±ÅŸ + kapanÄ±ÅŸ
                    
                    // SEÃ‡Ä°M 2: Spot SELL - Pozisyonu kapat
                    var spotComm = CalcSpotCommission(spotBidNow, spotQty);
                    var spotPnlIfClose = 0m;
                    if (spotEntryPrice > 0) {
                        spotPnlIfClose = (spotBidNow - spotEntryPrice) * spotQty;  // GerÃ§ek P&L
                    }
                    spotPnlIfClose -= spotComm;  // SatÄ±ÅŸ komisyonu
                    
                    Log("ğŸ“Š ORPHAN KARAR: " + oSym + " (Spot var, Near yok)" +
                        " | Near SELL @" + nearBidNow.ToString("F2") + " â†’ Beklenen:" + expectedPnlIfComplete.ToString("F0") + " TL" +
                        " | Spot KAPAT @" + spotBidNow.ToString("F2") + " â†’ Komisyon:" + spotPnlIfClose.ToString("F0") + " TL");
                    
                    // Spread cazip mi? (min marj + komisyon)
                    var minRequired = SN_MIN_MARGIN;
                    
                    if (expectedSpread >= minRequired && expectedPnlIfComplete > spotPnlIfClose) {
                        // NEAR SELL daha karlÄ± - Pozisyonu tamamla
                        Log("ğŸ”„ ORPHAN: " + oSym + " Near SELL seÃ§ildi (spread cazip)");
                        
                        var nr = ExecGuar(nearC, "SELL", nearQty);
                        if (nr.Item1 > 0) {
                            var nearFilledQty = nr.Item1;
                            var nearAvgP = nr.Item2;
                            
                            var openSpread = (nearAvgP - spotAskNow) / spotAskNow;
                            var expPnl = openSpread * spotAskNow * spotQty;
                            var sComm = CalcSpotCommission(spotAskNow, spotQty);
                            var nComm = CalcCommission(oSym, nearAvgP, nearFilledQty);
                            expPnl -= (sComm + nComm) * 2;
                            
                            snPos[oSym] = new decimal[] { spotQty, nearFilledQty, spotAskNow, nearAvgP, openSpread, expPnl, 0, DateTime.Now.Ticks };
                            dailyViopCommission += nComm;
                            var viopTeminat = teminat.ContainsKey(oSym) ? teminat[oSym] * nearFilledQty : 0;
                            viopUsed += viopTeminat;
                            
                            orphanLegs.Remove(oSym);
                            Log("âœ… ORPHAN TAMAMLANDI: " + oSym + " Near:" + nearFilledQty + " @" + nearAvgP.ToString("F2") + 
                                " Spread:" + (openSpread * 100).ToString("F3") + "% Beklenen:" + expPnl.ToString("F0"));
                            SavePositions();
                            if (SaveDailyStats != null) SaveDailyStats();
                        } else {
                            Log("âš ï¸ ORPHAN: " + oSym + " Near SELL baÅŸarÄ±sÄ±z, tekrar denenecek");
                        }
                    } else {
                        // SPOT SELL - Pozisyonu kapat
                        Log("ğŸ”„ ORPHAN: " + oSym + " Spot KAPAT seÃ§ildi (spread cazip deÄŸil)");
                        
                        var sr = ExecGuar(oSym, "SELL", spotQty);
                        if (sr.Item1 > 0) {
                            dailySpotCommission += CalcSpotCommission(sr.Item2, sr.Item1);
                            
                            orphanLegs.Remove(oSym);
                            Log("âœ… ORPHAN KAPATILDI: " + oSym + " Spot SELL x" + sr.Item1 + " @" + sr.Item2.ToString("F2"));
                            SavePositions();
                            if (SaveDailyStats != null) SaveDailyStats();
                        } else {
                            Log("âš ï¸ ORPHAN: " + oSym + " Spot SELL baÅŸarÄ±sÄ±z, tekrar denenecek");
                        }
                    }
                }
            } catch (Exception ex) {
                Log("âŒ ORPHAN RECOVERY: " + oSym + " hata: " + ex.Message);
            }
        }
    }
    
    foreach (var sym in symbols) {
        try {
            if (IsBlocked(sym)) continue;
            
            var spotS = SPOT_PREFIX + sym;
            var nearC = GetContract(sym, 0);
            var farC = GetContract(sym, 1);
            var nearS = FUTURES_PREFIX + nearC;
            
            // Derinlikten fiyat al (yÃ¼zeysel veri 26ms gecikmeli olabilir)
            var spotAskDepth = ReadDepth(spotS, "ASK", 0, 1, 50);  // Spot Ask
            var spotBidDepth = ReadDepth(spotS, "BID", 0, 1, 50);  // Spot Bid
            var nearBidDepth = ReadDepth(nearS, "BID", 0, 1, 50);  // Near Bid
            var nearAskDepth = ReadDepth(nearS, "ASK", 0, 1, 50);  // Near Ask
            
            var spotAsk = spotAskDepth.Item1 ? spotAskDepth.Item4 : 0m;
            var spotBid = spotBidDepth.Item1 ? spotBidDepth.Item4 : 0m;
            var nearBid = nearBidDepth.Item1 ? nearBidDepth.Item4 : 0m;
            var nearAsk = nearAskDepth.Item1 ? nearAskDepth.Item4 : 0m;
            
            if (spotAsk == 0 && nearAsk == 0) continue;
            
            // Spread hesabÄ±: derinlikten (yÃ¼zeysel veri 26ms gecikmeli)
            // dayanakAlSat = nearBid - spotAsk (aÃ§Ä±lÄ±ÅŸ spread'i)
            // dayanakSatAl = nearAsk - spotBid (kapanÄ±ÅŸ spread'i)
            var dayanakAlSat = nearBid - spotAsk;
            var dayanakSatAl = nearAsk - spotBid;
            
            var daysN = GetDays(nearC);
            var daysF = GetDays(farC);
            var tem = teminat.ContainsKey(sym) ? teminat[sym] : 0;
            var xlbnkT = teminat.ContainsKey("XLBNK") ? teminat["XLBNK"] : 20000m;
            var qty = tem > 0 ? (int)Math.Max(1, xlbnkT / tem) : 1;
            
            var snSp = spotAsk > 0 ? (dayanakAlSat / spotAsk) * 100 : 0;
            
            // BB pozisyonu (5dk'da bir grafikten gÃ¼ncelleniyor)
            var sBBPos = snBBPos.ContainsKey(sym) ? snBBPos[sym] : 50m;
            
            // P&L hesapla (piyasa kapalÄ±yken de hesaplanÄ±r - sadece gÃ¶rÃ¼ntÃ¼leme)
            if (snPos.ContainsKey(sym)) {
                var snP = snPos[sym];
                var snPnl = (spotBid - snP[2]) * snP[0] + (snP[3] - nearAsk) * snP[1] * GetMultiplier(sym);
                totalSnPnl += snPnl;
                if (!firstSn) snStats.Append(",");
                firstSn = false;
                snStats.Append("\"" + sym + "\":{\"sq\":" + ((int)snP[0]).ToString() + 
                    ",\"nq\":" + ((int)snP[1]).ToString() +
                    ",\"pnl\":" + snPnl.ToString("F0", ic) + 
                    ",\"exp\":" + snP[5].ToString("F0", ic) +
                    ",\"d\":" + ((int)snP[6]).ToString() + "}");
            }
            
            // === PÄ°YASA KAPALI Ä°SE SADECE SPREAD KAYDI YAP ===
            if (!isMarketOpen) continue;
            
            // === BROKER BAÄLANTISI YOKSA EMÄ°R GÃ–NDERME (Test modu hariÃ§) ===
            if (!brokerConnected && !IS_TEST) continue;
            
            // === DEVRE KESÄ°CÄ° KONTROLÃœ ===
            var spotCircuit = IsSpotCircuitBreaker(sym);
            var hasPosition = snPos.ContainsKey(sym);
            
            // ENDEKS DEVRE KESÄ°CÄ°: TÃ¼m iÅŸlemler engellenir (vade gÃ¼nÃ¼ hariÃ§ - o zaman kapat)
            if (indexCircuitBreaker && hasPosition) {
                if (daysN == 0) {
                    // Vade gÃ¼nÃ¼ - pozisyonu hemen kapat
                    Log("ğŸ”´ ENDEKS DEVRE KESÄ°CÄ° + VADE GÃœNÃœ: " + sym + " kapatÄ±lÄ±yor");
                    CloseSN(sym, nearC, (int)snPos[sym][0], (int)snPos[sym][1], "Endeks devre kesici + Vade gÃ¼nÃ¼");
                }
                // Vade gÃ¼nÃ¼ deÄŸilse: rollover, kapanÄ±ÅŸ ve tÃ¼m iÅŸlemler engelli - sadece bekle
                continue;
            }
            
            // SPOT DEVRE KESÄ°CÄ°: O hisse iÃ§in tÃ¼m iÅŸlemler engellenir (vade gÃ¼nÃ¼ hariÃ§ - o zaman kapat)
            if (spotCircuit && hasPosition) {
                if (daysN == 0) {
                    // Vade gÃ¼nÃ¼ - pozisyonu hemen kapat
                    Log("ğŸ”´ SPOT DEVRE KESÄ°CÄ° + VADE GÃœNÃœ: " + sym + " kapatÄ±lÄ±yor");
                    CloseSN(sym, nearC, (int)snPos[sym][0], (int)snPos[sym][1], "Spot devre kesici + Vade gÃ¼nÃ¼");
                }
                // Vade gÃ¼nÃ¼ deÄŸilse: rollover, kapanÄ±ÅŸ ve tÃ¼m iÅŸlemler engelli - sadece bekle
                continue;
            }
            
            // Devre kesici yoksa normal iÅŸlem akÄ±ÅŸÄ±na devam et
            
            // KapanÄ±ÅŸ kontrolÃ¼ (sadece BIST aÃ§Ä±kken - Spot satÄ±lmalÄ±)
            if (isBistOpen) {
                var snCloseReason = CheckSNClose(sym, nearC, spotBid, nearAsk, daysN, sBBPos);
                if (snCloseReason != null) {
                    CloseSN(sym, nearC, (int)snPos[sym][0], (int)snPos[sym][1], snCloseReason);
                    continue;  // Pozisyon kapandÄ±, bu sembol iÃ§in devam etme
                }
            }
            
            // Rollover kontrolÃ¼ (vadeye 1 gÃ¼n veya vade gÃ¼nÃ¼, sadece BIST aÃ§Ä±kken, vade gÃ¼nÃ¼ 12:00 sonrasÄ±)
            var rolloverTimeOk = daysN > 0 || (DateTime.Now.Hour * 60 + DateTime.Now.Minute >= 12 * 60);
            if (isBistOpen && snPos.ContainsKey(sym) && daysN <= 1 && daysN >= 0 && spotAsk > 0 && rolloverTimeOk) {
                var farBidDepth = ReadDepth(FUTURES_PREFIX + farC, "BID", 0, 1, 50);
                var farBid = farBidDepth.Item1 ? farBidDepth.Item4 : 0m;
                var farSpread = (farBid - spotAsk) / spotAsk;
                
                // Rollover karlÄ±lÄ±k kontrolÃ¼: Far spread >= dinamik eÅŸik + min kar marjÄ± + x2 komisyon
                var farThreshold = SNThreshold(daysF);
                var rolloverCommCost = (CalcCommission(sym, spotAsk, 1) * 2) / (spotAsk * 1);  // x2 komisyon oranÄ±
                var minRequired = farThreshold + ROLL_MIN_MARGIN + rolloverCommCost;
                
                if (farSpread >= minRequired) {
                    Log("ğŸ”„ Rollover uygun: Far spread " + (farSpread * 100).ToString("F3") + "% >= " + (minRequired * 100).ToString("F3") + "%");
                    RolloverSN(sym, nearC, farC, (int)snPos[sym][1]);
                } else if (daysN == 0) {
                    // Vade gÃ¼nÃ¼ ve rollover karlÄ± deÄŸil - pozisyonu kapat
                    Log("âš ï¸ Vade gÃ¼nÃ¼, rollover karlÄ± deÄŸil - pozisyon kapatÄ±lÄ±yor");
                    CloseSN(sym, nearC, (int)snPos[sym][0], (int)snPos[sym][1], "Vade sonu (rollover uygun deÄŸil)");
                }
            }
            
            // === YENÄ° POZÄ°SYON / BÃœYÃœTME Ä°Ã‡Ä°N DEVRE KESÄ°CÄ° KONTROLÃœ ===
            // Endeks veya spot devre kesici aktifse yeni pozisyon aÃ§ma/bÃ¼yÃ¼tme
            if (indexCircuitBreaker || spotCircuit) continue;
            
            // FÄ±rsat tarama (sadece piyasa aÃ§Ä±kken)
            if (rejected.ContainsKey(sym) && now - rejected[sym] < COOLDOWN) continue;
            
            // Pozisyon yoksa veya varsa iÅŸlem kontrolÃ¼
            
            if (!snPos.ContainsKey(sym)) {
                // Near vade son gÃ¼nÃ¼ yeni pozisyon aÃ§ma
                if (daysN <= 0) continue;
                
                var snThresh = SNThreshold(daysN);
                var snSpPct = snSp / 100m;
                
                // BB93 saat kontrolÃ¼ (10:00-12:55 arasÄ±)
                var bb93Now = DateTime.Now;
                var bb93TimeOk = (bb93Now.Hour > BB93_START_HOUR || (bb93Now.Hour == BB93_START_HOUR && bb93Now.Minute >= BB93_START_MIN)) &&
                                 (bb93Now.Hour < BB93_END_HOUR || (bb93Now.Hour == BB93_END_HOUR && bb93Now.Minute <= BB93_END_MIN));
                
                // BB 93+ ise margin kontrolÃ¼ yapma, direkt gir (5dk BB - gÃ¼n iÃ§i strateji)
                var isBB93Entry = BB93_ENTRY_ENABLED && bb93TimeOk && sBBPos >= BB93_ENTRY_THRESHOLD;
                
                // Spread uygun mu? (BB93+ ise threshold kontrolÃ¼ atlanÄ±r)
                if ((isBB93Entry || snSpPct >= snThresh) && spotAsk > 0) {
                    // GÃ¼nlÃ¼k BB kontrolÃ¼ kaldÄ±rÄ±ldÄ± - analiz sonucu iÅŸe yaramÄ±yor
                    // Sadece BB93+ (5dk intraday) stratejisi aktif
                    
                    // BIST KAPALI Ä°SE YENÄ° POZÄ°SYON AÃ‡MA (Spot alÄ±namaz!)
                    if (!isBistOpen) continue;
                    
                    // AÃ‡ILIÅ VOLATÄ°LÄ°TESÄ° KORUMASI: 10:05'e kadar yeni giriÅŸ yapma
                    // TemettÃ¼ gap'i ve aÃ§Ä±lÄ±ÅŸ volatilitesi riski
                    if (!IsAfterOpeningVolatility()) {
                        continue;  // Sessizce atla
                    }
                    
                    // TEMETTÃœ GÃœNÃœ KORUMASI: Ex-dividend gÃ¼nÃ¼ o sembole giriÅŸ yapma
                    // Spot fiyat temettÃ¼ kadar dÃ¼ÅŸer, Near henÃ¼z dÃ¼zelmemiÅŸ olabilir
                    if (IsDividendDay(sym)) {
                        Log("âš ï¸ SN: " + sym + " temettÃ¼ gÃ¼nÃ¼ - giriÅŸ atlandÄ±");
                        continue;
                    }
                    
                    // SERMAYE ARTIRIMI KORUMASI: BugÃ¼n veya 7 gÃ¼n iÃ§inde sermaye artÄ±rÄ±mÄ± varsa atla
                    if (IsSermayeArtirimiBlocked(sym)) {
                        Log("â›” SN: " + sym + " sermaye artÄ±rÄ±mÄ± - giriÅŸ atlandÄ±");
                        continue;
                    }
                    
                    // Not: Devre kesici kontrolÃ¼ dÃ¶ngÃ¼ baÅŸÄ±nda yapÄ±ldÄ±
                    
                    // TAVAN/TABAN KONTROLÃœ - Pozisyon aÃ§ma
                    // Pozisyon aÃ§arken: Spot ALIYORUZ + Near SATIYORUZ
                    var spotSym = SPOT_PREFIX + sym;
                    var nearSym = FUTURES_PREFIX + nearC;
                    
                    // Spot TAVAN ise â†’ ALINAMAZ (satÄ±cÄ± yok)
                    var spotTavanFiyat = tavanFiyat.ContainsKey(spotSym) ? tavanFiyat[spotSym] : 0;
                    if (spotTavanFiyat > 0 && spotAsk >= spotTavanFiyat) {
                        // Spot tavanda - alÄ±namaz, pozisyon aÃ§Ä±lamaz
                        continue;
                    }
                    
                    // Near TABAN ise â†’ SATILAMAZ (alÄ±cÄ± yok)
                    var nearTabanFiyat = tabanFiyat.ContainsKey(nearSym) ? tabanFiyat[nearSym] : 0;
                    if (nearTabanFiyat > 0 && nearBid <= nearTabanFiyat) {
                        // Near tabanda - satÄ±lamaz, pozisyon aÃ§Ä±lamaz
                        continue;
                    }
                    
                    var snSQty = qty * 100;
                    var reqS = spotAsk * snSQty;
                    var reqV = tem * qty;
                    
                    // BÃ¼tÃ§e sÄ±nÄ±r kontrolÃ¼: Pozisyon deÄŸerinin 2 katÄ± boÅŸluk yoksa
                    // replacement riski var, ekstra komisyon eÅŸiÄŸi iste
                    // BB93+ giriÅŸlerinde bu kontrol atlanÄ±r
                    var spotBosluk = spotBalance - reqS;
                    var viopBosluk = viopBalance - reqV;
                    var budgetTight = !isBB93Entry && ((spotBosluk < reqS * 2) || (viopBosluk < reqV * 2));
                    
                    if (budgetTight) {
                        // BÃ¼tÃ§e sÄ±nÄ±rda - threshold'a ekstra komisyon ekle
                        var tightThresh = snThresh + SN_TOTAL_COST;
                        if (snSpPct < tightThresh) {
                            // BÃ¼tÃ§e sÄ±nÄ±rda ve spread yetersiz - sessizce atla
                            continue;
                        }
                    }
                    
                    if (reqS <= spotBalance && reqV <= viopBalance) {
                        var filterInfo = "";
                        if (budgetTight) filterInfo += " [BÃœTÃ‡E SINIRDA]";
                        if (isBB93Entry) filterInfo += " [BB93+]";
                        Log("ğŸ¯ SN: " + sym + " BB:" + sBBPos.ToString("F0") + " Sp:" + snSp.ToString("F3") + "%" + filterInfo);
                        
                        // BB93+ giriÅŸi ise flag'i kaydet (p[6] = 1)
                        var bb93Flag = isBB93Entry ? 1 : 0;
                        if (OpenSN(sym, nearC, snSQty, qty, snThresh, bb93Flag)) {
                            UpdateBalances();
                        }
                        else rejected[sym] = DateTime.Now.Ticks;
                    } else {
                            // BÃ¼tÃ§e yetersiz - replacement deÄŸerlendir
                            var eksikS = reqS - spotBalance;
                            var eksikV = reqV - viopBalance;
                            
                            // Near derinlik kontrolÃ¼ - Ã¶nce yÃ¼zeysel veri (hÄ±zlÄ±), yetmezse derinlik
                            // nearSym zaten yukarÄ±da tanÄ±mlÄ± (tavan/taban kontrolÃ¼nde)
                            var nearDepthQty = (int)Sistem.SatisLot(nearSym);  // Near satÄ±yoruz, Bid tarafÄ±
                            if (nearDepthQty < qty) {
                                // 1. kademe yetmiyor, 2. kademeye de bak
                                System.Threading.Thread.Sleep(200);
                                dynamic nearDepthCheck = Sistem.DerinlikVerisiOku(nearSym);
                                if (nearDepthCheck != null && nearDepthCheck.Bids != null && nearDepthCheck.Bids.Count > 1) {
                                    nearDepthQty += (int)nearDepthCheck.Bids[1].Size;
                                }
                                if (nearDepthQty < qty) {
                                    // Near derinlik yetersiz - sessizce atla
                                    continue;
                                }
                            }
                            
                            // Yeni pozisyonun beklenen karÄ± (aÃ§Ä±lÄ±ÅŸ + kapanÄ±ÅŸ komisyonu dahil)
                            var newOpenComm = CalcSpotCommission(spotAsk, snSQty) + CalcCommission(sym, nearBid, qty);
                            var newExpectedPnl = snSpPct * spotAsk * snSQty - newOpenComm * 2;  // x2: aÃ§Ä±lÄ±ÅŸ + kapanÄ±ÅŸ
                            
                            // BÃ¼tÃ§e sÄ±nÄ±rda kontrolÃ¼ - replacement sonrasÄ± yeni pozisyon iÃ§in de geÃ§erli
                            // Replacement yapÄ±lacaksa yeni pozisyon da bÃ¼tÃ§e sÄ±nÄ±rda threshold'u geÃ§meli
                            var tightThreshForReplacement = snThresh + SN_TOTAL_COST;
                            if (snSpPct < tightThreshForReplacement) {
                                // Spread yetersiz - sessizce atla
                                continue;
                            }
                            
                            // ============ Ã–NCE AÃ‡ SONRA KAPAT MODU (v17) ============
                            // VIOP ve/veya SPOT rezervi kullanarak Ã¶nce yeni pozisyonu aÃ§
                            // KoÅŸullar: eksikler rezerv limitlerini aÅŸmamalÄ±
                            var useReserveMode = false;
                            var reserveNeededV = 0m;
                            var reserveNeededS = 0m;
                            
                            // VIOP eksik mi ve rezerv yeterli mi?
                            var viopOk = eksikV <= 0 || (eksikV > 0 && eksikV <= VIOP_RESERVE);
                            // SPOT eksik mi ve rezerv (kredi) yeterli mi?
                            var spotOk = eksikS <= 0 || (eksikS > 0 && eksikS <= SPOT_RESERVE);
                            
                            if (viopOk && spotOk && (eksikV > 0 || eksikS > 0)) {
                                // === Ã–NEMLÄ°: KapatÄ±labilir pozisyon var mÄ± kontrol et ===
                                // Rezerv moduna girmeden Ã¶nce en az bir pozisyonun threshold geÃ§tiÄŸinden emin ol
                                var hasCloseablePosition = false;
                                var tempExclude = new System.Collections.Generic.HashSet<string>();
                                tempExclude.Add(sym);  // Yeni aÃ§Ä±lacak sembolÃ¼ hariÃ§ tut
                                
                                var checkResult = FindWorstSNPosition(sym, tempExclude);
                                if (checkResult.Item1 != null) {
                                    var checkSym = checkResult.Item1;
                                    var checkEntrySpread = checkResult.Item2;
                                    var checkPos = snPos[checkSym];
                                    var checkSQty = (int)checkPos[0];
                                    var checkNQty = (int)checkPos[1];
                                    
                                    // Threshold hesapla
                                    var checkCloseSpotComm = CalcSpotCommission(checkPos[2], checkSQty);
                                    var checkCloseNearComm = CalcCommission(checkSym, checkPos[3], checkNQty);
                                    var checkCloseComm = checkCloseSpotComm + checkCloseNearComm;
                                    var checkCloseCommRate = (checkPos[2] * checkSQty) > 0 ? checkCloseComm / (checkPos[2] * checkSQty) : 0;
                                    var checkNewSpreadNet = snSpPct - (newOpenComm / (spotAsk * snSQty)) - checkCloseCommRate;
                                    var checkMinRequired = checkEntrySpread * (1 + REPLACEMENT_THRESHOLD);
                                    
                                    if (checkNewSpreadNet > checkMinRequired) {
                                        hasCloseablePosition = true;
                                    }
                                }
                                
                                if (!hasCloseablePosition) {
                                    // KapatÄ±labilir pozisyon yok - rezerv moduna girme!
                                    continue;
                                }
                                
                                // En az biri eksik ve her ikisi de rezerv limitleri iÃ§inde
                                useReserveMode = true;
                                reserveNeededV = eksikV > 0 ? eksikV : 0;
                                reserveNeededS = eksikS > 0 ? eksikS : 0;
                                var reserveInfo = "";
                                if (reserveNeededV > 0) reserveInfo += "VIOP:" + reserveNeededV.ToString("N0");
                                if (reserveNeededS > 0) reserveInfo += (reserveInfo.Length > 0 ? " + " : "") + "SPOT(kredi):" + reserveNeededS.ToString("N0");
                                Log("ğŸ”„ REZERV MODU: " + sym + " iÃ§in rezerv kullanÄ±lacak (" + reserveInfo + " TL)");
                            }
                            
                            if (useReserveMode) {
                                // Ã–NCE YENÄ° POZÄ°SYONU AÃ‡ (rezerv kullanarak)
                                
                                // === Near VE Spot derinlik kontrolÃ¼ + miktar ayarlama (3 deneme) ===
                                var nearFullSym = FUTURES_PREFIX + nearC;
                                var spotFullSym = SPOT_PREFIX + sym;
                                var mult = GetMultiplier(sym);
                                
                                var reserveDepthOK = false;
                                var nearTotalDepth = 0;
                                var nearBid1Size = 0;
                                var nearBid2Size = 0;
                                var nearBidPrice = 0m;
                                var spotTotalDepth = 0;
                                var spotAsk1Size = 0;
                                var spotAsk2Size = 0;
                                var spotAskPrice = 0m;
                                var actualSQty = 0;
                                var actualNQty = 0;
                                
                                for (int depthAttempt = 1; depthAttempt <= 3; depthAttempt++) {
                                    // 1. Near derinliÄŸi kontrol et (3 deneme ile)
                                    nearBid1Size = 0;
                                    nearBid2Size = 0;
                                    nearBidPrice = 0m;
                                    
                                    for (int depthTry = 1; depthTry <= 3; depthTry++) {
                                        dynamic nearDepthData = Sistem.DerinlikVerisiOku(nearFullSym);
                                        if (nearDepthData != null && nearDepthData.Bids != null && nearDepthData.Bids.Count > 0) {
                                            nearBid1Size = (int)nearDepthData.Bids[0].Size;
                                            nearBid2Size = nearDepthData.Bids.Count > 1 ? (int)nearDepthData.Bids[1].Size : 0;
                                            nearBidPrice = (decimal)nearDepthData.Bids[0].Price;
                                            if (nearBid1Size > 0 || nearBid2Size > 0) break;
                                        }
                                        if (depthTry < 3) System.Threading.Thread.Sleep(100);
                                    }
                                    nearTotalDepth = nearBid1Size + nearBid2Size;
                                    
                                    if (nearTotalDepth < 1 || nearBidPrice <= 0) {
                                        if (depthAttempt < 3) {
                                            Log("â³ REZERV AÃ‡ILIÅ: " + sym + " Near derinlik bekleniyor (deneme " + depthAttempt + "/3)");
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " Near derinlik/fiyat yok");
                                        break;
                                    }
                                    
                                    // 2. Spot derinliÄŸi kontrol et (3 deneme ile)
                                    var snSQtyNeeded = qty * mult;
                                    spotAsk1Size = 0;
                                    spotAsk2Size = 0;
                                    spotAskPrice = 0m;
                                    
                                    for (int depthTry = 1; depthTry <= 3; depthTry++) {
                                        dynamic spotDepthData = Sistem.DerinlikVerisiOku(spotFullSym);
                                        if (spotDepthData != null && spotDepthData.Asks != null && spotDepthData.Asks.Count > 0) {
                                            spotAsk1Size = (int)spotDepthData.Asks[0].Size;
                                            spotAsk2Size = spotDepthData.Asks.Count > 1 ? (int)spotDepthData.Asks[1].Size : 0;
                                            spotAskPrice = (decimal)spotDepthData.Asks[0].Price;
                                            if (spotAsk1Size > 0 || spotAsk2Size > 0) break;
                                        }
                                        if (depthTry < 3) System.Threading.Thread.Sleep(100);
                                    }
                                    spotTotalDepth = spotAsk1Size + spotAsk2Size;
                                    
                                    if (spotTotalDepth < mult || spotAskPrice <= 0) {
                                        if (depthAttempt < 3) {
                                            Log("â³ REZERV AÃ‡ILIÅ: " + sym + " Spot derinlik bekleniyor (deneme " + depthAttempt + "/3)");
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " Spot derinlik/fiyat yok");
                                        break;
                                    }
                                    
                                    // 3. GerÃ§ek iÅŸlem miktarÄ±nÄ± belirle
                                    var spotFromNear = nearTotalDepth * mult;
                                    var maxSpotFromDepth = Math.Min(spotTotalDepth, spotFromNear);
                                    
                                    if (maxSpotFromDepth < mult) {
                                        if (depthAttempt < 3) {
                                            Log("â³ REZERV AÃ‡ILIÅ: " + sym + " derinlik dÃ¼ÅŸÃ¼k, bekleniyor (deneme " + depthAttempt + "/3)");
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " derinlik Ã§ok dÃ¼ÅŸÃ¼k (Near:" + nearTotalDepth + " Spot:" + spotTotalDepth + ")");
                                        break;
                                    }
                                    
                                    // Ä°stenen miktarla kÄ±yasla
                                    actualSQty = Math.Min(snSQty, maxSpotFromDepth);
                                    actualNQty = (int)Math.Ceiling((decimal)actualSQty / mult);
                                    actualNQty = Math.Min(actualNQty, nearTotalDepth);
                                    actualSQty = actualNQty * mult;
                                    
                                    if (actualNQty < 1 || actualSQty < mult) {
                                        if (depthAttempt < 3) {
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " miktar yetersiz (N:" + actualNQty + " S:" + actualSQty + ")");
                                        break;
                                    }
                                    
                                    reserveDepthOK = true;
                                    break;
                                }
                                
                                if (!reserveDepthOK) continue;
                                
                                // Miktar deÄŸiÅŸtiyse logla
                                if (actualNQty != qty || actualSQty != snSQty) {
                                    Log("ğŸ“Š REZERV AÃ‡ILIÅ: " + sym + " miktar ayarlandÄ± - Orijinal S:" + snSQty + " N:" + qty + " â†’ Yeni S:" + actualSQty + " N:" + actualNQty);
                                }
                                
                                Log("ğŸ“Š REZERV AÃ‡ILIÅ: " + sym + " S:" + actualSQty + " N:" + actualNQty + " (Derinlik N:" + nearTotalDepth + " S:" + spotTotalDepth + ")");
                                
                                // Near bacaÄŸÄ±nÄ± GÄ°E ile aÃ§
                                var giePriceRes = nearBidPrice;  // YÃ¼zeysel veya derinlikten alÄ±nan fiyat
                                var gieResult = SendGIE(nearC, "SELL", actualNQty, giePriceRes);
                                if (!gieResult) {
                                    Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " Near GÄ°E baÅŸarÄ±sÄ±z");
                                    continue;
                                }
                                
                                // Near doldu mu kontrol et
                                System.Threading.Thread.Sleep(500);
                                var nearFilledQty = CheckFilledQty(nearC, "SELL", actualNQty);
                                if (nearFilledQty < actualNQty) {
                                    Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " Near dolmadÄ± (" + nearFilledQty + "/" + actualNQty + ")");
                                    // Near kÄ±smen dolmuÅŸsa geri al
                                    if (nearFilledQty > 0) {
                                        ExecGuar(nearC, "BUY", nearFilledQty);
                                    }
                                    continue;
                                }
                                
                                // Near doldu - Spot al (miktarÄ± Near'a gÃ¶re ayarla)
                                // === YENÄ° v17.5: Derinlik yoksa 3 deneme ===
                                var finalSQty = nearFilledQty * mult;
                                var spotResult = new System.Tuple<int, decimal>(0, 0m);
                                
                                for (int spotAttempt = 1; spotAttempt <= 3; spotAttempt++) {
                                    // Ã–nce derinlik var mÄ± kontrol et
                                    var spotCheckSym = SPOT_PREFIX + sym;
                                    var spotCheckDepth = Sistem.DerinlikVerisiOku(spotCheckSym);
                                    var hasDepth = spotCheckDepth != null && spotCheckDepth.Asks != null && spotCheckDepth.Asks.Count > 0;
                                    
                                    if (!hasDepth) {
                                        if (spotAttempt < 3) {
                                            Log("âš ï¸ REZERV AÃ‡ILIÅ: " + sym + " Spot derinlik yok, deneme " + spotAttempt + "/3...");
                                            System.Threading.Thread.Sleep(500);
                                            continue;  // Tekrar dene
                                        } else {
                                            Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " Spot derinlik 3 denemede bulunamadÄ±");
                                            break;  // VazgeÃ§
                                        }
                                    }
                                    
                                    // Derinlik var - emir gÃ¶nder (KIE olduÄŸu iÃ§in tek seferde)
                                    spotResult = ExecGuar(sym, "BUY", finalSQty);
                                    break;  // Emir gÃ¶nderildi, dÃ¶ngÃ¼den Ã§Ä±k (kÄ±smi dolum olabilir)
                                }
                                
                                if (spotResult.Item1 < finalSQty * 0.5m) {  // En az yarÄ±sÄ± dolmalÄ±
                                    Log("âŒ REZERV AÃ‡ILIÅ: " + sym + " Spot alÄ±namadÄ± (" + spotResult.Item1 + "/" + finalSQty + ") - Near geri alÄ±nÄ±yor");
                                    ExecGuar(nearC, "BUY", nearFilledQty);
                                    continue;
                                }
                                
                                // Spot kÄ±smi dolduysa, fazla Near'Ä± geri al
                                var actualSpotFilled = spotResult.Item1;
                                var neededNear = (int)Math.Ceiling((decimal)actualSpotFilled / mult);
                                var excessNear = nearFilledQty - neededNear;
                                
                                if (excessNear > 0) {
                                    Log("âš ï¸ REZERV AÃ‡ILIÅ: " + sym + " Spot kÄ±smi doldu (" + actualSpotFilled + "/" + finalSQty + ") - Fazla Near geri alÄ±nÄ±yor: " + excessNear);
                                    ExecGuar(nearC, "BUY", excessNear);
                                    nearFilledQty = neededNear;
                                }
                                
                                // Pozisyon aÃ§Ä±ldÄ± - kaydet
                                // Near fiyatÄ± yÃ¼zeysel veya derinlikten alÄ±ndÄ±
                                var nearPrice = nearBidPrice;
                                var spotPrice = spotResult.Item2;
                                var spread = spotPrice > 0 ? (nearPrice - spotPrice) / spotPrice : 0;
                                var actualOpenComm = CalcSpotCommission(spotPrice, actualSpotFilled) + CalcCommission(sym, nearPrice, nearFilledQty);
                                var expPnl = spread * spotPrice * actualSpotFilled - actualOpenComm * 2;
                                
                                snPos[sym] = new decimal[] { actualSpotFilled, nearFilledQty, spotPrice, nearPrice, spread, expPnl, 0, DateTime.Now.Ticks };
                                spotUsed += spotPrice * actualSpotFilled;
                                viopUsed += teminat.ContainsKey(sym) ? teminat[sym] * nearFilledQty : 0;
                                
                                Log("âœ… REZERV AÃ‡ILDI: " + sym + " S:" + actualSpotFilled + "@" + spotPrice.ToString("F2") + " N:" + nearFilledQty + "@" + nearPrice.ToString("F2") + " Spread:" + (spread * 100).ToString("F3") + "%");
                                
                                // Åimdi rezerv kadar bÃ¼tÃ§e aÃ§mak iÃ§in en kÃ¶tÃ¼ pozisyonlarÄ± kapat
                                // Bu gÃ¶revi pendingReserveClose listesine ekle
                                var reserveCloseNeeded = reserveNeededV;
                                var closedForReserve = new System.Collections.Generic.List<string>();
                                
                                while (reserveCloseNeeded > 0) {
                                    var worstResult = FindWorstSNPosition(sym, new System.Collections.Generic.HashSet<string>(closedForReserve));
                                    var worstSym = worstResult.Item1;
                                    
                                    if (worstSym == null) {
                                        Log("âš ï¸ REZERV KAPANIÅ: KapatÄ±lacak pozisyon kalmadÄ±, rezerv:" + reserveCloseNeeded.ToString("N0") + " TL aÃ§Ä±k");
                                        break;
                                    }
                                    
                                    var oldPos = snPos[worstSym];
                                    var oldSQty = (int)oldPos[0];
                                    var oldNQty = (int)oldPos[1];
                                    var oldViopValue = teminat.ContainsKey(worstSym) ? teminat[worstSym] * oldNQty : 0;
                                    
                                    // Threshold kontrolÃ¼
                                    var worstEntrySpread = worstResult.Item2;
                                    var closeSpotComm = CalcSpotCommission(oldPos[2], oldSQty);
                                    var closeNearComm = CalcCommission(worstSym, oldPos[3], oldNQty);
                                    var thisCloseComm = closeSpotComm + closeNearComm;
                                    var closeCommRate = (oldPos[2] * oldSQty) > 0 ? thisCloseComm / (oldPos[2] * oldSQty) : 0;
                                    var newSpreadNet = snSpPct - (newOpenComm / (spotAsk * snSQty)) - closeCommRate;
                                    var minRequiredSpread = worstEntrySpread * (1 + REPLACEMENT_THRESHOLD);
                                    
                                    if (newSpreadNet <= minRequiredSpread) {
                                        Log("âš ï¸ REZERV KAPANIÅ: " + worstSym + " threshold geÃ§medi, atlanÄ±yor");
                                        closedForReserve.Add(worstSym);
                                        continue;
                                    }
                                    
                                    // AnlÄ±k P&L kontrolÃ¼: Pozisyon zararda ise yeni pozisyon bu zararÄ± karÅŸÄ±lamalÄ±
                                    var worstNearC = GetContract(worstSym, 0);
                                    var worstSpotBidDepth = ReadDepth(SPOT_PREFIX + worstSym, "BID", 0, 1, 50);
                                    var worstNearAskDepth = ReadDepth(FUTURES_PREFIX + worstNearC, "ASK", 0, 1, 50);
                                    var worstSpotBid = worstSpotBidDepth.Item1 ? worstSpotBidDepth.Item4 : 0m;
                                    var worstNearAsk = worstNearAskDepth.Item1 ? worstNearAskDepth.Item4 : 0m;
                                    var worstMult = GetMultiplier(worstSym);
                                    var worstCurrentPnl = (worstSpotBid - oldPos[2]) * oldSQty + (oldPos[3] - worstNearAsk) * oldNQty * worstMult;
                                    worstCurrentPnl -= thisCloseComm;  // Kapatma komisyonu
                                    
                                    if (worstCurrentPnl < 0) {
                                        // Pozisyon zararda - yeni pozisyon bu zararÄ± + threshold kadar karÅŸÄ±lamalÄ±
                                        var minRequiredPnl = Math.Abs(worstCurrentPnl) * (1 + REPLACEMENT_THRESHOLD);
                                        if (newExpectedPnl < minRequiredPnl) {
                                            Log("â­ï¸ REZERV: " + worstSym + " zararÄ± Ã§ok yÃ¼ksek: " + worstCurrentPnl.ToString("F0") + " TL, beklenen: " + newExpectedPnl.ToString("F0") + " < gerekli: " + minRequiredPnl.ToString("F0"));
                                            closedForReserve.Add(worstSym);
                                            continue;
                                        }
                                    }
                                    
                                    // Kapat
                                    Log("ğŸ”„ REZERV KAPANIÅ: " + worstSym + " kapatÄ±lÄ±yor (rezerv iÃ§in)");
                                    CloseSN(worstSym, GetContract(worstSym, 0), oldSQty, oldNQty, "RESERVE_REPLACEMENT");
                                    
                                    if (!snPos.ContainsKey(worstSym)) {
                                        closedForReserve.Add(worstSym);
                                        reserveCloseNeeded -= oldViopValue;
                                        Log("âœ… REZERV KAPANIÅ: " + worstSym + " kapatÄ±ldÄ±, kalan rezerv:" + Math.Max(0, reserveCloseNeeded).ToString("N0") + " TL");
                                    } else {
                                        Log("âŒ REZERV KAPANIÅ: " + worstSym + " kapanÄ±ÅŸ baÅŸarÄ±sÄ±z");
                                        closedForReserve.Add(worstSym);
                                    }
                                }
                                
                                UpdateBalances();
                                continue;  // Bu sembol iÃ§in iÅŸlem tamamlandÄ±
                            }
                            // ============ Ã–NCE AÃ‡ SONRA KAPAT MODU SONU ============
                            
                            // v17.2: Rezerv modu baÅŸarÄ±sÄ±z olduysa pas geÃ§
                            // Eski "Ã¶nce kapat sonra aÃ§" modu kaldÄ±rÄ±ldÄ± - spread kaÃ§Ä±rma riski yÃ¼ksek
                            // Rezervler yetmiyorsa zaten sistem dÃ¼zgÃ¼n Ã§alÄ±ÅŸmÄ±yor demektir
                            // Log("â­ï¸ " + sym + " rezerv yetersiz, replacement atlanÄ±yor");
                            continue;
                    }
                }
            } else if (snPos.ContainsKey(sym) && (int)snPos[sym][6] < 2) {
                // Near vade son gÃ¼nÃ¼ bÃ¼yÃ¼tme/replacement yapma
                if (daysN <= 0) continue;
                
                // BÃ¼yÃ¼tme
                var snThresh = SNThreshold(daysN);
                var snSpPct = snSp / 100m;
                var entrySpread = snPos[sym][4];  // Mevcut pozisyonun giriÅŸ spread'i
                
                // BÃ¼yÃ¼tme iÃ§in: yeni spread >= giriÅŸ spread * (1 + threshold) VE yeni spread >= dinamik threshold
                var minSpreadForAdd = entrySpread * (1 + REPLACEMENT_THRESHOLD);
                if (snSpPct >= snThresh && snSpPct >= minSpreadForAdd) {
                    // GÃ¼nlÃ¼k BB kontrolÃ¼ kaldÄ±rÄ±ldÄ± - analiz sonucu iÅŸe yaramÄ±yor
                    // Not: Devre kesici kontrolÃ¼ dÃ¶ngÃ¼ baÅŸÄ±nda yapÄ±ldÄ±
                    
                    var snSQty = qty * 100;
                    var reqS = spotAsk * snSQty;
                    var reqV = tem * qty;
                    if (reqS <= spotBalance && reqV <= viopBalance) {
                        Log("ğŸ¯ SN BÃ¼yÃ¼tme: " + sym + " BB:" + sBBPos.ToString("F0") + " Sp:" + snSp.ToString("F3") + "% (giriÅŸ:" + (entrySpread * 100).ToString("F3") + "%)");
                        if (AddToSN(sym, nearC, snSQty, qty, snThresh)) {
                            UpdateBalances();
                        }
                    } else {
                            // BÃ¼tÃ§e yetersiz - bÃ¼yÃ¼tme iÃ§in replacement deÄŸerlendir
                            var eksikS = reqS - spotBalance;
                            var eksikV = reqV - viopBalance;
                            
                            // Near derinlik kontrolÃ¼ (bÃ¼yÃ¼tme) - Ã¶nce yÃ¼zeysel veri, yetmezse derinlik
                            var nearSym = FUTURES_PREFIX + nearC;
                            var nearDepthQty = (int)Sistem.SatisLot(nearSym);  // Near satÄ±yoruz, Bid tarafÄ±
                            if (nearDepthQty < qty) {
                                // 1. kademe yetmiyor, 2. kademeye de bak
                                System.Threading.Thread.Sleep(200);
                                dynamic nearDepthCheck = Sistem.DerinlikVerisiOku(nearSym);
                                if (nearDepthCheck != null && nearDepthCheck.Bids != null && nearDepthCheck.Bids.Count > 1) {
                                    nearDepthQty += (int)nearDepthCheck.Bids[1].Size;
                                }
                                if (nearDepthQty < qty) {
                                    // Near derinlik yetersiz - sessizce atla
                                    continue;
                                }
                            }
                            
                            // BÃ¼yÃ¼tmenin beklenen karÄ± (aÃ§Ä±lÄ±ÅŸ komisyonu dahil)
                            var addOpenComm = CalcSpotCommission(spotAsk, snSQty) + CalcCommission(sym, nearBid, qty);
                            var addExpectedPnl = snSpPct * spotAsk * snSQty - addOpenComm * 2;  // x2: aÃ§Ä±lÄ±ÅŸ + kapanÄ±ÅŸ
                            
                            // BÃ¼tÃ§e sÄ±nÄ±rda kontrolÃ¼ - bÃ¼yÃ¼tme iÃ§in replacement yapÄ±lacaksa da threshold geÃ§meli
                            var tightThreshForAdd = snThresh + SN_TOTAL_COST;
                            if (snSpPct < tightThreshForAdd) {
                                // Spread yetersiz - sessizce atla
                                continue;
                            }
                            
                            // ============ BÃœYÃœTME Ä°Ã‡Ä°N Ã–NCE AÃ‡ SONRA KAPAT MODU (v17) ============
                            var useReserveModeAdd = false;
                            var reserveNeededAddV = 0m;
                            var reserveNeededAddS = 0m;
                            
                            // VIOP eksik mi ve rezerv yeterli mi?
                            var viopOkAdd = eksikV <= 0 || (eksikV > 0 && eksikV <= VIOP_RESERVE);
                            // SPOT eksik mi ve rezerv (kredi) yeterli mi?
                            var spotOkAdd = eksikS <= 0 || (eksikS > 0 && eksikS <= SPOT_RESERVE);
                            
                            if (viopOkAdd && spotOkAdd && (eksikV > 0 || eksikS > 0)) {
                                // === Ã–NEMLÄ°: KapatÄ±labilir pozisyon var mÄ± kontrol et ===
                                var hasCloseablePositionAdd = false;
                                var tempExcludeAdd = new System.Collections.Generic.HashSet<string>();
                                tempExcludeAdd.Add(sym);  // BÃ¼yÃ¼tÃ¼len sembolÃ¼ hariÃ§ tut
                                
                                var checkResultAdd = FindWorstSNPosition(sym, tempExcludeAdd);
                                if (checkResultAdd.Item1 != null) {
                                    var checkSymAdd = checkResultAdd.Item1;
                                    var checkEntrySpreadAdd = checkResultAdd.Item2;
                                    var checkPosAdd = snPos[checkSymAdd];
                                    var checkSQtyAdd = (int)checkPosAdd[0];
                                    var checkNQtyAdd = (int)checkPosAdd[1];
                                    
                                    // Threshold hesapla
                                    var checkCloseSpotCommAdd = CalcSpotCommission(checkPosAdd[2], checkSQtyAdd);
                                    var checkCloseNearCommAdd = CalcCommission(checkSymAdd, checkPosAdd[3], checkNQtyAdd);
                                    var checkCloseCommAdd = checkCloseSpotCommAdd + checkCloseNearCommAdd;
                                    var checkCloseCommRateAdd = (checkPosAdd[2] * checkSQtyAdd) > 0 ? checkCloseCommAdd / (checkPosAdd[2] * checkSQtyAdd) : 0;
                                    var checkNewSpreadNetAdd = snSpPct - (addOpenComm / (spotAsk * snSQty)) - checkCloseCommRateAdd;
                                    var checkMinRequiredAdd = checkEntrySpreadAdd * (1 + REPLACEMENT_THRESHOLD);
                                    
                                    if (checkNewSpreadNetAdd > checkMinRequiredAdd) {
                                        hasCloseablePositionAdd = true;
                                    }
                                }
                                
                                if (!hasCloseablePositionAdd) {
                                    // KapatÄ±labilir pozisyon yok - bÃ¼yÃ¼tme rezerv moduna girme!
                                    continue;
                                }
                                
                                // En az biri eksik ve her ikisi de rezerv limitleri iÃ§inde
                                useReserveModeAdd = true;
                                reserveNeededAddV = eksikV > 0 ? eksikV : 0;
                                reserveNeededAddS = eksikS > 0 ? eksikS : 0;
                                var reserveInfoAdd = "";
                                if (reserveNeededAddV > 0) reserveInfoAdd += "VIOP:" + reserveNeededAddV.ToString("N0");
                                if (reserveNeededAddS > 0) reserveInfoAdd += (reserveInfoAdd.Length > 0 ? " + " : "") + "SPOT(kredi):" + reserveNeededAddS.ToString("N0");
                                Log("ğŸ”„ BÃœYÃœTME REZERV MODU: " + sym + " iÃ§in rezerv kullanÄ±lacak (" + reserveInfoAdd + " TL)");
                            }
                            
                            if (useReserveModeAdd) {
                                // Ã–NCE BÃœYÃœTME YAP (rezerv kullanarak)
                                
                                // === Near VE Spot derinlik kontrolÃ¼ + miktar ayarlama (3 deneme) ===
                                var nearFullSymAdd = FUTURES_PREFIX + nearC;
                                var spotFullSymAdd = SPOT_PREFIX + sym;
                                var multAdd = GetMultiplier(sym);
                                
                                var reserveDepthOKAdd = false;
                                var nearTotalDepthAdd = 0;
                                var nearBid1SizeAdd = 0;
                                var nearBid2SizeAdd = 0;
                                var nearBidPriceAdd = 0m;
                                var spotTotalDepthAdd = 0;
                                var spotAsk1SizeAdd = 0;
                                var spotAsk2SizeAdd = 0;
                                var spotAskPriceAdd = 0m;
                                var actualSQtyAdd = 0;
                                var actualNQtyAdd = 0;
                                
                                for (int depthAttemptAdd = 1; depthAttemptAdd <= 3; depthAttemptAdd++) {
                                    // 1. Near derinliÄŸi kontrol et (3 deneme ile)
                                    nearBid1SizeAdd = 0;
                                    nearBid2SizeAdd = 0;
                                    nearBidPriceAdd = 0m;
                                    
                                    for (int depthTry = 1; depthTry <= 3; depthTry++) {
                                        dynamic nearDepthDataAdd = Sistem.DerinlikVerisiOku(nearFullSymAdd);
                                        if (nearDepthDataAdd != null && nearDepthDataAdd.Bids != null && nearDepthDataAdd.Bids.Count > 0) {
                                            nearBid1SizeAdd = (int)nearDepthDataAdd.Bids[0].Size;
                                            nearBid2SizeAdd = nearDepthDataAdd.Bids.Count > 1 ? (int)nearDepthDataAdd.Bids[1].Size : 0;
                                            nearBidPriceAdd = (decimal)nearDepthDataAdd.Bids[0].Price;
                                            if (nearBid1SizeAdd > 0 || nearBid2SizeAdd > 0) break;
                                        }
                                        if (depthTry < 3) System.Threading.Thread.Sleep(100);
                                    }
                                    nearTotalDepthAdd = nearBid1SizeAdd + nearBid2SizeAdd;
                                    
                                    if (nearTotalDepthAdd < 1 || nearBidPriceAdd <= 0) {
                                        if (depthAttemptAdd < 3) {
                                            Log("â³ REZERV BÃœYÃœTME: " + sym + " Near derinlik bekleniyor (deneme " + depthAttemptAdd + "/3)");
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV BÃœYÃœTME: " + sym + " Near derinlik/fiyat yok");
                                        break;
                                    }
                                    
                                    // 2. Spot derinliÄŸi kontrol et (3 deneme ile)
                                    var snSQtyNeededAdd = qty * multAdd;
                                    spotAsk1SizeAdd = 0;
                                    spotAsk2SizeAdd = 0;
                                    spotAskPriceAdd = 0m;
                                    
                                    for (int depthTry = 1; depthTry <= 3; depthTry++) {
                                        dynamic spotDepthDataAdd = Sistem.DerinlikVerisiOku(spotFullSymAdd);
                                        if (spotDepthDataAdd != null && spotDepthDataAdd.Asks != null && spotDepthDataAdd.Asks.Count > 0) {
                                            spotAsk1SizeAdd = (int)spotDepthDataAdd.Asks[0].Size;
                                            spotAsk2SizeAdd = spotDepthDataAdd.Asks.Count > 1 ? (int)spotDepthDataAdd.Asks[1].Size : 0;
                                            spotAskPriceAdd = (decimal)spotDepthDataAdd.Asks[0].Price;
                                            if (spotAsk1SizeAdd > 0 || spotAsk2SizeAdd > 0) break;
                                        }
                                        if (depthTry < 3) System.Threading.Thread.Sleep(100);
                                    }
                                    spotTotalDepthAdd = spotAsk1SizeAdd + spotAsk2SizeAdd;
                                    
                                    if (spotTotalDepthAdd < multAdd || spotAskPriceAdd <= 0) {
                                        if (depthAttemptAdd < 3) {
                                            Log("â³ REZERV BÃœYÃœTME: " + sym + " Spot derinlik bekleniyor (deneme " + depthAttemptAdd + "/3)");
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV BÃœYÃœTME: " + sym + " Spot derinlik/fiyat yok");
                                        break;
                                    }
                                    
                                    // 3. GerÃ§ek iÅŸlem miktarÄ±nÄ± belirle
                                    var spotFromNearAdd = nearTotalDepthAdd * multAdd;
                                    var maxSpotFromDepthAdd = Math.Min(spotTotalDepthAdd, spotFromNearAdd);
                                    
                                    if (maxSpotFromDepthAdd < multAdd) {
                                        if (depthAttemptAdd < 3) {
                                            Log("â³ REZERV BÃœYÃœTME: " + sym + " derinlik dÃ¼ÅŸÃ¼k, bekleniyor (deneme " + depthAttemptAdd + "/3)");
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV BÃœYÃœTME: " + sym + " derinlik Ã§ok dÃ¼ÅŸÃ¼k (Near:" + nearTotalDepthAdd + " Spot:" + spotTotalDepthAdd + ")");
                                        break;
                                    }
                                    
                                    // Ä°stenen miktarla kÄ±yasla
                                    actualSQtyAdd = Math.Min(snSQty, maxSpotFromDepthAdd);
                                    actualNQtyAdd = (int)Math.Ceiling((decimal)actualSQtyAdd / multAdd);
                                    actualNQtyAdd = Math.Min(actualNQtyAdd, nearTotalDepthAdd);
                                    actualSQtyAdd = actualNQtyAdd * multAdd;
                                    
                                    if (actualNQtyAdd < 1 || actualSQtyAdd < multAdd) {
                                        if (depthAttemptAdd < 3) {
                                            System.Threading.Thread.Sleep(300);
                                            continue;
                                        }
                                        Log("âŒ REZERV BÃœYÃœTME: " + sym + " miktar yetersiz (N:" + actualNQtyAdd + " S:" + actualSQtyAdd + ")");
                                        break;
                                    }
                                    
                                    reserveDepthOKAdd = true;
                                    break;
                                }
                                
                                if (!reserveDepthOKAdd) continue;
                                
                                // Miktar deÄŸiÅŸtiyse logla
                                if (actualNQtyAdd != qty || actualSQtyAdd != snSQty) {
                                    Log("ğŸ“Š REZERV BÃœYÃœTME: " + sym + " miktar ayarlandÄ± - Orijinal S:" + snSQty + " N:" + qty + " â†’ Yeni S:" + actualSQtyAdd + " N:" + actualNQtyAdd);
                                }
                                
                                Log("ğŸ“Š REZERV BÃœYÃœTME: " + sym + " S:" + actualSQtyAdd + " N:" + actualNQtyAdd + " (Derinlik N:" + nearTotalDepthAdd + " S:" + spotTotalDepthAdd + ")");
                                
                                // Miktar deÄŸiÅŸtiyse logla
                                if (actualNQtyAdd != qty || actualSQtyAdd != snSQty) {
                                    Log("ğŸ“Š REZERV BÃœYÃœTME: " + sym + " miktar ayarlandÄ± - Orijinal S:" + snSQty + " N:" + qty + " â†’ Yeni S:" + actualSQtyAdd + " N:" + actualNQtyAdd);
                                }
                                
                                Log("ğŸ“Š REZERV BÃœYÃœTME: " + sym + " S:" + actualSQtyAdd + " N:" + actualNQtyAdd + " (Derinlik N:" + nearTotalDepthAdd + " S:" + spotTotalDepthAdd + ")");
                                
                                // Near bacaÄŸÄ±nÄ± GÄ°E ile aÃ§
                                var giePriceAdd = nearBidPriceAdd;  // YÃ¼zeysel veya derinlikten alÄ±nan fiyat
                                var gieResult = SendGIE(nearC, "SELL", actualNQtyAdd, giePriceAdd);
                                if (!gieResult) {
                                    Log("âŒ REZERV BÃœYÃœTME: " + sym + " Near GÄ°E baÅŸarÄ±sÄ±z");
                                    continue;
                                }
                                
                                // Near doldu mu kontrol et
                                System.Threading.Thread.Sleep(500);
                                var nearFilledQtyAdd = CheckFilledQty(nearC, "SELL", actualNQtyAdd);
                                if (nearFilledQtyAdd < actualNQtyAdd) {
                                    Log("âŒ REZERV BÃœYÃœTME: " + sym + " Near dolmadÄ± (" + nearFilledQtyAdd + "/" + actualNQtyAdd + ")");
                                    // Near kÄ±smen dolmuÅŸsa geri al
                                    if (nearFilledQtyAdd > 0) {
                                        ExecGuar(nearC, "BUY", nearFilledQtyAdd);
                                    }
                                    continue;
                                }
                                
                                // Near doldu - Spot al (miktarÄ± Near'a gÃ¶re ayarla)
                                // === YENÄ° v17.5: Derinlik yoksa 3 deneme ===
                                var finalSQtyAdd = nearFilledQtyAdd * multAdd;
                                var spotResultAdd = new System.Tuple<int, decimal>(0, 0m);
                                
                                for (int spotAttemptAdd = 1; spotAttemptAdd <= 3; spotAttemptAdd++) {
                                    // Ã–nce derinlik var mÄ± kontrol et
                                    var spotCheckSymAdd = SPOT_PREFIX + sym;
                                    var spotCheckDepthAdd = Sistem.DerinlikVerisiOku(spotCheckSymAdd);
                                    var hasDepthAdd = spotCheckDepthAdd != null && spotCheckDepthAdd.Asks != null && spotCheckDepthAdd.Asks.Count > 0;
                                    
                                    if (!hasDepthAdd) {
                                        if (spotAttemptAdd < 3) {
                                            Log("âš ï¸ REZERV BÃœYÃœTME: " + sym + " Spot derinlik yok, deneme " + spotAttemptAdd + "/3...");
                                            System.Threading.Thread.Sleep(500);
                                            continue;  // Tekrar dene
                                        } else {
                                            Log("âŒ REZERV BÃœYÃœTME: " + sym + " Spot derinlik 3 denemede bulunamadÄ±");
                                            break;  // VazgeÃ§
                                        }
                                    }
                                    
                                    // Derinlik var - emir gÃ¶nder (KIE olduÄŸu iÃ§in tek seferde)
                                    spotResultAdd = ExecGuar(sym, "BUY", finalSQtyAdd);
                                    break;  // Emir gÃ¶nderildi, dÃ¶ngÃ¼den Ã§Ä±k (kÄ±smi dolum olabilir)
                                }
                                
                                if (spotResultAdd.Item1 < finalSQtyAdd * 0.5m) {  // En az yarÄ±sÄ± dolmalÄ±
                                    Log("âŒ REZERV BÃœYÃœTME: " + sym + " Spot alÄ±namadÄ± (" + spotResultAdd.Item1 + "/" + finalSQtyAdd + ") - Near geri alÄ±nÄ±yor");
                                    ExecGuar(nearC, "BUY", nearFilledQtyAdd);
                                    continue;
                                }
                                
                                // Spot kÄ±smi dolduysa, fazla Near'Ä± geri al
                                var actualSpotFilledAdd = spotResultAdd.Item1;
                                var neededNearAdd = (int)Math.Ceiling((decimal)actualSpotFilledAdd / multAdd);
                                var excessNearAdd = nearFilledQtyAdd - neededNearAdd;
                                
                                if (excessNearAdd > 0) {
                                    Log("âš ï¸ REZERV BÃœYÃœTME: " + sym + " Spot kÄ±smi doldu (" + actualSpotFilledAdd + "/" + finalSQtyAdd + ") - Fazla Near geri alÄ±nÄ±yor: " + excessNearAdd);
                                    ExecGuar(nearC, "BUY", excessNearAdd);
                                    nearFilledQtyAdd = neededNearAdd;
                                }
                                
                                // BÃ¼yÃ¼tme yapÄ±ldÄ± - pozisyonu gÃ¼ncelle
                                var nearPriceAdd = nearBidPriceAdd;  // YÃ¼zeysel veya derinlikten alÄ±nan fiyat
                                var spotPriceAdd = spotResultAdd.Item2;
                                var p = snPos[sym];
                                var oldSQty = (int)p[0];
                                var oldNQty = (int)p[1];
                                var oldSpotEntry = p[2];
                                var oldNearEntry = p[3];
                                
                                // Ortalama fiyat hesapla
                                var newSQty = oldSQty + actualSpotFilledAdd;
                                var newNQty = oldNQty + nearFilledQtyAdd;
                                var avgSpotEntry = (oldSpotEntry * oldSQty + spotPriceAdd * actualSpotFilledAdd) / newSQty;
                                var avgNearEntry = (oldNearEntry * oldNQty + nearPriceAdd * nearFilledQtyAdd) / newNQty;
                                var newSpread = avgSpotEntry > 0 ? (avgNearEntry - avgSpotEntry) / avgSpotEntry : 0;
                                
                                // Yeni beklenen kar
                                var totalSpotComm = CalcSpotCommission(avgSpotEntry, newSQty);
                                var totalNearComm = CalcCommission(sym, avgNearEntry, newNQty);
                                var newExpPnl = newSpread * avgSpotEntry * newSQty - (totalSpotComm + totalNearComm) * 2;
                                
                                snPos[sym] = new decimal[] { newSQty, newNQty, avgSpotEntry, avgNearEntry, newSpread, newExpPnl, 0, p[7] };
                                spotUsed += spotPriceAdd * actualSpotFilledAdd;
                                viopUsed += teminat.ContainsKey(sym) ? teminat[sym] * nearFilledQtyAdd : 0;
                                
                                Log("âœ… REZERV BÃœYÃœTME: " + sym + " S:" + oldSQty + "â†’" + newSQty + " N:" + oldNQty + "â†’" + newNQty + " Spread:" + (newSpread * 100).ToString("F3") + "%");
                                
                                // Åimdi rezerv kadar bÃ¼tÃ§e aÃ§mak iÃ§in en kÃ¶tÃ¼ pozisyonlarÄ± kapat
                                var reserveCloseNeededAdd = reserveNeededAddV;
                                var closedForReserveAdd = new System.Collections.Generic.List<string>();
                                
                                while (reserveCloseNeededAdd > 0) {
                                    var worstResult = FindWorstSNPosition(sym, new System.Collections.Generic.HashSet<string>(closedForReserveAdd));
                                    var worstSym = worstResult.Item1;
                                    
                                    if (worstSym == null) {
                                        Log("âš ï¸ BÃœYÃœTME REZERV KAPANIÅ: KapatÄ±lacak pozisyon kalmadÄ±, rezerv:" + reserveCloseNeededAdd.ToString("N0") + " TL aÃ§Ä±k");
                                        break;
                                    }
                                    
                                    var oldPos = snPos[worstSym];
                                    var oldPosSQty = (int)oldPos[0];
                                    var oldPosNQty = (int)oldPos[1];
                                    var oldViopValue = teminat.ContainsKey(worstSym) ? teminat[worstSym] * oldPosNQty : 0;
                                    
                                    // Threshold kontrolÃ¼
                                    var worstEntrySpread = worstResult.Item2;
                                    var closeSpotComm = CalcSpotCommission(oldPos[2], oldPosSQty);
                                    var closeNearComm = CalcCommission(worstSym, oldPos[3], oldPosNQty);
                                    var thisCloseCommAdd = closeSpotComm + closeNearComm;
                                    var closeCommRate = (oldPos[2] * oldPosSQty) > 0 ? thisCloseCommAdd / (oldPos[2] * oldPosSQty) : 0;
                                    var addSpreadNet = snSpPct - (addOpenComm / (spotAsk * snSQty)) - closeCommRate;
                                    var minRequiredSpread = worstEntrySpread * (1 + REPLACEMENT_THRESHOLD);
                                    
                                    if (addSpreadNet <= minRequiredSpread) {
                                        Log("âš ï¸ BÃœYÃœTME REZERV KAPANIÅ: " + worstSym + " threshold geÃ§medi, atlanÄ±yor");
                                        closedForReserveAdd.Add(worstSym);
                                        continue;
                                    }
                                    
                                    // AnlÄ±k P&L kontrolÃ¼: Pozisyon zararda ise bÃ¼yÃ¼tmenin beklenen karÄ± bu zararÄ± karÅŸÄ±lamalÄ±
                                    var worstNearCAdd = GetContract(worstSym, 0);
                                    var worstSpotBidDepthAdd = ReadDepth(SPOT_PREFIX + worstSym, "BID", 0, 1, 50);
                                    var worstNearAskDepthAdd = ReadDepth(FUTURES_PREFIX + worstNearCAdd, "ASK", 0, 1, 50);
                                    var worstSpotBidAdd = worstSpotBidDepthAdd.Item1 ? worstSpotBidDepthAdd.Item4 : 0m;
                                    var worstNearAskAdd = worstNearAskDepthAdd.Item1 ? worstNearAskDepthAdd.Item4 : 0m;
                                    var worstMultAdd = GetMultiplier(worstSym);
                                    var worstCurrentPnlAdd = (worstSpotBidAdd - oldPos[2]) * oldPosSQty + (oldPos[3] - worstNearAskAdd) * oldPosNQty * worstMultAdd;
                                    worstCurrentPnlAdd -= thisCloseCommAdd;  // Kapatma komisyonu
                                    
                                    if (worstCurrentPnlAdd < 0) {
                                        // Pozisyon zararda - bÃ¼yÃ¼tme bu zararÄ± + threshold kadar karÅŸÄ±lamalÄ±
                                        var minRequiredPnlAdd = Math.Abs(worstCurrentPnlAdd) * (1 + REPLACEMENT_THRESHOLD);
                                        if (addExpectedPnl < minRequiredPnlAdd) {
                                            Log("â­ï¸ BÃœYÃœTME REZERV: " + worstSym + " zararÄ± Ã§ok yÃ¼ksek: " + worstCurrentPnlAdd.ToString("F0") + " TL, beklenen: " + addExpectedPnl.ToString("F0") + " < gerekli: " + minRequiredPnlAdd.ToString("F0"));
                                            closedForReserveAdd.Add(worstSym);
                                            continue;
                                        }
                                    }
                                    
                                    // Kapat
                                    Log("ğŸ”„ BÃœYÃœTME REZERV KAPANIÅ: " + worstSym + " kapatÄ±lÄ±yor (rezerv iÃ§in)");
                                    CloseSN(worstSym, GetContract(worstSym, 0), oldPosSQty, oldPosNQty, "RESERVE_ADD");
                                    
                                    if (!snPos.ContainsKey(worstSym)) {
                                        closedForReserveAdd.Add(worstSym);
                                        reserveCloseNeededAdd -= oldViopValue;
                                        Log("âœ… BÃœYÃœTME REZERV KAPANIÅ: " + worstSym + " kapatÄ±ldÄ±, kalan rezerv:" + Math.Max(0, reserveCloseNeededAdd).ToString("N0") + " TL");
                                    } else {
                                        Log("âŒ BÃœYÃœTME REZERV KAPANIÅ: " + worstSym + " kapanÄ±ÅŸ baÅŸarÄ±sÄ±z");
                                        closedForReserveAdd.Add(worstSym);
                                    }
                                }
                                
                                UpdateBalances();
                                continue;  // Bu sembol iÃ§in iÅŸlem tamamlandÄ±
                            }
                            // ============ BÃœYÃœTME REZERV MODU SONU ============
                            
                            // v17.2: Rezerv modu baÅŸarÄ±sÄ±z olduysa pas geÃ§
                            // Eski "Ã¶nce kapat sonra aÃ§" modu kaldÄ±rÄ±ldÄ± - spread kaÃ§Ä±rma riski yÃ¼ksek
                            // Rezervler yetmiyorsa zaten sistem dÃ¼zgÃ¼n Ã§alÄ±ÅŸmÄ±yor demektir
                            // Log("â­ï¸ " + sym + " bÃ¼yÃ¼tme iÃ§in rezerv yetersiz, atlanÄ±yor");
                            continue;
                    }
                }
            }
        } catch { }
    }
    
    // ====================================
    // NEAR-FAR (NF) STRATEJÄ°SÄ° DÃ–NGÃœSÃœ
    // ====================================
    if (NF_ENABLED && isMarketOpen && !isPaused && marginStatus < 2 && apiDataOk) {
        
        // NF saat kontrolÃ¼
        var nfNow = DateTime.Now;
        var nfTimeOk = (nfNow.Hour > NF_START_HOUR || (nfNow.Hour == NF_START_HOUR && nfNow.Minute >= NF_START_MIN)) &&
                       (nfNow.Hour < NF_END_HOUR || (nfNow.Hour == NF_END_HOUR && nfNow.Minute <= NF_END_MIN));
        
        // NF bÃ¼tÃ§e kontrolÃ¼
        var nfAvailableBudget = NF_BUDGET - nfViopUsed;
        
        foreach (var sym in symbols) {
            try {
                if (IsBlocked(sym)) continue;
                
                // SPOT DEVRE KESÄ°CÄ° kontrolÃ¼
                var nfSpotCircuit = IsSpotCircuitBreaker(sym);
                
                // Ã‡akÄ±ÅŸma kontrolÃ¼: Spot-Near'da bu sembol varsa NF iÅŸlem yapma
                if (snPos.ContainsKey(sym)) continue;
                
                var nearC = GetContract(sym, 0);
                var farC = GetContract(sym, 1);
                
                // Mevcut NF pozisyonu varsa, kayÄ±tlÄ± kontrat kodlarÄ±nÄ± kullan
                if (nfPos.ContainsKey(sym) && nfContracts.ContainsKey(sym)) {
                    nearC = nfContracts[sym][0];
                    farC = nfContracts[sym][1];
                }
                
                if (string.IsNullOrEmpty(nearC) || string.IsNullOrEmpty(farC)) continue;
                
                var nearS = FUTURES_PREFIX + nearC;
                var farS = FUTURES_PREFIX + farC;
                
                var daysN = GetDays(nearC);
                var daysF = GetDays(farC);
                
                // Near vadesi dolmak Ã¼zere ise NF aÃ§ma
                if (daysN <= 1) continue;
                
                // Derinlik oku
                var nearBidDepth = ReadDepth(nearS, "BID", 0, 1, 50);
                var nearAskDepth = ReadDepth(nearS, "ASK", 0, 1, 50);
                var farBidDepth = ReadDepth(farS, "BID", 0, 1, 50);
                var farAskDepth = ReadDepth(farS, "ASK", 0, 1, 50);
                
                var nearBid = nearBidDepth.Item1 ? nearBidDepth.Item4 : 0m;
                var nearAsk = nearAskDepth.Item1 ? nearAskDepth.Item4 : 0m;
                var farBid = farBidDepth.Item1 ? farBidDepth.Item4 : 0m;
                var farAsk = farAskDepth.Item1 ? farAskDepth.Item4 : 0m;
                
                if (nearAsk <= 0 || farBid <= 0) continue;
                
                // NF spread BB pozisyonu (SN BB'yi kullanÄ±yoruz)
                var nfBBPos = snBBPos.ContainsKey(sym) ? snBBPos[sym] : 50m;
                
                // === NF KAPANIÅ KONTROLÃœ ===
                // Devre kesicide bile kar alma yapÄ±labilir (spread daralabilir)
                if (nfPos.ContainsKey(sym)) {
                    var closeReason = CheckNFClose(sym, nearC, farC, nearBid, farAsk, daysN);
                    if (closeReason != null) {
                        var nfP = nfPos[sym];
                        CloseNF(sym, nearC, farC, (int)nfP[0], (int)nfP[1], closeReason);
                        UpdateBalances();
                    }
                    continue;  // Pozisyon varsa yeni aÃ§ma
                }
                
                // === NF AÃ‡ILIÅ KONTROLÃœ ===
                // Endeks veya spot devre kesici aktifse yeni pozisyon aÃ§ma
                if (indexCircuitBreaker || nfSpotCircuit) continue;
                if (!nfTimeOk) continue;  // Saat uygun deÄŸil
                if (nfPos.Count >= NF_MAX_POSITIONS) continue;  // Max pozisyon
                
                // AÃ‡ILIÅ VOLATÄ°LÄ°TESÄ° KORUMASI: 10:05'e kadar yeni giriÅŸ yapma
                if (!IsAfterOpeningVolatility()) continue;
                
                // TEMETTÃœ GÃœNÃœ KORUMASI: BB verisi henÃ¼z dÃ¼zeltilmemiÅŸ olabilir
                if (IsDividendDay(sym)) {
                    Log("âš ï¸ NF: " + sym + " temettÃ¼ gÃ¼nÃ¼ - giriÅŸ atlandÄ± (BB verisi gÃ¼venilmez)");
                    continue;
                }
                
                // SERMAYE ARTIRIMI KORUMASI: BugÃ¼n veya 7 gÃ¼n iÃ§inde sermaye artÄ±rÄ±mÄ± varsa atla
                if (IsSermayeArtirimiBlocked(sym)) {
                    Log("â›” NF: " + sym + " sermaye artÄ±rÄ±mÄ± - giriÅŸ atlandÄ±");
                    continue;
                }
                
                // BB >= 99 kontrolÃ¼
                if (nfBBPos < NF_ENTRY_BB) continue;
                
                // BÃ¼tÃ§e kontrolÃ¼
                var tem = teminat.ContainsKey(sym) ? teminat[sym] : 5000m;
                var reqNF = tem * 2;  // Near + Far teminat
                if (reqNF > nfAvailableBudget) continue;
                
                // NF spread hesapla (aÃ§Ä±lÄ±ÅŸ iÃ§in: Near AL @ nearAsk, Far SAT @ farBid)
                var nfSpread = CalcNFSpread(nearC, farC, nearAsk, farBid);
                
                // Spread pozitif olmalÄ± (Far > Near)
                if (nfSpread <= 0) continue;
                
                // Derinlik kontrolÃ¼
                var nearAskQty = nearAskDepth.Item2;
                var farBidQty = farBidDepth.Item2;
                if (nearAskQty < 1 || farBidQty < 1) continue;
                
                var qty = 1;  // NF iÃ§in 1 lot
                
                Log("ğŸ”· NF FÄ±rsat: " + sym + " BB:" + nfBBPos.ToString("F0") + " Spread:" + (nfSpread * 100).ToString("F3") + "%");
                
                if (OpenNF(sym, nearC, farC, qty)) {
                    nfAvailableBudget -= reqNF;
                    UpdateBalances();
                }
            } catch { }
        }
    }
    
    // ====================================
    // PAIR TRADING STRATEJÄ°SÄ° DÃ–NGÃœSÃœ
    // ====================================
    if (PAIR_ENABLED && isMarketOpen && !isPaused && marginStatus < 2 && apiDataOk) {
        try {
            // Ã–nce bekleyen emirleri kontrol et
            CheckPairPending();
            // Sonra yeni sinyalleri kontrol et
            CheckPairSignals();
        } catch (Exception ex) {
            Log("âŒ PAIR hata: " + ex.Message);
        }
    }
    
    // Stats kaydet
    try {
        var sb = new System.Text.StringBuilder();
        var totalComm = dailySpotCommission + totalTransferredComm + dailyViopCommission;
        
        // DÃ¶nemsel istatistikler
        var weekStats = CalcPeriodStats(7);
        var monthStats = CalcPeriodStats(30);
        var allStats = CalcAllTimeStats();
        
        sb.Append("{\"ts\":\"" + DateTime.Now.ToString("HH:mm:ss") + "\",");
        sb.Append("\"test\":" + (IS_TEST ? "true" : "false") + ",");
        sb.Append("\"running\":" + (isRunning ? "true" : "false") + ",");
        sb.Append("\"market\":" + (isMarketOpen ? "true" : "false") + ",");
        sb.Append("\"paused\":" + (isPaused ? "true" : "false") + ",");
        sb.Append("\"data\":" + (dataConnected ? "true" : "false") + ",");
        sb.Append("\"broker\":" + (brokerConnected ? "true" : "false") + ",");
        sb.Append("\"viop_bal\":" + viopBalance.ToString("F0", ic) + ",\"spot_bal\":" + spotBudgetTotal.ToString("F0", ic) + ",");
        sb.Append("\"viop_used\":" + viopUsed.ToString(ic) + ",\"spot_used\":" + spotUsed.ToString(ic) + ",");
        sb.Append("\"daily_pnl\":" + dailyRealizedPnl.ToString("F0", ic) + ",\"trades\":" + dailyTrades + ",");
        sb.Append("\"total_comm\":" + totalComm.ToString("F2", ic) + ",");
        sb.Append("\"risk_free\":" + RISK_FREE.ToString("F4", ic) + ",");
        
        sb.Append("\"week\":{\"pnl\":" + weekStats[0].ToString("F0", ic) + 
            ",\"comm\":" + (weekStats[1] + weekStats[2]).ToString("F0", ic) + 
            ",\"trades\":" + ((int)weekStats[3]).ToString() + 
            ",\"days\":" + ((int)weekStats[4]).ToString() + "},");
        sb.Append("\"month\":{\"pnl\":" + monthStats[0].ToString("F0", ic) + 
            ",\"comm\":" + (monthStats[1] + monthStats[2]).ToString("F0", ic) + 
            ",\"trades\":" + ((int)monthStats[3]).ToString() + 
            ",\"days\":" + ((int)monthStats[4]).ToString() + "},");
        sb.Append("\"all\":{\"pnl\":" + allStats[0].ToString("F0", ic) + 
            ",\"comm\":" + (allStats[1] + allStats[2]).ToString("F0", ic) + 
            ",\"trades\":" + ((int)allStats[3]).ToString() + 
            ",\"days\":" + ((int)allStats[4]).ToString() + "},");
        
        sb.Append("\"positions\":{" + snStats.ToString() + "},");
        
        // NF pozisyonlarÄ±
        sb.Append("\"nf_positions\":{");
        var nfFirst = true;
        decimal totalNfPnl = 0;
        foreach (var kv in nfPos) {
            if (!nfFirst) sb.Append(",");
            nfFirst = false;
            var nfSym = kv.Key;
            var nfP = kv.Value;
            var nearC = nfContracts.ContainsKey(nfSym) ? nfContracts[nfSym][0] : GetContract(nfSym, 0);
            var farC = nfContracts.ContainsKey(nfSym) ? nfContracts[nfSym][1] : GetContract(nfSym, 1);
            var nearS = FUTURES_PREFIX + nearC;
            var farS = FUTURES_PREFIX + farC;
            
            // P&L hesapla
            var nearBidD = ReadDepth(nearS, "BID", 0, 1, 50);
            var farAskD = ReadDepth(farS, "ASK", 0, 1, 50);
            var nearBidP = nearBidD.Item1 ? nearBidD.Item4 : nfP[2];
            var farAskP = farAskD.Item1 ? farAskD.Item4 : nfP[3];
            var nfMult = GetMultiplier(nfSym);
            var nfPnl = (nearBidP - nfP[2]) * nfP[0] * nfMult + (nfP[3] - farAskP) * nfP[1] * nfMult;
            totalNfPnl += nfPnl;
            
            sb.Append("\"" + nfSym + "\":{");
            sb.Append("\"nq\":" + ((int)nfP[0]).ToString() + ",\"fq\":" + ((int)nfP[1]).ToString() + ",");
            sb.Append("\"pnl\":" + nfPnl.ToString("F0", ic) + ",\"exp\":" + nfP[5].ToString("F0", ic) + ",");
            sb.Append("\"d\":" + GetDays(nearC).ToString() + "}");
        }
        sb.Append("},");
        sb.Append("\"nf_count\":" + nfPos.Count + ",");
        
        // Bekleyen emirler
        sb.Append("\"pending\":{");
        var pendFirst = true;
        foreach (var pk in pendingOrders) {
            if (!pendFirst) sb.Append(",");
            pendFirst = false;
            var pd = pk.Value;
            var waitMin = (DateTime.Now - (DateTime)pd[3]).TotalMinutes;
            sb.Append("\"" + pk.Key + "\":{");
            sb.Append("\"side\":\"" + pd[0] + "\",");
            sb.Append("\"qty\":" + ((int)pd[1]).ToString() + ",");
            sb.Append("\"price\":" + ((decimal)pd[2]).ToString("F2", ic) + ",");
            sb.Append("\"wait\":" + waitMin.ToString("F0", ic) + ",");
            sb.Append("\"processed\":" + (pd.Length > 11 ? ((int)pd[11]).ToString() : "0") + "}");
        }
        sb.Append("},");
        sb.Append("\"pending_count\":" + pendingOrders.Count + ",");
        
        // Yetim bacaklar
        sb.Append("\"orphans\":{");
        var orphFirst2 = true;
        foreach (var kv in orphanLegs) {
            if (!orphFirst2) sb.Append(",");
            orphFirst2 = false;
            var o = kv.Value;
            sb.Append("\"" + kv.Key + "\":{");
            sb.Append("\"fl\":\"" + o[0] + "\",");              // filledLeg
            sb.Append("\"fs\":\"" + o[2] + "\",");              // filledSide
            sb.Append("\"fq\":" + ((int)o[3]).ToString() + ","); // filledQty
            sb.Append("\"fp\":" + ((decimal)o[4]).ToString("F2", ic) + ","); // filledPrice
            sb.Append("\"tl\":\"" + o[5] + "\"}");              // targetLeg
        }
        sb.Append("},");
        sb.Append("\"orphan_count\":" + orphanLegs.Count + ",");
        
        // Pair Trading stats
        sb.Append("\"pair_enabled\":" + (PAIR_ENABLED ? "true" : "false") + ",");
        sb.Append("\"pair_budget\":" + PAIR_BUDGET.ToString("F0", ic) + ",");
        sb.Append("\"pair_used\":" + pairUsed.ToString("F0", ic) + ",");
        sb.Append("\"pair_count\":" + pairPos.Count + ",");
        
        // Pair Z-Scores
        sb.Append("\"pair_z\":{");
        var zFirst = true;
        foreach (var kv in pairZScores) {
            if (!zFirst) sb.Append(",");
            zFirst = false;
            sb.Append("\"" + kv.Key + "\":" + kv.Value.ToString("F2", ic));
        }
        sb.Append("},");
        
        // Pair pozisyonlarÄ± (detaylÄ±: anlÄ±k ve beklenen kar)
        sb.Append("\"pair_pos\":{");
        var ppFirst = true;
        decimal totalPairPnl = 0;
        foreach (var kv in pairPos) {
            if (!ppFirst) sb.Append(",");
            ppFirst = false;
            var p = kv.Value;
            var parts = kv.Key.Split('-');
            if (parts.Length == 2) {
                var symA = parts[0];
                var symB = parts[1];
                var currentZ = pairZScores.ContainsKey(kv.Key) ? pairZScores[kv.Key] : 0m;
                var unrealizedPnl = CalcPairUnrealizedPnl(kv.Key, p);
                var expectedPnl = p.Length > 7 ? p[7] : 0m;
                totalPairPnl += unrealizedPnl;
                
                // Vade gÃ¼n sayÄ±sÄ±
                var nearA = GetContract(symA, 0);
                var daysToExp = string.IsNullOrEmpty(nearA) ? 0 : GetDays(nearA);
                
                sb.Append("\"" + kv.Key + "\":{");
                sb.Append("\"a\":" + ((int)p[0]).ToString() + ",");
                sb.Append("\"b\":" + ((int)p[1]).ToString() + ",");
                sb.Append("\"avgA\":" + p[2].ToString("F2", ic) + ",");
                sb.Append("\"avgB\":" + p[3].ToString("F2", ic) + ",");
                sb.Append("\"oz\":" + p[4].ToString("F2", ic) + ",");
                sb.Append("\"cz\":" + currentZ.ToString("F2", ic) + ",");
                sb.Append("\"t\":" + ((int)p[5]).ToString() + ",");
                sb.Append("\"exp\":" + expectedPnl.ToString("F0", ic) + ",");
                sb.Append("\"pnl\":" + unrealizedPnl.ToString("F0", ic) + ",");
                sb.Append("\"d\":" + daysToExp.ToString() + "}");
            }
        }
        sb.Append("},");
        sb.Append("\"pair_pnl\":" + totalPairPnl.ToString("F0", ic) + ",");
        
        sb.Append("\"total_pnl\":" + (totalSnPnl + totalNfPnl + totalPairPnl).ToString("F0", ic) + ",\"count\":" + (snPos.Count + nfPos.Count + pairPos.Count) + "}");
        SafeWrite(STATS_FILE, sb.ToString());
        
        // Dashboard gÃ¼ncelle (dakikada bir)
        if ((DateTime.Now - lastGistUpload).TotalMinutes >= GIST_INTERVAL_MIN) {
            UpdateDashboard(false, true);  // resetCommand=false, includeLogs=true
        }
        
        // BB verisi gÃ¼ncelle (5 dakikalÄ±k bar tamamlandÄ±ktan sonra)
        // Bar kapanÄ±ÅŸ zamanlarÄ±: XX:00, XX:05, XX:10, XX:15, XX:20, XX:25, XX:30, XX:35, XX:40, XX:45, XX:50, XX:55
        var bbNow = DateTime.Now;
        var currentMinute = bbNow.Minute;
        var isBarCloseTime = (currentMinute % 5 == 0) && bbNow.Second <= 30;  // Bar kapanÄ±ÅŸÄ±ndan sonraki 30 sn iÃ§inde
        var lastRefreshMinute = lastBBRefresh.Minute;
        var minutesSinceRefresh = (bbNow - lastBBRefresh).TotalMinutes;
        
        // KoÅŸul: Bar kapanÄ±ÅŸ zamanÄ±ndayÄ±z VE (son gÃ¼ncelleme 4+ dk Ã¶nce VEYA farklÄ± bar'dayÄ±z)
        if (isBarCloseTime && (minutesSinceRefresh >= 4 || (currentMinute / 5) != (lastRefreshMinute / 5))) {
            try { LoadSpreadBBFromChart(); } catch { }
        }
    } catch { }
};

// ====================================
// FORM
// ====================================
System.Windows.Forms.Form posForm = null;
System.Windows.Forms.DataGridView gridSn = null;
System.Windows.Forms.Label lblPosUpdate = null;
System.Windows.Forms.Label lblSnTotal = null;
System.Windows.Forms.Timer posTimer = null;

// JSON'dan sayÄ± Ã§Ä±karan yardÄ±mcÄ± fonksiyon
Func<string, int, string> ExtractNumber = (s, start) => {
    var sb = new System.Text.StringBuilder();
    for (int i = start; i < s.Length; i++) {
        var c = s[i];
        if (char.IsDigit(c) || c == '.' || c == '-') sb.Append(c);
        else if (sb.Length > 0) break;
    }
    return sb.ToString();
};

Action UpdatePositionsGrid = null;
UpdatePositionsGrid = () => {
    if (posForm == null || posForm.IsDisposed || gridSn == null) return;
    try {
        posForm.BeginInvoke(new Action(() => {
            try {
                if (!System.IO.File.Exists(STATS_FILE)) return;
                var json = System.IO.File.ReadAllText(STATS_FILE);
                var ic = System.Globalization.CultureInfo.InvariantCulture;
                
                decimal totalPnl = 0;
                decimal totalExp = 0;
                gridSn.Rows.Clear();
                
                // positions bÃ¶lÃ¼mÃ¼nÃ¼ bul
                var posIdx = json.IndexOf("\"positions\":{");
                if (posIdx == -1) { gridSn.Rows.Add("Pozisyon yok", "-", "-", "-", "-", "-"); return; }
                
                var posStart = json.IndexOf("{", posIdx + 12);
                var posEnd = json.IndexOf("}}", posStart);
                if (posStart == -1 || posEnd == -1) return;
                
                var posContent = json.Substring(posStart, posEnd - posStart + 1);
                if (posContent == "{}") { gridSn.Rows.Add("Pozisyon yok", "-", "-", "-", "-", "-"); return; }
                
                // Her pozisyonu parse et
                int pos = 0;
                while (pos < posContent.Length) {
                    var q1 = posContent.IndexOf("\"", pos);
                    if (q1 == -1) break;
                    var q2 = posContent.IndexOf("\"", q1 + 1);
                    if (q2 == -1) break;
                    var sym = posContent.Substring(q1 + 1, q2 - q1 - 1);
                    
                    var objStart = posContent.IndexOf("{", q2);
                    var objEnd = posContent.IndexOf("}", objStart);
                    if (objStart == -1 || objEnd == -1) break;
                    
                    var objStr = posContent.Substring(objStart, objEnd - objStart + 1);
                    
                    // sq, nq, pnl, exp, d parse et
                    int sq = 0, nq = 0, d = 0;
                    decimal pnl = 0, exp = 0;
                    
                    var sqIdx = objStr.IndexOf("\"sq\":");
                    if (sqIdx >= 0) int.TryParse(ExtractNumber(objStr, sqIdx + 5), out sq);
                    
                    var nqIdx = objStr.IndexOf("\"nq\":");
                    if (nqIdx >= 0) int.TryParse(ExtractNumber(objStr, nqIdx + 5), out nq);
                    
                    var pnlIdx = objStr.IndexOf("\"pnl\":");
                    if (pnlIdx >= 0) decimal.TryParse(ExtractNumber(objStr, pnlIdx + 6), System.Globalization.NumberStyles.Any, ic, out pnl);
                    
                    var expIdx = objStr.IndexOf("\"exp\":");
                    if (expIdx >= 0) decimal.TryParse(ExtractNumber(objStr, expIdx + 6), System.Globalization.NumberStyles.Any, ic, out exp);
                    
                    var dIdx = objStr.IndexOf("\"d\":");
                    if (dIdx >= 0) int.TryParse(ExtractNumber(objStr, dIdx + 4), out d);
                    
                    totalPnl += pnl;
                    totalExp += exp;
                    
                    var row = gridSn.Rows.Add(sym, sq, nq, exp.ToString("N0"), pnl.ToString("N0"), d);
                    gridSn.Rows[row].Cells[3].Style.ForeColor = exp >= 0 ? System.Drawing.Color.Green : System.Drawing.Color.Red;
                    gridSn.Rows[row].Cells[4].Style.ForeColor = pnl >= 0 ? System.Drawing.Color.Green : System.Drawing.Color.Red;
                    
                    pos = objEnd + 1;
                }
                
                if (gridSn.Rows.Count == 0) gridSn.Rows.Add("Pozisyon yok", "-", "-", "-", "-", "-");
                lblSnTotal.Text = "Beklenen: " + totalExp.ToString("N0") + " | P&L: " + totalPnl.ToString("N0") + " TL";
                lblSnTotal.ForeColor = totalPnl >= 0 ? System.Drawing.Color.Green : System.Drawing.Color.Red;
                lblPosUpdate.Text = "GÃ¼ncelleme: " + DateTime.Now.ToString("HH:mm:ss");
            } catch { }
        }));
    } catch { }
};

Action ShowPositionsForm = () => {
    if (posForm != null && !posForm.IsDisposed) { posForm.BringToFront(); return; }
    if (mainForm != null) mainForm.TopMost = false;
    
    posForm = new System.Windows.Forms.Form();
    posForm.Text = "Spot-Near Pozisyonlar";
    posForm.Size = new System.Drawing.Size(600, 300);
    posForm.TopMost = true;
    
    gridSn = new System.Windows.Forms.DataGridView();
    gridSn.Location = new System.Drawing.Point(10, 10);
    gridSn.Size = new System.Drawing.Size(565, 180);
    gridSn.AllowUserToAddRows = false;
    gridSn.ReadOnly = true;
    gridSn.AutoSizeColumnsMode = System.Windows.Forms.DataGridViewAutoSizeColumnsMode.Fill;
    gridSn.Columns.Add("Sym", "Sembol");
    gridSn.Columns.Add("Spot", "Spot Adet");
    gridSn.Columns.Add("Near", "Near Adet");
    gridSn.Columns.Add("Exp", "Beklenen");
    gridSn.Columns.Add("PnL", "P&L");
    gridSn.Columns.Add("Days", "GÃ¼n");
    
    lblSnTotal = new System.Windows.Forms.Label();
    lblSnTotal.Location = new System.Drawing.Point(280, 200);
    lblSnTotal.Size = new System.Drawing.Size(290, 25);
    lblSnTotal.Font = new System.Drawing.Font("Segoe UI", 11, System.Drawing.FontStyle.Bold);
    
    lblPosUpdate = new System.Windows.Forms.Label();
    lblPosUpdate.Location = new System.Drawing.Point(10, 200);
    lblPosUpdate.Size = new System.Drawing.Size(200, 20);
    lblPosUpdate.ForeColor = System.Drawing.Color.Gray;
    
    var btnClose = new System.Windows.Forms.Button();
    btnClose.Text = "Kapat";
    btnClose.Location = new System.Drawing.Point(250, 225);
    btnClose.Click += (s, e) => posForm.Close();
    
    posForm.Controls.AddRange(new System.Windows.Forms.Control[] { gridSn, lblSnTotal, lblPosUpdate, btnClose });
    
    posTimer = new System.Windows.Forms.Timer();
    posTimer.Interval = IS_TEST ? 10000 : 5000;  // Test: 10sn, Live: 5sn
    posTimer.Tick += (s, e) => UpdatePositionsGrid();
    posTimer.Start();
    
    posForm.FormClosing += (s, e) => { if (posTimer != null) posTimer.Stop(); if (mainForm != null) mainForm.TopMost = true; };
    UpdatePositionsGrid();
    posForm.Show();
};

Action ShowSettingsForm = () => {
    var sf = new System.Windows.Forms.Form();
    sf.Text = "Ayarlar";
    sf.Size = new System.Drawing.Size(760, 720);  // Butonlar iÃ§in yÃ¼kseklik artÄ±rÄ±ldÄ±
    sf.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedDialog;
    sf.StartPosition = System.Windows.Forms.FormStartPosition.CenterParent;
    sf.MaximizeBox = false;
    
    var ic = System.Globalization.CultureInfo.InvariantCulture;
    
    // ==================== SOL SÃœTUN (x=15) ====================
    var leftX = 15;
    var leftLabelW = 95;
    var leftInputX = 115;
    var leftInputW = 100;
    var y = 15;
    
    // Gist ayarlarÄ±
    var lblGistToken = new System.Windows.Forms.Label { Text = "Gist Token:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(80, 20) };
    var txtGistToken = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX - 15, y), Size = new System.Drawing.Size(250, 22), Text = GIST_TOKEN, PasswordChar = '*' };
    y += 26;
    var lblGistId = new System.Windows.Forms.Label { Text = "Gist ID:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(80, 20) };
    var txtGistId = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX - 15, y), Size = new System.Drawing.Size(250, 22), Text = GIST_ID };
    y += 32;
    
    // AyraÃ§ - BÃ¼tÃ§e
    var sep1 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(340, 2) };
    y += 8;
    var lblBudgetTitle = new System.Windows.Forms.Label { Text = "ğŸ’° BÃœTÃ‡E", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(100, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.DarkBlue };
    y += 22;
    
    var lblViop = new System.Windows.Forms.Label { Text = "VIOP BÃ¼tÃ§e:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtViop = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = VIOP_BUDGET.ToString("F0") };
    y += 26;
    var lblSpot = new System.Windows.Forms.Label { Text = "Spot BÃ¼tÃ§e:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtSpot = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = SPOT_BUDGET.ToString("F0") };
    y += 32;
    
    // AyraÃ§ - SN Strateji
    var sep2 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(340, 2) };
    y += 8;
    var lblSNTitle = new System.Windows.Forms.Label { Text = "ğŸ“Š SN STRATEJÄ°", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(120, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.DarkBlue };
    y += 22;
    
    var lblMargin = new System.Windows.Forms.Label { Text = "Min Marj %:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtMargin = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = (SN_MIN_MARGIN * 100).ToString("F2", ic) };
    y += 26;
    var lblRollMargin = new System.Windows.Forms.Label { Text = "Roll Min %:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtRollMargin = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = (ROLL_MIN_MARGIN * 100).ToString("F2", ic) };
    y += 26;
    var lblReplaceThresh = new System.Windows.Forms.Label { Text = "Replace %:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtReplaceThresh = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = (REPLACEMENT_THRESHOLD * 100).ToString("F0", ic) };
    y += 26;
    var lblGieDepth = new System.Windows.Forms.Label { Text = "GIE Kademe:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtGieDepth = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = GIE_DEPTH_LEVELS.ToString() };
    y += 32;
    
    // AyraÃ§ - Risk
    var sep3 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(340, 2) };
    y += 8;
    var lblRiskTitle = new System.Windows.Forms.Label { Text = "âš ï¸ RÄ°SK", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(100, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.DarkRed };
    y += 22;
    
    var lblLoss = new System.Windows.Forms.Label { Text = "Max Zarar:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtLoss = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(leftInputW, 22), Text = MAX_DAILY_LOSS.ToString("F0") };
    y += 26;
    var lblEarlyK = new System.Windows.Forms.Label { Text = "Erken Ã‡Ä±kÄ±ÅŸ K:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtEarlyK = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(60, 22), Text = EARLY_EXIT_K.ToString("F2", ic) };
    var lblEarlyKHint = new System.Windows.Forms.Label { Text = "(dinamik)", Location = new System.Drawing.Point(leftInputX + 65, y), Size = new System.Drawing.Size(60, 20), ForeColor = System.Drawing.Color.Gray };
    y += 26;
    var lblBBExit = new System.Windows.Forms.Label { Text = "BB Ã‡Ä±kÄ±ÅŸ Ref:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtBBExit = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(60, 22), Text = BB_EXIT_HELPER.ToString("F0", ic) };
    var lblBBExitHint = new System.Windows.Forms.Label { Text = "(BB5 altÄ±)", Location = new System.Drawing.Point(leftInputX + 65, y), Size = new System.Drawing.Size(60, 20), ForeColor = System.Drawing.Color.Gray };
    y += 26;
    var lblIntraday = new System.Windows.Forms.Label { Text = "GÃ¼n Ä°Ã§i Minâ€°:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtIntraday = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(60, 22), Text = (INTRADAY_MIN_PROFIT * 1000).ToString("F1", ic) };
    var lblIntradayHint = new System.Windows.Forms.Label { Text = "(binde)", Location = new System.Drawing.Point(leftInputX + 65, y), Size = new System.Drawing.Size(50, 20), ForeColor = System.Drawing.Color.Gray };
    y += 32;
    
    // AyraÃ§ - Margin
    var sep4 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(340, 2) };
    y += 8;
    var lblMarginTitle = new System.Windows.Forms.Label { Text = "ğŸ›¡ï¸ MARJÄ°N", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(100, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.DarkOrange };
    y += 22;
    
    var lblMarginWarn = new System.Windows.Forms.Label { Text = "SarÄ± %:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(50, 20) };
    var txtMarginWarn = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 55, y), Size = new System.Drawing.Size(40, 22), Text = (MARGIN_WARNING_PCT * 100).ToString("F0", ic) };
    var lblMarginDanger = new System.Windows.Forms.Label { Text = "Turuncu:", Location = new System.Drawing.Point(leftX + 105, y), Size = new System.Drawing.Size(55, 20) };
    var txtMarginDanger = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 165, y), Size = new System.Drawing.Size(40, 22), Text = (MARGIN_DANGER_PCT * 100).ToString("F0", ic) };
    var lblMarginCrit = new System.Windows.Forms.Label { Text = "KÄ±rmÄ±zÄ±:", Location = new System.Drawing.Point(leftX + 215, y), Size = new System.Drawing.Size(50, 20) };
    var txtMarginCrit = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 270, y), Size = new System.Drawing.Size(40, 22), Text = (MARGIN_CRITICAL_PCT * 100).ToString("F0", ic) };
    y += 32;
    
    // AyraÃ§ - BB93
    var sep5 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(340, 2) };
    y += 8;
    var lblBB93Title = new System.Windows.Forms.Label { Text = "ğŸ¯ BB93 STRATEJÄ°SÄ°", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(140, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.Purple };
    y += 22;
    
    var chkBB93 = new System.Windows.Forms.CheckBox { Text = "Aktif", Location = new System.Drawing.Point(leftX, y), Checked = BB93_ENTRY_ENABLED, Size = new System.Drawing.Size(55, 20) };
    var txtBB93StartHour = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 60, y), Size = new System.Drawing.Size(35, 22), Text = BB93_START_HOUR.ToString() };
    var lblBB93Sep1 = new System.Windows.Forms.Label { Text = ":", Location = new System.Drawing.Point(leftX + 97, y), Size = new System.Drawing.Size(10, 20) };
    var txtBB93StartMin = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 107, y), Size = new System.Drawing.Size(35, 22), Text = BB93_START_MIN.ToString("D2") };
    var lblBB93Dash = new System.Windows.Forms.Label { Text = "-", Location = new System.Drawing.Point(leftX + 147, y), Size = new System.Drawing.Size(15, 20) };
    var txtBB93EndHour = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 162, y), Size = new System.Drawing.Size(35, 22), Text = BB93_END_HOUR.ToString() };
    var lblBB93Sep2 = new System.Windows.Forms.Label { Text = ":", Location = new System.Drawing.Point(leftX + 199, y), Size = new System.Drawing.Size(10, 20) };
    var txtBB93EndMin = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftX + 209, y), Size = new System.Drawing.Size(35, 22), Text = BB93_END_MIN.ToString("D2") };
    y += 32;
    
    // AyraÃ§ - Cache
    var sep6 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(340, 2) };
    y += 8;
    var lblCachePath = new System.Windows.Forms.Label { Text = "Cache Yolu:", Location = new System.Drawing.Point(leftX, y), Size = new System.Drawing.Size(leftLabelW, 20) };
    var txtCachePath = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(230, 22), Text = CACHE_PATH != BASE_PATH ? CACHE_PATH : "" };
    y += 20;
    var lblCacheHint = new System.Windows.Forms.Label { Text = "(BoÅŸ=D:\\arbit\\, RAMDisk iÃ§in Z:\\ gibi)", Location = new System.Drawing.Point(leftInputX, y), Size = new System.Drawing.Size(220, 16), ForeColor = System.Drawing.Color.Gray, Font = new System.Drawing.Font("Segoe UI", 7.5f) };
    y += 26;
    
    var chkTest = new System.Windows.Forms.CheckBox { Text = "ğŸ§ª Test Modu", Location = new System.Drawing.Point(leftX, y), Checked = IS_TEST, Size = new System.Drawing.Size(120, 20), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold) };
    
    // ==================== SAÄ SÃœTUN (x=390) ====================
    var rightX = 390;
    var rightLabelW = 95;
    var rightInputX = 490;
    var rightInputW = 100;
    var yR = 68;  // Gist satÄ±rlarÄ±nÄ±n altÄ±ndan baÅŸla
    
    // AyraÃ§ - NF
    var sepR1 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(340, 2) };
    yR += 8;
    var lblNFTitle = new System.Windows.Forms.Label { Text = "ğŸ”„ NEAR-FAR STRATEJÄ°SÄ°", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(180, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.DarkGreen };
    yR += 22;
    
    var chkNF = new System.Windows.Forms.CheckBox { Text = "Aktif", Location = new System.Drawing.Point(rightX, yR), Checked = NF_ENABLED, Size = new System.Drawing.Size(55, 20) };
    var lblNFMax = new System.Windows.Forms.Label { Text = "Max Poz:", Location = new System.Drawing.Point(rightX + 70, yR), Size = new System.Drawing.Size(60, 20) };
    var txtNFMax = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 135, yR), Size = new System.Drawing.Size(40, 22), Text = NF_MAX_POSITIONS.ToString() };
    yR += 26;
    
    var lblNFEntryBB = new System.Windows.Forms.Label { Text = "GiriÅŸ BB â‰¥", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(70, 20) };
    var txtNFEntryBB = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 75, yR), Size = new System.Drawing.Size(40, 22), Text = NF_ENTRY_BB.ToString() };
    var lblNFExitBB = new System.Windows.Forms.Label { Text = "Ã‡Ä±kÄ±ÅŸ BB â‰¤", Location = new System.Drawing.Point(rightX + 130, yR), Size = new System.Drawing.Size(70, 20) };
    var txtNFExitBB = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 205, yR), Size = new System.Drawing.Size(40, 22), Text = NF_EXIT_BB.ToString() };
    yR += 26;
    
    var lblNFProfit = new System.Windows.Forms.Label { Text = "KÃ¢r Ã‡Ä±kÄ±ÅŸ â€°:", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(80, 20) };
    var txtNFProfit = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 85, yR), Size = new System.Drawing.Size(40, 22), Text = (NF_EXIT_PROFIT * 1000).ToString("F1") };
    var lblNFProfitHint = new System.Windows.Forms.Label { Text = "(binde)", Location = new System.Drawing.Point(rightX + 130, yR), Size = new System.Drawing.Size(50, 20), ForeColor = System.Drawing.Color.Gray };
    yR += 38;
    
    // AyraÃ§ - PAIR
    var sepR2 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(340, 2) };
    yR += 8;
    var lblPairTitle = new System.Windows.Forms.Label { Text = "ğŸ“Š PAIR TRADING", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(140, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.Teal };
    yR += 22;
    
    var chkPair = new System.Windows.Forms.CheckBox { Text = "Aktif", Location = new System.Drawing.Point(rightX, yR), Checked = PAIR_ENABLED, Size = new System.Drawing.Size(55, 20) };
    var lblPairBudget = new System.Windows.Forms.Label { Text = "BÃ¼tÃ§e:", Location = new System.Drawing.Point(rightX + 70, yR), Size = new System.Drawing.Size(50, 20) };
    var txtPairBudget = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 120, yR), Size = new System.Drawing.Size(80, 22), Text = PAIR_BUDGET.ToString("F0") };
    yR += 28;
    
    var lblPairAlloc = new System.Windows.Forms.Label { Text = "DaÄŸÄ±lÄ±m %:", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(70, 20) };
    var txtPairAlloc1 = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 75, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_ALLOC_1.ToString() };
    var txtPairAlloc2 = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 115, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_ALLOC_2.ToString() };
    var txtPairAlloc3 = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 155, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_ALLOC_3.ToString() };
    var lblPairAllocHint = new System.Windows.Forms.Label { Text = "(K1/K2/K3)", Location = new System.Drawing.Point(rightX + 195, yR), Size = new System.Drawing.Size(70, 20), ForeColor = System.Drawing.Color.Gray };
    yR += 28;
    
    var lblPairZ1 = new System.Windows.Forms.Label { Text = "Z GiriÅŸ:", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(55, 20) };
    var txtPairZ1 = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 55, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_Z_ENTRY_1.ToString("F1", ic) };
    var txtPairZ2 = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 95, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_Z_ENTRY_2.ToString("F1", ic) };
    var txtPairZ3 = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 135, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_Z_ENTRY_3.ToString("F1", ic) };
    var lblPairZExit = new System.Windows.Forms.Label { Text = "Ã‡Ä±kÄ±ÅŸ:", Location = new System.Drawing.Point(rightX + 180, yR), Size = new System.Drawing.Size(40, 20) };
    var txtPairZExit = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX + 220, yR), Size = new System.Drawing.Size(35, 22), Text = PAIR_Z_EXIT.ToString("F1", ic) };
    yR += 32;
    
    // AyraÃ§ - Ã‡ift TanÄ±mlarÄ±
    var sepR3 = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(340, 2) };
    yR += 8;
    var lblPairDefsTitle = new System.Windows.Forms.Label { Text = "ğŸ“ Ã‡Ä°FT TANIMLARI", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(140, 18), Font = new System.Drawing.Font("Segoe UI", 9, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.DarkSlateGray };
    yR += 22;
    
    var txtPairDefs = new System.Windows.Forms.TextBox { Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(340, 22), Text = PAIR_DEFINITIONS };
    yR += 22;
    var lblPairDefsHint = new System.Windows.Forms.Label { Text = "(SYM1-SYM2:beta, ... Ã¶rn: TCELL-TTKOM:1.80)", Location = new System.Drawing.Point(rightX, yR), Size = new System.Drawing.Size(340, 16), ForeColor = System.Drawing.Color.Gray, Font = new System.Drawing.Font("Segoe UI", 7.5f) };
    yR += 30;
    
    // Butonlar (ortalanmÄ±ÅŸ)
    var btnY = Math.Max(y + 30, yR + 30);
    var btnSave = new System.Windows.Forms.Button();
    btnSave.Text = "Kaydet";
    btnSave.Location = new System.Drawing.Point(280, btnY);
    btnSave.Size = new System.Drawing.Size(90, 32);
    btnSave.BackColor = System.Drawing.Color.FromArgb(46, 125, 50);
    btnSave.ForeColor = System.Drawing.Color.White;
    btnSave.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
    btnSave.Click += (s, e) => {
        try {
            // Kademe daÄŸÄ±lÄ±mÄ± validasyonu
            var allocTotal = int.Parse(txtPairAlloc1.Text) + int.Parse(txtPairAlloc2.Text) + int.Parse(txtPairAlloc3.Text);
            if (allocTotal != 100) {
                System.Windows.Forms.MessageBox.Show("Kademe daÄŸÄ±lÄ±mÄ± toplamÄ± %100 olmalÄ±! Åu an: %" + allocTotal, "UyarÄ±");
                return;
            }
            
            // Gist credentials ayrÄ± dosyaya (Gist'e yÃ¼klenmiyor)
            var credSb = new System.Text.StringBuilder();
            credSb.Append("{\"gist_token\":\"" + txtGistToken.Text + "\"");
            credSb.Append(",\"gist_id\":\"" + txtGistId.Text + "\"}");
            System.IO.File.WriteAllText(GIST_CREDENTIALS_FILE, credSb.ToString());
            
            // DiÄŸer ayarlar (Gist'e yÃ¼kleniyor)
            var sb = new System.Text.StringBuilder();
            sb.Append("{\"test_mode\":" + (chkTest.Checked ? "1" : "0"));
            sb.Append(",\"viop_budget\":" + txtViop.Text);
            sb.Append(",\"spot_budget\":" + txtSpot.Text);
            sb.Append(",\"sn_min_margin\":" + (decimal.Parse(txtMargin.Text, ic) / 100).ToString(ic));
            sb.Append(",\"roll_min_margin\":" + (decimal.Parse(txtRollMargin.Text, ic) / 100).ToString(ic));
            sb.Append(",\"replacement_threshold\":" + (decimal.Parse(txtReplaceThresh.Text, ic) / 100).ToString(ic));
            sb.Append(",\"gie_depth_levels\":" + txtGieDepth.Text);
            sb.Append(",\"max_daily_loss\":" + txtLoss.Text);
            sb.Append(",\"early_exit_k\":" + decimal.Parse(txtEarlyK.Text.Replace(",", "."), ic).ToString(ic));
            sb.Append(",\"bb_exit_helper\":" + decimal.Parse(txtBBExit.Text, ic).ToString(ic));
            sb.Append(",\"intraday_min_profit\":" + (decimal.Parse(txtIntraday.Text.Replace(",", "."), ic) / 1000).ToString(ic));
            sb.Append(",\"margin_warning_pct\":" + (decimal.Parse(txtMarginWarn.Text, ic) / 100).ToString(ic));
            sb.Append(",\"margin_danger_pct\":" + (decimal.Parse(txtMarginDanger.Text, ic) / 100).ToString(ic));
            sb.Append(",\"margin_critical_pct\":" + (decimal.Parse(txtMarginCrit.Text, ic) / 100).ToString(ic));
            // Cache path (RAMDisk) - normalize et
            if (!string.IsNullOrEmpty(txtCachePath.Text.Trim())) {
                var cp = txtCachePath.Text.Trim().TrimEnd('\\');
                cp += "\\";
                sb.Append(",\"cache_path\":\"" + cp.Replace("\\", "\\\\") + "\"");
            }
            // BB93 ayarlarÄ±
            sb.Append(",\"bb93_enabled\":" + (chkBB93.Checked ? "1" : "0"));
            sb.Append(",\"bb93_start_hour\":" + int.Parse(txtBB93StartHour.Text));
            sb.Append(",\"bb93_start_min\":" + int.Parse(txtBB93StartMin.Text));
            sb.Append(",\"bb93_end_hour\":" + int.Parse(txtBB93EndHour.Text));
            sb.Append(",\"bb93_end_min\":" + int.Parse(txtBB93EndMin.Text));
            // NF ayarlarÄ±
            sb.Append(",\"nf_enabled\":" + (chkNF.Checked ? "1" : "0"));
            sb.Append(",\"nf_max_positions\":" + int.Parse(txtNFMax.Text));
            sb.Append(",\"nf_entry_bb\":" + int.Parse(txtNFEntryBB.Text));
            sb.Append(",\"nf_exit_bb\":" + int.Parse(txtNFExitBB.Text));
            sb.Append(",\"nf_exit_profit\":" + (decimal.Parse(txtNFProfit.Text.Replace(",", "."), ic) / 1000).ToString(ic));
            // PAIR ayarlarÄ±
            sb.Append(",\"pair_enabled\":" + (chkPair.Checked ? "1" : "0"));
            sb.Append(",\"pair_budget\":" + decimal.Parse(txtPairBudget.Text, ic).ToString("F0", ic));
            sb.Append(",\"pair_alloc_1\":" + txtPairAlloc1.Text);
            sb.Append(",\"pair_alloc_2\":" + txtPairAlloc2.Text);
            sb.Append(",\"pair_alloc_3\":" + txtPairAlloc3.Text);
            sb.Append(",\"pair_z_entry_1\":" + decimal.Parse(txtPairZ1.Text.Replace(",", "."), ic).ToString(ic));
            sb.Append(",\"pair_z_entry_2\":" + decimal.Parse(txtPairZ2.Text.Replace(",", "."), ic).ToString(ic));
            sb.Append(",\"pair_z_entry_3\":" + decimal.Parse(txtPairZ3.Text.Replace(",", "."), ic).ToString(ic));
            sb.Append(",\"pair_z_exit\":" + decimal.Parse(txtPairZExit.Text.Replace(",", "."), ic).ToString(ic));
            sb.Append(",\"pair_definitions\":\"" + txtPairDefs.Text.Trim() + "\"");
            sb.Append(",\"bb_period\":" + BB_PERIOD);
            sb.Append(",\"loop_ms\":" + LOOP_MS);
            sb.Append("}");
            System.IO.File.WriteAllText(SETTINGS_FILE, sb.ToString());
            
            settingsNeedReload = true;
            sf.Close();
        } catch (Exception ex) {
            System.Windows.Forms.MessageBox.Show("Hata: " + ex.Message);
        }
    };
    
    var btnCancel = new System.Windows.Forms.Button { Text = "Ä°ptal", Location = new System.Drawing.Point(390, btnY), Size = new System.Drawing.Size(90, 32) };
    btnCancel.FlatStyle = System.Windows.Forms.FlatStyle.Flat;
    btnCancel.Click += (s, e) => sf.Close();
    
    sf.Controls.AddRange(new System.Windows.Forms.Control[] { 
        // Sol sÃ¼tun
        lblGistToken, txtGistToken, lblGistId, txtGistId, sep1, lblBudgetTitle,
        lblViop, txtViop, lblSpot, txtSpot,
        sep2, lblSNTitle, lblMargin, txtMargin, lblRollMargin, txtRollMargin, 
        lblReplaceThresh, txtReplaceThresh, lblGieDepth, txtGieDepth,
        sep3, lblRiskTitle, lblLoss, txtLoss, lblEarlyK, txtEarlyK, lblEarlyKHint, 
        lblBBExit, txtBBExit, lblBBExitHint, lblIntraday, txtIntraday, lblIntradayHint,
        sep4, lblMarginTitle, lblMarginWarn, txtMarginWarn, lblMarginDanger, txtMarginDanger, 
        lblMarginCrit, txtMarginCrit,
        sep5, lblBB93Title, chkBB93, txtBB93StartHour, lblBB93Sep1, txtBB93StartMin, 
        lblBB93Dash, txtBB93EndHour, lblBB93Sep2, txtBB93EndMin,
        sep6, lblCachePath, txtCachePath, lblCacheHint, chkTest,
        // SaÄŸ sÃ¼tun
        sepR1, lblNFTitle, chkNF, lblNFMax, txtNFMax, 
        lblNFEntryBB, txtNFEntryBB, lblNFExitBB, txtNFExitBB, 
        lblNFProfit, txtNFProfit, lblNFProfitHint,
        sepR2, lblPairTitle, chkPair, lblPairBudget, txtPairBudget,
        lblPairAlloc, txtPairAlloc1, txtPairAlloc2, txtPairAlloc3, lblPairAllocHint,
        lblPairZ1, txtPairZ1, txtPairZ2, txtPairZ3, lblPairZExit, txtPairZExit,
        sepR3, lblPairDefsTitle, txtPairDefs, lblPairDefsHint,
        // Butonlar
        btnSave, btnCancel 
    });
    
    // mainForm varsa parent olarak kullan, yoksa baÄŸÄ±msÄ±z aÃ§
    if (mainForm != null && !mainForm.IsDisposed) {
        sf.ShowDialog(mainForm);
    } else {
        sf.StartPosition = System.Windows.Forms.FormStartPosition.CenterScreen;
        sf.ShowDialog();
    }
};

Action CreateControlForm = () => {
    mainForm = new System.Windows.Forms.Form();
    mainForm.Text = "SN-NF-PAIR Robot v19.4";
    mainForm.Size = new System.Drawing.Size(760, 295);  // 8 satÄ±r log iÃ§in
    mainForm.TopMost = true;
    mainForm.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedDialog;
    
    var btnExit = new System.Windows.Forms.Button { Text = "Ã‡Ä±kÄ±ÅŸ", Location = new System.Drawing.Point(20, 20), Size = new System.Drawing.Size(80, 35), BackColor = System.Drawing.Color.FromArgb(220, 53, 69), ForeColor = System.Drawing.Color.White };
    btnExit.Click += (s, e) => { 
        stopRequested = true; 
        mainForm.Close(); 
    };
    
    btnPause = new System.Windows.Forms.Button { Text = "Duraklat", Location = new System.Drawing.Point(110, 20), Size = new System.Drawing.Size(80, 35), BackColor = System.Drawing.Color.FromArgb(255, 193, 7) };
    btnPause.Click += (s, e) => {
        isPaused = !isPaused;
        btnPause.Text = isPaused ? "BaÅŸlat" : "Duraklat";
        btnPause.BackColor = isPaused ? System.Drawing.Color.FromArgb(40, 167, 69) : System.Drawing.Color.FromArgb(255, 193, 7);
        lblStatus.Text = isPaused ? "â¸ï¸ DURAKLADI" : "â–¶ï¸ Ã‡ALIÅIYOR";
        lblStatus.ForeColor = isPaused ? System.Drawing.Color.Orange : System.Drawing.Color.Green;
        if (!isPaused) {
            if (settingsNeedReload) { LoadSettings(); settingsNeedReload = false; }
            // Gist komutunu sÄ±fÄ±rla (dashboard senkronizasyonu iÃ§in)
            System.Threading.ThreadPool.QueueUserWorkItem(_ => ResetGistToNone());
        }
    };
    
    var btnSettings = new System.Windows.Forms.Button { Text = "Ayarlar", Location = new System.Drawing.Point(200, 20), Size = new System.Drawing.Size(80, 35), BackColor = System.Drawing.Color.FromArgb(0, 123, 255), ForeColor = System.Drawing.Color.White };
    btnSettings.Click += (s, e) => { if (isPaused) ShowSettingsForm(); };
    
    var btnPos = new System.Windows.Forms.Button { Text = "Pozisyonlar", Location = new System.Drawing.Point(290, 20), Size = new System.Drawing.Size(90, 35), BackColor = System.Drawing.Color.FromArgb(108, 117, 125), ForeColor = System.Drawing.Color.White };
    btnPos.Click += (s, e) => ShowPositionsForm();
    
    lblStatus = new System.Windows.Forms.Label { Text = "â–¶ï¸ Ã‡ALIÅIYOR", Location = new System.Drawing.Point(20, 65), Size = new System.Drawing.Size(700, 25), Font = new System.Drawing.Font("Segoe UI", 12, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.Green };
    lblInfo = new System.Windows.Forms.Label { Text = "BaÅŸlatÄ±lÄ±yor...", Location = new System.Drawing.Point(20, 95), Size = new System.Drawing.Size(700, 20), Font = new System.Drawing.Font("Consolas", 9) };
    
    // Log paneli - 100 karakter + %5 margin, 8 satÄ±r (Consolas 8pt ~7px/char, ~14px/satÄ±r)
    lblLog = new System.Windows.Forms.Label { 
        Text = "", 
        Location = new System.Drawing.Point(20, 120), 
        Size = new System.Drawing.Size(705, 125), 
        Font = new System.Drawing.Font("Consolas", 8), 
        ForeColor = System.Drawing.Color.DarkSlateGray,
        BackColor = System.Drawing.Color.FromArgb(245, 245, 245),
        BorderStyle = System.Windows.Forms.BorderStyle.FixedSingle,
        Padding = new System.Windows.Forms.Padding(3)
    };
    
    mainForm.Controls.AddRange(new System.Windows.Forms.Control[] { btnExit, btnPause, btnSettings, btnPos, lblStatus, lblInfo, lblLog });
    mainForm.FormClosing += (s, e) => stopRequested = true;
    System.Windows.Forms.Application.Run(mainForm);
};

Action UpdateFormInfo = () => {
    if (mainForm == null || lblInfo == null) return;
    try {
        mainForm.BeginInvoke(new Action(() => {
            lblInfo.Text = "Poz: " + snPos.Count + " | P&L: " + dailyRealizedPnl.ToString("N0") + " TL | Piyasa: " + (isMarketOpen ? "AÃ‡IK" : "KAPALI");
        }));
    } catch { }
};

// ====================================
// BAÅLATMA
// ====================================

// Settings'i Ã¶nce yÃ¼kle (LOG_PATH iÃ§in)
try { LoadSettings(); } catch { }

// BaÅŸlangÄ±Ã§ formu - BaÅŸlat/Ayarlar/Ã‡Ä±kÄ±ÅŸ seÃ§imi + Ã¶zet bilgiler
var userChoice = 0;  // 0=bekle, 1=baÅŸlat, 2=Ã§Ä±kÄ±ÅŸ
var startupForm = new System.Windows.Forms.Form();
startupForm.Text = "SN-NF-PAIR Robot v19.4";
startupForm.Size = new System.Drawing.Size(420, 340);
startupForm.StartPosition = System.Windows.Forms.FormStartPosition.CenterScreen;
startupForm.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedDialog;
startupForm.MaximizeBox = false;
startupForm.MinimizeBox = false;
startupForm.BackColor = System.Drawing.Color.FromArgb(250, 250, 252);

// BaÅŸlÄ±k
var lblStartup = new System.Windows.Forms.Label {
    Text = "ğŸ¤– SN-NF-PAIR Arbitraj Robot",
    Location = new System.Drawing.Point(20, 15),
    Size = new System.Drawing.Size(380, 28),
    Font = new System.Drawing.Font("Segoe UI", 14, System.Drawing.FontStyle.Bold),
    ForeColor = System.Drawing.Color.FromArgb(30, 60, 114),
    TextAlign = System.Drawing.ContentAlignment.MiddleCenter
};

// Ayarlar Ã¶zeti paneli
var pnlSummary = new System.Windows.Forms.Panel {
    Location = new System.Drawing.Point(20, 50),
    Size = new System.Drawing.Size(375, 180),
    BorderStyle = System.Windows.Forms.BorderStyle.FixedSingle,
    BackColor = System.Drawing.Color.White
};

// Ã–zet bilgiler - sol sÃ¼tun
var summaryFont = new System.Drawing.Font("Consolas", 9);
var labelColor = System.Drawing.Color.FromArgb(100, 100, 100);
var valueColor = System.Drawing.Color.FromArgb(30, 30, 30);

var lblMode = new System.Windows.Forms.Label { Text = "Mod:", Location = new System.Drawing.Point(10, 10), Size = new System.Drawing.Size(70, 18), Font = summaryFont, ForeColor = labelColor };
var lblModeVal = new System.Windows.Forms.Label { 
    Text = IS_TEST ? "ğŸ§ª TEST" : "ğŸ”´ CANLI", 
    Location = new System.Drawing.Point(85, 10), Size = new System.Drawing.Size(90, 18), 
    Font = new System.Drawing.Font("Consolas", 9, System.Drawing.FontStyle.Bold), 
    ForeColor = IS_TEST ? System.Drawing.Color.Orange : System.Drawing.Color.Red 
};

var suLblViop = new System.Windows.Forms.Label { Text = "VIOP BÃ¼tÃ§e:", Location = new System.Drawing.Point(10, 32), Size = new System.Drawing.Size(75, 18), Font = summaryFont, ForeColor = labelColor };
var suLblViopVal = new System.Windows.Forms.Label { Text = VIOP_BUDGET.ToString("N0") + " â‚º", Location = new System.Drawing.Point(85, 32), Size = new System.Drawing.Size(90, 18), Font = summaryFont, ForeColor = valueColor };

var suLblSpot = new System.Windows.Forms.Label { Text = "SPOT BÃ¼tÃ§e:", Location = new System.Drawing.Point(10, 54), Size = new System.Drawing.Size(75, 18), Font = summaryFont, ForeColor = labelColor };
var suLblSpotVal = new System.Windows.Forms.Label { Text = SPOT_BUDGET.ToString("N0") + " â‚º", Location = new System.Drawing.Point(85, 54), Size = new System.Drawing.Size(90, 18), Font = summaryFont, ForeColor = valueColor };

var lblMinMarj = new System.Windows.Forms.Label { Text = "Min Marj:", Location = new System.Drawing.Point(10, 76), Size = new System.Drawing.Size(75, 18), Font = summaryFont, ForeColor = labelColor };
var lblMinMarjVal = new System.Windows.Forms.Label { Text = (SN_MIN_MARGIN * 100).ToString("F2") + "%", Location = new System.Drawing.Point(85, 76), Size = new System.Drawing.Size(90, 18), Font = summaryFont, ForeColor = valueColor };

// Ã–zet bilgiler - saÄŸ sÃ¼tun (stratejiler)
var lblSep = new System.Windows.Forms.Label { BorderStyle = System.Windows.Forms.BorderStyle.Fixed3D, Location = new System.Drawing.Point(185, 8), Size = new System.Drawing.Size(1, 160), BackColor = System.Drawing.Color.LightGray };

var lblStrTitle = new System.Windows.Forms.Label { Text = "ğŸ“Š STRATEJÄ°LER", Location = new System.Drawing.Point(195, 10), Size = new System.Drawing.Size(120, 18), Font = new System.Drawing.Font("Segoe UI", 8, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.FromArgb(30, 60, 114) };

var lblBB93 = new System.Windows.Forms.Label { Text = "BB93 GiriÅŸ:", Location = new System.Drawing.Point(195, 32), Size = new System.Drawing.Size(70, 18), Font = summaryFont, ForeColor = labelColor };
var lblBB93Val = new System.Windows.Forms.Label { 
    Text = BB93_ENTRY_ENABLED ? "âœ“ AKTÄ°F" : "âœ— KAPALI", 
    Location = new System.Drawing.Point(270, 32), Size = new System.Drawing.Size(90, 18), 
    Font = summaryFont, 
    ForeColor = BB93_ENTRY_ENABLED ? System.Drawing.Color.Green : System.Drawing.Color.Gray 
};

var lblNF = new System.Windows.Forms.Label { Text = "Near-Far:", Location = new System.Drawing.Point(195, 54), Size = new System.Drawing.Size(70, 18), Font = summaryFont, ForeColor = labelColor };
var lblNFVal = new System.Windows.Forms.Label { 
    Text = NF_ENABLED ? "âœ“ AKTÄ°F" : "âœ— KAPALI", 
    Location = new System.Drawing.Point(270, 54), Size = new System.Drawing.Size(90, 18), 
    Font = summaryFont, 
    ForeColor = NF_ENABLED ? System.Drawing.Color.Green : System.Drawing.Color.Gray 
};

var lblPair = new System.Windows.Forms.Label { Text = "Pair Trade:", Location = new System.Drawing.Point(195, 76), Size = new System.Drawing.Size(70, 18), Font = summaryFont, ForeColor = labelColor };
var lblPairVal = new System.Windows.Forms.Label { 
    Text = PAIR_ENABLED ? "âœ“ AKTÄ°F" : "âœ— KAPALI", 
    Location = new System.Drawing.Point(270, 76), Size = new System.Drawing.Size(90, 18), 
    Font = summaryFont, 
    ForeColor = PAIR_ENABLED ? System.Drawing.Color.Green : System.Drawing.Color.Gray 
};

var suLblPairBudget = new System.Windows.Forms.Label { Text = "Pair BÃ¼tÃ§e:", Location = new System.Drawing.Point(195, 98), Size = new System.Drawing.Size(70, 18), Font = summaryFont, ForeColor = labelColor };
var suLblPairBudgetVal = new System.Windows.Forms.Label { Text = PAIR_BUDGET.ToString("N0") + " â‚º", Location = new System.Drawing.Point(270, 98), Size = new System.Drawing.Size(90, 18), Font = summaryFont, ForeColor = valueColor };

// Pozisyon Ã¶zeti (positions.json'dan)
var lblPosTitle = new System.Windows.Forms.Label { Text = "ğŸ“ˆ POZÄ°SYONLAR", Location = new System.Drawing.Point(10, 105), Size = new System.Drawing.Size(120, 18), Font = new System.Drawing.Font("Segoe UI", 8, System.Drawing.FontStyle.Bold), ForeColor = System.Drawing.Color.FromArgb(30, 60, 114) };

var snPosCount = snPos.Count;
var nfPosCount = nfPos.Count;
var pairPosCount = pairPos.Count;

var lblPosSN = new System.Windows.Forms.Label { Text = "SN: " + snPosCount, Location = new System.Drawing.Point(10, 125), Size = new System.Drawing.Size(50, 18), Font = summaryFont, ForeColor = snPosCount > 0 ? System.Drawing.Color.Blue : labelColor };
var lblPosNF = new System.Windows.Forms.Label { Text = "NF: " + nfPosCount, Location = new System.Drawing.Point(65, 125), Size = new System.Drawing.Size(50, 18), Font = summaryFont, ForeColor = nfPosCount > 0 ? System.Drawing.Color.Purple : labelColor };
var lblPosPair = new System.Windows.Forms.Label { Text = "Pair: " + pairPosCount, Location = new System.Drawing.Point(120, 125), Size = new System.Drawing.Size(55, 18), Font = summaryFont, ForeColor = pairPosCount > 0 ? System.Drawing.Color.Teal : labelColor };

// Gist baÄŸlantÄ± durumu
var gistOk = !string.IsNullOrEmpty(GIST_TOKEN) && !string.IsNullOrEmpty(GIST_ID);
var lblGist = new System.Windows.Forms.Label { Text = "Dashboard:", Location = new System.Drawing.Point(195, 125), Size = new System.Drawing.Size(70, 18), Font = summaryFont, ForeColor = labelColor };
var lblGistVal = new System.Windows.Forms.Label { 
    Text = gistOk ? "âœ“ BAÄLI" : "âœ— YOK", 
    Location = new System.Drawing.Point(270, 125), Size = new System.Drawing.Size(90, 18), 
    Font = summaryFont, 
    ForeColor = gistOk ? System.Drawing.Color.Green : System.Drawing.Color.Orange 
};

// Son gÃ¼ncelleme
var lblUpdate = new System.Windows.Forms.Label { 
    Text = "settings.json: " + (System.IO.File.Exists(SETTINGS_FILE) ? System.IO.File.GetLastWriteTime(SETTINGS_FILE).ToString("dd.MM HH:mm") : "yok"), 
    Location = new System.Drawing.Point(10, 150), Size = new System.Drawing.Size(355, 18), 
    Font = new System.Drawing.Font("Segoe UI", 8), 
    ForeColor = System.Drawing.Color.Gray,
    TextAlign = System.Drawing.ContentAlignment.MiddleRight
};

pnlSummary.Controls.AddRange(new System.Windows.Forms.Control[] { 
    lblMode, lblModeVal, suLblViop, suLblViopVal, suLblSpot, suLblSpotVal, lblMinMarj, lblMinMarjVal,
    lblSep, lblStrTitle, lblBB93, lblBB93Val, lblNF, lblNFVal, lblPair, lblPairVal, suLblPairBudget, suLblPairBudgetVal,
    lblPosTitle, lblPosSN, lblPosNF, lblPosPair,
    lblGist, lblGistVal, lblUpdate
});

// Butonlar
var btnStart = new System.Windows.Forms.Button {
    Text = "â–¶ BaÅŸlat",
    Location = new System.Drawing.Point(20, 245),
    Size = new System.Drawing.Size(115, 40),
    BackColor = System.Drawing.Color.FromArgb(40, 167, 69),
    ForeColor = System.Drawing.Color.White,
    Font = new System.Drawing.Font("Segoe UI", 11, System.Drawing.FontStyle.Bold),
    FlatStyle = System.Windows.Forms.FlatStyle.Flat,
    Cursor = System.Windows.Forms.Cursors.Hand
};
btnStart.FlatAppearance.BorderSize = 0;
btnStart.Click += (s, e) => { userChoice = 1; startupForm.Close(); };

var suBtnSettings = new System.Windows.Forms.Button {
    Text = "âš™ Ayarlar",
    Location = new System.Drawing.Point(150, 245),
    Size = new System.Drawing.Size(115, 40),
    BackColor = System.Drawing.Color.FromArgb(0, 123, 255),
    ForeColor = System.Drawing.Color.White,
    Font = new System.Drawing.Font("Segoe UI", 11, System.Drawing.FontStyle.Bold),
    FlatStyle = System.Windows.Forms.FlatStyle.Flat,
    Cursor = System.Windows.Forms.Cursors.Hand
};
suBtnSettings.FlatAppearance.BorderSize = 0;
suBtnSettings.Click += (s, e) => { 
    ShowSettingsForm();
    // Ayarlar kapatÄ±ldÄ±ktan sonra Ã¶zeti gÃ¼ncelle
    try { LoadSettings(); } catch { }
    lblModeVal.Text = IS_TEST ? "ğŸ§ª TEST" : "ğŸ”´ CANLI";
    lblModeVal.ForeColor = IS_TEST ? System.Drawing.Color.Orange : System.Drawing.Color.Red;
    suLblViopVal.Text = VIOP_BUDGET.ToString("N0") + " â‚º";
    suLblSpotVal.Text = SPOT_BUDGET.ToString("N0") + " â‚º";
    lblMinMarjVal.Text = (SN_MIN_MARGIN * 100).ToString("F2") + "%";
    lblBB93Val.Text = BB93_ENTRY_ENABLED ? "âœ“ AKTÄ°F" : "âœ— KAPALI";
    lblBB93Val.ForeColor = BB93_ENTRY_ENABLED ? System.Drawing.Color.Green : System.Drawing.Color.Gray;
    lblNFVal.Text = NF_ENABLED ? "âœ“ AKTÄ°F" : "âœ— KAPALI";
    lblNFVal.ForeColor = NF_ENABLED ? System.Drawing.Color.Green : System.Drawing.Color.Gray;
    lblPairVal.Text = PAIR_ENABLED ? "âœ“ AKTÄ°F" : "âœ— KAPALI";
    lblPairVal.ForeColor = PAIR_ENABLED ? System.Drawing.Color.Green : System.Drawing.Color.Gray;
    suLblPairBudgetVal.Text = PAIR_BUDGET.ToString("N0") + " â‚º";
    var gistOkNew = !string.IsNullOrEmpty(GIST_TOKEN) && !string.IsNullOrEmpty(GIST_ID);
    lblGistVal.Text = gistOkNew ? "âœ“ BAÄLI" : "âœ— YOK";
    lblGistVal.ForeColor = gistOkNew ? System.Drawing.Color.Green : System.Drawing.Color.Orange;
    lblUpdate.Text = "settings.json: " + (System.IO.File.Exists(SETTINGS_FILE) ? System.IO.File.GetLastWriteTime(SETTINGS_FILE).ToString("dd.MM HH:mm") : "yok");
};

var btnQuit = new System.Windows.Forms.Button {
    Text = "âœ• Ã‡Ä±kÄ±ÅŸ",
    Location = new System.Drawing.Point(280, 245),
    Size = new System.Drawing.Size(115, 40),
    BackColor = System.Drawing.Color.FromArgb(220, 53, 69),
    ForeColor = System.Drawing.Color.White,
    Font = new System.Drawing.Font("Segoe UI", 11, System.Drawing.FontStyle.Bold),
    FlatStyle = System.Windows.Forms.FlatStyle.Flat,
    Cursor = System.Windows.Forms.Cursors.Hand
};
btnQuit.FlatAppearance.BorderSize = 0;
btnQuit.Click += (s, e) => { userChoice = 2; startupForm.Close(); };

startupForm.Controls.AddRange(new System.Windows.Forms.Control[] { lblStartup, pnlSummary, btnStart, suBtnSettings, btnQuit });

// Form'u gÃ¶ster (modal - kullanÄ±cÄ± seÃ§ene kadar bekle)
System.Windows.Forms.Application.Run(startupForm);

// KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸ seÃ§tiyse - script tamamen bitsin
if (userChoice != 1) {
    Sistem.RobotStop();
}

// BaÅŸlat seÃ§ildiyse devam et
if (userChoice == 1) {

// Eski log dosyasÄ±nÄ± sil (temiz baÅŸlangÄ±Ã§)
try {
    var oldLogPath = LOG_PATH + "arb.log";
    if (System.IO.File.Exists(oldLogPath)) {
        System.IO.File.Delete(oldLogPath);
    }
    // logLines listesini de temizle (LoadSettings iÃ§inde Log Ã§aÄŸrÄ±ldÄ±ysa dolu olabilir)
    logLines.Clear();
    logPath = "";  // Path'i sÄ±fÄ±rla ki Log tekrar okumasÄ±n
} catch { }

Log("=== SN-NF-PAIR ROBOT v19.4 BAÅLADI ===");

var formThread = new System.Threading.Thread(() => CreateControlForm());
formThread.SetApartmentState(System.Threading.ApartmentState.STA);
formThread.IsBackground = true;
formThread.Start();

// Form oluÅŸmasÄ±nÄ± bekle (max 5 saniye)
var formWaitStart = DateTime.Now;
while (mainForm == null && (DateTime.Now - formWaitStart).TotalSeconds < 5) {
    System.Threading.Thread.Sleep(100);
}
if (mainForm == null) {
    Log("âš ï¸ Form oluÅŸturulamadÄ± - devam ediliyor");
}

isMarketOpen = CheckMarketOpen();
Log("Piyasa: " + (isMarketOpen ? "AÃ‡IK" : "KAPALI") + " (10:01-18:09)");

try { LoadTeminatFromFile(); } catch { }
Log("Spread BB grafik verisinden yÃ¼kleniyor...");
try { LoadSpreadBBFromChart(); } catch { }
try { UpdateRiskFree(); } catch { }
try { UpdateTeminatFromVIOP(); } catch { }
try { LoadPositions(); } catch { }
try { LoadStatsHistory(); } catch { }
try { UpdateBalances(); } catch { }
try { UpdateDividends(); } catch { }  // TemettÃ¼ verilerini gÃ¼ncelle/yÃ¼kle
try { UpdateSermayeArtirimi(); } catch { }  // Sermaye artÄ±rÄ±mÄ± verilerini gÃ¼ncelle/yÃ¼kle

// Pair Trading: BaÅŸlangÄ±Ã§ta Z-Score hesapla (piyasa kapalÄ± olsa bile)
if (PAIR_ENABLED && PAIR_DEFS.Count > 0) {
    try { 
        LoadPairData(); 
        Log("ğŸ“Š PAIR: " + PAIR_DEFS.Count + " Ã§ift tanÄ±mlÄ±, Z-Score yÃ¼klendi");
    } catch (Exception ex) { 
        Log("âš ï¸ PAIR: Veri yÃ¼kleme hatasÄ± - " + ex.Message); 
    }
}

Log("HazÄ±r: " + symbols.Count + " sembol, " + snPos.Count + " pozisyon");
if (IS_TEST) {
    Log("Bakiye: VIOP=" + viopBalance.ToString("N0") + " SPOT=" + spotBudgetTotal.ToString("N0") + " (kalan:" + spotBalance.ToString("N0") + ") [TEST]");
} else {
    Log("Bakiye: VIOP=" + viopBalance.ToString("N0") + " SPOT=" + spotBudgetTotal.ToString("N0") + " (T+2:" + t2Balance.ToString("N0") + ") [GERÃ‡EK]");
}

// Robot Ã§alÄ±ÅŸÄ±yor olarak iÅŸaretle
isRunning = true;

// Tavan/taban fiyatlarÄ±nÄ± yÃ¼kle (gÃ¼n iÃ§i baÅŸlatma iÃ§in gerekli)
LoadTavanTaban();

// BaÅŸlangÄ±Ã§ recovery'si (sadece normal mod)
if (!IS_TEST) {
    Log("ğŸ”„ BaÅŸlangÄ±Ã§ pozisyon senkronizasyonu...");
    SyncAndRecoverPositions();  // RefreshHesaplar iÃ§inde bekleme var
    recoveryTriggered = true;
    
    // Ä°lk bakiye gÃ¼ncellemesi (T+2 hesaplanacak)
    UpdateBalances();
    Log("ğŸ“Š BÃ¼tÃ§e: VIOP=" + viopBalance.ToString("N0") + " SPOT=" + spotBudgetTotal.ToString("N0") + " (T+2:" + t2Balance.ToString("N0") + ")");
    
    // Ä°lk Gist gÃ¼ncellemesi + komut sÄ±fÄ±rlama
    Log("ğŸ“¤ Ä°lk Gist gÃ¼ncellemesi gÃ¶nderiliyor...");
    UpdateDashboard(true, true);  // resetCommand=true, includeLogs=true
    Log("âœ… Ä°lk Gist gÃ¼ncellemesi tamamlandÄ±");
    
    // BaÅŸlangÄ±Ã§ta veri baÄŸlantÄ±sÄ± durumunu kontrol et
    dataConnected = Sistem.BaglantiVar;
    if (!dataConnected) {
        Log("âš ï¸ BaÅŸlangÄ±Ã§ta veri baÄŸlantÄ±sÄ± yok");
    }
}

var lastRiskFreeUpdate = DateTime.Now;
var lastFormUpdate = DateTime.Now;

while (true) {
    try {
        // STOP kontrolÃ¼ - dÃ¶ngÃ¼ baÅŸÄ±nda hemen kontrol et
        if (stopRequested || (mainForm != null && mainForm.IsDisposed)) {
            Log("=== SN-NF-PAIR ROBOT v19.4 DURDU ===");
            // NOT: STOP.txt silinmiyor - yeniden baÅŸlamayÄ± engellemek iÃ§in kalacak
            isRunning = false;
            UpdateDashboard(false, true);
            Log("ğŸ“¤ Dashboard'a durma bildirimi gÃ¶nderildi");
            Sistem.RobotStop();
            break;
        }
        
        // IdealData veri baÄŸlantÄ±sÄ± kontrolÃ¼
        var wasDataConnected = dataConnected;
        dataConnected = Sistem.BaglantiVar;
        if (!dataConnected) {
            if (wasDataConnected) {
                // Ä°lk kopma anÄ± - hemen full Gist gÃ¶nder
                Log("âš ï¸ Veri baÄŸlantÄ±sÄ± koptu!");
                UpdateDashboard(false, true);  // Tam gÃ¼ncelleme (log dahil)
                lastGistUpload = DateTime.Now;  // ZamanÄ± kaydet
            } else {
                // Kopuk kaldÄ± - 1 dk sonra bir kere, sonra saatte bir dene
                var minutesSinceLastUpload = (DateTime.Now - lastGistUpload).TotalMinutes;
                if ((minutesSinceLastUpload >= 1 && minutesSinceLastUpload < 2) || minutesSinceLastUpload >= 60) {
                    var statsJson = BuildStatsJson();
                    SafeWrite(STATS_FILE, statsJson);
                    UpdateDashboard(false, true);
                }
            }
            
            // Veri baÄŸlantÄ±sÄ± kopukken de broker kontrolÃ¼ yap
            CheckBrokerConnection();
            
            System.Threading.Thread.Sleep(5000);
            continue;
        } else if (!wasDataConnected) {
            Log("âœ… Veri baÄŸlantÄ±sÄ± yeniden saÄŸlandÄ±");
            UpdateDashboard(false, true);  // Tam gÃ¼ncelleme (log dahil)
        }
        
        // STOP.txt dosyasÄ± kontrolÃ¼ (uzaktan durdurma iÃ§in)
        if (System.IO.File.Exists(BASE_PATH + "STOP.txt")) {
            stopRequested = true;
            continue;  // DÃ¶ngÃ¼ baÅŸÄ±na git, orada Ã§Ä±kÄ±ÅŸ yapÄ±lacak
        }
        
        isMarketOpen = CheckMarketOpen();
        
        if ((DateTime.Now - lastFormUpdate).TotalSeconds >= 2) {
            UpdateFormInfo();
            lastFormUpdate = DateTime.Now;
        }
        
        // Piyasa kapalÄ±yken de Gist'i gÃ¼ncelle (dakikada bir)
        if (!isMarketOpen) {
            if ((DateTime.Now - lastGistUpload).TotalMinutes >= 1) {
                // Lokal dosyaya yaz ve Gist'e yÃ¼kle
                var statsJson = BuildStatsJson();
                SafeWrite(STATS_FILE, statsJson);
                UpdateDashboard(false, true);  // resetCommand=false, includeLogs=true
            }
            
            // Piyasa kapalÄ±yken 30sn yerine 5sn bekle (stopRequested daha hÄ±zlÄ± kontrol edilsin)
            System.Threading.Thread.Sleep(5000);
            continue;
        }
        
        // Duraklama dÃ¶ngÃ¼sÃ¼ - dakikada bir Gist kontrolÃ¼ (STOP ve RESUME iÃ§in)
        if (isPaused) {
            var timeSinceLastCheck = (DateTime.Now - lastGistUpload).TotalMinutes;
            if (timeSinceLastCheck >= 1) {
                CheckGistCommand();
                lastGistUpload = DateTime.Now;  // Kontrol zamanÄ±nÄ± gÃ¼ncelle
                if (stopRequested) continue;  // STOP geldi, hemen dÃ¶ngÃ¼ baÅŸÄ±na git
            }
            System.Threading.Thread.Sleep(LOOP_MS);
            continue;
        }
        
        // Periyodik recovery kontrolÃ¼ (11:50, 17:35) - sadece normal mod
        CheckScheduledRecovery();
        
        // Recovery retry kontrolÃ¼ (teyit alÄ±namadÄ±ysa 30sn sonra tekrar)
        if (recoveryRetryNeeded && DateTime.Now >= recoveryRetryTime) {
            Log("ğŸ”„ RECOVERY RETRY: Teyit alÄ±namayan iÅŸlem iÃ§in tekrar kontrol...");
            recoveryRetryNeeded = false;
            SyncAndRecoverPositions();
        }
        
        // Teminat gÃ¼ncelleme kontrolÃ¼ (09:20'de)
        CheckTeminatUpdate();
        
        // Derinlik cache warmup (09:56'da - piyasa aÃ§Ä±lÄ±ÅŸÄ±ndan Ã¶nce)
        WarmupDepthCache();
        
        if ((DateTime.Now - lastRiskFreeUpdate).TotalMinutes >= 5) {
            UpdateRiskFree();
            lastRiskFreeUpdate = DateTime.Now;
        }
        
        if (DateTime.Today > lastBlockReset) {
            // Ã–nce dÃ¼nÃ¼n stats'Ä±nÄ± kaydet (eÄŸer veri varsa)
            if (dailySNPnl != 0 || totalClosedSN > 0 || dailyViopCommission > 0 || dailySpotCommission > 0) {
                var yesterday = lastBlockReset.ToString("yyyy-MM-dd");
                statsHistory[yesterday] = new decimal[] { dailySNPnl, dailyViopCommission, dailySpotCommission, totalClosedSN };
                SaveStatsHistory();
                Log("ğŸ“Š DÃ¼n stats kaydedildi: " + yesterday);
            }
            
            // GÃ¼nlÃ¼k deÄŸiÅŸkenleri sÄ±fÄ±rla
            blockedSymbols.Clear();
            dailyRealizedPnl = 0;
            dailyTrades = 0;
            dailySpotCommission = 0;
            dailyViopCommission = 0;
            dailySNPnl = 0;
            totalClosedSN = 0;
            dailyPairPnl = 0;       // Pair gÃ¼nlÃ¼k P&L sÄ±fÄ±rla
            totalClosedPair = 0;    // Pair kapatÄ±lan pozisyon sayÄ±sÄ± sÄ±fÄ±rla
            totalTransferredComm = 0;  // Yeni gÃ¼n, transfer sÄ±fÄ±rla
            lastBlockReset = DateTime.Today;
            lastStatsSaveDate = "";
            Log("ğŸ“… Yeni gÃ¼n");
            
            // TemettÃ¼ verilerini gÃ¼ncelle
            try { UpdateDividends(); } catch { }
        }
        
        // 09:25'te temettÃ¼ verilerini kontrol et (gÃ¼n iÃ§inde henÃ¼z gÃ¼ncellenmemiÅŸse)
        var nowMinutes = DateTime.Now.Hour * 60 + DateTime.Now.Minute;
        if (nowMinutes >= 9 * 60 + 25 && nowMinutes <= 9 * 60 + 27 && lastTemettuCheck.Date < DateTime.Today) {
            try { UpdateDividends(); } catch { }
        }
        
        // 09:25'te sermaye artÄ±rÄ±mÄ± verilerini kontrol et (gÃ¼n iÃ§inde henÃ¼z gÃ¼ncellenmemiÅŸse)
        if (nowMinutes >= 9 * 60 + 25 && nowMinutes <= 9 * 60 + 27 && lastSrmCheck.Date < DateTime.Today) {
            try { UpdateSermayeArtirimi(); } catch { }
        }
        
        // 10:10'da sermaye artÄ±rÄ±mÄ± olan pozisyonlarÄ± otomatik kapat
        if (nowMinutes >= 10 * 60 + 10 && nowMinutes <= 10 * 60 + 12 && lastSrmCloseCheck.Date < DateTime.Today) {
            lastSrmCloseCheck = DateTime.Now;
            
            try {
                var closedCount = 0;
                
                // SN pozisyonlarÄ±nÄ± kontrol et ve kapat
                var snToClose = new System.Collections.Generic.List<string>();
                foreach (var kv in snPos) {
                    if (CheckSermayeArtirimi(kv.Key) > 0) {
                        snToClose.Add(kv.Key);
                    }
                }
                foreach (var sym in snToClose) {
                    try {
                        if (!snPos.ContainsKey(sym)) continue;
                        var pos = snPos[sym];
                        var sQty = (int)pos[0];
                        var nQty = (int)pos[1];
                        var nearC = GetContract(sym, 0);
                        if (nQty > 0 && !string.IsNullOrEmpty(nearC)) {
                            Log("ğŸš¨ SERMAYE ARTIRIMI KAPATMA (SN): " + sym + " Spot:" + sQty + " Near:" + nQty);
                            CloseSN(sym, nearC, sQty, nQty, "SERMAYE_ARTIRIMI");
                            closedCount++;
                        }
                    } catch (Exception ex) { Log("âŒ SN kapatma hatasÄ± (" + sym + "): " + ex.Message); }
                }
                
                // NF pozisyonlarÄ±nÄ± kontrol et ve kapat
                var nfToClose = new System.Collections.Generic.List<string>();
                foreach (var kv in nfPos) {
                    if (CheckSermayeArtirimi(kv.Key) > 0) {
                        nfToClose.Add(kv.Key);
                    }
                }
                foreach (var sym in nfToClose) {
                    try {
                        if (!nfPos.ContainsKey(sym)) continue;
                        var pos = nfPos[sym];
                        var nearQty = (int)pos[0];
                        var farQty = (int)pos[1];
                        var nearC = nfContracts.ContainsKey(sym) ? nfContracts[sym][0] : GetContract(sym, 0);
                        var farC = nfContracts.ContainsKey(sym) ? nfContracts[sym][1] : GetContract(sym, 1);
                        if (nearQty > 0 && farQty > 0 && !string.IsNullOrEmpty(nearC) && !string.IsNullOrEmpty(farC)) {
                            Log("ğŸš¨ SERMAYE ARTIRIMI KAPATMA (NF): " + sym + " Near:" + nearQty + " Far:" + farQty);
                            CloseNF(sym, nearC, farC, nearQty, farQty, "SERMAYE_ARTIRIMI");
                            closedCount++;
                        }
                    } catch (Exception ex) { Log("âŒ NF kapatma hatasÄ± (" + sym + "): " + ex.Message); }
                }
                
                // Pair pozisyonlarÄ±nÄ± kontrol et ve kapat
                var pairToClose = new System.Collections.Generic.List<int>();
                for (int pi = 0; pi < PAIR_DEFS.Count; pi++) {
                    var def = PAIR_DEFS[pi];
                    var symA = (string)def[0];
                    var symB = (string)def[1];
                    var pairKey = GetPairKey(symA, symB);
                    if (pairPos.ContainsKey(pairKey) && (CheckSermayeArtirimi(symA) > 0 || CheckSermayeArtirimi(symB) > 0)) {
                        pairToClose.Add(pi);
                    }
                }
                foreach (var pairIdx in pairToClose) {
                    try {
                        var def = PAIR_DEFS[pairIdx];
                        var symA = (string)def[0];
                        var symB = (string)def[1];
                        var pairKey = GetPairKey(symA, symB);
                        Log("ğŸš¨ SERMAYE ARTIRIMI KAPATMA (PAIR): " + pairKey);
                        ClosePair(pairIdx);
                        closedCount++;
                    } catch (Exception ex) { Log("âŒ Pair kapatma hatasÄ±: " + ex.Message); }
                }
                
                if (closedCount > 0) {
                    Log("âœ… Sermaye artÄ±rÄ±mÄ± kapatma tamamlandÄ±: " + closedCount + " pozisyon kapatÄ±ldÄ±");
                    SavePositions();
                }
            } catch (Exception ex) {
                Log("âŒ Sermaye artÄ±rÄ±mÄ± kapatma genel hatasÄ±: " + ex.Message);
            }
        }
        
        // VÄ°OP komisyonlarÄ±nÄ± 15 dakikada bir SPOT'a transfer et
        if ((DateTime.Now - lastCommissionTransfer).TotalMinutes >= 15) {
            TransferViopCommission();
        }
        
        // Bakiyeleri gÃ¼ncelle (her dÃ¶ngÃ¼de) - cache'i doldurur
        UpdateBalances();
        
        // AracÄ± kurum baÄŸlantÄ± kontrolÃ¼ (UpdateBalances sonrasÄ±, cache dolu)
        CheckBrokerConnection();
        
        // Endeks devre kesici kontrolÃ¼ (her dÃ¶ngÃ¼de)
        CheckIndexCircuitBreaker();
        
        // Not: CheckMarginStatus artÄ±k RefreshHesaplar iÃ§inden tetikleniyor
        
        MainLoop();
        System.Threading.Thread.Sleep(LOOP_MS);
    } catch (Exception ex) {
        Log("HATA: " + ex.Message);
        System.Threading.Thread.Sleep(5000);
    }
}

Log("=== ROBOT DURDURULDU ===");
// Log artÄ±k List<string> ile tutuluyor, StreamWriter yok

} // userChoice == 1 kapanÄ±ÅŸÄ±
